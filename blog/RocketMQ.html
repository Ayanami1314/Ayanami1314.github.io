<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">RocketMQ学习 | Ayanami&#x27;s Cave</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ayanami1314.github.io/blog/RocketMQ"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="RocketMQ学习 | Ayanami&#x27;s Cave"><meta data-rh="true" name="description" content="mq: 异步，解耦，削峰填谷"><meta data-rh="true" property="og:description" content="mq: 异步，解耦，削峰填谷"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2025-05-24T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="mq"><link data-rh="true" rel="icon" href="/img/ayanami.jpg"><link data-rh="true" rel="canonical" href="https://ayanami1314.github.io/blog/RocketMQ"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog/RocketMQ" hreflang="en"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog/RocketMQ" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/RocketMQ","mainEntityOfPage":"https://ayanami1314.github.io/blog/RocketMQ","url":"https://ayanami1314.github.io/blog/RocketMQ","headline":"RocketMQ学习","name":"RocketMQ学习","description":"mq: 异步，解耦，削峰填谷","datePublished":"2025-05-24T00:00:00.000Z","author":{"@type":"Person","name":"ayanami"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://ayanami1314.github.io/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ayanami&#39;s Cave Atom Feed">



<link rel="alternate" type="application/rss+xml" href="/personal-essays/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-essays/atom.xml" title="Ayanami&#39;s Cave Atom Feed">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.00dd3480.css">
<script src="/assets/js/runtime~main.aa217668.js" defer="defer"></script>
<script src="/assets/js/main.0da58ad9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ayanami&#x27;s Cave</b></a><a class="navbar__item navbar__link" href="/docs/Chcore源码阅读">课程笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">技术博客</a><a class="navbar__item navbar__link" href="/personal-essays">个人随笔</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All our posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/llm for code paper notes">paper-reading, code&amp;rl方向</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/speculative-decode-overview">投机解码简述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Paper reading Context Pruning and beyond hard pruning">Paper reading - Context Pruning and beyond hard pruning</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/结构化输出">结构化输出与AI工具与Agent</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/context-engineering">context-engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/从微 调reranker到搜推">从微调reranker到搜推工程实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/llm-tech-report">部分llm技术报告的阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Ask in Any Modality A Comprehensive Survey on Multimodal Retrieval-Augmented Generation">Paper reading-Ask in Any Modality A Comprehensive Survey on Multimodal Retrieval-Augmented Generation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/精读 AAAI 2025 Fit and Prune Fast and Training-free Visual Token Pruning for Multi-modal Large Language Models">Paper reading - Fit and Prune Fast and Training-free Visual Token Pruning for Multi-modal Large Language Models</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/精读：Eagle Exploring The Design Space for Multi- modal LLMs with Mixture of Encoders">Paper reading-Eagle Exploring The Design Space for Multi- modal LLMs with Mixture of Encoders</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/RAG的一些思考和细节">RAG的一些思考与细节</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/精读  Interleaved Scene Graph for Interleaved Text-and-Image Generation Assessment">Paper reading - Interleaved Scene Graph for Interleaved Text-and-Image Generation Assessment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ColBERT">ColBERT-后期交互方法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/05/26/技术博客阅读">美团技术博客阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Milvus">稀疏神经嵌入</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/RocketMQ">RocketMQ学习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/AI limu">李沐dl  笔记</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs186-database-WIP">ucb cs186 课程笔记(更新中)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os-虚拟化">NJU操作系统(jyy OS)课程笔记-虚拟化部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/local-llm">来本地部署大模型!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ostep-chapter42-44">ostep阅读笔记：单机fs的崩溃一致性(chapter42-44)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/系统架构设计笔记">system-design-interview笔记</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/JUC">JUC</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144 labs">cs144 labs(Winter 2024)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os：并发">NJU操作系统(jyy OS)课程笔记-并发部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/nginx">nginx基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144/cs144 lec notes">CS144 Lecture Notes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/django-mosh">Django_mosh</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/splay-tree">splay tree</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/xv6book-notes">xv6book Notes(C1-4)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Go-Gin学习">Go,Gin学习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godis源码阅读">godis源码阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hibernate-jpa">hibernate&amp;jpa</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/linking-复  习">linking 复习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ts基础">ts基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/实战2-mosh-gamehub">react practice:mosh gamehub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/浅入理解断点和调试器">浅入理解断点和调试器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/黑马点评">黑马点评(速通版)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/js基础">js基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-14-11-26学习双周记">11-14-11-26学习双周记</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">RocketMQ学习</h1><div class="container_mt6G margin-vert--md"><time datetime="2025-05-24T00:00:00.000Z">May 24, 2025</time> · <!-- -->19 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>mq: 异步，解耦，削峰填谷</p>
<p>传统项目架构下，对网络波动没有耐受性</p>
<p>mq多用于分布式系统间进行通信</p>
<p>请求方/响应方 <code>-&gt;</code> 生产者/消费者</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="优劣">优劣<a class="hash-link" aria-label="Direct link to 优劣" title="Direct link to 优劣" href="/blog/RocketMQ#优劣">​</a></h3>
<p>优势：异步，解耦，削峰填谷</p>
<ul>
<li>解耦: 消费方存活与否不影响生产方</li>
<li>异步: 提速</li>
<li>削峰填谷（作为一个buffer/cache）, 提升系统稳定性，应对突发性高并发冲击</li>
</ul>
<p>例子-电子商务下单：</p>
<p>生产者: 订单系统 <code>-&gt;</code> MQ <code>-&gt;</code> 库存系统、支付系统、物流系统、大数据系统(用户数据收集)（复制与多分发）</p>
<p>生产者发完消息，可以继续下一步业务逻辑</p>
<p>订单系统不需要新增业务代码，达成解耦</p>
<p>同时，订单系统可以发MQ消息之后就返回。准确地说，MQ消息 + 订单入库(校验等)</p>
<p>劣势：</p>
<ul>
<li>可用性降低: MQ宕机就寄，需要保证MQ的高可用</li>
<li>系统复杂度提高：<strong>消息丢失? 消息保序？重复消费？</strong></li>
<li>一致性问题：多消费，部分成功，部分失败？下游失败怎么办？</li>
</ul>
<p>市面主流MQ产品：</p>
<ul>
<li>ActiveMQ: 万级吞吐，主从架构，ms延迟，现在不怎么用</li>
<li>RabbitMQ: erlang，us处理，万级吞吐，主从架构，较难维护</li>
<li>RocketMQ: java，十万级吞吐，ms级，分布式</li>
<li>kafka: scala， 十万级，ms级，分布式，功能比较少</li>
</ul>
<p>rocketmq: 17年双十一，TPS 5600w</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="架构">架构<a class="hash-link" aria-label="Direct link to 架构" title="Direct link to 架构" href="/blog/RocketMQ#架构">​</a></h3>
<p>生产者集群 Producer</p>
<p>消息服务器集群 Broker 接受消息，提供消息，消息持久化，过滤消息，高可用</p>
<p>消费者 Consumer</p>
<p>命名服务器集群 NameServer Cluster 存储元数据**（Broker IPs）**</p>
<p>producer，broker，consumer向nameserver注册，nameserver用心跳确认其他组件的存活</p>
<p><img decoding="async" loading="lazy" alt="image-20250524133745882" src="/assets/images/image-20250524133745882-2079dd6b627ccbcc592dcdba316130f8.png" width="1723" height="844" class="img_ev3q"></p>
<p>支持拉推两种模式，Consumer可以主动拉取，也可以用监听器模式</p>
<p>能推肯定是推省资源，免去轮询等</p>
<p>消息</p>
<ul>
<li>Message</li>
<li>Topic 一级标题</li>
<li>Tag 二级标题</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础流程">基础流程:<a class="hash-link" aria-label="Direct link to 基础流程:" title="Direct link to 基础流程:" href="/blog/RocketMQ#基础流程">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="producer">Producer：<a class="hash-link" aria-label="Direct link to Producer：" title="Direct link to Producer：" href="/blog/RocketMQ#producer">​</a></h4>
<p>生产者创建 - 设置nameserver - 生产者启动 - 创建消息（指定topic，tag，内容）- 发送（获取结果）- 关闭生产者</p>
<p>发送结果是什么？主要是记录消息元数据例如消息ID的一个结构体，和<code>Future</code>那种设计不一样</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="consumer">Consumer<a class="hash-link" aria-label="Direct link to Consumer" title="Direct link to Consumer" href="/blog/RocketMQ#consumer">​</a></h4>
<p>两类： <code>DefaultLitePullConsumer</code> 和 <code>DefaultMQPushConsumer</code></p>
<p>对应拉取(额外线程轮询)和推送(长连接)模式</p>
<p>消费者创建 - 设置nameserver - 设置监听(订阅)主题 - 注册监听器(消息处理函数类，返回消息处理结果) - 消费者启动</p>
<p>设置监听的api rocketmq是这样设计的</p>
<p><code>subscribe(&lt;topic&gt;, &lt;subExpression&gt;)</code></p>
<p>这个<code>subExpression</code>通过通配符等支持，让api 表达力变强不少</p>
<ul>
<li>支持tag过滤</li>
<li>支持sql过滤，在给<strong>消息追加属性</strong>的时候很有用<!-- -->
<ul>
<li><code>&gt;&lt;=</code> <code>BETWEEN</code> <code>IN</code> <code>IS NULL</code> <code>AND</code> <code>OR</code> <code>NOT</code></li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="onetomany-多消费">OneToMany 多消费<a class="hash-link" aria-label="Direct link to OneToMany 多消费" title="Direct link to OneToMany 多消费" href="/blog/RocketMQ#onetomany-多消费">​</a></h3>
<p>多个消费者监听一个topic的默认行为：</p>
<ul>
<li><strong>一条消息只会被消费一次</strong></li>
<li><strong>多个消费者之间有默认的负载均衡</strong></li>
</ul>
<p>如果想要多个消费者都消费这条消息呢？例如上面的电商情况</p>
<ul>
<li><strong>消费者组</strong> consumer group概念</li>
</ul>
<p>相同组的消费者，有负载均衡，单消费</p>
<ul>
<li><strong>也可以修改消息模式</strong>，将默认的消费模式改掉<!-- -->
<ul>
<li><code>CLUSTERING -&gt; BROADCASTING</code></li>
</ul>
</li>
</ul>
<p>单条消息会被<strong>复制数份</strong>，发送到每一个消费者组</p>
<ul>
<li>“复制”是指HTTP传数次，不是存储文件复制</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="消息类型">消息类型<a class="hash-link" aria-label="Direct link to 消息类型" title="Direct link to 消息类型" href="/blog/RocketMQ#消息类型">​</a></h3>
<p>同步：即时性强、必须有回执，例如短信通知</p>
<p>异步：即时性弱，也需要有回执，如订单信息</p>
<p>单向：不需要有回执，如写日志</p>
<ul>
<li>eg 分布式日志系统，所有Producer只管发</li>
</ul>
<p>直接<code>send(msg)</code> 是发同步消息</p>
<p><code>send(msg, callback)</code>是异步，等有结果再做处理</p>
<p><code>sendOneway</code>是单向</p>
<p>延时消息</p>
<p>早期: v4.x</p>
<p>只支持不同的delayLevel，固定的1s 1m这样的时间</p>
<ul>
<li>固定级别的延时消息实现简单，<strong>为每个延时类别创建单独的队列来管理， 采用内部特定主题（SCHEDULE_TOPIC_XXXX）和队列来实现延时功能</strong></li>
<li>可能是简单的分队列定时扫描算法</li>
</ul>
<p>后来：v5+</p>
<p>任意毫秒级时间戳延时，需要高效时间轮算法, 每条消息单独计时器跟踪</p>
<ul>
<li>
<p><strong>时间轮算法</strong>：小时轮，分钟轮，秒钟轮。将消息“填入时间轮槽”（即每个槽是一个<code>TaskList</code>）</p>
<ul>
<li><strong>层级时间轮</strong>，如 果一个任务是1分30s, 会先被放入1分的分钟轮，处理到时，减去1分，降级放入秒钟轮</li>
</ul>
</li>
<li>
<p>将时间线分割成多个区间，不同区间采用不同精度的扫描策略, 近期消息采用高精度扫描，远期消息采用低频率扫描</p>
</li>
<li>
<p>高效索引，分布式时钟对齐.....</p>
</li>
</ul>
<p>批量消息</p>
<p>底层支持直接传 <code>Collection&lt;Message&gt;</code></p>
<p>注意:</p>
<ul>
<li>相同的topic</li>
<li>不能是延时消息</li>
<li>总长度不超过<strong>4M</strong> (IBM默认最大消息长度设置，可以通过改环境变量修改，但4M算是一个实验值)</li>
<li>相同的waitStoreMsgOK</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-ioc集成">Spring IoC集成<a class="hash-link" aria-label="Direct link to Spring IoC集成" title="Direct link to Spring IoC集成" href="/blog/RocketMQ#spring-ioc集成">​</a></h3>
<p>直接在配置文件中指定name-server， producer group之类</p>
<p>类似Kafka/Redis, <code>RocketMQTemplate</code> 链接管理</p>
<p><code>convertAndSend</code> 方法</p>
<ul>
<li><code>convert</code>? Spring的Template send发送的是抽象的message，只有一个<code>byte[]</code>的<code>payload</code>，convert就是在处理上层java类与下层不同的template需要的通信格式的转换</li>
</ul>
<p>消费者也是和Kafka类似的</p>
<p><code>@Service</code>的类 <code>implements RocketMQListener&lt;MessageType&gt;</code> 就行,  <code>@RocketMQListener(topic=, tag=,consumerGroup=, selctorExpression=, selectorType=, messageModal=)</code></p>
<p>然后这个类就作为监听类了，调用的方法就是重载方法<code>onMessage(T t)</code></p>
<p>(这里Spring顺带还做了个返回值处理，只要没抛异常都是消费成功，抛异常消费失败回传)</p>
<p>其他的机制也整合了，例如同步异步单向延时批量之类对应<code>syncSend, asyncSend, ...</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="消息保序">消息保序<a class="hash-link" aria-label="Direct link to 消息保序" title="Direct link to 消息保序" href="/blog/RocketMQ#消息保序">​</a></h3>
<p>消息错乱的原因，队列内有序，队列外无序</p>
<p>要做多队列的负载均衡，就不能无开销严格保证顺序</p>
<p>一连串的消息需要作为一个不能被拆分到多个负载均衡队列的整体</p>
<ul>
<li>一个实现<code>messagequeueSelector</code>的实体类，例如id hash + 取模</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="事务消息无丢">事务消息（无丢）<a class="hash-link" aria-label="Direct link to 事务消息（无丢）" title="Direct link to 事务消息（无丢）" href="/blog/RocketMQ#事务消息无丢">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20250524165007633" src="/assets/images/image-20250524165007633-44d4c669017b42796867ad8a572764af.png" width="1621" height="776" class="img_ev3q"></p>
<p>本地事务：如入本地数据库</p>
<p>事务状态：</p>
<ul>
<li>提交状态，允许进入队列</li>
<li>回滚状态，不允许进入队列，当作没发生过</li>
<li>中间状态，未对half做二次确认</li>
</ul>
<p>代码实现</p>
<p><code>TransactionMQProducer</code></p>
<p><code>setTransactionListener</code>: 正常事务过程, 补偿过程</p>
<ul>
<li><code>executeLocalTransaction</code>: 正常事务，入库等，根据本地事务状态返回消息状态</li>
<li><code>checkLocalTransaction</code>：在正常事务超时等情况（实际上是正常事务函数返回了<code>UNKNOW</code>状态）时被调用，本地再次查询事务状态的函数</li>
</ul>
<p>事务补偿还是<code>UNKNOW</code>?写个log或者其他人工介入方式</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="集群搭建">集群搭建<a class="hash-link" aria-label="Direct link to 集群搭建" title="Direct link to 集群搭建" href="/blog/RocketMQ#集群搭建">​</a></h3>
<p>多broker：</p>
<p>多master多slave架构</p>
<p>master slave同步消息的方式可以是同步（生产者阻塞请求）也可以是异步（不阻塞）</p>
<p>常见：一主三从</p>
<ul>
<li>只有brokerId为0的是主节点</li>
<li>brokerName是集群名</li>
</ul>
<p>每一个broker会向<strong>所有的</strong>nameserver注册</p>
<p><img decoding="async" loading="lazy" alt="image-20250525132947941" src="/assets/images/image-20250525132947941-9a53ed1bdc0ac1caef4e61df5db97513.png" width="1576" height="521" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="高级特性">高级特性<a class="hash-link" aria-label="Direct link to 高级特性" title="Direct link to 高级特性" href="/blog/RocketMQ#高级特性">​</a></h3>
<p>消息存储</p>
<p>一次完整的消费需要两个ACK</p>
<p>即Producer向Broker发消息，Broker返回ACK</p>
<p>Broker向Consumer发消息，Consumer返回ACK</p>
<p>但如果中间Broker宕机，就会出现重复消费</p>
<p>例如，在Broker返回ACK之前宕机，Producer就可能再发一次消息；在Consumer返回ACK之前宕机，Broker就可能再发一次消息。</p>
<p>解决方案是，<strong>在Broker返回Producer ACK之前，先将消息存储到磁盘上持久化（数据库中），在接收到Consumer ACK之后，Broker删除这一条消息</strong></p>
<ul>
<li>如果在返回Producer ACK之前宕机，能从磁盘读消息避免重发</li>
<li>如果在Consumer返回ACK之前宕机，也是同理</li>
</ul>
<p>消息的存储介质</p>
<p>使用<strong>数据库</strong>：</p>
<ul>
<li>ActiveMQ：缺点是<strong>数据库瓶颈成为MQ瓶颈</strong></li>
</ul>
<p><strong>文件系统</strong>：</p>
<ul>
<li><strong>RocketMQ/Kafka/RabbitMQ：采用消息刷盘机制，进行数据存储</strong></li>
</ul>
<p>zero copy：mmap，java MappedByteBuffer</p>
<p>预留了一块空间进行顺序读写，默认1G commitlog</p>
<p>本质上，利用<code>mmap</code>,<code>sendfile</code>等系统api减少了<strong>内核空间与用户空间</strong>的数据交换次数  。<code>mmap</code>处理<code>文件-内存</code>在内核态直通，<code>sendfile</code>处理<code>内存-网络</code>在内核态直通。省去的是内核态内存页到用户态内存页的拷贝，zero copy的用户程序都是没有持有数据copy的buffer的。</p>
<p><img decoding="async" loading="lazy" alt="image-20250525135808051" src="/assets/images/image-20250525135808051-fd6ae5ce6cf4bf10575448fffe1f8747.png" width="1557" height="859" class="img_ev3q"></p>
<p>刷盘机制</p>
<p>同步刷盘：先<strong>入盘</strong>再返回ACK</p>
<ul>
<li>可靠性高，性能低</li>
</ul>
<p>异步刷盘：<strong>不挂起Producer线程</strong>，也先不写硬盘，<strong>将消息保留到内存之后就向Producer返回ACK</strong>，而是<strong>积累到一定batch的消息，再批量刷盘</strong></p>
<p>高可用：</p>
<ul>
<li>nameserver:<!-- -->
<ul>
<li>无状态+全服务器注册</li>
</ul>
</li>
<li>消息服务器<!-- -->
<ul>
<li>主从架构，2主2从</li>
</ul>
</li>
<li>消息生产<!-- -->
<ul>
<li>生产者将相同的topic绑定到多个group组，保障master挂掉之后，其他master仍然可以正常接受消息</li>
</ul>
</li>
<li>消息消费：RocketMQ会根据master压力确认是否由master承担数据读取功能，master繁忙的时候，自动切换slave做承担数据读取的工作（<strong>读写分离</strong>）</li>
</ul>
<p>负载均衡</p>
<p>Producer负载均衡</p>
<ul>
<li>RocketMQ内部实现了不同broker集群中对同一topic对应消费队列的负载均衡</li>
</ul>
<p>Consumer负载均衡</p>
<ul>
<li>平均分配(AABBCC)不好，循环平均分配(ABCABC)好<!-- -->
<ul>
<li>原因，broker部分挂掉时，生产者的流量会被均分到剩下的broker上，如果平均分配，则有些对应挂掉的broker的consumer就不干活了，其他consumer压力会变大；循环平均分配则是将所有的consumer都分到剩下的broker上，避免了单个consumer压力过大</li>
</ul>
</li>
</ul>
<p>消息重试：</p>
<p>顺序消息：</p>
<ul>
<li>当消费消息失败后，RocketMQ会以1s为间隔进行自动重试。</li>
<li>应用会出现消息消费被阻塞的情况，因此需要对顺序消息的消费情况进行监控（监控offset等），避免阻塞</li>
</ul>
<p>无序消息：</p>
<ul>
<li>
<p>仅适用于负载均衡（集群）模型下的消息消费，不适用于广播模式</p>
</li>
<li>
<p>MQ设定了合理的消息重试间隔时长，有一个指数的backoff</p>
</li>
<li>
<p>当重试到达指定次数（默认16次）后，MQ将无法被正常消费的消息称为死信消息。<strong>死信消息不会被直接抛弃，而是会被发送到一个死信队列中</strong>，供后续处理</p>
</li>
</ul>
<p>死信消息不会再被重复消费，有效期为3天，过时后会被删除</p>
<p>死信处理，业务逻辑处理，或者人工介入</p>
<p>RocketMQ不可能完全避免重复消费，还是存在可能出现重复消费的情况：</p>
<ul>
<li>生产者发送重复消息，例如，网络闪断没收到ACK，生产者宕机</li>
<li>Broker和消费者之间网络闪断，消费者/broker重启</li>
<li>客户端扩缩容</li>
<li>......</li>
</ul>
<p><strong>所以不能完全依赖RocketMQ的幂等性，还是要在业务逻辑上做幂等性处理</strong></p>
<ul>
<li>使用业务id作为消息key</li>
<li>在消费消息时，客户端对key做判定，未使用放行，使用过抛弃</li>
<li>注意：messageId由RocketMQ生成，不具有唯一性，不能做幂等判定条件</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="kafka-vs-rocketmq">Kafka VS RocketMQ<a class="hash-link" aria-label="Direct link to Kafka VS RocketMQ" title="Direct link to Kafka VS RocketMQ" href="/blog/RocketMQ#kafka-vs-rocketmq">​</a></h3>
<p><strong>Kafka:</strong></p>
<ul>
<li><strong>专注简单与吞吐量</strong>: &quot;Do one thing and do it well&quot;的Unix哲学，专注于高吞吐的消息传递</li>
<li><strong>不可变数据流</strong>: 将消息视为不可变的数据流， 适合事件溯源和流处理</li>
<li><strong>客户端复杂性</strong>: 将复杂性推向客户端，保持服务端简单高效</li>
</ul>
<p><strong>RocketMQ:</strong></p>
<ul>
<li><strong>丰富的消息功能</strong>: 目标是作为全功能的企业级消息系统</li>
<li><strong>服务端智能</strong>: 在服务端实现更多功能，减轻客户端负担</li>
<li><strong>电商场景驱动</strong>: 由阿里巴巴电商业务需求驱动设计，面向复杂业务场景</li>
</ul>
<p>那么古尔丹，高吞吐量的代价是什么呢？</p>
<ul>
<li>偏移量指针的设计只能顺序前进，无法原生支持延迟时间，通过时间戳索引查找偏移量、专用延时主题、定时扫描来达到延时队列</li>
<li>必须顺序处理消息，无法灵活跳过（异常消息）和回退（重放）</li>
<li>消息路由和分布式一致性绑定，路由灵活性受限</li>
<li>不支持消息优先级队列，因为都得按照offset指针顺序处理.....</li>
<li>无法设置可见性超时等，都需要上层应用做</li>
<li>消费失败的幂等性保证处理复杂，偏移量需要分布式维护增加网络开销.....</li>
</ul>
<table><thead><tr><th>特性</th><th>Kafka</th><th>RocketMQ</th></tr></thead><tbody><tr><td>定时/延时消息</td><td>需外部实现</td><td>原生支持 <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></td></tr><tr><td>消息回溯</td><td>支持(通过偏移量)</td><td>支持(更灵活) <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></td></tr><tr><td>消息过滤</td><td>有限支持</td><td>服务器端支持SQL92表达式过滤 <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></td></tr><tr><td>事务消息</td><td>有限支持</td><td>完整支持 <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></td></tr><tr><td>死信队列</td><td>不支持</td><td>支持</td></tr><tr><td>消息优先级</td><td>不支持</td><td>不直接支持，但可通过设计实现</td></tr><tr><td>多租户隔离</td><td>有限支持</td><td>更好支持</td></tr><tr><td>消息轨迹追踪</td><td>需外部工具</td><td>原生支持 <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></td></tr></tbody></table>
<p>核心设计的哪些不同带来了这样的差异？</p>
<p>存储模型</p>
<p><strong>Kafka:</strong></p>
<ul>
<li><strong>分散的文件存储</strong>: 每个主题的每个分区对应一个物理文件，消息按照写入顺序存储 <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></li>
<li><strong>顺序追加写入</strong>: 使用顺序追加的方式写入文件，不允许修改已写入的数据</li>
<li><strong>偏移量指针</strong>: 消费者通过偏移量指针确定读取位置，不复制消息</li>
</ul>
<p><strong>RocketMQ:</strong></p>
<ul>
<li><strong>统一的文件存储</strong>: 所有主题的消息存储在同一组物理文件中 <a href="https://alibaba-cloud.medium.com/kafka-vs-rocketmq-multiple-topic-stress-test-results-d27b8cbb360f" target="_blank" rel="noopener noreferrer">3</a></li>
<li><strong>逻辑分区</strong>: 主题和队列仅是逻辑概念，不与物理文件一一对应</li>
<li><strong>消息索引</strong>: 维护更复杂的索引结构，支持按多种方式查询消息</li>
</ul>
<p>消息投递模型</p>
<p><strong>Kafka:</strong></p>
<ul>
<li><strong>基于分区的消费模型</strong>: 消费者组内的消费者分配分区，消费者只能按顺序消费分区中的消息 <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></li>
<li><strong>仅支持拉模式</strong>: 消费者主动从Broker拉取消息</li>
</ul>
<p><strong>RocketMQ:</strong></p>
<ul>
<li><strong>更灵活的消费模型</strong>: 支持更多的消费模式，包括集群消费和广播消费 <a href="https://rocketmq.apache.org/docs/" target="_blank" rel="noopener noreferrer">1</a></li>
<li><strong>推拉结合</strong>: 同时支持推模式和拉模式，提供更灵活的消息投递方式</li>
<li><strong>消息过滤</strong>: 支持在服务器端进行消息过滤，减少不必要的网络传输</li>
</ul>
<p>消息处理机制</p>
<p><strong>Kafka:</strong> 消息就是字节数组</p>
<p>**RocketMQ: ** 消息包含更多元数据和属性</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mq">mq</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/Milvus"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">稀疏神经嵌入</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/AI limu"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">李沐dl笔记</div></a></nav><div>Loading Comments...</div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#优劣">优劣</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#架构">架构</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#基础流程">基础流程:</a><ul><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#producer">Producer：</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#consumer">Consumer</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#onetomany-多消费">OneToMany 多消费</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#消息类型">消息类型</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#spring-ioc集成">Spring IoC集成</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#消息保序">消息保序</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#事务消息无丢">事务消息（无丢）</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#集群搭建">集群搭建</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#高级特性">高级特性</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/RocketMQ#kafka-vs-rocketmq">Kafka VS RocketMQ</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">notes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/RL">课程笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/personal-essays">Personal Essays</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Ayanami, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>