<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">12 posts tagged with &quot;ai&quot; | Ayanami&#x27;s Cave</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ayanami1314.github.io/blog/tags/ai"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="12 posts tagged with &quot;ai&quot; | Ayanami&#x27;s Cave"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/ayanami.jpg"><link data-rh="true" rel="canonical" href="https://ayanami1314.github.io/blog/tags/ai"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog/tags/ai" hreflang="en"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog/tags/ai" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ayanami&#39;s Cave Atom Feed">



<link rel="alternate" type="application/rss+xml" href="/personal-essays/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-essays/atom.xml" title="Ayanami&#39;s Cave Atom Feed">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.00dd3480.css">
<script src="/assets/js/runtime~main.18707836.js" defer="defer"></script>
<script src="/assets/js/main.103dbd8f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ayanami&#x27;s Cave</b></a><a class="navbar__item navbar__link" href="/docs/Chcore源码阅读">课程笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">技术博客</a><a class="navbar__item navbar__link" href="/personal-essays">个人随笔</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All our posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/code-search&amp;code-embedding">从现代Coding Agent视角回看代码搜索与嵌入</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/llm for code paper notes">paper-reading, code&amp;rl方向</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/speculative-decode-overview">投机解码简述</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Paper reading Context Pruning and beyond hard pruning">Paper reading - Context Pruning and beyond hard pruning</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/结构化输出">结构化输出与AI工具与Agent</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/context-engineering">context-engineering</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/从微调reranker到搜推">从微调reranker到搜推工程实践</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/llm-tech-report">部分llm技术报告的阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Ask in Any Modality A Comprehensive Survey on Multimodal Retrieval-Augmented Generation">Paper reading-Ask in Any Modality A Comprehensive Survey on Multimodal Retrieval-Augmented Generation</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/精读 AAAI 2025 Fit and Prune Fast and Training-free Visual Token Pruning for Multi-modal Large Language Models">Paper reading - Fit and Prune Fast and Training-free Visual Token Pruning for Multi-modal Large Language Models</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/精读：Eagle Exploring The Design Space for Multi- modal LLMs with Mixture of Encoders">Paper reading-Eagle Exploring The Design Space for Multi- modal LLMs with Mixture of Encoders</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/RAG的一些思考和细节">RAG的一些思考与细节</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/精读  Interleaved Scene Graph for Interleaved Text-and-Image Generation Assessment">Paper reading - Interleaved Scene Graph for Interleaved Text-and-Image Generation Assessment</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ColBERT">ColBERT-后期交互方法</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/2025/05/26/技术博客阅读">美团技术博客阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Milvus">稀疏神经嵌入</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/RocketMQ">RocketMQ学习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs186-database-WIP">ucb cs186 课程笔记(更新中)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os-虚拟化">NJU操作系统(jyy OS)课程笔记-虚拟化部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/local-llm">来本地部署大模型!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ostep-chapter42-44">ostep阅读笔记：单机fs的崩溃一致性(chapter42-44)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/系统架构设计笔记">system-design-interview笔记</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/AI limu">李沐dl笔记</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/JUC">JUC</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144 labs">cs144 labs(Winter 2024)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os：并发">NJU操作系统(jyy OS)课程笔记-并发部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/nginx">nginx基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144/cs144 lec notes">CS144 Lecture Notes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/django-mosh">Django_mosh</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/splay-tree">splay tree</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/xv6book-notes">xv6book Notes(C1-4)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Go-Gin学习">Go,Gin学习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godis源码阅读">godis源码阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hibernate-jpa">hibernate&amp;jpa</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/linking-复习">linking 复习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ts基础">ts基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/实战2-mosh-gamehub">react practice:mosh gamehub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/浅入理解断点和调试器">浅入理解断点和调试器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/黑马点评">黑马点评(速通版)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/js基础">js基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-14-11-26学习双周记">11-14-11-26学习双周记</a></li></ul></nav></aside><main class="col col--7"><header class="margin-bottom--xl"><h1>12 posts tagged with &quot;ai&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/code-search&amp;code-embedding">从现代Coding Agent视角回看代码搜索与嵌入</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-11-23T00:00:00.000Z">November 23, 2025</time> · <!-- -->24 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><p>应该如何说起代码搜索呢，先说代码搜索的几个小的子流派吧，这方面可能略微和其他领域不同</p>
<p>代码的检索我认为是可以分解成以下几种的：</p>
<ul>
<li>搜索引擎式</li>
<li>grep传统搜</li>
<li>向量embedding搜</li>
<li>码仓index</li>
</ul>
<p>每一种都是什么意思呢，举个例子</p>
<p>搜索引擎式是复用传统的搜索引擎，如elasticsearch, meilisearch等；也有一些变体，比如github的代码搜索，主要是弥补传统搜索引擎在代码搜索的不足</p>
<p>grep如其名字，基于linux grep或者riggrep，在agent内使用最广</p>
<p>向量embedding搜则有多个子任务，如NL2Code, Code2Code, Code2NL等，每个还有一些细微差别，这个很有意思，待会讲；</p>
<p>码仓index呢，则大致有两种：一种基于传统的AST分析，希望构建整个码仓的符号树或者CKG来辅助搜，另一种则寄希望于新型的生成式大模型，希望让LLM读了仓库之后能生成”索引“，典型的做法比如deepwiki。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="搜索引擎式">搜索引擎式<a class="hash-link" aria-label="Direct link to 搜索引擎式" title="Direct link to 搜索引擎式" href="/blog/tags/ai#搜索引擎式">​</a></h3>
<p>传统的搜索引擎其实在代码搜上有很多问题，参见</p>
<p><a href="https://github.blog/engineering/architecture-optimization/the-technology-behind-githubs-new-code-search/" target="_blank" rel="noopener noreferrer">https://github.blog/engineering/architecture-optimization/the-technology-behind-githubs-new-code-search/</a></p>
<p>最严重的问题甚至不是想象的NL2Code的问题，而是传统搜索引擎的部分优化不够、部分优化又不足，总之不与代码适配</p>
<ol>
<li>索引的开销, 恐怖的内存消耗</li>
</ol>
<blockquote>
<p>当我们第一次部署 Elasticsearch 时，需要几个月的时间才能索引 GitHub 上的所有代码（当时大约有 800 万个存储库）。今天，这个数字已经超过 2 亿，而且代码不是静态的：它不断变化，这对搜索引擎来说是相当具有挑战性的。</p>
</blockquote>
<ol start="2">
<li>可不可以不要索引？对大规模库高并发是不可能的：</li>
</ol>
<blockquote>
<p>首先，让我们探讨一下解决问题的蛮力方法。我们经常收到这样的问题：“你<strong>为什么不直接使用 grep</strong>？为了回答这个问题，让我们使用 <a href="https://github.com/BurntSushi/ripgrep" target="_blank" rel="noopener noreferrer">ripgrep</a> 对这 115 TB 的内容进行一些数学计算。在具有八核 Intel CPU 的机器上，ripgrep 可以在 2.769 秒内对缓存在内存中的 13 GB 文件运行<a href="https://github.com/BurntSushi/ripgrep#quick-examples-comparing-tools" target="_blank" rel="noopener noreferrer">详尽的正则表达式查询 </a>，即大约 0.6 GB/秒/内核。
我们很快就会发现，这对于我们拥有的大量数据来说确实不起作用。代码搜索在 64 个核心、32 个机器集群上运行。即使我们设法将 115 TB 的代码放入内存中并假设我们可以完美并行化工作，我们也会在 96 秒内使 2,048 个 CPU 内核饱和，以处理单个查询！只能运行一个查询。其他人都必须排队。结果是<strong>每秒 0.01 次查询</strong></p>
</blockquote>
<ol start="3">
<li>
<p>分词器不需要了：搜索引擎依赖分词来减少构建倒排的成本和作为基础搜索单元，但就和Tokenizer的引入一样，这个开销的减少从来不是免费的，接下来的问题就是：代码如何分词？另一个问题是：停用词全部没用了！无论是<code>!@?/#$:{}()[]</code>还是什么别的乱七八糟的符号，都是编程语言的最爱, 这使得传统的分词系统更加雪上加霜</p>
<ol>
<li>如果提前跑一遍AST分析呢？我们的CPU要算爆炸了<code>:)</code>, 并且你如何统一没有LSP小众语言，不同的语法版本（<code>py2-&gt;3</code>）... 工程量立刻爆炸了</li>
<li>能不能在char level倒排？太爆炸了索引，所以github是使用<strong>3-char</strong>的倒排的 <code>argument -&gt; arg、rgu、gum、...</code></li>
<li>代码里面还有注释，注释还有多语言，甚至单个仓库都很常见中英两种语言的注释...看起来朴素的分词器比如jieba要全面阵亡了...</li>
</ol>
</li>
<li>
<p>基于git的增量更新：增量更新本身 可以用merkel tree，这也是cursor在用的技术，但结合git版本？你发现事情变得复杂起来了，这是纯工程的复杂性。一次git commit涉及到十几个文件的几行变化，需要触发至少十几个chunk的embedding更新？如何处理多分支呢？我的每一个存储代码块是否还得加一个tag标识它的branch，然后在搜索引擎里面支持完备地按tag过滤，省的不同branch的代码在同一个搜索引擎中返回？（然后发现branch name作为tag简直太烂了，它是一个完全动态的无限的集合）</p>
</li>
</ol>
<p>鉴于恐怖的存储代码数量，github采用的搜索引擎相当简陋，甚至是弱化版本的完全匹配：3-grams索引</p>
<blockquote>
<p>对于代码搜索，我们需要一种特殊类型的倒排索引，称为 ngram 索引，它对于查找内容的子字符串很有用。<a href="https://en.wikipedia.org/wiki/N-gram" target="_blank" rel="noopener noreferrer">ngram</a> 是长度为 <em>n</em> 的字符序列。例如，如果我们选择 n=3，则构成内容“limits”的 ngram 是 <code>lim</code>、<code>imi</code>、<code>mit</code>、<code>its</code>。<strong>(二元组的选择性不够，四元组占用了太多空间)</strong></p>
</blockquote>
<p>这个索引显然是非常大无法放入内存的，所以github采用了一些传统数据库里面的懒加载和流式优化技术，使得可以仅读取一个小子集完成搜索</p>
<p>而关于构建索引本身，github还有很多特殊设计，但这其实属于system/后端任务了，不细讲：</p>
<ul>
<li>
<p>用Git blob object ID来分片，kafka分区</p>
</li>
<li>
<p>用path, branch, repository + 元信息(owner, visibility, etc.) 来构建增量索引key</p>
</li>
<li>
<p>commit-level的一致性</p>
</li>
<li>
<p>Github相当多的blob是相同的，使用增量编码很有吸引力, 这里用到了概率上的近似数据结构和一些分布式图（近似）算法</p>
<blockquote>
<p>To determine the optimal ingest order, we need a way to tell how similar one repository is to another (similar in terms of their content), so <strong>we invented a new probabilistic data structure to do this in the same class of data structures as <a href="https://en.wikipedia.org/wiki/MinHash" target="_blank" rel="noopener noreferrer">MinHash</a> and <a href="https://en.wikipedia.org/wiki/HyperLogLog" target="_blank" rel="noopener noreferrer">HyperLogLog</a></strong>. This data structure, which we call a geometric filter, allows computing set similarity and the symmetric difference between sets with logarithmic space. <strong>In this case, the sets we’re comparing are the contents of each repository as represented by (path, blob_sha) tuples. Armed with that knowledge, we can construct a graph where the vertices are repositories and edges are weighted with this similarity metric. Calculating a minimum spanning tree of this graph (with similarity as cost) and then doing a level order traversal of the tree gives us an ingest order where we can make best use of delta encoding. Really though, this graph is enormous (millions of nodes, trillions of edges), so our MST algorithm computes an approximation that only takes a few minutes to calculate and provides 90% of the delta compression benefits we’re going for.</strong></p>
</blockquote>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="grep">Grep<a class="hash-link" aria-label="Direct link to Grep" title="Direct link to Grep" href="/blog/tags/ai#grep">​</a></h3>
<p>grep属实是在Coding Agent时代焕发了第二春，由于其系统级别自带+完美匹配Bash工具和Unix文本管道的特性，在现代的LLM之中都大量训练了如何写出各种米奇妙妙grep的数据</p>
<p>claude code这种经过更多优化的grep会更过分一点，它会有几个细节优化：</p>
<ul>
<li>使用更现代的<code>rg</code>(riggrep)代替原始的grep</li>
<li>逆向cc源码可知，它的grep有<strong>七八个参数</strong>，分别对应grep里面的不同参数比如 <code>-A</code> <code>-E</code> <code>-C</code> , 除了一些呈现格式（比如带不带行号和文件名）之类的差别，主要的几个参数就是在<strong>匹配行前保留多少行、匹配行后保留多少行、和上下保留多少行</strong>
<ul>
<li>如果读者熟悉coding agent的工作的话，其实早在swe-agent就已经探究过这个context window开多少的问题，原始论文的实验结论是50行</li>
</ul>
</li>
</ul>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ tldr grep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grep</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Find patterns in files using regular expressions.More information: https://www.gnu.org/software/grep/manual/grep.html.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Search for a pattern within a file:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   grep &quot;{{search_pattern}}&quot; {{path/to/file}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Search for an exact string (disables regular expressions):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   grep {{[-F|--fixed-strings]}} &quot;{{exact_string}}&quot; {{path/to/file}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Search for a pattern in all files recursively in a directory, showing line numbers of matches, ignoring binary files:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   grep {{[-r|--recursive]}} {{[-n|--line-number]}} --binary-files {{without-match}} &quot;{{search_pattern}}&quot; {{path/to/directory}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Use extended regular expressions (supports ?, +, {}, (), and |), in case-insensitive mode:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   grep {{[-E|--extended-regexp]}} {{[-i|--ignore-case]}} &quot;{{search_pattern}}&quot; {{path/to/file}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Print 3 lines of [C]ontext around, [B]efore or [A]fter each match:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   grep --{{context|before-context|after-context}} 3 &quot;{{search_pattern}}&quot; {{path/to/file}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Print file name and line number for each match with color output:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   grep {{[-H|--with-filename]}} {{[-n|--line-number]}} --color=always &quot;{{search_pattern}}&quot; {{path/to/file}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Search for lines matching a pattern, printing only the matched text:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   grep {{[-o|--only-matching]}} &quot;{{search_pattern}}&quot; {{path/to/file}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> - Search stdin for lines that do not match a pattern:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   cat {{path/to/file}} | grep {{[-v|--invert-match]}} &quot;{{search_pattern}}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>另一个有趣的事情是，现在的coding agent不约而同地使用了grep而不是rag作为其系统原生的工具，我觉得理由也是非常清晰的：</p>
<ol>
<li>grep的输出是标准可预测的，而rag的输出依赖于 <code>{基础模型， 分块方法，召回topk，重排模型}</code> 等多个配置参数，一个标准的输出带来的好处是 <strong>可强化学习</strong>， 如果对一个 code llm + rag 的系统做RL，最后的搜索策略一定会是拟合到和rag的embedding模型和具体策略相匹配，丧失了可迁移性</li>
<li>除此之外的好处也有很多，比如RL环境不需要embedding的额外开销（存储和计算上甚至编码成本上），整体轨迹可解释，精确匹配效果好，速度快...</li>
</ol>
<p>rag的index开销其实相当大，学界不在乎这个，为了提升精度每个token一个embedding的方法也有，但一个embedding是一个1024维的向量，光存储开销就是4KB，对于百万行级别的代码仓库，其chunk可能在数万，达到了GB级别的存储开销</p>
<p>而工业项目有百万码仓，在TB级别的存储上进行高效地索引和查询着实压力很大，可以参考 美团和milvus/lancedb的相关文章 ，索引优化也有相当多的新实践，但这是做DB的人考虑的（雾</p>
<p>但Grep就是万灵药吗？并非如此</p>
<p><strong>Grep提供了一个切面，能够让模型Agentic Search，根据搜索到的局部反馈调整搜索方法，从部分开始探索整个代码仓库——大部分需求的完成不需要对全仓的理解</strong></p>
<p>——吗？</p>
<p>一个Grep的bad case是<strong>高阶语义的需求</strong>：</p>
<ul>
<li>哪里导致了这个bug?</li>
<li>某个模块的核心逻辑是什么？</li>
<li>整体的代码结构？</li>
<li>...</li>
</ul>
<p>模型要么老实cat，要么就只能在log中见到它尝试“猜”你的变量名字，比如你问“...的实现”就会开始Grep <code>impl</code>，如果你把所有变量换成abcde，它立刻就GG了</p>
<p>比起失败的搜索浪费的上下文更糟地是浪费的交互轮数 —— 长达几百轮的agent轨迹是相当稀少的训练数据，如果再配合没那么好的历史压缩方法，或是没有精心设计的防止模型死循环的额外环境反馈，连续失败的grep会让agent的性能迅速地劣化</p>
<p>基于这方面的需求，在推理阶段Grep还是得配合别的工具，比如deepwiki，比如CKG（代码知识图谱，例如每个函数的caller和callee），</p>
<p>比如Code RAG</p>
<p>这方面也有一些新的探索，例如 <a href="https://cognition.ai/blog/swe-grep" target="_blank" rel="noopener noreferrer">https://cognition.ai/blog/swe-grep</a> 的RL并行工具调用（<strong>关键不在速度，关键在减少交互轮数！</strong>），比如在工程侧融合Grep和RAG如<a href="https://github.com/daimh/mgrep" target="_blank" rel="noopener noreferrer">https://github.com/daimh/mgrep</a> 和 <a href="https://github.com/zilliztech/claude-context" target="_blank" rel="noopener noreferrer">https://github.com/zilliztech/claude-context</a> ，以及我们将要发的一篇文章（自吹自擂一下，关注主包后续的工作谢谢喵）</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-embedding">code embedding<a class="hash-link" aria-label="Direct link to code embedding" title="Direct link to code embedding" href="/blog/tags/ai#code-embedding">​</a></h3>
<p>主包主包，code embedding和文本的embedding有什么区别呢？为什么要强调code?</p>
<p>非常好问题，爱来自AI4SE。我认为code其实和图像比较像，某种意义上<strong>算是一种特殊的模态</strong>，不完全是文本——code某种  意义上是“反语言常理”的，例如大部分语言的上下文有限，一句话很难和1000个字之前的某个东西形成强烈的联系，而这种长程交互在code之中非常常见——甚至有跨文件、跨模块、跨仓库的交互</p>
<p>而另一个很有趣的事情是，<strong>当我们在讲“某段代码的语义”的时候，这件事本身是模糊的</strong>，文本没有那么强的二义性，太阳就是太阳，月亮就是月亮，但一个递归斐波那契函数的语义到底是 “递归“ 还是 ”斐波那契“？这其实折射出了代码的某种特殊性，它同时具备<strong>字面义</strong> ”斐波那契“ 和<strong>运行义</strong> ”递归“（甚至”低效“、”算法“、“python”），而在一个代码仓库之中，代码还具备了<strong>上下游的属性</strong>：谁是我的caller，谁是我的callee?</p>
<p><strong>这件事情为什么重要呢，因为传统的embedding向量相似度产出的是一个标量，它只能衡量一个维度的相似性！</strong></p>
<ul>
<li>当你在说“查找与function A相关的代码”时，你想要的到底是什么？<!-- -->
<ul>
<li>function A的字面义相关的代码？</li>
<li>function A的运行效果相关的代码？</li>
<li>function A的caller/callee?</li>
<li>...</li>
</ul>
</li>
</ul>
<p>然后你就发现从这个角度上来说，Code2Code的向量搜是很诡异的一件事情，至少传统的cos相似度无法干这件事——</p>
<ul>
<li>更悲伤（从学术研究的角度上来说或许是兴奋）的是，在现实需求中，我们真的不在意找到和一个function的字面意相关的function...假设你想要补全一段代码，你可能更需要关注谁会是它的caller，假设你需要优化一段代码，你可能搜索的方法是某种低效的pattern...<strong>而这些embedding相似度全部做不到</strong>
<ul>
<li>据我所知，企业对这个接近摆烂了，只有MSRA有一个group还在研究，我之前溯源到的比较早的上下游建模技术是Order Embedding，感兴趣的或许可以试试做</li>
</ul>
</li>
</ul>
<p><strong>直接结果是：我们只有NL2Code了</strong></p>
<p>并且这个NL也只能关注一个方面...</p>
<p>什么样的NL才是真实会问会写的NL呢？Coding Agent的轨迹数据</p>
<p>没有轨迹数据怎么办？从大规模代码中<strong>挖掘注释作为NL</strong></p>
<p><strong>一个人写注释的方法和提问的方法不一样，这个语义空间的unmatch如何处理？各家自显神通</strong></p>
<ul>
<li>
<p>例如2025年5月快手的OASIS: Order-Augmented Strategy for Improved Code Search，认为<strong>现有的code</strong> <strong>embedding</strong>往往关注的是<strong>代码的字面相似性</strong>，即只把代码认为是一种特殊的“语言”，而忽略了代码的非文字意义上的相似性</p>
<ul>
<li>对代码片段（结合其他静态分析信息），用LLM产生其作用的描述文本</li>
<li>计算这个描述文本和其他代码片段的相似性，以此来挖掘难负样本</li>
<li>因为这个文本描述的是相对High Level的函数作用，能够一定程度上避免变量名字等带来的影响，专注于实际作用</li>
</ul>
</li>
<li>
<p>24年12月的Nomic AI的cornstack</p>
<ul>
<li>强调<code>&lt;文档，代码&gt;</code>对的相关性重要性，并采用双重过滤：如果文档与代码间相似度低，或者并不在topK，只要有一个满足就筛掉</li>
<li>动态硬负例挖掘策略：对于批内负样本挖掘，采用softmax概率采样，但是在训练过程中，逐步改变softmax的温度，前期温度高提高多样性，后期温度低，注重难负样本的区分</li>
</ul>
</li>
<li>
<p>25年5月的BAAI Towards A Generalist Code Embedding Model Based On Massive Data Synthesis</p>
<ul>
<li>强调退火训练，第一阶段纯文本，第二阶段全数据训练text-code能力，第三阶段纯代码</li>
</ul>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="码仓index---deepwikickg">码仓Index - DeepWiki/CKG<a class="hash-link" aria-label="Direct link to 码仓Index - DeepWiki/CKG" title="Direct link to 码仓Index - DeepWiki/CKG" href="/blog/tags/ai#码仓index---deepwikickg">​</a></h3>
<p>这个说起来就比较简单了，deepwiki重要的始终是LLM的能力，而CKG则是静态分析的质量，开源的tree-sitter固然可用，企业也有一些统一各种语言的私有AST，静态分析已经日趋成熟，困难的是<strong>如何将这个信息给到LLM</strong>？</p>
<p>很早在Google的博客中就有论述: <strong>现在的vibe coding就像是把一个几千行的代码粘贴到记事本里面，然后让程序员来修改bug</strong> —— LLM看到的就是 “记事本”，而不是程序员的带有各种Lint和跳转的IDE界面</p>
<p>AST分析树如此庞大，除了摆烂式地提供一个获取caller/callee的mcp工具给agent之外，还可以做些什么？</p>
<p>先前在web领域有一个llms.txt的旨在LLM-friendly的格式，代码领域却暂时缺乏哪怕是新兴的统一处理格式</p>
<p>AI-friendly IDE可能对于Coding Agent的能力提升相当重要，这也是moonbit社区他们宣传的，不过我没有实际上手用过，也不是学PL的，就不瞎讲了，感兴趣的可以看张宏波的演讲</p>
<p>【AI时代下的基础软件 | 张宏波 刘子悦 蚂蚁&amp;MoonBit Meetup杭州站回放】</p>
<p><a href="https://www.bilibili.com/video/BV1wL8DzgEXZ/" target="_blank" rel="noopener noreferrer">https://www.bilibili.com/video/BV1wL8DzgEXZ/</a></p>
<p><strong>除此之外，可能我们原先认为不能搜索或者没必要搜索的部分，现在也正在发挥着额外的作用</strong>：</p>
<ul>
<li>python的package，众所周知（可能并非），pip包只是一个特殊的压缩包，可以直接看到文本格式的原始代码，现代的claude-sonnet-4等模型在环境出错的时候会主动读/搜 <code>pyproject.toml</code>, <code>.venv</code>等特殊文件，遇到<code>import</code>的不了解api还会尝试进入package观看源码</li>
<li>而某些binary风格或是一串神秘哈希引入的包可能对于LLM并不是很友好...</li>
</ul>
<p>除此之外也有很多新兴的想法，例如注释本身可不可以作为一个天生的码仓Index? ...</p>
<p><strong>CLI版本</strong>的Coding Agent好处是可以在各处方便的引用，尤其利于<strong>大规模并发采集数据</strong></p>
<p>但<strong>IDE版本的Coding Agent则会更加地“懂人</strong>”，原因是AI IDE在背后做了一大堆不仅仅是diff等格式渲染的工作，用户环境信息，用户系统信息，... 这些都被从后台塞入了Coding Agent的system prompt，使得你在Linux上运行Copilot的时候，模型不会让你执行 <code>brew install</code>命令</p>
<p>但文本本身依然有着局限，或许在某个未来，我们能看到真正的code native架构，不在绞尽脑汁地想把编译器的报错，AST的分析等等原本结构化的东西转成markdown再塞入永远不够的agent上下文...</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai-4-se">ai4se</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/coding-agent">coding agent</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/embedding">embedding</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rag">rag</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/llm for code paper notes">paper-reading, code&amp;rl方向</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-09-01T00:00:00.000Z">September 1, 2025</time> · <!-- -->27 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="effi-code-unleashing-code-efficiency-in-language-modelsswiftcoder-enhancing-code-generation-in-large-language-models-through-efficiency-aware-fine-tuning">Effi-code: Unleashing code efficiency in language modelsSWIFTCODER: Enhancing Code Generation in Large Language Models through Efficiency-Aware Fine-tuning<a class="hash-link" aria-label="Direct link to Effi-code: Unleashing code efficiency in language modelsSWIFTCODER: Enhancing Code Generation in Large Language Models through Efficiency-Aware Fine-tuning" title="Direct link to Effi-code: Unleashing code efficiency in language modelsSWIFTCODER: Enhancing Code Generation in Large Language Models through Efficiency-Aware Fine-tuning" href="/blog/tags/ai#effi-code-unleashing-code-efficiency-in-language-modelsswiftcoder-enhancing-code-generation-in-large-language-models-through-efficiency-aware-fine-tuning">​</a></h2>
<p>问题：以前的方法主要关注正确性忽略效率(effibench，gpt4 代码执行时间是标准解决方案的1.69与45.49倍(avg, worst))</p>
<p>衡量效率：本地测量执行时间和内存</p>
<p>具体来说是三个指标：</p>
<ul>
<li>执行时间ET</li>
<li>最大内存使用量MU</li>
<li>总内存使用量TMU</li>
</ul>
<p>这篇论文并没有用RL的方法去激发LLM生成更高效率代码的能力，而是”优化“训练数据集的代码效率，并证明了训练集代码效率高也会让LLM生成更高效率的代码（ET 的相关性为 0.972，MU 的相关性为 0.950，TMU 的相关性为 0.986）</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/8ODW2a1x7r9bFUC.png" alt="Refer to caption" class="img_ev3q"></p>
<p>效果：<code>qwen2.5-coder-7b-instruct pass@1 44.8 -&gt; 57.7</code>，正确任务的执行时间减少48.4%</p>
<p>方法：构建代码生成数据集，进行微调</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/ecP8JdFNAkaCwVr.png" alt="Refer to caption" class="img_ev3q"></p>
<p>具体来说，先拉下来开源数据集，过滤一遍后，直接让更强的LLM生成更好的解决方案，然后本地跑一遍得到效率</p>
<p>不同效率的代码示例 <img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/njUJ3lsdbSM2v9e.png" alt="Refer to caption" class="img_ev3q"></p>
<p>文章认为的效果提升来源：</p>
<ol>
<li>多语言数据集</li>
<li>数据准备阶段过滤充分</li>
<li>数据量（有超过 70,000 个训练示例，比先前的mercury 1.8k要大很多）</li>
</ol>
<p>简评：大体上感觉是工作量密集型的工作，比如finetune多个llm和在多个数据集上进行相关评测，但方法上并没有创新之感，洗的数据是高效率代码的自然输出的结果效率也会变高，并不令人感觉新奇，只是讲好了我们需要同时看重代码质量（这里是效率）这一指标的故事</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="effibench-benchmarking-the-efficiency-of-automatically-generated-code">EffiBench: Benchmarking the Efficiency of Automatically Generated Code<a class="hash-link" aria-label="Direct link to EffiBench: Benchmarking the Efficiency of Automatically Generated Code" title="Direct link to EffiBench: Benchmarking the Efficiency of Automatically Generated Code" href="/blog/tags/ai#effibench-benchmarking-the-efficiency-of-automatically-generated-code">​</a></h2>
<p>问题：现在衡量代码正确性的文章已经有很多了，但是兼顾正确和效率的相对少</p>
<p>如果要考虑效率的话，一个问题是原先的代码数据集的任务太简单了，很难区分效率；同时很多任务也不是效率密集型的，并且效率相关的测试也不够</p>
<p>数据集构建：leetcode</p>
<p>“标准解决方案”: stackoverflow最多star/leetcode top answer</p>
<p>测试用例：LLM生成</p>
<p>简评：典型的benchmark工作</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="diversity-aware-policy-optimization-for-large-language-model-reasoning">Diversity-Aware Policy Optimization for Large Language Model Reasoning<a class="hash-link" aria-label="Direct link to Diversity-Aware Policy Optimization for Large Language Model Reasoning" title="Direct link to Diversity-Aware Policy Optimization for Large Language Model Reasoning" href="/blog/tags/ai#diversity-aware-policy-optimization-for-large-language-model-reasoning">​</a></h2>
<p>问题：diversity在reasoning能力中扮演重要角色，但缺乏定量的研究</p>
<p>动机：传统RL认为，多样性有助于策略探索（例如，SAC等算法），帮助跳出局部最优、加速训练收敛，但对于LLM呢？</p>
<p>方法：</p>
<p>直接增加熵，长度bias, 较长的响应 <code>-&gt;</code> 引入token level diversity</p>
<p>tradeoff 质量和多样性 <code>-&gt;</code> 仅对正样本用多样性增强，确保以性能标准为主导</p>
<p>贡献：</p>
<ul>
<li>多样性的Potential@k指标和LLM reasoning存在正相关关系</li>
<li>token-level diversity objective, selectively applied to positive samples</li>
</ul>
<p>奖励：和R1一致，acc reward和format reward，前者和ground truth 比较，后者让答案以 <code>\boxed{}</code>格式呈现</p>
<p>多样性度量：response中不同方程的比例</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mi>i</mi><mi>v</mi><mi>E</mi><mi>q</mi><mi>u</mi><mo>:</mo><mo>=</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><msub><mo>∑</mo><mi>k</mi></msub><mfrac><mi>U</mi><mi>A</mi></mfrac></mrow><annotation encoding="application/x-tex">DivEqu :=  \frac{1}{N} \sum_k \frac{U}{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em">v</span><span class="mord mathnormal" style="margin-right:0.03588em">Eq</span><span class="mord mathnormal">u</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.2173em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8723em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">A</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">U</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
<p>其中，U是k个采样中的独立方程数量，A是总方程数量</p>
<p>Potential@k： 衡量模型在第一次失败后，在k次（k=16 in paper）内纠正答案的能力</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>o</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>a</mi><mi>l</mi><mi mathvariant="normal">@</mi><mi>k</mi><mo>:</mo><mo>=</mo><mfrac><mrow><mo>∑</mo><mi>P</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">@</mi><mi>k</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>P</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">@</mi><mn>1</mn><mo stretchy="false">)</mo></mrow><mrow><mo>∑</mo><mn>1</mn><mo>−</mo><mi>P</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi mathvariant="normal">@</mi><mn>1</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">Potential@k := \frac{\sum Pass@k (1 - Pass@1)}{ \sum 1 - Pass@1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ia</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord">@</span><span class="mord mathnormal" style="margin-right:0.03148em">k</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">:=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.53em;vertical-align:-0.52em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.01em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em">∑</span><span class="mspace mtight" style="margin-right:0.1952em"></span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ss</span><span class="mord mtight">@1</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.485em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mop op-symbol small-op mtight" style="position:relative;top:0em">∑</span><span class="mspace mtight" style="margin-right:0.1952em"></span><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ss</span><span class="mord mtight">@</span><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span><span class="mopen mtight">(</span><span class="mord mtight">1</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.13889em">P</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">ss</span><span class="mord mtight">@1</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.52em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></p>
<p>（为啥定义这样一个指标？这个分子分母分别求和挺怪异的，也不是类似条件概率的算法）</p>
<p>结果：对于推理能力有限的LLM(<code>Pass@1&lt;0.4</code>) 多样性和Potential@k没什么关系，但对于更好的LLM，就有明显的正相关关系</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/KN2ZTl3WHbAfotv.png" alt="Refer to caption" class="img_ev3q"></p>
<p>定义的token-level熵</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/9zOCUMnTHIdcsA5.png" alt="image-20250817161107663" class="img_ev3q"></p>
<p>在实测中，作者发现直接把这个熵带入训练会增强错误样本的多样性，相当于对错误样本做增强，因此打了只对正样本做的补丁</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/EiW5Io6xJjOgLyp.png" alt="image-20250817161240377" class="img_ev3q"></p>
<p>而对这个式子求导能直观感受到多样性的部分</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/B4GSM6VPi3c2Cml.png" alt="image-20250817161427155" class="img_ev3q"></p>
<p>对于大多数token, 采样概率<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.03588em">π</span></span></span></span>的值都是小于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mo>−</mo><mn>1</mn></mrow></msup></mrow><annotation encoding="application/x-tex">e^{-1}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight">1</span></span></span></span></span></span></span></span></span></span></span></span>的，则前一个乘项小于0 ，熵的梯度和采样概率的梯度成正相关，熵增有利于对稀有Token的采样</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/tuR3Ey7BxJ4sFfi.png" alt="image-20250817161718666" class="img_ev3q"></p>
<p>实际取 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>0.01</mn></mrow><annotation encoding="application/x-tex">\lambda=0.01</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">λ</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6444em"></span><span class="mord">0.01</span></span></span></span></p>
<p>简评：</p>
<p>动机非常清晰，实验也比较充分，展示了虽然是 well-known 的需要基模能力达标多样性才有意义的结论。</p>
<p>对于LLM优化目标的改造的说明是合理的。理论说法是GRPO带来的更新依赖于组内样本的差异，（因为是用std/mean来计算优势函数A），所以增强多样性能避免优势消失带来的一些问题，本质上是在避免 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mrow><mi>r</mi><mo>−</mo><mi>m</mi><mi>e</mi><mi>a</mi><mi>n</mi></mrow><mrow><mi>s</mi><mi>t</mi><mi>d</mi></mrow></mfrac></mrow><annotation encoding="application/x-tex">\frac{r - mean}{std}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1473em;vertical-align:-0.345em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8023em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mord mathnormal mtight">t</span><span class="mord mathnormal mtight">d</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em">r</span><span class="mbin mtight">−</span><span class="mord mathnormal mtight">m</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">an</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span> 里面的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>t</mi><mi>d</mi></mrow><annotation encoding="application/x-tex">std</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal">d</span></span></span></span> 过小导致不稳定的问题</p>
<p>只对正样本应用多样性损失的trick也是有意义的。</p>
<p>但衡量多样性的时候比较草率，首先是局限在数学范围，其次感觉 <code>方程多样性 != 解法多样性</code>，所以多样性指标总感觉欠说服力。</p>
<p>他们自己也在文章中说：&quot;许多现实世界的应用需要用户意图的多样性（例如，需要数学问题的代数和算术解，或者生成具有不同算法方法的代码）, 这样的多样性不等于token level的多样性&quot;</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="beyond-the-8020-rule-high-entropy-minority-tokens-drive-effective-reinforcement-learning-for-llm-reasoning">Beyond the 80/20 Rule: High-Entropy Minority Tokens Drive Effective Reinforcement Learning for LLM Reasoning<a class="hash-link" aria-label="Direct link to Beyond the 80/20 Rule: High-Entropy Minority Tokens Drive Effective Reinforcement Learning for LLM Reasoning" title="Direct link to Beyond the 80/20 Rule: High-Entropy Minority Tokens Drive Effective Reinforcement Learning for LLM Reasoning" href="/blog/tags/ai#beyond-the-8020-rule-high-entropy-minority-tokens-drive-effective-reinforcement-learning-for-llm-reasoning">​</a></h2>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/EXbKjUpG9tBPO4R.png" alt="Refer to caption" class="img_ev3q"></p>
<p>问题： 现有RL for LLM算法对不同的token一视同仁，没有考虑token自身的异构性</p>
<p>观察： 低熵token主要决定语言结构，高熵token则作为关键的决策点。手动调整forking token的熵，适度增加这些token的熵可以显著提升推理性能，降低熵会导致性能下降。</p>
<p>仅保留20% token的策略梯度更新，剩下的mask掉，性能上能和全量媲美甚至超越，在RL过程中，只有一小部分高熵 token 对探索有实际贡献，而其他 token 则可能中性甚至有害</p>
<p>20%是实验得到的最优比例</p>
<p>另一个发现是32B的性能提升大于14B大于8B</p>
<p>熵定义：</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/dvBLzo681VuCRsa.png" alt="image-20250817165117549" class="img_ev3q"></p>
<p>一个很直观的分布图，高熵Token基本是重要的转折词，而低熵token是一些前后缀等</p>
<p><img decoding="async" loading="lazy" src="https://ar5iv.labs.arxiv.org/html/2506.01939/assets/x2.png" alt="Refer to caption" class="img_ev3q"></p>
<p>另一个稍微不直观的图</p>
<p>可以得到的结论是高熵token配合高温度能够得到好性能，而低熵token在不同温度下都不太影响最终效果</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/xJQaW8wsCp6OT2H.png" alt="Refer to caption" class="img_ev3q"></p>
<p>作者还发现，RLVR的过程基本就是这些高熵token的熵改变的过程，低熵Token的熵相对稳定，初始熵较高的 token 在 RLVR 后往往会经历更大的熵增。</p>
<p>而只对高熵Token进行RLVR能得到更好的效果</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/QsO7VlpMdqhmPKb.png" alt="Refer to caption" class="img_ev3q"></p>
<p>甚至作者在OOD数据（代码数据）上进行评测，发现高熵的token选择后，泛化性也更好</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/8JzUWnoklK5xdS1.png" alt="Refer to caption" class="img_ev3q"></p>
<p>讨论：</p>
<ol>
<li>RL倾向于保持高熵令牌的熵，而SFT倾向于将输出推向one-hot，降低熵，作者表示这可能是RL更能泛化而SFT容易记忆、难以泛化的原因</li>
<li>传统RL假设一整条轨迹上的熵是接近均匀分布的，这对LLM不成立</li>
<li>LLM RL中，之前常用的熵损失鼓励探索可能未必适用，因为可以是低熵token的熵增也可能是高熵token的，而DAPO的clip higher能筛选出高熵token，即重要性比率ratio（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>π</mi><mi mathvariant="normal">/</mi><msub><mi>π</mi><mrow><mi>o</mi><mi>l</mi><mi>d</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\pi/\pi_{old}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="mord">/</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em">π</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">o</span><span class="mord mathnormal mtight" style="margin-right:0.01968em">l</span><span class="mord mathnormal mtight">d</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>）更高的token通常对应高熵token，这呼应了前文中，RLVF对高熵token的熵值有较大改变</li>
</ol>
<p>简评：开始的手动把熵调高感觉等价于把奖励调高等价于数据增强，作为一种RL trick细想并不惊奇，是稀有样本情况下的常用技术</p>
<p>从这个角度继续往下想，如何理解这个多数token对训练甚至有害呢，感觉也是能合上现有对LLM RL的state定义不太合理，或者说探索空间太大，采样样本太少，不可能得到正确的Q函数，导致对于一些本来就很无所谓的token，更新的方向也是比较盲目</p>
<p>总之，这篇文章实验非常充足，分析也比较到位，效果也十分亮眼，确实是在当前的SOTA上往前推进的好文章</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="passk-training-for-adaptively-balancing-exploration-and-exploitation-of-large-reasoning-models">Pass@k Training for Adaptively Balancing Exploration and Exploitation of Large Reasoning Models<a class="hash-link" aria-label="Direct link to Pass@k Training for Adaptively Balancing Exploration and Exploitation of Large Reasoning Models" title="Direct link to Pass@k Training for Adaptively Balancing Exploration and Exploitation of Large Reasoning Models" href="/blog/tags/ai#passk-training-for-adaptively-balancing-exploration-and-exploitation-of-large-reasoning-models">​</a></h2>
<p>问题：RLVR 通常采用 Pass@1作为奖励，但容易收敛到局部最优；Pass@k则常用于验证，本文用Pass@k直接作为训练，并设计了对应的优势函数，发现效果比Pass@1更好（更高的Pass@k分数，保持的Pass@1分数）</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/U3Ay7amXxpnqcub.png" alt="Refer to caption" class="img_ev3q"></p>
<p>Pass@1 收敛到局部最优的问题在于正向奖励  的探索可能路径太长，模型会倾向于利用而不是探索</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/i85Q2WRxPvmazh9.png" alt="Refer to caption" class="img_ev3q"></p>
<p>方法：</p>
<ul>
<li>
<p>Full Sampling: 每组采样的k个rollout计算奖励，之后整组的奖励由每个rollout的<strong>最大值</strong>给出<img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/asnfy7dcjm4UeK3.jpg" alt="Refer to caption" class="img_ev3q"></p>
</li>
<li>
<p>Bootstrap Sampling: Full Sampling虽然提高了性能，但计算量太大。为了减少推理次数，同时保持组数不变，采用bootstrap采样，先生成一个候选池，再从这个池子里面抽取k个答案，就形成了一组（这样允许某个答案被分到多个组里面重用），论文中候选池大小就和正常top1大小相同，也就是平均而言每个样本被重用k次</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/mLOqDY2PvnCokEN.jpg" alt="Refer to caption" class="img_ev3q"></p>
<ul>
<li>既然Bootstrap Sampling只不过是对样本的采样重用，那其实可以直接计算对应的优势值的期望，所以可以省去采样这一步，直接计算候选池中正负样本的个数，通过解析解得到期望带入计算</li>
</ul>
<p>其他实验：</p>
<p>Pass@k的熵在训练中是上升的，而Pass@1后期会收敛，支持了前面的探索-利用论</p>
<p>k的值的影响？k的值不是跳出局部解的重要因素，但k值越大，优势越小（因为只有抽样全负才会是负奖励，k值越大正奖励概率越高），步长越小，训练效率降低，这个结论和也可以在改变学习率中得到验证</p>
<p>无论是小规模还是大规模的 LLM，都可以从 Pass@k 训练中受益。此外，模型架构和模型系列不会影响持续 Pass@1 训练的提升，下游任务的领域和形式也不会影响 LLM Pass@k 性能向 Pass@1 性能的迁移</p>
<p>分析：</p>
<p>同样是奖励从0到1，Pass@k的梯度出现在比Pass@1更早的地方（一次做对和K次做对），会使得Pass@k更倾向于解决更难的问题而不是中等难度的问题（由于Pass@k有一个argmax, 所以提高已经会做的题的正确率的效果是不断减小的）</p>
<p>Pass@1</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/kwHnEW4mdQfrZqc.jpg" alt="Refer to caption" class="img_ev3q"></p>
<p>Pass@k</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/d1Rg98LKeMtoNhm.jpg" alt="Refer to caption" class="img_ev3q"></p>
<p>还做了一个对比试验是仅将简单问题的奖励设置为0，不能防止模型过度优化</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/Urpd158SLRyWvaM.jpg" alt="Refer to caption" class="img_ev3q"></p>
<p>为了分析是否全是梯度曲线峰值带来的影响，手动调整奖励曲线，设计了一个这样的曲线</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/pWVjfl1t8JSgyo6.jpg" alt="Refer to caption" class="img_ev3q"></p>
<p>发现太注重困难的样本也不好，模型后期乏力</p>
<p>既然Pass@k 更注重困难样本，Pass@1 更注重一般样本，能否动态结合？</p>
<p>一个样本池中，正样本越多，越需要注重困难样本；反之需要先学会一般样本，因此设计了这样的优势函数</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/gwcpM1DWYLRAonm.png" alt="image-20250818003914103" class="img_ev3q"></p>
<p>发现效果非常好</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/rLXHtQpnTy2Phqc.jpg" alt="Refer to caption" class="img_ev3q"></p>
<p>文章还做了另一个实验是，用熵而不是正样本数量来判断一个问题是否是困难的，熵高的50%认为是困难问题，使用Pass@1, 低的使用Pass@k，也得到了不错的效果</p>
<p>简评：感觉没太多好说的了，他们做的相当好，从最开始的发现topk training可以提升效果，再到用bootstrap sample提高效率，再到公式的推出，自然发现topk就是本质上对应的难度-奖励曲线的不同，再到设计相关的实验验证，最后提出简单的自适应机制来结合Pass@1和Pass@k，也取得了相当好的实验效果，感觉挺一气呵成的，感觉是一个会成为范式的trick</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="structure-aware-fill-in-the-middle-pretraining-for-code">Structure-Aware Fill-in-the-Middle Pretraining for Code<a class="hash-link" aria-label="Direct link to Structure-Aware Fill-in-the-Middle Pretraining for Code" title="Direct link to Structure-Aware Fill-in-the-Middle Pretraining for Code" href="/blog/tags/ai#structure-aware-fill-in-the-middle-pretraining-for-code">​</a></h2>
<p>问题：现有的FIM将代码视为字符序列，而忽视句法结构</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/qrSZeCaH1uMOfsI.png" alt="Refer to caption" class="img_ev3q"></p>
<p>方法： 结合AST和FIM， 在训练时，被mask的部分始终是AST的一个或多个完整子树</p>
<p>代码解析：Tree-sitter</p>
<p>mask算法：涵盖不同的AST节点，提高泛化能力，且与具体语言无关</p>
<ul>
<li>单节点mask: 按照对应文本的数量成比例抽样</li>
<li>多节点mask: 先进行一次字符区间的采样，再找到包含这个字符区间的最小3节点的AST子树，子树中再取和原始字符区间有最大交并比的部分</li>
</ul>
<p>评估：字符级别困惑度，文章给出不用实际benchmark的原因是大规模单测太难。</p>
<p>简评：非常直接的想法，就类似word-level BERT对原始BERT的改进，不过它怎么构建AST的倒是可以参考。文章最后的评估用困惑度说服力不高，但考虑到它的数据量确实大（256*H100训练），也可以理解</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="the-entropy-mechanism-of-reinforcement-learning-for-reasoning-language-models">The Entropy Mechanism of Reinforcement Learning for Reasoning Language Models<a class="hash-link" aria-label="Direct link to The Entropy Mechanism of Reinforcement Learning for Reasoning Language Models" title="Direct link to The Entropy Mechanism of Reinforcement Learning for Reasoning Language Models" href="/blog/tags/ai#the-entropy-mechanism-of-reinforcement-learning-for-reasoning-language-models">​</a></h2>
<p>问题：现有RL后训练存在策略熵减小导致模型快速收敛，后期探索较少难以提升的问题</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/G7D8E1Tij9VUvor.png" alt="Refer to caption" class="img_ev3q"></p>
<p>作者发现，在前1/3的epoch中，基本就已经达到了大部分的性能，而熵也进入低值，作者称之为熵崩溃&quot;entropy collapse&quot;</p>
<p>且对于不同的模型大小，对于不同的RL方法，都能拟合近似的定律  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo>=</mo><mo>−</mo><mi>a</mi><msup><mi>e</mi><mi>H</mi></msup><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">R=-a e^{H} + b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.9247em;vertical-align:-0.0833em"></span><span class="mord">−</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.08125em">H</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">b</span></span></span></span></p>
<p>有了这样的拟合公式，可以在训练早期估计后期的性能，且ab与算法几乎无关，极限就是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mi>a</mi><mo>+</mo><mi>b</mi></mrow><annotation encoding="application/x-tex">-a+b</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6667em;vertical-align:-0.0833em"></span><span class="mord">−</span><span class="mord mathnormal">a</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal">b</span></span></span></span></p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/U8MvB1IJD5izsQf.png" alt="Refer to caption" class="img_ev3q"></p>
<p>另一个有趣的发现是，ab和模型大小呈对数线性关系</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/Vqo3QmfCA54is7x.png" alt="Refer to caption" class="img_ev3q"></p>
<p>也就是说，不仅可以在训练前期拟合后期，还可以用小模型预测大模型的RL效果</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/DnwJNZRAXuvSlEO.png" alt="image-20250818222517778" class="img_ev3q"></p>
<p>熵变公式如上，直观地讲，如果动作 a 同时获得高/低概率和高/低优  势，则熵会降低，反之亦然</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/DRXsvrGAMuIBFOU.png" alt="Refer to caption" class="img_ev3q"></p>
<p>作者还提出，直接使用熵损失的方法，如<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><msub><mi>L</mi><mn>0</mn></msub><mo>−</mo><mi>α</mi><mi>H</mi></mrow><annotation encoding="application/x-tex">L = L_0 - \alpha H</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal">L</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span><span class="mord mathnormal" style="margin-right:0.08125em">H</span></span></span></span>， 不仅对超参数敏感，实验效果也并不优于基线</p>
<p>所以作者提出的方法是，针对高协方差的一小部分token做Clip或者KL，就能防止熵崩溃，下面的实验结果也表现很好，熵后期不下降，回答长度增长，正确率大幅度提高</p>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2505.22617v1/x25.png" alt="Refer to caption" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/4iR9K8EvMwGD1no.png" alt="Refer to caption" class="img_ev3q"></p>
<p>作者发现策略熵对超参数设置非常敏感。具体来说，我们的方法仅干预一小部分 token（ 10−4 到 10−3 ），却完全改变了熵曲线。这意味着几个“关键” token 对 LLM 的熵至关重要</p>
<p>简评：搬运作者对clip-higher的讨论，作者认为，clip-higher也有类似的功能，提高重要性采样的上限会带来更多低概率的token，上限阈值仅影响具有正优势的 token，这意味着 clip-higher 实际上在梯度计算中添加了更多低协方差（低概率、高优势）的 token，所以结论殊途同归。而作者直接提出协方差是更胜一筹。</p>
<p>不过作者也说了现在还不清楚熵和模型性能的完整关系，也不清楚最优的熵值</p>
<p>另一个就是这些熵的论文主要还是在math任务上做的，code任务能否有相同的结论还是一个问题 (我认为这两个任务关键在于中间过程是不是重要的，math只有结果可能会得到一些错误的结论)</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="improving-llm-generated-code-quality-with-grpo">Improving LLM-Generated Code Quality with GRPO<a class="hash-link" aria-label="Direct link to Improving LLM-Generated Code Quality with GRPO" title="Direct link to Improving LLM-Generated Code Quality with GRPO" href="/blog/tags/ai#improving-llm-generated-code-quality-with-grpo">​</a></h2>
<p>问题：take code quality into consideration，不多赘述</p>
<p>方法：维护了一个库，把现有的一些评估代码质量的方案整合了起来（code complexity, dead code, code structure(linter等)， style&amp;doc, safety, performance...）, 然后质量奖励和正确性奖励一起放到奖励里面丢给GRPO</p>
<p>简评：只是占坑的，很草率的方法（对于奖励参数的设定），定量结果也不足。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="enhancing-high-quality-code-generation-in-large-language-models-with-comparative-prefix-tuning">Enhancing High-Quality Code Generation in Large Language Models with Comparative Prefix-Tuning<a class="hash-link" aria-label="Direct link to Enhancing High-Quality Code Generation in Large Language Models with Comparative Prefix-Tuning" title="Direct link to Enhancing High-Quality Code Generation in Large Language Models with Comparative Prefix-Tuning" href="/blog/tags/ai#enhancing-high-quality-code-generation-in-large-language-models-with-comparative-prefix-tuning">​</a></h2>
<p>问题：take code quality into consideration</p>
<p>方法：比较有新意，将Dynamic Prefix和代码质量结合起来了，并且是使用对比学习的方法做这个前缀</p>
<p>基于Pylint打分，构建了一套数据处理流水线标注大量高、低质量的代码对（相似度高，质量差距大，且都至少通过一项基本测试）</p>
<p>然后在微调Dynamic Prefix的的时候，加上一个排名Loss，希望模型倾向于生成高质量的样本。</p>
<p>里面的掩码是用difflib做的，目标是聚焦于差异的导致质量出现区别的token，而不要考虑重复的token</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/trwUWyP8RMniE5H.png" alt="image-20250818231615372" class="img_ev3q"></p>
<p>然后进行PEFT微调，再加上KL散度来保证不要丢失原始模型的代码生成能力</p>
<p>简评：这篇文章写得特别冗长，实验做的重点不突出，但思想是有意思的，并且明显可以继续挖，例如他们的代码相似度是简单的词频向量，自然挖掘出来的是细微处的代码风格问题，如是用index还是for each的形式遍历循环（只有这样的才会词频上高度相似）。但实际上是否可以用例如bge-code这样的代码语义嵌入呢？值得探究。</p>
<p>还有就是，这个数据收集的方法依赖于大语料库，也只能挖掘常见的代码模式，如果用自生成的方法，例如假设我们已经有一些高质量的代码库作为ground truth，</p>
<p>用llm得到的补全片段当负项，也能构造正负样本对啊，既然都是训练得到一个通用的“code style prefix”，这样数据丰富程度能高很多。他们明显的数据少训练小（2*A6000*3h）。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="augmenting-large-language-models-with-static-code-analysis-for-automated-code-quality-improvements">Augmenting Large Language Models with Static Code Analysis for Automated Code Quality Improvements<a class="hash-link" aria-label="Direct link to Augmenting Large Language Models with Static Code Analysis for Automated Code Quality Improvements" title="Direct link to Augmenting Large Language Models with Static Code Analysis for Automated Code Quality Improvements" href="/blog/tags/ai#augmenting-large-language-models-with-static-code-analysis-for-automated-code-quality-improvements">​</a></h2>
<p>问题：LLM refactor code没结合静态分析</p>
<p>方法：RAG + 静态分析软件 + Prompt 工程</p>
<p>简评：垃圾文章，真要做也是做一个能排序Code Quality的专用BERT，或者对现有的code embedder/reranker做adapter研究怎么把code quality调进去</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-hierarchical-and-evolvable-benchmark-for-fine-grained-code-instruction-following-with-multi-turn-feedback">A Hierarchical and Evolvable Benchmark for Fine-Grained Code Instruction Following with Multi-Turn Feedback<a class="hash-link" aria-label="Direct link to A Hierarchical and Evolvable Benchmark for Fine-Grained Code Instruction Following with Multi-Turn Feedback" title="Direct link to A Hierarchical and Evolvable Benchmark for Fine-Grained Code Instruction Following with Multi-Turn Feedback" href="/blog/tags/ai#a-hierarchical-and-evolvable-benchmark-for-fine-grained-code-instruction-following-with-multi-turn-feedback">​</a></h2>
<p>只需要看一张图就行了</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/ZOrG26Leygztn5N.png" alt="image-20250818234727444" class="img_ev3q"></p>
<p>现有模型在约束生成时，quality这种抽象的约束是满足最差的</p>
<p>而对于多种约束的组合，现有LLM都很差</p>
<p>而对于有反馈的情况（例如linter之类），在3轮迭代左右就能有很大的提升，但后续再增加轮数也难以获得更高收益</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="training-language-models-on-synthetic-edit-sequences-improves-code-synthesis">Training Language Models on Synthetic Edit Sequences Improves Code Synthesis<a class="hash-link" aria-label="Direct link to Training Language Models on Synthetic Edit Sequences Improves Code Synthesis" title="Direct link to Training Language Models on Synthetic Edit Sequences Improves Code Synthesis" href="/blog/tags/ai#training-language-models-on-synthetic-edit-sequences-improves-code-synthesis">​</a></h2>
<p>问题：LLM这样“一口气生成所有代码”和先前的软件工程实践（增量式开发）是相悖的，而现在的code agent又需要增量开发的能力，有绕远路之感，于是研究能不能从预训练的数据侧上解决这个问题，即大规模合成 增量编辑数据</p>
<p>方法: 文章提出了一个LintSeq的方法，对于一段已有的代码，从里面修建某些部分回退，让回退后的代码不会触发linter错误，则构建了一个edit stage</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/kGrRXUvC1Sbs6Pe.png" alt="Refer to caption" class="img_ev3q"></p>
<p>然后这样构建了数据集后自己SFT codellm，发现确有提升</p>
<p>简评：简单有效，或许可以想想这个怎么和RL结合？</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="focused-dpo-enhancing-code-generation-through-focused-preference-optimization-on-error-prone-points">Focused-DPO: Enhancing Code Generation Through Focused Preference Optimization on Error-Prone Points<a class="hash-link" aria-label="Direct link to Focused-DPO: Enhancing Code Generation Through Focused Preference Optimization on Error-Prone Points" title="Direct link to Focused-DPO: Enhancing Code Generation Through Focused Preference Optimization on Error-Prone Points" href="/blog/tags/ai#focused-dpo-enhancing-code-generation-through-focused-preference-optimization-on-error-prone-points">​</a></h2>
<p>问题：代码错误很多是中间的“易错点”出错，对于所有token一视同仁的奖励函数在代码任务上可能未必高效</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/1PfxEt2h8gaKnXl.png" alt="image-20250819001722237" class="img_ev3q"></p>
<p>方法：</p>
<ol>
<li>该方法从真实代码库中提取概念，生成问题、代码和测试</li>
<li>由于有了测试，所以可以比较不同的生成代码的相对性能</li>
<li>通过共同前缀和共同后缀，得到中间不一样的中缀，就认为是“易错点”</li>
</ol>
<p>然后DPO专注这一块的优化</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/08/19/BKAtb5MYlhkGoW3.png" alt="image-20250819002037550" class="img_ev3q"></p>
<p>简评：感觉上是更软件工程的熵方法的简化，感觉这个易错点是能从LLM自身状态或者其他软件工程分析技巧中得到的，从前面几篇也可以看出，现在这种广义上的RL ”attention“ mask类工作越来越多了</p>
<p>这个方法要求生成测试，实际生产中感觉并不可用；抛开这个不谈，感觉就单纯对一个大型代码数据集，去分析里面的编码模式，找到相对少的n-gram，或者AST level迅速变化的地方作为易错点重点训都或许可行</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/code">code</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rl">RL</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/Paper reading Context Pruning and beyond hard pruning">Paper reading - Context Pruning and beyond hard pruning</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-07-29T00:00:00.000Z">July 29, 2025</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="引子">引子<a class="hash-link" aria-label="Direct link to 引子" title="Direct link to 引子" href="/blog/tags/ai#引子">​</a></h2>
<p>我们知道，在现在Agent需要处理的一大问题是长上下文下性能的开销问题，对此infra团队有非常多的优化，从attention架构的优化如各种windowed attention到kv的压缩重用如cacheblend和megicdec等都提出了一系列的解决方案，但有一个最本质的方法是：有没有可能直接减少上下文的长度(去掉不必要的上下文?) ，这就是Context Pruning的出发点。</p>
<p>而截止2025年8月，相关的方法已经发展了两三年了，大体上可以分成几个类别，本文会对此做一些简单的介绍和总结。</p>
<p>借用naver lab最新的相关论文里面的<a href="https://europe.naverlabs.com/blog/efficient-online-text-compression-for-rag/" target="_blank" rel="noopener noreferrer">说法</a>，现在的方法可以被 一个四方格归纳：</p>
<p><img decoding="async" loading="lazy" src="https://europe.naverlabs.com/wp-content/uploads/2025/05/5-OnlineOfflineHardSoft.png" alt="" class="img_ev3q"></p>
<p>其中，Hard和Soft代表裁剪方法是直接作用于token上（hard，相当于裁剪结束后，输入的是一个新的prompt），还是作用于token的embedding上（soft，相当于裁剪结束后，输入的是一个新的qkv和其他东西，无法还原出“原始”的token输入）</p>
<p>在线和离线一般代表着这个裁剪方案是否依赖于用户查询q，依赖q的方案是在线的，不依赖q的方案是离线的，可以提前做好。但传统上，如果你的裁剪方法也需要用到和原始模型一样大的LLM，也一般称之为离线，或许“是否会对在线推理造成明显时延影响”做划分更好一些</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="离线硬裁剪">离线硬裁剪<a class="hash-link" aria-label="Direct link to 离线硬裁剪" title="Direct link to 离线硬裁剪" href="/blog/tags/ai#离线硬裁剪">​</a></h3>
<p>在最早期的时候，就有相关的一些朴素方法，例如直接对查询文本段做一次总结摘要，再用总结后的文本段去做后续的任务，这种方法是离线硬裁剪的典型代表。如果用的是llm就是离线的，如果用轻量级模型做摘要或者总结就是在线的</p>
<p>而在后面的时候，出现了例如微软的llmlingua这样的工作，直接用一个小模型(gpt2 small，llama-7b, etc)去预测哪些token是重要的，哪些token是不重要的，然后把不重要的token直接裁剪掉，这种方法也是离线硬裁剪的典型代表。(llmlingua2 换成了微调的 BERT 来做这个事情，所以可以说在线的)， 其出发点和常规的硬裁剪可能有部分地方不同，例如llmlingua认为，裁剪本身是可以得到一些人类不可读但是大模型可以理解的token序列的，所以可解释性上可能并没有想象的那么强。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="离线软裁剪">离线软裁剪<a class="hash-link" aria-label="Direct link to 离线软裁剪" title="Direct link to 离线软裁剪" href="/blog/tags/ai#离线软裁剪">​</a></h3>
<p>和硬裁剪同时推进的是软裁剪相关的工作，其想法很简单: 如果我牺牲解释性，直接调整prompt的embedding这类，即使产生的是不对应任何token的&quot;fake embedding&quot;，其在高维空间中也应该融合了多个token的语义，理应得到更高的压缩率(可以理解为，在训练过程中为llm 扩充为无限词表，然后定义了一些高效的&quot;额外语言&quot;)</p>
<p>比较早期的工作是 xRAG， 其裁剪策略非常极端，将整个段落都压缩成1个embedding X，怎么训练呢？一个在此类论文中经常出现的是重建loss，即</p>
<p>压缩前<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mi>o</mi><mi>c</mi><mo>+</mo><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mo>→</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">Doc + query \to x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord mathnormal">Doc</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.03588em">ery</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">x</span></span></span></span></p>
<p>压缩后<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi><mi>o</mi><msup><mi>c</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo>+</mo><mi>q</mi><mi>u</mi><mi>e</mi><mi>r</mi><mi>y</mi><mo>→</mo><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">Doc&#x27; + query \to x&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8352em;vertical-align:-0.0833em"></span><span class="mord mathnormal">Do</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.03588em">ery</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">→</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.7519em"></span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mi>L</mi><mo stretchy="false">(</mo><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo><mo>=</mo><msub><mi>D</mi><mrow><mi>K</mi><mi>L</mi></mrow></msub><mo stretchy="false">(</mo><msup><mi>x</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo separator="true">,</mo><mi>x</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L=L(x&#x27;,x)=D_{KL}(x&#x27;,x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em"></span><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0019em;vertical-align:-0.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">D</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.07153em">K</span><span class="mord mathnormal mtight">L</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7519em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">x</span><span class="mclose">)</span></span></span></span>，  即自蒸馏，希望压缩后依然能重建原始的输出，论文实际中可能会用变体版本来实现指令遵循等</p>
<p>xRAG的做法是，使用一个通用编码器E，把这个编码器E视作一个新的模态，仿照CLIP的方法直接用MLP projector做通用编码器和实际使用的LLM token embedding的模态对齐</p>
<p>但[大家实测下来](笔记：RAG 的相关优化方法之六（xRAG/PISCO） - 刀刀宁的文章 - 知乎
<a href="https://zhuanlan.zhihu.com/p/29292925032)%EF%BC%8CxRAG%E7%9A%84%E6%95%88%E6%9E%9C%E5%B9%B6%E4%B8%8D%E5%A5%BD%EF%BC%8C%E8%80%8C%E7%9B%B8%E5%AF%B9%E8%BE%83%E5%A5%BD%E7%9A%84%E6%98%AF%E6%9B%B4%E6%96%B0%E7%9A%84Pisco%E6%96%B9%E6%B3%95" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/29292925032)，xRAG的效果并不好，而相对较好的是更新的Pisco方法</a></p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/09/07/qYgLrSRHVJj4P5x.png" alt="Refer to caption" class="img_ev3q"></p>
<p>Pisco将检索到的文档D和memory tokens一起送到LLM中，产生embeddings</p>
<p>再将embeddings +query送到相同的LLM中，产生输出，这个 q+E 和原始的 q+D 比较， 计算交叉熵损失</p>
<p>这里有一些复杂的地方:</p>
<ul>
<li>
<p>虽然叫解码和编码，但是Student LLM都是同一个LLM, 只是训练不同LoRA模块</p>
</li>
<li>
<p>交叉熵是怎么得出的? teacher模型和student模型都是采用的最大长度128的贪婪解码，就可以直接令 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mo>−</mo><mo>∑</mo><mn>1</mn><mi>l</mi><mi>o</mi><mi>g</mi><mi>p</mi><mo>+</mo><mn>0</mn><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>p</mi><mo stretchy="false">)</mo><mo>=</mo><mo>−</mo><msub><mo>∑</mo><mi>i</mi></msub><mi>l</mi><mi>o</mi><mi>g</mi><mi>P</mi><mo stretchy="false">(</mo><msub><mi>a</mi><mi>i</mi></msub><mi mathvariant="normal">∣</mi><mi>q</mi><mo separator="true">,</mo><mi>e</mi><mo separator="true">,</mo><msub><mi>a</mi><mrow><mo>&lt;</mo><mi>i</mi></mrow></msub><mo separator="true">,</mo><msub><mi>θ</mi><mi>c</mi></msub><mo separator="true">,</mo><msub><mi>θ</mi><mi>d</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">L=-\sum 1logp + 0log(1-p) = - \sum_i log P(a_i|q,e,a_{&lt;i},\theta_c,\theta_d) </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal">L</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">1</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal">p</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord">0</span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal">p</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.0497em;vertical-align:-0.2997em"></span><span class="mord">−</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.162em"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal" style="margin-right:0.01968em">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03588em">g</span><span class="mord mathnormal" style="margin-right:0.13889em">P</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mord">∣</span><span class="mord mathnormal" style="margin-right:0.03588em">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">e</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">&lt;</span><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1774em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>， 优化目标是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\theta_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 和 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">\theta_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 还有 memory_tokens</p>
</li>
<li>
<p>如何理解memory token? 我觉得文章是借用了之前的一些研究比如ICAE, 在这些文章之中，训练的压缩机制是，将上下文压缩成一个定长的memory slot, 这里的memory token实际上只是多个embedding向量而已，而更关键的是LoRA微调的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">\theta_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>，我的理解是，memory tokens只是一个后置的、可以看到Documents的所有信息（假设它没有魔改注意力）的语义位置，叫tokens也可以理解为直接扩了词表加入了l个特殊token，类似BERT里面的<code>[BOS]</code> ，只是decoder llm需要后置。</p>
<ul>
<li>文章并没有细说这里的注意力是怎么设置的，但从后文中发现的memory tokens具有明显的位置特性（例如1位mem token主要注意最开头一段），感觉应该是没改过</li>
</ul>
</li>
<li>
<p>文章的另一个重要的实验结论是，微调student llm(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">\theta_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>)是必要的，之前的研究中没有相关模块，会导致性能的大幅度下降。这细想其实是一个很有趣的事情，可以注意到，压缩的时候是没有接触到query信息的（这也是为什么称为离线的原因），可以理解为某种意义上的LLM as an embedder，而加入了query和embedding再训练的时候，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>θ</mi><mi>d</mi></msub></mrow><annotation encoding="application/x-tex">\theta_d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:-0.0278em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>一边学会了如何理解自己产生的embedding，另一方面学会了如何根据query去选择embedding，整体上类似于ColBERT架构的Reranker（前面是multi-vec embed, 后面是maxsim）</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="在线硬裁剪">在线硬裁剪<a class="hash-link" aria-label="Direct link to 在线硬裁剪" title="Direct link to 在线硬裁剪" href="/blog/tags/ai#  在线硬裁剪">​</a></h3>
<p>Provence</p>
<p>之前的裁剪方案只注重于“自然语言是有冗余的”，所以主要做的都是token-level的pruning，而provence则更注重实际一些，它发掘了一个问题是，其实现在RAG里面的 “Chunk” 是一个特别微妙的概念</p>
<p>如果chunk切得大了，那上下文自然就长了，甚至效果也会明显下降（详见ground truth在chunk中的不同位置的position bias相关的研究，现有embedder对这个bias耐受性不佳，会狠狠掉点）；但如果chunk切得小了，语义信息的丢失、检索的困难又是很恼人的事情（先不论检索，检索到了多个小块之后信息不够怎么办？一种是合并，但策略怎么定？另一种是Anthropic的Contextual Retrieval，把上下文放进来，本质上还是变成大块（我说这个a一串真是炒作勾啊.jpg））。</p>
<p>而Provence给了一个折中的方案，既然我们有句子级别的语义，为什么不用呢？分几步走</p>
<ol>
<li>训练一个接受q,d的BERT，给每一个token打0~1分，并根据用户指定的阈值进行二值化变为0/1, 表示删除/留下</li>
<li>进行句子级别的聚类，裁剪掉0的token数量大于1的token数量的句子</li>
</ol>
<p>如何训练呢？选取有5~10个句子的段（可以多次选取来拓展到更长的上下文），标上句子序号，让LLM选择相关句子来产生label，从而训练模型</p>
<p>这里其实做了很有意思的工程设计，</p>
<ul>
<li>
<p>如果让LLM来打token-level的标，肯定是收集不到足够的样本的，并且真的无所谓多出来的几个token，更在意句意的完整性</p>
</li>
<li>
<p>BERT带来了相当多的好处:</p>
<ul>
<li>
<p>这样进行的句子裁剪，每个句子都可以和整个chunk里面的所有上下文交互，使得一个句子的保留与否不仅取决于这个句子和查询的相关性，还取决于其于其他（和查询相关性高的）句子的相关性，这就使得这个方法必然会优于按句子切分的朴素方法</p>
</li>
<li>
<p>我们的 reranker 也就是个BERT啊，完全可以训裁剪和训rerank一起进行，推的时候也一样，相当于和rerank overlap了</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/09/07/yxnpqQOfW6lv8zg.png" alt="image/png" class="img_ev3q"></p>
</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="在线软裁剪">在线软裁剪<a class="hash-link" aria-label="Direct link to 在线软裁剪" title="Direct link to 在线软裁剪" href="/blog/tags/ai#在线软裁剪">​</a></h3>
<p>Oscar</p>
<p>Pisco为代表的离线软裁剪有一个问题是，它的压缩需要微调，并且受限于难以对齐encoder-only架构的预训练编码器模态和实际推理使用的decoder LLM的模态，难以把压缩这一步在线做</p>
<p>Oscar就提出了一种方法是，我的对齐既然难做，我直接不对齐了，使用LLM的前L层 + memory token(他们也做了用Llama硬对齐的版本)，足以得到够好的embedding，文章最大的贡献其实是实验证明了这样表达能力已经足够，能训出来（太神奇了LLM）。当然，L越大效果越好</p>
<p>而还是复用Provence的工程技巧，把裁剪和rerank overlap起来，OSCAR的compressor留了一个RR头，在这个头和Teacher Reranker对齐，整体的Loss就是rerank loss + generation loss</p>
<p>而令LLM理解embedding这件事情还是通过LoRA adapter来做，这篇文章其实像是序列工作的延申，综合了PISCO的训练方法，把PISCO的压缩部分从LLM + LoRA换成目标模型的前N层transformer，然后压缩器全参微调、生成器LoRA微调，再使用和Provence相同的技巧进行rerank的overlap</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2025/09/07/pDRSe2sCwFabN8X.png" alt="image-20250907213839337" class="img_ev3q"></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="异曲同工">异曲同工<a class="hash-link" aria-label="Direct link to 异曲同工" title="Direct link to 异曲同工" href="/blog/tags/ai#异曲同工">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="从hyde到投机解码">从HyDE到“投机解码”<a class="hash-link" aria-label="Direct link to 从HyDE到“投机解码”" title="Direct link to 从HyDE到“投机解码”" href="/blog/tags/ai#从hyde到投机解码">​</a></h4>
<p>另一个有趣的工作是广义上的“裁剪”，或者就是更好的搜索吧。我们知道HyDE的思想是原始query一般都比较短，而生成的假设文档可能会更好地与索引文档对齐，所以使用 q‘ = q + generated d 来进行搜索。</p>
<p>而智谱的<a href="https://arxiv.org/abs/2409.05591" target="_blank" rel="noopener noreferrer">memorag</a> 则提出了这样一种场景，我们是否能以低成本训练一个小模型，来根据源文本生成这个假设答案呢？（例如，使用Llama3-8B在哈利波特上训练比用Deepseek-R1在哈利波特上训练成本要低廉的多，将HyDE的生成方从R1自己换成小模型）这就非常像是投机解码的思想了</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="外接模块-memory-decoder-catridges">外接模块: memory decoder, catridges<a class="hash-link" aria-label="Direct link to 外接模块: memory decoder, catridges" title="Direct link to 外接模块: memory decoder, catridges" href="/blog/tags/ai#外接模块-memory-decoder-catridges">​</a></h4>
<p>其实这种将memory训为embedding的方法确实不少，如果说前面的压缩器是在训一个meta network，能够从doc生成embedding的话，外接模块的工作就是在训练embedding本身 -&gt; 我能否直接从一个大的文档库中训练出一个参数化的memory?</p>
<p>最近的<a href="https://www.arxiv.org/abs/2508.09874" target="_blank" rel="noopener noreferrer">memory decoder</a>选择的是直接扭曲生成过程，将一个小模型在目标适配数据集上训练，在大模型生成token时，将小模型的概率和大模型的概率相加（再重归一化），认为这样会带来领域知识的纠正（比较暴力www）</p>
<p>而另一篇<a href="https://arxiv.org/abs/2506.06266" target="_blank" rel="noopener noreferrer">catridges</a> 则是在使用类似P-tuning的方式训一个Prefix KVCache，在推理时实时加载，而希望这个KV中有相关的memory</p>
<p>包括一系列的kvcache evict的工作也是在做类似的东西，为了决定evict哪些甚至都把搜索又搬上来了，比如clusterKV的knn(笑)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="总结">总结<a class="hash-link" aria-label="Direct link to 总结" title="Direct link to 总结" href="/blog/tags/ai#总结">​</a></h3>
<p>总体而言，我感觉相关工作已经进入了深水区了，硬裁剪可能在某些程度上到头了，现在主流在探索一些牺牲解释性的，更能scale out的方法来进行参数化memory来解决长上下文、领域适配等一系列问题</p>
<p>而大家方法逐渐趋向于无标签学习的统一也再次证明了scale out能力在广义embedding能力的训练上的重要性</p>
<p>另一个很有意思的是，可以看到搜索中的多向量和多memory token有一些很有趣的相似性，或许在后续的一些工作中，我们能看到一些多向量的方法被用到memory之中，希望会让memory这个很多时候靠prompt编故事的领域更多可验证性吧</p>
<p>而从另一个方面，正如这里列出的部分文章说的，自从eagle在投机解码中得到了确实很好的效果之后，大家都开始用 token + embedding的混合来捕捉更强的信息了，还有HyDE和投机解码这种很有趣的对应</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rag">rag</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/agent">agent</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/embedding">embedding</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/结构化输出">结构化输出与AI工具与Agent</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-07-29T00:00:00.000Z">July 29, 2025</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><p>假如大伙接到一个需求，需要把claude code接入jupyter前端（例如，在jupyter前端直接输入魔法指令和claude code交互，而后台claude code展示claude code的一些关键节点，工具调用，费用开销，输出结果等），会怎么做？</p>
<p>一种想法是，将claude code的输出塞到一个文件里面去，起一个后台线程读取这个文件，尝试解析之中的某些部分，再以插件的形式加载到jupyter前端</p>
<p>但带来了一个问题是，效果（尤其是工具数量upup，上下文长度upup后的效果）不稳定，纯prompt的形式约束claude code及时向这个文件中写入以向前端通信，在经过长的交互过程后，claude经常会把这个文件忘掉</p>
<p>那claude code直接全塞前端呢？</p>
<p>在claude code里面问一个问题，可能就是几千上万token的交互，全塞前端，那用户体验就烂掉了。</p>
<p>另一个很容易想到的方案是，那我们不要让他输出文件了，直接当场处理把，定义一些特殊块叫
display 之类的东西，在prompt里面指定这个块里面是什么格式，让他如果想要和前端输出的话，放到这个块里面</p>
<p>这样看起来比文件好一些，但带来了新的问题没解决，长上下文下，display块的结构偶尔会有不稳定，会有不少特殊的渲染格式如html等由于几个字符的差异退化成了纯文本</p>
<p>如何修复这个呢？一个简单的方法，也是你能在任意一个现在的agent中看到的，是及时判错，再把把错误的部分发给模型让他修复一下，但又带来了额外的开销，并且前端的呈现也收到影响</p>
<p>有没有更优雅的办法呢？</p>
<p>如果你做AI应用比较多的话，肯定注意到了这实际上是一个结构化输出(约束解码)的场景，但现在的问题是，输出不止是一个json，而是正常文本块和display块的交错</p>
<p>（对于不了解约束解码的简单介绍一下，就是把上层的json等约束编译成状态机之后，用于动态建立llm output logits的mask，从而杜绝输出非法输出的技术）</p>
<p>看起来似乎不能约束解码？但display块本身是可以约束解码的，好恶心。</p>
<p>让我们打开vllm文档，翻到 Structured Outputs，你会发现，除了常见的regex约束解码之外，还有两种更强语义的解决方案，救赎之道就在其中，ebnf解码和structure tags解码</p>
<p>实际上，json解码只不过是ebnf解码的特殊情况罢了，毕竟实际都是状态机
（不知道ebnf是什么的同学，可以搜索一下编译前端，BNF范式，就能看懂下面的示例啦）</p>
<p>官方给的一个ebnf解码的例子如下, 用于执行一个简化sql的约束解码以提升sql正确率</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">simplified_sql_grammar </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    root ::= select_statement</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    select_statement ::= &quot;SELECT &quot; column &quot; from &quot; table &quot; where &quot; condition</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    column ::= &quot;col_1 &quot; | &quot;col_2 &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    table ::= &quot;table_1 &quot; | &quot;table_2 &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    condition ::= column &quot;= &quot; number</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    number ::= &quot;1 &quot; | &quot;2 &quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">completion </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> client</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">chat</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">completions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    messages</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;role&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;content&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Generate an SQL query to show the &#x27;username&#x27; and &#x27;email&#x27; from the &#x27;users&#x27; table.&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    extra_body</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token string" style="color:#e3116c">&quot;guided_grammar&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> simplified_sql_grammar</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">completion</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">choices</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">message</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果放到这个问题，我们可以快乐地写出类似这样的定义</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">output := (display | normal text) *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">display := (```display json ```)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">json = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">normal text = others</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>其中，display, json都是容易得到的，但恶心的地方在于什么是“others”
未拓展的ebnf是没有“非”定义的，从实操上虽然感觉可行（mask token取反），但这下已经没有支持了</p>
<p>（但ebnf解码肯定是有大用的，还是以Text2SQL举例，任何一个数据库都会给你他们的解析引擎的ebnf定义，都不需要你写）</p>
<p>怎么办呢，就带来了最后一个冷门工具，structured tags，
我先上代码，</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_structural_tag_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">StructuralTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> triggers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;structural_tag&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;structures&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> model </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> tags</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;triggers&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> triggers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_v2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        base_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">base_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api_key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">api_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temperature</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top_p</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extra_body</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;response_format&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> get_structural_tag_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=text&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TextMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=image&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ImageMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=tool_use&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ToolUseMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=todo_list&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TodoListMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=html&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HTMLMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                triggers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;&lt;block=&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个tags + triggers, 就是structured output的关键之处，它允许我们在trigger触发的时候才开始约束解码，在end结束的时候停止约束解码</p>
<p>至此，这个工作已经做完了</p>
<hr>
<p>那约束解码和不约束带来的效果差距有多大呢，我在24B的Mistral-Small上做了个实验
最后的结果直接尝试解析后渲染到前端</p>
<p>Prompt如下，</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sys_prompt = f&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">你是一个agent模型，你负责处理用户的问题，发起工具调用, 绘制图片、html、获取文本等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">由于你的token交互  量很大，不是所有信息都需要展示给前端。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">你可以正常思考和输出，但你需要将你认为需要展示给用户的有效信息包裹在 `&lt;block={{tag}}&gt; {{schema}} &lt;/block&gt;` 中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">前端会将这部分内容进行渲染，交给用户。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">你现在可用的tag有:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">tags: &quot;text&quot;, &quot;image&quot;, &quot;tool_use&quot;, &quot;todo_list&quot;, &quot;html&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">对应的schema(pydantic格式)如下:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- {schemas_str}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">例如，你可以先产生一个todo list，然后不断执行子任务，并更新todo list，直到所有任务完成。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">由于你现在没有接入工具调用，所以对于所有工具调用交互，你只需要“假装”执行了工具调用并得到一个合理的响应就行，这是一个debug环境，</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">你需要根据用户的问题尽可能多的展示不同的block，并给出一个合理的响应。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>这个prompt下，<code>&lt;block=text&gt;111&lt;/block&gt;</code> 这种就取代了上文所述的display块的效果</p>
<p>只定义了五种特殊的前端展示格式，文本，图片，TODO list，工具调用和HTML块</p>
<p>效果对比如下：</p>
<p>用户：帮我完成编写一个论坛帖子，打开浏览器的水源社区论坛，登录之后在discourse发帖的流程。</p>
<p><img decoding="async" loading="lazy" alt="alt text" src="/assets/images/image-10-57a8fd70dc61313b1baa8538ab00ca8f.png" width="1035" height="705" class="img_ev3q">
<img decoding="async" loading="lazy" alt="alt text" src="/assets/images/image-11-fea313f95fa94fb03b64d9ffb986bcdd.png" width="1035" height="742" class="img_ev3q">
<img decoding="async" loading="lazy" alt="alt text" src="/assets/images/image-12-fea313f95fa94fb03b64d9ffb986bcdd.png" width="1035" height="742" class="img_ev3q">
<img decoding="async" loading="lazy" alt="alt text" src="/assets/images/image-13-8da20497ce50bd4b1c67a14c8618f6ec.png" width="1035" height="744" class="img_ev3q"></p>
<p>可以看到，左侧没有约束解码的模型，在这样的任务负载下，json 参数就已经频频出现失误了，而右边的即使是24B模型的fp8量化非思考版本，却跑出了几百B agent的气势，并且token开销是来回倒腾的几分之一</p>
<hr>
<p>一点感想：
我们常说一个子领域的知识对于另一个子领域是用处寥寥的，然而，这不是拒绝新领域知识的理由啊，vllm和xgrammer、outlines这种框架都把几种更强大的结构化解码方法摆到人们的脸上了，还是能在知乎看到“ebnf好像是编译原理的内容，（作为后端程序员）跳过”，或者是在各种开源仓库中还在广泛使用的拿prompt指导llm输出，完全不考虑（甚至不知道）结构化输出这样的东西</p>
<p>现在的后端、infra、算法，又有多少更深的优化方案是独立的呢？今天在看snowflakes优化方案，真是把上层算法和底层infra相辅相成，只是缺乏探索性的人们，会拿&quot;这不是我的工作，这是专攻模型/infra/算法的人的工作&quot;搪塞，最后又堆起来一个prompt史山罢了</p>
<p>在现在的agent框架中，充斥的也是prompt的兜底方案，带来的是qwen3-coder几个问题爆掉用户百万token，带来的是claude code问个“你是谁”都要花一角钱，但有没有一种可能，我们本可以用更确定的东西呢？LLM是一种万能的  模糊推理，但好钢也要用在刀刃上啊。</p>
<p>参考完整代码如下</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># ruff: noqa: E501</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># SPDX-License-Identifier: Apache-2.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># SPDX-FileCopyrightText: Copyright contributors to the vLLM project</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> argparse</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> asyncio</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> enum</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> re</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pathlib </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Path</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> typing </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> Any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> colorlog</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> openai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain_core</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">messages </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> HumanMessage</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> SystemMessage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> langchain_openai </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> ChatOpenAI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> pydantic </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> BaseModel</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Field</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">from</span><span class="token plain"> dotenv </span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> load_dotenv</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">load_dotenv</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    begin</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    end</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Any</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># JSON schema for validation, model_dump by pydantic model</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TextMsgSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Text message&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Render text message as HTML&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;&lt;div class=&quot;text-message&quot;&gt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">text</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/div&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">HTMLMsgSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    raw_html</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;raw html str, like &lt;div&gt;&lt;/div&gt;&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Render HTML message as HTML&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;&lt;div class=&quot;html-message&quot;&gt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">raw_html</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/div&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ImageMsgSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image_url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Image URL&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    image_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Image name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Render image message as HTML&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;&quot;&quot;&lt;div class=&quot;image-message&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;img src=&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">image_url</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot; alt=&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">image_name</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot; style=&quot;max-width: 100%; height: auto;&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;p class=&quot;image-caption&quot;&gt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">image_name</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;/div&gt;&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">ToolUseMsgSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tool_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Tool name&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    args</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Tool args&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tool_output</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Any</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Tool output&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Render tool use message as HTML&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        args_html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">args</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ensure_ascii</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        output_html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">tool_output</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ensure_ascii</span><span class="token operator" style="color:#393A34">=</span><span class="token boolean" style="color:#36acaa">False</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;&quot;&quot;&lt;div class=&quot;tool-use-message&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;h4&gt;Tool: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">self</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">.</span><span class="token string-interpolation interpolation">tool_name</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/h4&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;div class=&quot;tool-args&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;strong&gt;Arguments:&lt;/strong&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;pre&gt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">args_html</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;div class=&quot;tool-output&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;strong&gt;Output:&lt;/strong&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;pre&gt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">output_html</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;/div&gt;&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">TodoListMsgSchema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BaseModel</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    todo_list</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">tuple</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">bool</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Field</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> description</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Todo list&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">to_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">self</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Render todo list message as HTML&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> done</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> item </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> self</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">todo_list</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            checked </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;checked&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> done </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            item_class </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;completed&quot;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> done </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pending&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            items</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">append</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;&lt;li class=&quot;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">item_class</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;&gt;&lt;input type=&quot;checkbox&quot; </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">checked</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> disabled&gt; </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">item</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/li&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        items_html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n&quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">items</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;&quot;&quot;&lt;div class=&quot;todo-list-message&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;h4&gt;Todo List&lt;/h4&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;ul class=&quot;todo-list&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">items_html</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;/ul&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;/div&gt;&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">get_structural_tag_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tags</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">StructuralTag</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> triggers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;type&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;structural_tag&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;structures&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_dump</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> model </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> tags</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;triggers&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> triggers</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">parse_structured_response</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Parse structured response and convert blocks to HTML&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Schema mapping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schema_classes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;text&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TextMsgSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;image&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ImageMsgSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;tool_use&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ToolUseMsgSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;todo_list&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> TodoListMsgSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&quot;html&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> HTMLMsgSchema</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">replace_block</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">match</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tag_type </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">match</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        content </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">match</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">strip</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> tag_type </span><span class="token keyword" style="color:#00009f">not</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> schema_classes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">match</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">group</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># Return original if unknown tag</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">try</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Parse JSON content</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">loads</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Create schema instance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            schema_instance </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> schema_classes</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">tag_type</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">**</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token comment" style="color:#999988;font-style:italic"># Return HTML</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> schema_instance</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">to_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">except</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">JSONDecodeError</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ValueError</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> e</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token string-interpolation string" style="color:#e3116c">f&#x27;&lt;div class=&quot;error&quot;&gt;Error parsing </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">tag_type</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"> block: </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">e</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/div&gt;&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># Replace all &lt;block=type&gt;content&lt;/block&gt; with HTML</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pattern </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">r&quot;&lt;block=(\w+)&gt;\s*(.*?)\s*&lt;/block&gt;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sub</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pattern</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> replace_block</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> flags</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">re</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">DOTALL</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">create_comparison_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response1</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response2</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Create a comparison HTML page with both responses&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    parsed_response2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> parse_structured_response</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    css </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;style&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        body {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            font-family: -apple-system, BlinkMacSystemFont, &#x27;Segoe UI&#x27;, Roboto, sans-serif;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 20px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background-color: #f5f5f5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .container {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            max-width: 1200px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 0 auto;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: white;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 8px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            box-shadow: 0 2px 10px rgba(0,0,0,0.1);</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            overflow: hidden;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .header {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #2563eb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: white;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 20px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            text-align: center;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .comparison {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            display: flex;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            min-height: 600px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .column {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            flex: 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 20px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-right: 1px solid #e5e5e5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .column:last-child {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-right: none;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .column h3 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin-top: 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: #1f2937;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-bottom: 2px solid #e5e5e5;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding-bottom: 10px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .content {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            line-height: 1.6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: #374151;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        </span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        /* Schema-specific styles */</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .text-message {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #f8fafc;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 15px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 8px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-left: 4px solid #3b82f6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .image-message {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #f0fdf4;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 15px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 8px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-left: 4px solid #10b981;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            text-align: center;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .image-caption {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0 0 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            font-style: italic;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: #6b7280;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .tool-use-message {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #fefce8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 15px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 8px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-left: 4px solid #eab308;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .tool-use-message h4 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 0 0 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: #92400e;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .tool-args, .tool-output {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .tool-args pre, .tool-output pre {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #1f2937;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: #f9fafb;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 10px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 4px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            overflow-x: auto;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .todo-list-message {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #fdf2f8;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 15px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 8px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-left: 4px solid #ec4899;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .todo-list-message h4 {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 0 0 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: #be185d;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .todo-list {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            list-style: none;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .todo-list li {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 5px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 5px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .todo-list li.completed {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            text-decoration: line-through;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            opacity: 0.7;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .html-message {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #f5f3ff;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 15px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 8px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-left: 4px solid #8b5cf6;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        .error {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            background: #fef2f2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            color: #dc2626;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            padding: 15px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-radius: 8px;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            margin: 10px 0;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            border-left: 4px solid #dc2626;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        pre {</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            white-space: pre-wrap;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">            word-wrap: break-word;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &lt;/style&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token triple-quoted-string string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &lt;!DOCTYPE html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &lt;html lang=&quot;zh-CN&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &lt;head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;title&gt;模型响应对比&lt;/title&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">css</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &lt;/head&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &lt;body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;div class=&quot;container&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;div class=&quot;header&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;h1&gt;模型响应对比&lt;/h1&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;p&gt;左侧：无结构化标签 | 右侧：带结构化标签（已渲染）&lt;/p&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;div class=&quot;comparison&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;div class=&quot;column&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                    &lt;h3&gt;无 Structure Tag&lt;/h3&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                    &lt;div class=&quot;content&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                        &lt;pre&gt;</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">response1</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&lt;/pre&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                    &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;div class=&quot;column&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                    &lt;h3&gt;Structure Tag（已渲染）&lt;/h3&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                    &lt;div class=&quot;content&quot;&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                        </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">parsed_response2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                    &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">                &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">            &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">        &lt;/div&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &lt;/body&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &lt;/html&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;__main__&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base_url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;localhost:8000/v1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> openai</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OpenAI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">base_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">base_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> api_key</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;sk-&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schemas </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TextMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ImageMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ToolUseMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        TodoListMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HTMLMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    schemas_str </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;\n- &quot;</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">json</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dumps</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> indent</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> s </span><span class="token keyword" style="color:#00009f">in</span><span class="token plain"> schemas</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sys_prompt </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string-interpolation string" style="color:#e3116c">f&quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">你是一个agent模型，你负责处理用户的问题，发起工具调用, 绘制图片、html、获取文本等。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">由于你的token交互量很大，不是所有信息都需要展示给前端。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">你可以正常思考和输出，但你需要将你认为需要展示给用户的有效信息包裹在 `&lt;block={{tag}}&gt; {{schema}} &lt;/block&gt;` 中。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">前端会将这部分内容进行渲染，交给用户。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">你现在可用的tag有:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">tags: &quot;text&quot;, &quot;image&quot;, &quot;tool_use&quot;, &quot;todo_list&quot;, &quot;html&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">对应的schema(pydantic格式)如下:</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">- </span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">schemas_str</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">例如，你可以先产生一个todo list，然后不断执行子任务，并更新todo list，直到所有任务完成。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">由于你现在没有接入工具调用，所以对于所有工具调用交互，你只需要“假装”执行了工具调用并得到一个合理的响应就行，这是一个debug环境，</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">你需要根据用户的问题尽可能多的展示不同的block，并给出一个合理的响应。</span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="display:inline-block;color:#e3116c"></span><br></span><span class="token-line" style="color:#393A34"><span class="token string-interpolation string" style="color:#e3116c">    &quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    base_url </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;http://localhost:8000/v1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_name </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;stelterlab/Mistral-Small-3.2-24B-Instruct-2506-FP8&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    api_key </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sk-&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        base_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">base_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api_key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">api_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temperature</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top_p</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">print</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;-&quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">50</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> colorlog</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getLogger</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;Agent&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    msgs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        SystemMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">content</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">sys_prompt</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HumanMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            content</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;帮我完成编写一个论坛帖子，打开浏览器的水源社区论坛，登录之后在discourse发帖的流程。&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    model_v2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ChatOpenAI</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        base_url</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">base_url</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        model</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">model_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        api_key</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">api_key</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        temperature</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.15</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        top_p</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">0.9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extra_body</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&quot;response_format&quot;</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> get_structural_tag_params</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tags</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=text&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TextMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=image&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ImageMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=tool_use&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">ToolUseMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=todo_list&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">TodoListMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    StructuralTag</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        begin</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;block=html&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        end</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;&lt;/block&gt;&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        schema</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">HTMLMsgSchema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">model_json_schema</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                triggers</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;&lt;block=&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== 测试开始 ===&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msgs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;=== 测试结束 ===\n</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">response1</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;=== 测试开始 ===&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    response2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> model_v2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">invoke</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msgs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">content</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string-interpolation string" style="color:#e3116c">f&quot;=== 测试结束 ===\n</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">{</span><span class="token string-interpolation interpolation">response2</span><span class="token string-interpolation interpolation punctuation" style="color:#393A34">}</span><span class="token string-interpolation string" style="color:#e3116c">&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 生成对比HTML文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    comparison_html </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> create_comparison_html</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> response2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tmp/test_comparison.html&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write_text</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        comparison_html</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encoding</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;utf-8&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    logger</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">info</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;已生成对比HTML文件: tmp/test_comparison.html&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 保留原有的Markdown文件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">with</span><span class="token plain"> Path</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;tmp/test_diff.md&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token builtin">open</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;w&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> encoding</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;utf-8&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;无structure tag: \n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;\n\nstructure tag: \n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        f</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rag">rag</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/agent">agent</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/Ask in Any Modality A Comprehensive Survey on Multimodal Retrieval-Augmented Generation">Paper reading-Ask in Any Modality A Comprehensive Survey on Multimodal Retrieval-Augmented Generation</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-02T00:00:00.000Z">June 2, 2025</time> · <!-- -->16 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><p>RAG 抽象来说就是，<code>embed - opitional[rerank] - generate</code>管道</p>
<p>有许多的增强方案，例如 Plan X RAG（将问题分解为子问题的DAG，然后设计一些critic LLM判断流的状态正常与否，一个执行LLM按照拓扑序执行DAG），Agentic RAG,  feedback-driven iterative refinement</p>
<p>局限是：传统RAG主要针对文本，多模态集成还是挑战</p>
<p>流程概述如下图</p>
<hr>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2502.08826v2/extracted/6211743/MM-RAG-500.png" alt="Refer to caption" class="img_ev3q"></p>
<hr>
<h1>Multimodel RAG</h1>
<p>LLM拓展为MLLM带来了多模态RAG的挑战</p>
<ul>
<li><strong>检索哪些模态</strong></li>
<li><strong>数据类型的有效融合</strong></li>
<li><strong>跨模态相关性</strong></li>
</ul>
<p><strong>特定模态的编码器将不同的模态映射到共享语义空间，实现跨模态对齐</strong></p>
<hr>
<h1>现有数据集和基准</h1>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="数据集">数据集<a class="hash-link" aria-label="Direct link to 数据集" title="Direct link to 数据集" href="/blog/tags/ai#数据集">​</a></h2>
<ul>
<li>
<p>图文任务（字幕、检索）：MS-COCO, Flickr30K, LAION-400M</p>
</li>
<li>
<p>利用外部知识的视觉问答: OK-VQA</p>
</li>
<li>
<p>多模态推理：MultimodalQA</p>
</li>
<li>
<p>视频文本任务：ActivityNet，YouCook2</p>
</li>
<li>
<p>医学：MIMIC-CXR</p>
</li>
</ul>
<p>许多数据集都是单模态的，随后与其他模态的互补数据集集成。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="benchmark">Benchmark<a class="hash-link" aria-label="Direct link to Benchmark" title="Direct link to Benchmark" href="/blog/tags/ai#benchmark">​</a></h2>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>M</mi><mn>2</mn></msup><mtext>⁢</mtext><mi>R</mi><mtext>⁢</mtext><mi>A</mi><mtext>⁢</mtext><mi>G</mi></mrow><annotation encoding="application/x-tex">M^2⁢R⁢A⁢G</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em">M</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em"><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord">⁢</span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mord">⁢</span><span class="mord mathnormal">A</span><span class="mord">⁢</span><span class="mord mathnormal">G</span></span></span></span>:
我们执行以下步骤来处理图像，以确保它们具有高质量并且与用户查询相关：
（1）<strong>缓存和转换</strong>：使用 URL 下载所有图像，并将其转换为广泛接受的格式，例如 JPG、PNG、GIF 或 WEBP。无法成功下载或转换的图像将被丢弃；
（2）<strong>过滤</strong>：小于某个阈值或与查询文本的基于 CLIP 相似度得分较低的图像将被删除。此类图像通常包含非代表性的视觉内容，例如图标、横幅等。
（3）<strong>重复数据删除</strong>：使用 PHash Zauner 算法删除重复或高度相似的图像。</p>
<p>指标设计：<strong>主要靠prompt gpt-4o做评估</strong></p>
<ul>
<li>文本模态指标：流畅性，相关性，忠实度，上下文准确率</li>
<li>多模态指标：图像连贯性（图像和周围文本逻辑的连贯性，图像有用性， 图像引用（验证图像和文本引用的适当性），图像召回率（高度相关图像的召回比例）</li>
<li>取所有指标的平均值用于计算总分</li>
</ul>
<hr>
<h1>两种联合建模策略</h1>
<ul>
<li>single-stage：直接生成多模态输出</li>
<li>multi-stage: <strong>文本生成 - 图像插入 - 文本重润色</strong> 三个阶段</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2411.16365v3/x1.png" alt="" class="img_ev3q"></p>
<hr>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2411.16365v3/x2.png" alt="Refer to caption" class="img_ev3q"></p>
<hr>
<h1>视觉为中心的评估</h1>
<p>MRAG-Bench, VQAv2, VisDoMBench, Dyn-VQA, ScienceQA</p>
<p><img decoding="async" loading="lazy" src="https://mragbench.github.io/static/images/teaser.png" alt="img" class="img_ev3q"></p>
<hr>
<h1>知识密集型评估</h1>
<p>TriviaQA, RAG Check, Natural Questions</p>
<hr>
<p><img decoding="async" loading="lazy" alt="image-20250528162131659" src="/assets/images/image-20250528162131659-62018707c1a0f00cfba6a516a14268bc.png" width="1590" height="831" class="img_ev3q"></p>
<hr>
<p><img decoding="async" loading="lazy" alt="image-20250528162212109" src="/assets/images/image-20250528162212109-27a90337735939c22a158260b068557b.png" width="1639" height="793" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="创新和方法">创新和方法<a class="hash-link" aria-label="Direct link to 创新和方法" title="Direct link to 创新和方法" href="/blog/tags/ai#创新和方法">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="检索策略">检索策略<a class="hash-link" aria-label="Direct link to 检索策略" title="Direct link to 检索策略" href="/blog/tags/ai#检索策略">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="高效和精度">高效和精度<a class="hash-link" aria-label="Direct link to 高效和精度" title="Direct link to 高效和精度" href="/blog/tags/ai#高效和精度">​</a></h4>
<p>现代MRAG<strong>将不同输入模态编码到统一的embedding空间实现直接跨模态检索</strong></p>
<p>方法上，主要为Maximum inner product search (<strong>MIPS</strong>) 变体：近似MIPS，分布式MIPS，KNN变体，近似KNN，ScaNN</p>
<ul>
<li>ScaNN主要结合了一些数学方法 和 量化方法构建了足够快的向量检索索引，这类方法都是用于海量数据的（如1M）</li>
<li>专注于CPU，例如做了很多量化优化让它能尽量利用现代CPU的simd指令 <a href="https://zilliz.com/blog/faiss-vs-scann-choosing-the-right-tool-for-vector-search" target="_blank" rel="noopener noreferrer">https://zilliz.com/blog/faiss-vs-scann-choosing-the-right-tool-for-vector-search</a></li>
</ul>
<hr>
<p>创新主要在效率提升和精度降低：</p>
<ul>
<li>混合搜索</li>
<li>自适应量化</li>
<li>learned index: 神经网络驱动的索引建立，主要是数据库那边的工作</li>
</ul>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="以模态为中心的检索">以模态为中心的检索<a class="hash-link" aria-label="Direct link to 以模态为中心的检索" title="Direct link to 以模态为中心的检索" href="/blog/tags/ai#以模态为中心的检索">​</a></h4>
<p>文本中心</p>
<ul>
<li>BM25</li>
<li>bge-m3</li>
<li>ColBERT</li>
<li>RAFT(混合干扰和ground truth文档微调模型增强抗干扰能力)</li>
<li>...</li>
</ul>
<hr>
<p>视觉中心</p>
<ul>
<li>直接用图像表示进行知识提取</li>
<li>基于参考图像的检索，如EchoSight和ImgRet<!-- -->
<ul>
<li>EchoSight 引入了多模态重排</li>
<li><img decoding="async" loading="lazy" src="https://go2heart.github.io/echosight/static/images/teaser.png" alt="Teaser" class="img_ev3q"></li>
</ul>
</li>
</ul>
<hr>
<p>具体来说，对于一个图文问题query, 先用image视觉相似度找到对应的wiki条目，再将wiki的section与图+文的完整query（经过Q-Former之后）进行文本rerank，最后综合视觉分数和文本rerank分数，选取topk后输入LLM。<strong>专注于问题和知识库都是图+文的情况</strong>，也只是finding, 感觉确实创新度不够
<img decoding="async" loading="lazy" src="https://go2heart.github.io/echosight/static/images/overall.png" alt="Overall Structure h:500" class="img_ev3q"></p>
<hr>
<ul>
<li>组合多张图像特征形成综合查询表示</li>
<li>图文映射：Pic2word 如下图，将视觉映射到文本描述</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEjkH5SDYcnCCNSbv4tyJ7lEaZp4W0SsMVP2rBTx8-AnXGM2eYaY04UX9sczYL07-z9TPvcbKP5wF6huVyWe6SOQqqz_iE9Ove-RupgS0e50E5StD1A_yKF2KQtrVgy01J6WaLUZ4rYatFQqgBEnoltPBRXAqTgcGmuD8hVJ3BBkEi55ASVhMy35-_j1yCjs/s16000/image3.png" alt="img" class="img_ev3q"></p>
<hr>
<p>视频中心</p>
<ul>
<li>iRAG，增量检索</li>
<li>MV-Adapter</li>
<li>Video RAG</li>
<li>RTime: 时间因果关系</li>
<li>OmAgent：分治处理复杂视频理解</li>
<li>DRVideo：基于文档检索处理长视频理解</li>
<li>...</li>
</ul>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="文档检索和布局理解">文档检索和布局理解<a class="hash-link" aria-label="Direct link to 文档检索和布局理解" title="Direct link to 文档检索和布局理解" href="/blog/tags/ai#文档检索和布局理解">​</a></h4>
<p>ColPali， ColQwen2: 端到端文档图像检索，动态分辨率处理，整体多页推理，绕过OCR技术，1.9k star</p>
<p>它的想法是这样的</p>
<ul>
<li><strong>OCR的多个组件和分块带来误差传播</strong>，且预处理流程耗时也长，能不能直接端到端一次使用文档截图解决</li>
<li>但是如果将整页的文档编码成一个向量，肯定精度不够</li>
<li>多向量方案最经典的ColBERT, 并且在这样一个视觉的情况下，<strong>视觉patch做多向量比文本token还合理</strong></li>
</ul>
<hr>
<ul>
<li>贡献<!-- -->
<ul>
<li>benchmark ViDoRe</li>
<li>将ColBERT和视觉语言模型结合，利用多向量不仅启发了<strong>文搜文，文搜图，还启发了“给一个文档，查找相似的文档”这样的任务</strong></li>
<li>提供了一个良好的视觉文本融合的范式（例如，解决了CLIP这样的模型缺乏文本细粒度的问题），允许最先进的VLM如Qwen-VL-2B，以相同的训练策略微调后作为嵌入器，+5.3 nDCG@5</li>
</ul>
</li>
</ul>
<hr>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2407.01449v6/extracted/6240861/images/final_architecture.png" alt="Refer to caption" class="img_ev3q"></p>
<hr>
<p><strong>可不可以将这个范式沿用到引用溯源？</strong></p>
<p>已经有一些了，ColPali自己就做了每个词条最显著的图像块</p>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2407.01449v6/extracted/6240861/images/similarity_map_energy.png" alt="Refer to caption h:500" class="img_ev3q"></p>
<p>一些布局理解的新框架：ViTLP, DocLLM, CREAM, mPLUG-DocOwl</p>
<hr>
<blockquote>
<p><em>To our knowledge, no benchmark evaluates document retrieval systems in practical settings; in an end-to-end manner, across several document types and topics, and by evaluating the use of both textual and visual document features.</em></p>
</blockquote>
<blockquote>
<p><a href="https://huggingface.co/blog/fsommers/document-similarity-colpali" target="_blank" rel="noopener noreferrer">https://huggingface.co/blog/fsommers/document-similarity-colpali</a>
基于 OCR 的文本提取，以及随后的布局和边界框分析，仍然是重要文档 AI 模型（例如 LayoutLM）的核心。例如， <a href="https://huggingface.co/microsoft/layoutlmv3-base" target="_blank" rel="noopener noreferrer">LayoutLMv3</a> 对文档文本进行编码，包括文本标记序列的顺序、标记或线段的 OCR 边界框坐标以及文档本身。这在关键的文档 AI 任务中取得了最佳成果，但前提是第一步——OCR 文本提取——能够顺利完成。</p>
<p><strong>但通常情况并非如此。</strong></p>
<p>根据我最近的经验，<strong>OCR 瓶颈导致现实世界生产文档档案中的命名实体识别 (NER) 任务的性能下降近 50%。</strong></p>
</blockquote>
<hr>
<p><img decoding="async" loading="lazy" src="https://huggingface.co/datasets/huggingface/documentation-images/resolve/main/blog/paligemma/paligemma_arch.png" alt="Architecture h:600" class="img_ev3q"></p>
<hr>
<p>为下游任务提供了一系列微调版本</p>
<ul>
<li>Image Caption 加字幕</li>
<li>VQA</li>
<li>Detection (Detect [entity])</li>
<li>图像实体分割</li>
<li>文档理解</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="重排序和选择">重排序和选择<a class="hash-link" aria-label="Direct link to 重排序和选择" title="Direct link to 重排序和选择" href="/blog/tags/ai#重排序和选择">​</a></h3>
<p>多用多步骤检索，整合监督和非监督策略</p>
<ul>
<li>probabilistic control keywords to improve credibility<!-- -->
<ul>
<li>对示例的关键信息进行关键词提取，为关键词赋予概率权重，使用概率进行控制信号，<strong>让模型倾向于选择高概率关键词的示例</strong></li>
</ul>
</li>
<li>RULE 利用<strong>统计方法</strong>(Bonferroni校正)校准相关上下文<!-- -->
<ul>
<li>利用统计方法，将“5%概率<strong>存在</strong>错误上下文”这样的朴素要求通过统计运算转换成单个上下文相关度的硬阈值</li>
</ul>
</li>
<li>视频检索中<strong>基于聚类的关键帧选择</strong>来提高多样性</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="相关性评估">相关性评估<a class="hash-link" aria-label="Direct link to 相关性评估" title="Direct link to 相关性评估" href="/blog/tags/ai#相关性评估">​</a></h3>
<ul>
<li><strong>SSIM (Structural Similarity Index Measure)</strong>
最早用于图像领域，衡量两幅图像间的结构、亮度、对比度相似度。现在常用于多模态信息检索，例如图片和文本联合时的相似性计算。<!-- -->
<ul>
<li>比起传统的均方差等简单像素差，更符合人类对视觉感知的一致性判断，综合考虑亮度对比度等</li>
</ul>
</li>
<li><strong>NCC (Normalized Cross-Correlation)</strong>
标准化互相关，常见于信号处理，也可以衡量不同模态数据间的相关强度。<!-- -->
<ul>
<li>衡量两个向量或数组的<strong>线性相关性</strong></li>
</ul>
</li>
<li><strong>BERTScore</strong>
利用BERT这样的深度语义模型计算文本  间的语义相似度，比传统关键词对齐更关注上下文语义一致性</li>
<li>分层后处理：重排、相似度筛选、上下文窗口、合并、...</li>
</ul>
<hr>
<ul>
<li>
<p><strong>LDRE</strong></p>
<p>结合多种特征（如caption描述、上下文语义、实体识别等），通过权重自适应集成，提高不同表示方式下的检索相关性适应能力</p>
</li>
<li>
<p>BM25等传统排名的集成</p>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="过滤机制">过滤机制<a class="hash-link" aria-label="Direct link to 过滤机制" title="Direct link to 过滤机制" href="/blog/tags/ai#过滤机制">​</a></h3>
<ul>
<li>
<p>硬负样本挖掘：比起文本的硬负样本挖掘需要多处理跨模态的问题，如不同模态的bias等</p>
<ul>
<li>GME</li>
<li>MM Embed</li>
</ul>
</li>
<li>
<p>共识过滤、多向量过滤</p>
<ul>
<li>MuRAR</li>
<li>ColPali</li>
</ul>
</li>
<li>
<p>动态模态过滤</p>
<ul>
<li>训练retriever判断哪部分是噪声</li>
<li>RAFT, Img2Loc, MAIN-RAG</li>
</ul>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="融合机制">融合机制<a class="hash-link" aria-label="Direct link to 融合机制" title="Direct link to 融合机制" href="/blog/tags/ai#融合机制">​</a></h3>
<p>分数融合和对齐</p>
<ul>
<li>
<p>训练交叉编码器将多模态转换为文本格式</p>
</li>
<li>
<p>引入交错文本对，合并垂直多张few shot images（?）</p>
</li>
<li>
<p>CLIP分数融合，BLIP特征融合，嵌入到相同的空间</p>
</li>
<li>
<p>VISA 使用文档截图嵌入(DSE)模型，对齐文本查询和视觉文档表示</p>
</li>
<li>
<p>MA-LMM视频文本嵌入</p>
</li>
<li>
<p>LLM-RA 将文本和视觉嵌入连接成联合查询</p>
</li>
<li>
<p>...</p>
</li>
</ul>
<p>注意力机制：</p>
<p>注意力方法动态加权跨模态交互，支持特定任务推理</p>
<p>EMERGE, MORE, Alzheimer RAG,RAMM,RAGTrans, MV-Adapter, M2-RAAP</p>
<hr>
<p>统一的框架和预测</p>
<p>M3DocRAG : 多页文档展平为单个嵌入张量</p>
<p>PDF-MVQA 融合了基于感兴趣区域 (RoI) 和基于块 (CLIP) 的视觉语言模型</p>
<p>DQU-CIR 图像转换为复杂查询的文本标题以及将文本叠加到图像上来统一原始数据，然后通过 MLP 学习的权重融合嵌入</p>
<p>SAM-RAG生成图像的标题来对齐图像-文本模态</p>
<p>UFineBench 利用共享粒度解码器进行超精细文本人物检索</p>
<p>Dense2Sparse 投影，将来自 BLIP/ALBEF Li 等人 ( <a href="https://arxiv.org/html/2502.08826v2#bib.bib111" target="_blank" rel="noopener noreferrer">2022a</a> ) 等模型的密集嵌入转换为稀疏词汇向量，使用层归一化和概率扩展控制来优化存储和可解释性</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="增强技术">增强技术<a class="hash-link" aria-label="Direct link to 增强技术" title="Direct link to 增强技术" href="/blog/tags/ai#增强技术">​</a></h3>
<p>Context Enrichment</p>
<p>查询 重构为结构化检索请求， Video-RAG,EMERGE 整合实体关系和语义描述</p>
<p>Img2Loc 提示中包含数据库中最相似的和最不相似的点来让模型排除预测中不可信的位置</p>
<p>虽然说只是prompt工作，但想法似乎挺有趣，只是这样的作法能否比简单的几层MLP强呢？</p>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2403.19584v1/extracted/2403.19584v1/figure3.jpg" alt="Refer to caption h:400" class="img_ev3q"></p>
<hr>
<p>动态检索</p>
<ul>
<li>
<p>SKURG 查询复杂度决定跳数</p>
</li>
<li>
<p>MR2AG 动态评估和过滤</p>
</li>
<li>
<p>OmniSearch 分解问题</p>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="生成技术">生成技术<a class="hash-link" aria-label="Direct link to 生成技术" title="Direct link to 生成技术" href="/blog/tags/ai#生成技术">​</a></h3>
<ul>
<li>
<p>In context learning</p>
<ul>
<li>
<p>记忆数据 RAG-Driver（可解释的自动驾驶）</p>
<ul>
<li><strong>检索引擎</strong>
接收到当前驾驶场景（如视频帧和对应的车辆控制信号）后，先在专家示范的记忆库中检索出与当前最相似的历史驾驶样本。</li>
<li><strong>多模态大语言模型处理</strong>
将检索到的样本与当前场景一同输入多模态大语言模型（MLLM），利用指令微调（Instruction Tuning），实现三项任务：<!-- -->
<ul>
<li><strong>动作解释</strong>（Driving Action Explanation）：输出当前行为的自然语言解释；</li>
<li><strong>行为理由</strong>（Action Justification）：对决策作出合理性说明；</li>
<li><strong>控制信号预测</strong>（Control Signal Prediction）：给出下一个动作的具体数值（如速度和转角）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<p><img decoding="async" loading="lazy" src="https://yuanjianhao508.github.io/RAG-Driver/static/images/RAGDriver_main.png" alt="MY ALT TEXT h:600" class="img_ev3q"></p>
<hr>
<ul>
<li>
<p>融合上下文Fusion-in-Context Learning (没太看懂RAVEN这篇论文和融合上下文这一个比较早期的encoder-decoder模型的机制有什么关系)</p>
</li>
<li>
<p>Reasoning</p>
<ul>
<li>CoT RAGAR RAG链和RAG树，迭代方式优化事实核查</li>
<li>VisDoM CoT和证据整理</li>
<li>SAM-RAG 推理链和多阶段验证</li>
</ul>
</li>
</ul>
<p>指令调优：如mR2AG 用 mR2AG-IT的数据调优MLLM</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="来源归属">来源归属<a class="hash-link" aria-label="Direct link to 来源归属" title="Direct link to 来源归属" href="/blog/tags/ai#来源归属">​</a></h3>
<p>VISA 视觉来源归属</p>
<ul>
<li>看了看他的论文，VLM<strong>直接输出</strong>边界框(也就是，输入为文档图片，输出为答案 + Box)的，再<strong>LoRA微调</strong>......</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20250528205321419 h:400" src="/assets/images/image-20250528205321419-2f1eec60f2c657b45d90932b2e0c898a.png" width="956" height="538" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="对齐">对齐<a class="hash-link" aria-label="Direct link to 对齐" title="Direct link to 对齐" href="/blog/tags/ai#对齐">​</a></h3>
<p>主要是对比学习：文档/图片/字幕...</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="噪声管理">噪声管理<a class="hash-link" aria-label="Direct link to 噪声管理" title="Direct link to 噪声管理" href="/blog/tags/ai#噪声管理">​</a></h3>
<p>RagVL 噪声注入训练，数据级别加负样本，token级别加Gauss噪声</p>
<p>RA-CM3  随机删除查询token做query dropout</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="mrag解决的任务">MRAG解决的任务<a class="hash-link" aria-label="Direct link to MRAG解决的任务" title="Direct link to MRAG解决的任务" href="/blog/tags/ai#mrag解决的任务">​</a></h2>
<ul>
<li>图像字幕</li>
<li>QA</li>
<li>事实验证</li>
<li>视觉叙事连贯性</li>
<li>图文检索</li>
<li>.....</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="未来方向">未来方向<a class="hash-link" aria-label="Direct link to 未来方向" title="Direct link to 未来方向" href="/blog/tags/ai#未来方向">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="泛化">泛化<a class="hash-link" aria-label="Direct link to 泛化" title="Direct link to 泛化" href="/blog/tags/ai#泛化">​</a></h3>
<ul>
<li>
<p>领域自适应</p>
</li>
<li>
<p>模态偏差，过度依赖文本</p>
</li>
<li>
<p>可解释性</p>
</li>
<li>
<p>引用来源归属，在视觉/语音等模块更严重，难以识别出对应的小区域</p>
</li>
<li>
<p>多模态的对抗性扰动，误导性信息</p>
</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="推理">推理<a class="hash-link" aria-label="Direct link to 推理" title="Direct link to 推理" href="/blog/tags/ai#推理">​</a></h3>
<p>多模态融入KG</p>
<p>如何进行实体感知检索</p>
<p>位置敏感  性</p>
<p>冗余检索</p>
<p>具身智能</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="长上下文效率可拓展">长上下文，效率，可拓展<a class="hash-link" aria-label="Direct link to 长上下文，效率，可拓展" title="Direct link to 长上下文，效率，可拓展" href="/blog/tags/ai#长上下文效率可拓展">​</a></h3>
<ul>
<li>带图像的多页文档</li>
<li>视频这种超长上下文</li>
</ul></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mllm">mllm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/精读 AAAI 2025 Fit and Prune Fast and Training-free Visual Token Pruning for Multi-modal Large Language Models">Paper reading - Fit and Prune Fast and Training-free Visual Token Pruning for Multi-modal Large Language Models</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-02T00:00:00.000Z">June 2, 2025</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="任务">任务<a class="hash-link" aria-label="Direct link to 任务" title="Direct link to 任务" href="/blog/tags/ai#任务">​</a></h2>
<p>当前MLLM依赖于<strong>大量的视觉token</strong>做出高精度的视觉推理，例如LLaVa使用576 image patches as visual tokens，这相较于纯文本带来了<strong>6.2</strong>倍的计算时长开销。此外，一些其他工作正在使用提高图像 分辨率的方法来缓解MLLM的视觉缺陷，但<strong>进一步加剧了计算量</strong>。</p>
<p>作者想要得到一种方法来在MLLM的<strong>图像token输入</strong>中，进行压缩，从而进行<strong>推理时的加速</strong>，且不能太影响下游任务精度。</p>
<p>同时，作者认为先前的方法依赖于大量的实验来确定超参数，他提出的方法需要具有一定的<strong>泛化能力</strong>，并且<strong>超参数确认简单</strong> <code>can be obtained in about 5 minutes for all VL tasks</code></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">motivation<a class="hash-link" aria-label="Direct link to motivation" title="Direct link to motivation" href="/blog/tags/ai#motivation">​</a></h2>
<ol>
<li>大规模视觉token在MLLM中的存在明显的冗余，MLLMs 的多头注意力机制是单向的，而非真正“全局”的。简而言之，MLLMs 仅将信息从前一个标记传递到后一个标记，其视觉标记通常置于文本问题之前。在这种情况下，它们主要作用是为文本标记提供视觉语义，但实际上其中大部分并未被激活。</li>
</ol>
<p><img decoding="async" loading="lazy" src="https://pic4.zhimg.com/v2-8df5d0c2852ba56e89010c2fe91b9bb9_1440w.jpg" alt="img" class="img_ev3q"></p>
<hr>
<p>如图，大部分蓝色部分（不相关语义）实际上几乎不参加推理，图像到文本注意力非常集中。</p>
<p><img decoding="async" loading="lazy" alt="image-20250527131819120" src="/assets/images/image-20250527131819120-c14d369820575726608d4915d598be9a.png" width="813" height="618" class="img_ev3q"></p>
<hr>
<ol start="2">
<li>作者将确定压缩比例这一超参数的问题转换成一个统计问题。将压缩问题转换为这样的问题：<strong>给定一个采样样本集合</strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span></span></span></span>, 再给定一个计算开销<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03785em">δ</span></span></span></span> ，设压缩策略为<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>， 目标是找到<strong>一个压缩比够大</strong>（满足计算开销到<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03785em">δ</span></span></span></span>以下）的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>，<strong>使得在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span></span></span></span>上整体的注意力分布变化最小</strong></li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="方法">方法<a class="hash-link" aria-label="Direct link to 方法" title="Direct link to 方法" href="/blog/tags/ai#方法">​</a></h2>
<p><strong>作者只对多头注意力层进行修剪</strong></p>
<p><img decoding="async" loading="lazy" alt="image-20250527155650905" src="/assets/images/image-20250527155650905-1e815d1abeb04e6857086fe406cca405.png" width="1609" height="741" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="得到修剪策略">得到修剪策略<a class="hash-link" aria-label="Direct link to 得到修剪策略" title="Direct link to 得到修剪策略" href="/blog/tags/ai#得到修剪策略">​</a></h2>
<p>对于采样样本集<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span></span></span></span>, 计算每一层的视觉token自注意力和视觉-文本交叉注意力。假设视觉token数N，文本token数M，第i层的第j个视觉token的平均注意力为 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>a</mi><mrow><mi>s</mi><mo separator="true">,</mo><mi>c</mi></mrow><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msubsup><mo>=</mo><msubsup><mo>∑</mo><mrow><mi>m</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><msubsup><mi>A</mi><mrow><mi>m</mi><mo separator="true">,</mo><mi>j</mi></mrow><mi>i</mi></msubsup></mrow><annotation encoding="application/x-tex">a_{s,c}^{i,j}=\sum_{m=1}^{N}A_{m,j}^{i}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2078em;vertical-align:-0.3831em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">s</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">c</span></span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:1.376em;vertical-align:-0.3948em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.9812em"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mrel mtight">=</span><span class="mord mtight">1</span></span></span></span><span style="top:-3.2029em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em">N</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2997em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">A</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">m</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3948em"><span></span></span></span></span></span></span></span></span></span>, s和c分别代表自注意和交叉注意，A代表是在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.02778em">D</span></span></span></span>上取的平均</p>
<p>移除策略P可以建模成<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><msubsup><mi>t</mi><mn>1</mn><mo>∗</mo></msubsup><mo separator="true">,</mo><msubsup><mi>t</mi><mn>2</mn><mo>∗</mo></msubsup><mo separator="true">,</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><msubsup><mi>t</mi><mi>k</mi><mo>∗</mo></msubsup><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[t_1^*, t_2^*,...t_k^*]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0331em;vertical-align:-0.2831em"></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em"><span style="top:-2.4519em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2481em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord">...</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em"><span style="top:-2.4169em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em">k</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span> (假设模型有k层)</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>t</mi><mi>i</mi><mo>∗</mo></msubsup></mrow><annotation encoding="application/x-tex">t_i^*</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.2587em"></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.6887em"><span style="top:-2.4413em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mbin mtight">∗</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2587em"><span></span></span></span></span></span></span></span></span></span>表示在<strong>第i层新移除的token数量</strong>，注意前面层移除的token也不会传递给后面层，也就是说移除的总数是单调增的</p>
<p>采用一个注意力相差阈值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>和计算开销<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03785em">δ</span></span></span></span>两者一起控制裁剪，具体来说，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03785em">δ</span></span></span></span>是提前给定的  ，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>是二分查找计算出来的值</p>
<hr>
<p><img decoding="async" loading="lazy" alt="height:600 width:500" src="/assets/images/image-20250527153710785-90079defd43229432666e6978e287317.png" width="746" height="932" class="img_ev3q"></p>
<hr>
<p>用通俗的话翻译就是:</p>
<ol>
<li>将注意力分布的差别简化为平均每个token的自注意力/交叉注意力<strong>之和</strong>的差别，即是否删除某个token，注意力和的<strong>相对变化</strong>需要小于阈值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span></li>
<li>由于只计算和，所以可以对自注意力、交叉注意力两个集合分别按照大小排序 —— 注意力分布变化最小的保证转化为，总是优先考虑删除注意力最小的token</li>
<li>给定一个阈值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>, 对于每一层遍历，对于自  注意力、交叉注意力分别不断尝试删除token，直到注意力变化达到阈值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>, 而这一层最后的策略P，即token删除数量为自注意力删除集合<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>s</mi></msub></mrow><annotation encoding="application/x-tex">T_s</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>和交叉注意力集合<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>T</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">T_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em">T</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>的<strong>交集的大小</strong></li>
<li>现在有了一个删除策略<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>, 计算它是否满足计算开销约束（文中并没有具体说是怎么计算的，应该是根据模型的删除后token和参数量估算FLOPS，或者是某种直接测量计算量的工具，用的显卡是单张A100）</li>
</ol>
<hr>
<ol start="5">
<li>
<p>如果满足，说明删除策略<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>是可行的，但说不定<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>太大删除太多了，需要调小<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>；如果不满足，说明删除策略<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>不可行，说明<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>太小了，需要调大<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>。因此，二分查找<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>直到找到一个满足计算开销约束的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>，且这个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>的左右区间长度小于阈值<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>ϵ</mi></mrow><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal">ϵ</span></span></span></span>(后文实验是0.01)，则这个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>对应的删除策略<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>就是最终的删除策略。</p>
</li>
<li>
<p>最后效果是在满足计算开销约束<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi></mrow><annotation encoding="application/x-tex">\delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03785em">δ</span></span></span></span>的情况下，尽可能保留更多的视觉token</p>
</li>
</ol>
<hr>
<p>关于这样的算法最后带来的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>δ</mi><mo>−</mo><mi>α</mi></mrow><annotation encoding="application/x-tex">\delta - \alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.0833em"></span><span class="mord mathnormal" style="margin-right:0.03785em">δ</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.4306em"></span><span class="mord mathnormal" style="margin-right:0.0037em">α</span></span></span></span>关系，作者附了这么一个曲线</p>
<p><img decoding="async" loading="lazy" alt="image-20250527162141135" src="/assets/images/image-20250527162141135-8bdddf8722d17a88c421e695dc843834.png" width="534" height="458" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="根据策略在推理时修剪">根据策略在推理时修剪<a class="hash-link" aria-label="Direct link to 根据策略在推理时修剪" title="Direct link to 根据策略在推理时修剪" href="/blog/tags/ai#根据策略在推理时修剪">​</a></h2>
<p>在实际推理时，作者将得到的删除策略<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>应用到模型中。具体来说，对于每一层的视觉token，按照<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi></mrow><annotation encoding="application/x-tex">P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord mathnormal" style="margin-right:0.13889em">P</span></span></span></span>中给定的删除数量进行修剪。</p>
<p>具体删除哪些token呢？作者的方法是，</p>
<p>对于第i层</p>
<p>计算第i层<strong>剩余</strong>视觉token j的自注意力和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>a</mi><mi>s</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">a_s^{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0717em;vertical-align:-0.247em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span></span></span></span>和交叉注意力和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>a</mi><mi>c</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">a_c^{i,j}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0717em;vertical-align:-0.247em"></span><span class="mord"><span class="mord mathnormal">a</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8247em"><span style="top:-2.453em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span><span style="top:-3.063em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em"><span></span></span></span></span></span></span></span></span></span>，然后将这两个和的<strong>乘积</strong>作为用于排序的参考，排序之后<strong>去除</strong>最小的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span>个token（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em"></span><span class="mord mathnormal" style="margin-right:0.03148em">k</span></span></span></span>是删除数量）</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="实验结果">实验结果<a class="hash-link" aria-label="Direct link to 实验结果" title="Direct link to 实验结果" href="/blog/tags/ai#实验结果">​</a></h2>
<p>作者使用 LLaVA-655k 数据集（Liu et al. 2023b）中的 655 个样本（0.1%）来生成剪枝策略</p>
<p>在LLaVA, LLaVA-HR,LLaVA-NEXT三个具有不同大小的视觉token（7B模型，576，1024，2880 tokens）的模型上进行测试，十余个下游任务数据集上进行测试</p>
<hr>
<p><img decoding="async" loading="lazy" alt="image-20250527160437182" src="/assets/images/image-20250527160437182-35bb2b550fd308086647c96c255c4f7b.png" width="1789" height="979" class="img_ev3q"></p>
<hr>
<p>可以看到，剪枝之后，在保持准确率几乎不下降的情况下， 能够带来计算量 的大幅下降</p>
<p>作者还做了其他几组实验</p>
<ol>
<li>
<p><strong>视觉冗余在不同层级的变化</strong></p>
<p>采用在不同层级上，随机删除裁剪视觉Token的方法。作者发现，深层次token的冗余度更高，裁剪深层次token几乎不影响准确度，可视化图也表明深层次的注意力几乎集中在最关键的元素中。但具体到每一层的最佳剪枝比例，层间也有比较大的不同</p>
</li>
</ol>
<hr>
<p><img decoding="async" loading="lazy" alt="image-20250527161223832" src="/assets/images/image-20250527161223832-a7dedefa5a7d792b5b4df9d98c4c3abb.png" width="916" height="409" class="img_ev3q"></p>
<hr>
<p><img decoding="async" loading="lazy" alt="image-20250527161358014" src="/assets/images/image-20250527161358014-df758aa4a01ac89ba28d6406b516bf03.png" width="689" height="509" class="img_ev3q"></p>
<hr>
<ol start="2">
<li>
<p><strong>与baseline的对比</strong></p>
<p>对比了FastV和ToMe两种裁剪方法，表明了自身的SOTA性质。同时指出，在裁剪程度低的时候大家都差不多，裁剪程度高的时候才显露方法的性能差距</p>
<p><img decoding="async" loading="lazy" alt="image-20250527161538762" src="/assets/images/image-20250527161538762-cf4680fadb2324a68d23a06ed98d886e.png" width="1783" height="806" class="img_ev3q"></p>
</li>
</ol>
<hr>
<ol start="3">
<li>
<p><strong>样本数量的消融实验</strong></p>
<p>作者将&quot;LLaVA-655k 数据集（Liu et al. 2023b）中的 655 个样本（0.1%）来生成剪枝策略&quot; 换成1%的数据，发现性能相当。<strong>作者进一步推测MLLM层间信息交换的模式可能更多地依赖于模型本身的特性</strong>，而在不同的输入样本上有较高的泛化性，FitPrune 方法可以有效地捕捉这种模式。同时下面的表还表明，这个方法有着很强的少样本泛化性，确实是模型的特性而不是样本数据集的特性，在仅有10个样本的时候也能得到非常优秀的策略</p>
</li>
</ol>
<p><img decoding="async" loading="lazy" alt="image-20250527162201012" src="/assets/images/image-20250527162201012-c5d2cddb5c89b8435daf12cf36c90db6.png" width="632" height="316" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="结论">结论<a class="hash-link" aria-label="Direct link to 结论" title="Direct link to 结论" href="/blog/tags/ai#结论">​</a></h2>
<p>作者介绍了一种FitPrune的无训练方法，用于对 MLLMs 进行视觉标记剪枝。通过将标记剪枝问题表述为一个统计问题，FitPrune 旨在最小化注意力分布的偏差，从而实现冗余视觉token的高效剪枝，进而提高计算效率。FitPrune 能够基于少量数据生成最优的剪枝策略，避免了昂贵的手动试验。</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mllm">mllm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/精读：Eagle Exploring The Design Space for Multi- modal LLMs with Mixture of Encoders">Paper reading-Eagle Exploring The Design Space for Multi- modal LLMs with Mixture of Encoders</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-06-02T00:00:00.000Z">June 2, 2025</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><p>nvidia的论文, 主要还是实践训练MLLM上的一堆经验</p>
<hr>
<h1>任务</h1>
<p>探究通过使用<strong>不同的视觉编码器和分辨率</strong>来提高MLLM系统性能的不同设计带来的效果</p>
<hr>
<h1>motivation</h1>
<ol>
<li>解读<strong>高分辨率的精细视觉信息</strong>是MLLM重要的课题，常用的CLIP-ViT 预训练时候的分辨率只有如224*224或者336*336，<strong>对OCR等细粒度信息不够好</strong></li>
<li>近期研究发现<code>enhanced visual perception</code>显著减少幻觉和提高性能，许多近期MLLM用了混合视觉编码器<!-- -->
<ul>
<li>有扩大视觉编码器的预训练量和参数的</li>
<li>有将高分辨率编码器和CLIP融合的</li>
<li>也有更复杂的融合和路由，根据任务选用不同编码器，&quot;视觉MoE&quot;的</li>
</ul>
</li>
<li>但缺乏对此类方法设计的通用考量, 以及综合性的大benchmark</li>
</ol>
<hr>
<h1>方法</h1>
<ol>
<li>对<strong>不同的视觉编码器</strong>进行<strong>基准测试</strong>，寻找更<strong>高分辨率自适应</strong>的方案</li>
<li>对<strong>不同的视觉编码器混合策略</strong>做同类比较(论文将近期的混合策略归为了CC,SA,LH等几类)</li>
<li>寻找多个视觉编码器的<strong>最优组合</strong></li>
<li>改进<strong>pre-alignment</strong>和数据混合</li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="增加输入分辨率的做法">增加输入分辨率的做法<a class="hash-link" aria-label="Direct link to 增加输入分辨率的做法" title="Direct link to 增加输入分辨率的做法" href="/blog/tags/ai#增加输入分辨率的做法">​</a></h2>
<ul>
<li>Tiling 将输入分割为子图，CLIP-ViT单独编码</li>
<li>直接放大输入分辨率，并对位置编码进行进行插值</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="eagle做的实验">Eagle做的实验：<a class="hash-link" aria-label="Direct link to Eagle做的实验：" title="Direct link to Eagle做的实验：" href="/blog/tags/ai#eagle做的实验">​</a></h2>
<p>预训练，LLaVA-1.5 + CLIP 基础模型，和LLaVA相同的 595k 图文对，<strong>冻  结整个模型，只训练projection layer</strong></p>
<p>SFT： 1809k 多模态对话数据</p>
<p>评估：11个任务，包含VQA任务， OCR/文档/图表理解，视觉中心任务，基于知识的任务</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="结果---strong-clip">结果 - Strong CLIP<a class="hash-link" aria-label="Direct link to 结果 - Strong CLIP" title="Direct link to 结果 - Strong CLIP" href="/blog/tags/ai#结果---strong-clip">​</a></h2>
<ol>
<li>
<p><strong>如果插值，需要unfrozen视觉编码器，否则损害性能</strong>。这个结论和以前实验不同。</p>
</li>
<li>
<p>输入分辨率和预训练分辨率差越大，插值越掉点</p>
</li>
<li>
<p>672分辨率下，插值和子图方法性能差不多，但是考虑效率的话还是插值更好</p>
</li>
<li>
<p>进行分辨率adaption，300M的CLIP-ViT性能接近6B的InternVL</p>
</li>
</ol>
<p><strong>按照下表，nvidia着重提了448*448+解锁视觉编码器的方案，300M就达到非常接近SOTA的性能了。</strong></p>
<hr>
<p><img decoding="async" loading="lazy" alt="image-20250601233933871" src="/assets/images/image-20250601233933871-a091334ceb9515da01d836fd92b8ea12.png" width="1166" height="592" class="img_ev3q"></p>
<hr>
<h1>Vision Encoder</h1>
<p>选取了以下的encoder</p>
<ul>
<li>
<p>视觉语言对比学习的视觉Encoder，比如CLIP的ViT和OpenCLIP的ConxNeXt；</p>
</li>
<li>
<p>以目标检测为中心的任务预训练的视觉Encoder，EVA-02</p>
</li>
<li>
<p>OCR上训练的Pix2Struct</p>
</li>
<li>
<p>分割上预训练的SAM</p>
</li>
<li>
<p>自监督训练的DINO-V2</p>
</li>
</ul>
<p>对不同预训练的视觉encoder输出的特征图进行resize和插值，使得视觉token数量相同.</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="结果">结果：<a class="hash-link" aria-label="Direct link to 结果：" title="Direct link to 结果：" href="/blog/tags/ai#结果">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20250601234936395" src="/assets/images/image-20250601234936395-09f01aa111506ba3b9c5c12a40b0d2e0.png" width="1136" height="643" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="分析">分析：<a class="hash-link" aria-label="Direct link to 分析：" title="Direct link to 分析：" href="/blog/tags/ai#分析">​</a></h2>
<ul>
<li>在freeze的情况下他们通常能<strong>在和自己预训练任务相近的MLLM benchmark上实现最佳性能</strong>。例如来自CLIP的ConvNeXt进行了图文对齐，因此在TextVQA、SQA任务上时所有编码器里表现的最好的。而Text Recognition任务上训练所得的Pix2Struct视觉编码器，在OCR任务上是表现的最好的。</li>
<li>当跟随CLIP-ViT高分辨率拓展策略，<strong>unfreeze视觉编码器时，基本都能有性能提升</strong>，也有反超对应domain上训练的视觉编码器的可能性，例如CLIP-ConvNeXt微调后在OCR上性能超过了Pix2Struct。</li>
</ul>
<hr>
<h1>融合策略：</h1>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2408.15998v2/x2.png" alt="Refer to caption" class="img_ev3q"></p>
<hr>
<ul>
<li>序列维度拼接：SA sequence append</li>
<li>通道维度拼接：CC concat channel</li>
<li>LLAVA-HR式：LH 将高分辨率特征使用adapter注入低分辨率特征中，维持序列长度、通道维度不变</li>
<li>Mini-Gemini式：MG 将高分辨率特征使用local windows cross attention注入到低分辨率的queries中。</li>
<li>Deformable Attention式：DA 将MG的local windows变成了Deformable Attention</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="结果-1">结果：<a class="hash-link" aria-label="Direct link to 结果：" title="Direct link to 结果：" href="/blog/tags/ai#结果-1">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20250601235208565" src="/assets/images/image-20250601235208565-66c205343b77aadcdafb4b386a8db120.png" width="947" height="415" class="img_ev3q"></p>
<ul>
<li>
<p>融合策略 越复杂，性能的提升似乎越差，<strong>简单的SA/CC稳定涨点</strong></p>
</li>
<li>
<p>由于SA需要处理边长的序列长度，所以后面用CC</p>
</li>
</ul>
<hr>
<h1>Pre-Alignment</h1>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2408.15998v2/x3.png" alt="Refer to caption" class="img_ev3q"></p>
<p>考虑对其他的视觉专家进行预先的文本模态对齐，再学会去融合不同视觉专家的特征。因此在目前的两阶段MLLM训练框架之前，添加了一个vision-language pre-alignment training阶段，首先使用next-token prediction监督每个视觉专家的特征+各自<strong>单独的</strong>projector（与LLaVA原始预训练策略不同）训练，让其与一个冻结的较小语言模型对齐。</p>
<hr>
<ul>
<li><strong>进行一个额外的预先对齐，可以比较好提升MLLM性能。</strong></li>
<li>预对齐后，再合并所有的视觉专家，训练projector和encoder</li>
<li>虽然在 SFT 期间解冻视觉专家有助于通过更新视觉专家以适应语言模型来提高性能，但<em>预对齐</em>策略更有效地减轻了每位视觉专家的固有偏差，并稳定了训练过程，从而提高了整体性能 （<strong>unfreeze + pre-align效果加性</strong>）</li>
</ul>
<hr>
<h1>Fusion choice</h1>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2408.15998v2/x4.png" alt="w h:600" class="img_ev3q"></p>
<hr>
<p>采用上述的3阶段训练和最好最简单的Channel concat策略，就可以进一步研究哪种视觉编码器组合最好。组合的策略是依次增加模型视觉编码器的数量，每次的选择基于上一个数量下最好的组合进行进一步添加。<strong>四到五个编码器（X4, X5）目前看来就已经比较合适了。</strong></p>
<p>最佳组合是 <em>CLIP</em> 、 <em>ConvNeXt</em> 、 <em>SAM</em> 、 <em>Pix2Struct</em> 和 <em>EVA-02</em></p>
<hr>
<h1>最终和benchmark的比较</h1>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2408.15998v2/x1.png" alt="Refer to caption" class="img_ev3q"></p>
<hr>
<h1>高分辨率的文档任务的展示: 红色baseline失败，蓝色eagle成功</h1>
<p><img decoding="async" loading="lazy" src="https://arxiv.org/html/2408.15998v2/x5.png" alt="h:600" class="img_ev3q"></p>
<hr>
<h1>结论</h1>
<ol>
<li>MLLM训练期间<strong>解锁视觉编码器</strong>matters</li>
<li>设计<strong>先进的融合策略并不能较简单的通道级联显露优势</strong></li>
<li>更多的视觉专家<strong>MoE能带来持续增益</strong>，是增强MLLM能力的有效途径</li>
<li>视觉专家如果开始时候设计的任务和文本无关（没有对齐），用<strong>冻结的LLM进行预对齐</strong>（+解锁）后再整体训练能显著提升性能</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mllm">mllm</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/RAG的一些思考和细节">RAG的一些思考与细节</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-05-30T00:00:00.000Z">May 30, 2025</time> · <!-- -->13 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h4 class="anchor anchorWithStickyNavbar_LWe7" id="langchain-needle-in-haystack-实验">Langchain needle in haystack 实验<a class="hash-link" aria-label="Direct link to Langchain needle in haystack 实验" title="Direct link to Langchain needle in haystack 实验" href="/blog/tags/ai#langchain-needle-in-haystack-实验">​</a></h4>
<p>长上下文之后，越后面的部分的事实性细节越容易找，尤其是多事实的情况下</p>
<p>引发的一个思考是 rerank 时是否需要将最关注的块放在 prompt 的最后面，也就是倒序？</p>
<ul>
<li>后补: 但其实又有attention sink相关的研究，可能还是需要具体任务具体测试分析</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20250417222048515" src="/assets/images/image-20250417222048515-4b8dca1267f9a233e00e99645f943160.png" width="836" height="411" class="img_ev3q"></p>
<p>Maybe <strong>recency bias</strong> in LLMs：只记得最近的了</p>
<p>No retrieval guarantees</p>
<p><img decoding="async" loading="lazy" alt="image-20250417222613216" src="/assets/images/image-20250417222613216-ca6cf44bb533faa8009e9abf8e801437.png" width="1221" height="568" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="query-analysis将-question-联系到正确的文档">query analysis：将 question 联系到正确的文档<a class="hash-link" aria-label="Direct link to query analysis：将 question 联系到正确的文档" title="Direct link to query analysis：将 question 联系到正确的文档" href="/blog/tags/ai#query-analysis将-question-联系到正确的文档">​</a></h4>
<p>routing (to right DB)</p>
<p><code>full doc -&gt; summary -&gt; embedding</code>： doc 中噪声非常大, summary 是必要的，语义层次的保留 level 通过 prompt 保证</p>
<p>self-reflection 听起来很美好，但实际常常用不到，太慢了，并且搜不出来更多是前期处理没做好，再换着花样也很难搜出来</p>
<p>HyDE 对于高度 Domain Knowledge 和抽象性理解的任务基本没用:</p>
<p>一些自己的解释</p>
<ol>
<li>能否生成正确的假设文档， 难</li>
<li>即使通过先行的小批量搜索教导 LLM 根据这些 example 生成假设文档，也很难让 LLM 从这些文档中抽取某个泛化的问题，经常会 <strong>过 度 specific 而导致后续漏掉文档</strong></li>
<li>目前实验下来垂域脏文档类型最好的解决方案还是 reranker，embedder 如果不微调分布太接近了，例如全部的 chunk 都在 0.5~0.6 之间，意义寥寥</li>
</ol>
<p>和数据分析的结合:</p>
<p><code>分析波动-&gt;(数据分析)找出波动的阶段-&gt; 对每个波动的阶段做查询</code></p>
<p>GraphRag 这种 KG-based 的方法经常强调“对整个数据集信息的整合”</p>
<p>但这个要分领域，例如，个人知识库之中，这是好的</p>
<p>但垂域的知识文档常常是相似的格式，固定的路由，同时信息的整合关键不在“多实体”的关系上，而是在于“单个实体随时间的变化”上。</p>
<p>又或者说实体关系 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><msub><mi>e</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>e</mi><mn>2</mn></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(e_1, e_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 本身应该建模成一个包含时间的 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mo stretchy="false">(</mo><msub><mi>e</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>e</mi><mn>2</mn></msub><mo separator="true">,</mo><mi>t</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">R(e_1, e_2, t)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mord mathnormal" style="margin-right:0.00773em">R</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em"></span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span></p>
<p>如果仅仅是靠新加入的文档来动态更新 KG 的话，滞后性会很强</p>
<p>在这种半结构化的模板式文档中，LLM 实际上在干一个 Fuzzy DB manager, 提取信息，充当一个搜索引擎</p>
<p>利用 KG 进行某种意义上的多跳推理本质上也只是对文档的多次检索，推理跳数越多，关系越复杂，离线生成 KG 就越难，不是所有领域都像是法律一样有一个明确的 A 判例引用 BCD 法条的连接关系的，这样复杂的 KG 在要想随时间变化也更不可能</p>
<p>从某种意义上来说，KG 是在横向生成，而类似金融这种领域的 RAG 做的是纵向的 Timeline, 这部分对于关键实体是有数据的，并且可能数据都不需要自己做（例如各种行情的图），而离线准备好这些 timeline 之后，如何在 timeline 上进行一个跳跃和查询分析才是关键的。</p>
<p>如果从 DB 的角度上分析的话，金融领域这种关注点快速变化的 RAG 系统（with cache）也就相当于 lazy generated timeseries DB 了，例如问了一个 A 的价格变化，就像是生成了一个 <code>time, delta_price, event(detail)</code> 的 timeseries DB 表，把生成 reason 这样的 LLM 工作 lazy 化了而已</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="chunk-的前总结和后总结离线在线">chunk 的前总结和后总结(离线在线)<a class="hash-link" aria-label="Direct link to chunk 的前总结和后总结(离线在线)" title="Direct link to chunk 的前总结和后总结(离线在线)" href="/blog/tags/ai#chunk-的前总结和后总结离线在线">​</a></h4>
<p>离线总结最大的问题在于总结哪些方面，实际上是文档预处理的一个部分</p>
<p>最简单的方法就是整个提示模板每个 chunk 问一次 LLM，有 langchain 的 map reduce 等稍微 high level 一点的工具可以支持这个事情</p>
<p>对长文档总结更有效一些的做法是利用好 embedding，先对 chunk embedding 做聚类，再每个聚类里面抽几个 chunk, 从而保证多样性和 chunk 数量的平衡</p>
<p>后总结，或者说 query-based 总结大体上是用 LLM 做比较多，但对于时延和开销的增加太高了，一个比较新的方法是 paragraph sentence-level mask bert（自己造的词），在段落中根据 q, d 的交叉编码得到句子级别的二进制掩码，从而删除无关部分。有一篇 ICLR2025 基于 bge 训了个，<a href="https://huggingface.co/blog/nadiinchi/provence" target="_blank" rel="noopener noreferrer">https://huggingface.co/blog/nadiinchi/provence</a></p>
<p>provence效果非常好，又快又几乎对齐例如GPT4.1这种顶级模型的效果</p>
<p>另一个思路就是绕过这个问题，切小块，依赖 rerank 和重新合并乃至知识图谱检索之类的策略保证相关性，也就是在查询完之后是合并还是切分的思路差距</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="半结构化数据">半结构化数据<a class="hash-link" aria-label="Direct link to 半结构化数据" title="Direct link to 半结构化数据" href="/blog/tags/ai#半结构化数据">​</a></h4>
<p><a href="https://docs.superlinked.com/getting-started/installation" target="_blank" rel="noopener noreferrer">https://docs.superlinked.com/getting-started/installation</a> 聚焦半结构化的异构数据，例如朴素 embedding 方案对数字的理解不足，无法建模 1-99 的相似度分数与 higher/lower 这种文本的关系</p>
<p><a href="https://github.com/microsoft/multifield-adaptive-retrieval" target="_blank" rel="noopener noreferrer">https://github.com/microsoft/multifield-adaptive-retrieval</a> 做多字段的权重学习(自适应选择查询应该着重的权重)</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="embedding-相关的调优">embedding 相关的调优<a class="hash-link" aria-label="Direct link to embedding 相关的调优" title="Direct link to embedding 相关的调优" href="/blog/tags/ai#embedding-相关的调优">​</a></h4>
<p>colbert架构是一个better embedding的方向，其核心在于将文档的token level embedding保存下来，对于每一个query token，计算maxsim算子得到单token的score，再求和</p>
<p><img decoding="async" loading="lazy" src="https://github.com/stanford-futuredata/ColBERT/raw/main/docs/images/ColBERT-Framework-MaxSim-W370px.png" alt="img" class="img_ev3q"></p>
<p>对比朴素embedding方案，它在token level进行计算可以很好的带来类似关键词匹配的效果，有效避免长文档下，embedding过于平均化余弦相似太不敏感的问题</p>
<p>对比rerank方案，它的优点又在嵌入矩阵可以离线计算，不需要完全在线的交叉编码器</p>
<p>引入方案： <a href="https://python.langchain.com/docs/integrations/providers/ragatouille/" target="_blank" rel="noopener noreferrer">https://python.langchain.com/docs/integrations/providers/ragatouille/</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="prompt">Prompt<a class="hash-link" aria-label="Direct link to Prompt" title="Direct link to Prompt" href="/blog/tags/ai#prompt">​</a></h4>
<p>基本没有什么特别通用的工作，但值得一提的是将prompt作为一个优化变量，使用LLM在Trajatory上进行采样和跑各种论文的“prompt优化算法”的解耦框架dsPy <a href="https://dspy.ai/" target="_blank" rel="noopener noreferrer">https://dspy.ai/</a> 用户以类似类型/对象系统的简短注释提供给dspy作为“初始意图”，而后续复杂的提示由dspy生成，核心 思想是让用户专注于编程</p>
<div class="language-python codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-python codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">CheckCitationFaithfulness</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">dspy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Signature</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token triple-quoted-string string" style="color:#e3116c">&quot;&quot;&quot;Verify that the text is based on the provided context.&quot;&quot;&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dspy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InputField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;facts here are assumed to be true&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    text</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">str</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dspy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">InputField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    faithfulness</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">bool</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dspy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OutputField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    evidence</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">dict</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">list</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">str</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dspy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">OutputField</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">desc</span><span class="token operator" style="color:#393A34">=</span><span class="token string" style="color:#e3116c">&quot;Supporting evidence for claims&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">context </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The 21-year-old made seven appearances for the Hammers and netted his only goal for them in a Europa League qualification round match against Andorran side FC Lustrains last season. Lee had two loan spells in League One last term, with Blackpool and then Colchester United. He scored twice for the U&#x27;s but was unable to save them from relegation. The length of Lee&#x27;s contract with the promoted Tykes has not been revealed. Find all the latest football transfers on our dedicated page.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">text </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Lee scored 3 goals for Colchester United.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">faithfulness </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dspy</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">ChainOfThought</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">CheckCitationFaithfulness</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">faithfulness</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> text</span><span class="token operator" style="color:#393A34">=</span><span class="token plain">text</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<blockquote>
<p>DSPy 中的不同优化器将通过为每个模块<strong>合成良好的小样本示例</strong> （如 <code>dspy.BootstrapRS</code> <a href="https://arxiv.org/abs/2310.03714" target="_blank" rel="noopener noreferrer">1 ）</a> 来调整程序的质量；为每个提示<strong>提出并智能地探索更好的自然语言指令</strong> （如 <code>dspy.MIPROv2</code> <a href="https://arxiv.org/abs/2406.11695" target="_blank" rel="noopener noreferrer">2 ）</a> ，以及<strong>为您的模块构建数据集并使用它们来微调系统中的 LM 权重</strong> （如 <code>dspy.BootstrapFinetune</code> <a href="https://arxiv.org/abs/2407.10930" target="_blank" rel="noopener noreferrer">3 ）</a></p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="llm评估">LLM评估<a class="hash-link" aria-label="Direct link to LLM评估" title="Direct link to LLM评估" href="/blog/tags/ai#llm评估">​</a></h4>
<p>测试不可靠：有多少答案是被记忆出来的？</p>
<p>有多篇相关的paper在讨论这个问题，然后采用了一些方法来衡量这个事情，例如，在数学问题题集中，替换无关的描述、修改数字等等，看看模型性能变差多少</p>
<p>类似数学问题集这种在网络上数据中很难过滤干净，还需要考虑多语言影响</p>
<p>另一些评估指标如ARC-AGI通过抽象图像智力问题集来评估模型的推理能力，相对来说泄题风险小一些(并且有隐藏test set)</p>
<ul>
<li>丢给LLM的时候不是图像，而是矩阵，用数字表示不同颜色</li>
</ul>
<p><img decoding="async" loading="lazy" alt="image-20250505134411046" src="/assets/images/image-20250505134411046-5ad9c901ec94d830bb33f096ec492f2a.png" width="1224" height="849" class="img_ev3q"></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="chatbot-arena-让全世界的人都来进行判断哪个模型好">Chatbot Arena: 让全世界的人都来进行判断哪个模型好<a class="hash-link" aria-label="Direct link to Chatbot Arena: 让全世界的人都来进行判断哪个模型好" title="Direct link to Chatbot Arena: 让全世界的人都来进行判断哪个模型好" href="/blog/tags/ai#chatbot-arena-让全世界的人都来进行判断哪个模型好">​</a></h4>
<p>但还是有办法hack: 更fit人 的倾向（粗体字、分点、emoji.....）</p>
<p>Elo Score 考虑除了人的直接倾向之外其他因素的影响，在BF模型计算时加上一项<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>,  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mfrac><mn>1</mn><mrow><mn>1</mn><mo>+</mo><mi>e</mi><mi>x</mi><mi>p</mi><mo stretchy="false">(</mo><msub><mi>β</mi><mi>i</mi></msub><mo>−</mo><msub><mi>β</mi><mi>j</mi></msub><mo>+</mo><msub><mi>β</mi><mn>0</mn></msub><mo stretchy="false">)</mo></mrow></mfrac><mo>=</mo><msub><mi>E</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\frac{1}{1 + exp(\beta_i - \beta_j + \beta_0)} = E_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.3874em;vertical-align:-0.5423em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8451em"><span style="top:-2.655em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight">e</span><span class="mord mathnormal mtight">x</span><span class="mord mathnormal mtight">p</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.0528em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span><span class="mbin mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3281em"><span style="top:-2.357em;margin-left:-0.0528em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">j</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2819em"><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3173em"><span style="top:-2.357em;margin-left:-0.0528em;margin-right:0.0714em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em"><span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.5423em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span>, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>E</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub></mrow><annotation encoding="application/x-tex">E_{ij}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em">ij</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span> 是模型i和j的胜率，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\beta_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 是模型i的真实评分，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span> 是一个全局偏差项，表示人类评估者的偏好。通过最大化似然函数来估计参数<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\beta_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>和<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>，从而得到模型的真实评分。</p>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>0</mn></msub><mo>=</mo><msub><mi>γ</mi><mn>1</mn></msub><mo>∗</mo><mtext>长度差</mtext><mo>+</mo><msub><mi>γ</mi><mn>2</mn></msub><mo>∗</mo><mi>e</mi><mi>m</mi><mi>o</mi><mi>j</mi><mi>i</mi><mtext>个数差</mtext><mo>+</mo><msub><mi>γ</mi><mn>3</mn></msub><mo>∗</mo><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">\beta_0 = \gamma_1 * 长度差 + \gamma_2 * emoji个数差 + \gamma_3 * ...</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6597em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em"></span><span class="mord cjk_fallback">长度差</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6597em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em"></span><span class="mord mathnormal">e</span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">ji</span><span class="mord cjk_fallback">个数差</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.6597em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em"></span></span><span class="base"><span class="strut" style="height:0.1056em"></span><span class="mord">...</span></span></span></span></p>
<p><img decoding="async" loading="lazy" alt="image-20250505135351256" src="/assets/images/image-20250505135351256-3bf80497f080b17544c064176591200e.png" width="975" height="825" class="img_ev3q"></p>
<p>可以看到，考不考虑这个<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>β</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">\beta_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span>，模型的排名差别很大</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="goodharts-law">Goodhart&#x27;s Law<a class="hash-link" aria-label="Direct link to Goodhart&#x27;s Law" title="Direct link to Goodhart&#x27;s Law" href="/blog/tags/ai#goodharts-law">​</a></h4>
<p><strong>一旦一项指标被用作目标，它就不再是一个好的指标</strong></p>
<p><a href="http://becomingahacker.org/integrating-agentic-rag-with-mcp-servers-technical-implementation-guide-1aba8fd4e442" target="_blank" rel="noopener noreferrer">http://becomingahacker.org/integrating-agentic-rag-with-mcp-servers-technical-implementation-guide-1aba8fd4e442</a></p>
<p>However, traditional RAG has limitations: it usually queries a single data source and only performs one retrieval pass, so if the initial results are poor or the query is phrased oddly, the answer will suffer
但是，传统的 RAG 存在局限性：它通常查询单个数据源，并且只执行一次检索传递，因此如果初始结果不佳或查询措辞奇怪，答案将受到影响</p>
<p>There’s no built-in mechanism for the system to reason about <em>how</em> to retrieve better information or to use additional tools if needed.
系统没有内置机制来推理<em>如何</em>检索 更好的信息或在需要时使用其他工具。</p>
<p>关于结构化输出的另一篇特别好的文章: <a href="https://www.boundaryml.com/blog/schema-aligned-parsing" target="_blank" rel="noopener noreferrer">https://www.boundaryml.com/blog/schema-aligned-parsing</a></p>
<p>推理加速：是对的，例如huggingface-text-embedding项目，将各种转trt/onnx 可以让吞吐提升5x</p>
<p>H100 bge-reranker-v2-m3  1024 * 512char sentence， 13s -&gt; 2.3s</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="关键词抽取">关键词抽取<a class="hash-link" aria-label="Direct link to 关键词抽取" title="Direct link to 关键词抽取" href="/blog/tags/ai#关键词抽取">​</a></h4>
<p>基于主题LDA，词典等</p>
<p>小模型方法：先用spaCy、hanLP等得到语法树，再从语法树中拿到名词性关键词等</p>
<p>无监督，经典如YAKE！综合考虑词频，词位，共现等。可以考虑<a href="https://github.com/JackHCC/Chinese-Keyphrase-Extraction" target="_blank" rel="noopener noreferrer">https://github.com/JackHCC/Chinese-Keyphrase-Extraction</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="一篇非常有insight的blog上下文相关上下文充足定量充足性和它的应用">一篇非常有insight的blog：上下文相关!=上下文充足，定量充足性和它的应用<a class="hash-link" aria-label="Direct link to 一篇非常有insight的blog：上下文相关!=上下文充足，定量充足性和它的应用" title="Direct link to 一篇非常有insight的blog：上下文相关!=上下文充足，定量充足性和它的应用" href="/blog/tags/ai#一篇非常有insight的blog上下文相关上下文充足定量充足性和它的应用">​</a></h4>
<p><a href="https://research.google/blog/deeper-insights-into-retrieval-augmented-generation-the-role-of-sufficient-context/" target="_blank" rel="noopener noreferrer">https://research.google/blog/deeper-insights-into-retrieval-augmented-generation-the-role-of-sufficient-context/</a></p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/rag">rag</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/精读  Interleaved Scene Graph for Interleaved Text-and-Image Generation Assessment">Paper reading - Interleaved Scene Graph for Interleaved Text-and-Image Generation Assessment</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-05-30T00:00:00.000Z">May 30, 2025</time> · <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><p>开发了一个<strong>交错文本和图像生成综合评估框架</strong>ISG</p>
<p>使用<code>scene graph</code>捕获文本和图像的关系，提供四个级别的评估：整体的、结构性的、块级别和特定于图像的，并引入了一个新benchmark，ISG-BENCH</p>
<p>作者实验认为现有模型在端到端生成文本图像交错内容时，效果不好，于是做了一个Agent来完成这个任务</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="motivation">motivation<a class="hash-link" aria-label="Direct link to motivation" title="Direct link to motivation" href="/blog/tags/ai#motivation">​</a></h3>
<p><img decoding="async" loading="lazy" alt="image-20250530152606364" src="/assets/images/image-20250530152606364-d9605f8fed7f263b463ed75398a8cf8a.png" width="990" height="433" class="img_ev3q"></p>
<p>如图，现有MLLM<strong>不能直接生成交错文本和图像内容</strong>，需要将生成图像部分交给SD等外部模型再组合，带来了更大的开销与不一致性</p>
<hr>
<p>为了专注这一任务，作者的Benchmark优先考虑视觉为中心的任务，例如风格迁移等图像输出的特定要求。</p>
<ul>
<li>作者的数据集和人工标注比较有<strong>较高Pearson相似度，以此说明准确性</strong></li>
<li>作者表示先前没什么<strong>benchmark主要以视觉为中心，以此说明新颖度</strong></li>
<li>但有一说一，作者的表还是有点不公平的，例如它自己的<strong>sample很少</strong>(一千多)，同时评估级别是自己提出的这个四级别评估</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="作者的表">作者的表<a class="hash-link" aria-label="Direct link to 作者的表" title="Direct link to 作者的表" href="/blog/tags/ai#作者的表">​</a></h2>
<p><img decoding="async" loading="lazy" alt="image-20250530160048840" src="/assets/images/image-20250530160048840-646ee93968c80f9867ea0f316414a5a5.png" width="1052" height="362" class="img_ev3q"></p>
<hr>
<h1>方法</h1>
<p><img decoding="async" loading="lazy" alt="image-20250530153213139 h:500" src="/assets/images/image-20250530153213139-4ceb43c19d4bcc07cdc1baeb75d2408b.png" width="1151" height="576" class="img_ev3q"></p>
<p>注意点: <strong>中间看起来很复杂, 实际上是很多组prompt完成的</strong></p>
<hr>
<p>评估框架将query拆成scene-graph-like structure，<strong>其中图文作为节点，而它们的关系作为边</strong></p>
<p>在整体，结构，块和图四级别的评估中，每个级别都会生成一些用于评估的QA对。作者的意图是，<strong>让整体和结构评估连贯性和整体质量，块和图像评估指令完成的细节</strong></p>
<hr>
<p>结构性：用一个LLM预估图文交替内容的结构，然后与实际生成的内容进行比较</p>
<p><img decoding="async" loading="lazy" alt="image-20250530163448151" src="/assets/images/image-20250530163448151-71150c0f60bd09aee45e9107edd3eaa7.png" width="1060" height="523" class="img_ev3q"></p>
<hr>
<p>整体：MLLM-as-a-Judge和CoT，用1-10打分配合Yes/No判断</p>
<p>块： 将prompt P用LLM表示成三元组 （subj, obj, rel）,再用LLM生成问题，并用VQA评估</p>
<p><img decoding="async" loading="lazy" alt="image-20250530163519317" src="/assets/images/image-20250530163519317-1ba26e8e2cd40c56119403af2ba7b9b9.png" width="1047" height="770" class="img_ev3q"></p>
<hr>
<p>图像：从prompt 给的图像中用LLM抽出三元组关系和实体，判断query类别，根据类别不同使用不同的prompt产生判断的VQA，例如如果是&quot;How to&quot;，则需要包含特定实体，如果是“Painting”，则需要图像的准确生成</p>
<p><img decoding="async" loading="lazy" alt="image-20250530163331400 h:600" src="/assets/images/image-20250530163331400-1b1c3b6298aa1e9aad449957c2e03fd3.png" width="1039" height="679" class="img_ev3q"></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="实验结果">实验结果<a class="hash-link" aria-label="Direct link to 实验结果" title="Direct link to 实验结果" href="/blog/tags/ai#实验结果">​</a></h3>
<blockquote>
<p>所有统一模型在按照说明生成交错文本和图像内容方面都存在重大缺陷。许多模型只生成 1 到 3 张图像，而有些模型根本无法生成任何图像。</p>
</blockquote>
<blockquote>
<p>整体评估结果与三个细粒度级别的评估结果之间的不一致表明，即使同时提供用户指示和正确的黄金答案，MLLM-as-a-Judge 在全面评估回答方面也存在显着局限性。具体来说，Judge MLLM 努力根据细粒度的标准评估响应，例如输出结构（包括图像数量）和提示中规定的详细文本-图像关系。此外，我们对结果的分析揭示了 <strong>MLLM-as-a-Judge 中固有的偏见</strong>，即“图像质量偏见”，即<strong>具有更高质量图像内容的回答始终获得更高的分数，尽管这些回答可能违反用户的指导要求和评判指  南</strong>。这种偏见表明，即使获得了黄金答案，MLLM-as-a-Judge 仍然无法正确地对符合指定要求的交错回答进行准确评估。</p>
</blockquote>
<hr>
<p><img decoding="async" loading="lazy" alt="image-20250530160948640" src="/assets/images/image-20250530160948640-8a5505eaeadfe2ed274a09937abf96eb.png" width="1200" height="519" class="img_ev3q"></p>
<hr>
<h1>效果展示: 跑一次它这个Benchmark要60美刀</h1>
<p><img decoding="async" loading="lazy" alt="image-20250530163815015 h:600" src="/assets/images/image-20250530163815015-79e642937f498c3c9f5bde75cd8d23e3.png" width="1051" height="1016" class="img_ev3q"></p>
<hr>
<h1>结论</h1>
<ol>
<li>MLLM-as-a-judge存在图像质量bias</li>
<li>现有端到端MLLM生成图文内容效果不佳, 可能需要在工程性上的agent做补救</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/mllm">mllm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/2025/05/26/技术博客阅读">美团技术博客阅读</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-05-26T00:00:00.000Z">May 26, 2025</time> · <!-- -->19 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="美团外卖基于gpu的向量检索系统实践">美团外卖基于GPU的向量检索系统实践<a class="hash-link" aria-label="Direct link to 美团外卖基于GPU的向量检索 系统实践" title="Direct link to 美团外卖基于GPU的向量检索系统实践" href="/blog/tags/ai#美团外卖基于gpu的向量检索系统实践">​</a></h3>
<blockquote>
<p>美团外卖的向量检索系统使用了GPU来加速向量检索过程。该系统主要包括以下几个方面： 美团外卖业务特点具有较强的Location Based Service（LBS）依赖，即商家的配送范围，决定了用户所能点餐的商家列表。以商品向量检索场景为例：向量检索结果集需要经过“可配送商家列表”过滤。</p>
</blockquote>
<blockquote>
<p>美团外卖向量检索基于Elasticsearch+FAISS进行搭建，实现了10亿级别+高维向量集的标量+向量混合检索的能力。为了在保证业务高召回率的同时进一步减少检索时间，我们探索基于GPU的向量检索，并实现了一套通用的检索系统。</p>
</blockquote>
<p><strong>相继使用了HNSW（Hierarchical Navigable Small World），IVF（Inverted File），IVF-PQ（Inverted File with Product Quantization）以及IVF-PQ+Refine等算法，基于CPU实现了向量检索能力</strong></p>
<p>在HNSW算法中，这种导航小世界图的层次结构使得搜索过程可以从图的高层开始，快速定位到目标点的大致位置，然后逐层向下精细化搜索，最终在底层找到最近邻，在通用检索场景上有显著的优势。然而<strong>该算法在高过滤比下性能会有折损</strong>，从而导致在到家搜推这种强LBS过滤场景下会暴露其性能的劣势。业界有较多相关的benchmark可以参考，以Yahoo的向量检索系统Vespa相关博客为例</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-6ecdab7cf574caf7866ef8076970b00a.webp" width="1080" height="678" class="img_ev3q"></p>
<blockquote>
<p>索引吞吐</p>
<p>Observations: 观察结果：</p>
<ul>
<li>Indexing throughput depends on corpus size for Annoy and HNSW, where throughput is halved when corpus size is increased by 10x.
对于 Annoy  和 HNSW，<strong>索引吞吐量</strong>取决于语料库大小，当语料库大小增加 10 倍时，吞吐量就会减半。</li>
<li>Indexing throughput for RPLSH is independent of corpus size.
RPLSH 的索引吞吐量与语料库大小无关。</li>
<li>Annoy is <strong>4.5 to 5 times</strong> faster than HNSW.
Annoy 比 HNSW 快 <strong>4.5 到 5 倍</strong> 。</li>
<li>RPLSH is <strong>23 to 24 times faster</strong> than HNSW at 1M documents.
对于 1M 文档，RPLSH 的<strong>速度比 HNSW 快 23 到 24 倍</strong> 。</li>
</ul>
</blockquote>
<p><img decoding="async" loading="lazy" alt="img" src="/assets/images/indexing-throughput-sift-0d6b3d3501d6d01b8531d2fbf5f73052.png" width="1110" height="686" class="img_ev3q"></p>
<blockquote>
<p>查询吞吐</p>
<p>Observations: 观察结果：</p>
<ul>
<li>HNSW outperforms Annoy and RPLSH. At corpus size 1M the QPS is <strong>9 times as high</strong> as Annoy, and <strong>16 times as high</strong> as RPLSH at comparable quality. Similar observations between hnswlib and Annoy are found in <a href="https://ann-benchmarks.com/" target="_blank" rel="noopener noreferrer">ANN Benchmarks</a>, where the QPS of hnswlib is 5-10 times higher at the same quality on all tested datasets.
HNSW 的表现优于 Annoy 和 RPLSH。在 1M 语料库规模下，其每秒查询速度 (QPS) 是 Annoy 的 <strong>9 倍</strong> ，在同等质量下是 RPLSH 的 <strong>16 倍</strong> 。在 <a href="https://ann-benchmarks.com/" target="_blank" rel="noopener noreferrer">ANN 基准测试</a>中也发现了 hnswlib 与 Annoy 之间的类似现象：在所有测试数据集上，相同质量下 hnswlib 的每秒查询速度 (QPS) 比 Annoy 高 5-10 倍。</li>
<li><strong>HNSW 搜索算法很大程度上取决于节点之间的链接数量，而链接数量又取决于语料库的大小。当语料库规模增加 10 倍时，QPS 会减半</strong>。在索引过程中，我们也看到了同样的情况，因为它使用搜索算法来查找要连接的候选节点。</li>
</ul>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://blog.vespa.ai/assets/2020-06-30-approximate-nearest-neighbor-search-in-vespa-part-1/search-throughput-sift.png" alt="img" class="img_ev3q"></p>
<blockquote>
<p>内存占用</p>
<p>Observations: 观察结果：</p>
<ul>
<li>The Annoy index is almost 3 times larger than the HNSW index, which results in ~40% more total memory usage in the 1M SIFT dataset.
<strong>Annoy 索引几乎比 HNSW 索引大 3 倍</strong>，这导致 1M SIFT 数据集的总内存使用量增加约 40%。</li>
<li>Both indexes are independent of dimension size, but max points in a leaf node (Annoy) and max links per level (HNSW) might need adjustments with higher dimensionality to get decent quality.
这两个索引都与维度大小无关，但叶节点中的最大点数（Annoy）和每级的最大链接数（HNSW）可能需要使用更高的维度进行调整才能获得不错的质量。</li>
</ul>
</blockquote>
<p><a href="https://blog.vespa.ai/approximate-nearest-neighbor-search-in-vespa-part-1/" target="_blank" rel="noopener noreferrer">博客</a>给出了一个很重要的观察是：<strong>当超过 90% 到 95% 的文档被过滤掉时，过滤后计算精确最近邻比搜索 HNSW 索引（过滤器会丢弃候选匹配项）的成本更低</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="22-ivf-inverted-file">2.2 IVF （Inverted File）<a class="hash-link" aria-label="Direct link to 2.2 IVF （Inverted File）" title="Direct link to 2.2 IVF （Inverted File）" href="/blog/tags/ai#22-ivf-inverted-file">​</a></h4>
<p>IVF是一种基于倒排索引的方法，它将高维向量空间分为多个簇（Cluster），每个簇对应一个倒排列表，存储了属于该簇的向量索引。这种方法大大减少了搜索时需要比较的向量数量，从而<strong>提高了检索速度</strong>。它的缺点是需要存储原始的向量数据，<strong>同时为了保证检索性能需要将其全量加载到内存中，从而占用了大量的内存空间</strong>，容易造成内存资源瓶颈。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="23-ivf-pqinverted-file-with-product-quantization">2.3 IVF-PQ（Inverted File with Product Quantization）<a class="hash-link" aria-label="Direct link to 2.3 IVF-PQ（Inverted File with Product Quantization）" title="Direct link to 2.3 IVF-PQ（Inverted File with Product Quantization）" href="/blog/tags/ai#23-ivf-pqinverted-file-with-product-quantization">​</a></h4>
<p>在候选集数量巨大的场景下，比如商品向量检索场景下，IVF带来的内存空间大的问题很快就显现出来，为了解决内存空间的问题，开始尝试使用了IVF-PQ方法。该方法在IVF的基础上，使用了<strong>乘积量化（Product Quantization，PQ）的方法来压缩向量数据。PQ将高维向量分为多个子向量，然后对每个子向量进行量化</strong>，从而大大减少了对内存空间的需求。</p>
<p>然而，由于量化过程会引入误差，因此<strong>IVF-PQ的检索精度会低于IVF，从而导致召回率无法满足线上要求，对召回率要求相对较低的场景可以使用IVF-PQ，对召回率有一定要求的场景需要其他解决方案。</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="24-ivf-pqrefine">2.4 IVF-PQ+Refine<a class="hash-link" aria-label="Direct link to 2.4 IVF-PQ+Refine" title="Direct link to 2.4 IVF-PQ+Refine" href="/blog/tags/ai#24-ivf-pqrefine">​</a></h4>
<p>为了提高IVF-PQ的检索精度，进一步采用了IVF-PQ+Refine的方案，在IVF-PQ的基础上，在SSD磁盘上保存了未经压缩的原始向量数据。<strong>检索时，通过IVF-PQ召回数量更大的候选向量集合，然后获取对应的原始向量数据进行精确计算，从而提高检索精度</strong>。这种方法既保留了IVF-PQ的存储优势，解决了内存资源瓶颈，又保证了召回率，因此在实际应用中得到了广泛的使用。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="25-基于  地理位置的向量检索">2.5 基于地理位置的向量检索<a class="hash-link" aria-label="Direct link to 2.5 基于地理位置的向量检索" title="Direct link to 2.5 基于地理位置的向量检索" href="/blog/tags/ai#25-基于地理位置的向量检索">​</a></h4>
<p><strong>通过将经纬度编码为向量，优化具体做法是将用户或商家的经纬度以加权的方式加入查询Query和候选向量中，在计算Query和候选向量的相似度时，距离因素就可以在不同程度上影响最终的检索结果，从而达到让向量索引具备LBS属性的目标。</strong></p>
<p>这里没有细讲，但怎么具体怎么融入的LBS属性还是比较有意思的，最直接的方法是将经纬度信息直接拼接到现有的文本embedding向量上，也可以将经纬度用geohash，或者以用户为中心的极坐标系统表示?</p>
<p>我觉得最复杂的在于：</p>
<ul>
<li>如何确定经纬度特征的维度，这也算是一种权值</li>
<li>如何让经纬度特征和其他向量特征上对齐？美团是否有一个专用的embedding模型来嵌入地理信息特征，这个模型又是根据什么进行微调的？是类似推荐系统那种基于用户反馈的，还是内部有一个地理加权的人工设计公式，这个模型提供的地理特征使得整体效果向这个公式靠齐的？</li>
</ul>
<p><a href="https://docs.google.com/document/d/1R5nOiwFUn9ZJtuWywmos2yfB4aCWCGy1TUN5VAnMRaY/edit?usp=sharing" target="_blank" rel="noopener noreferrer">https://docs.google.com/document/d/1R5nOiwFUn9ZJtuWywmos2yfB4aCWCGy1TUN5VAnMRaY/edit?usp=sharing</a></p>
<blockquote>
<p>考虑到美团外卖的业务场景，目标方案应该满足以下要求：</p>
<ul>
<li><strong>支持向量+标量混合检索</strong>：在向量检索的基础上，支持复杂的标量过滤条件。</li>
<li><strong>高过滤比</strong>：标量作为过滤条件，有较高的过滤比（大于99%），过滤后候选集大（以外卖商品为例，符合LBS过滤的商品向量候选集仍然超过百万）。</li>
<li><strong>高召回率</strong>：召回率需要在95%+水平。</li>
<li><strong>高性能</strong>：在满足高召回率的前提下，检索耗时Tp99控制在20ms以内。</li>
<li><strong>数据量</strong>：需要支持上亿级别的候选集规模。</li>
</ul>
</blockquote>
<blockquote>
<p>实现向量+标量混合检索，一般有两种方式：前置过滤（pre-filter）和后置过滤（post-filter）。<strong>前置过滤指先对全体数据进行标量过滤，得到候选结果集，然后在候选结果集中进行向量检索，得到TopK结果。后置过滤指先进行向量检索，得到TopK*N个检索结果，再对这些结果进行标量过滤，得到最终的TopK结果</strong>。其中N为扩召回倍数，主要是为了缓解向量检索结果被标量检索条件过滤，导致最终结果数不足K个的问题。</p>
<p>业界已有较多的成熟的全库检索的方案，后置过滤方案可以尽量复用现有框架，开发量小、风险低，<strong>因此我们优先考虑后置过滤方案</strong>。我们基于GPU的后置过滤方案快速实现了一版向量检索引擎，并验证其召回率与检索性能。GPU中成熟的检索算法有Flat、IVFFlat和IVFPQ等，在不做扩召回的情况下，召回率偏低，<strong>因此我们在benchmark上选择了较大的扩召回倍数以提高召回率。</strong></p>
</blockquote>
<p><img decoding="async" loading="lazy" src="https://mmbiz.qpic.cn/sz_mmbiz_png/hEx03cFgUsVShPhmBKFPvZmO6XEY3ficv2O6cewUo5kHicVklOU2wUzECA2q5d0lf8kBFtYI8Jj2HBbvNs0TuQ9w/640?wx_fmt=png&amp;from=appmsg&amp;tp=webp&amp;wxfrom=10005&amp;wx_lazy=1" alt="图片" class="img_ev3q"></p>
<blockquote>
<p><strong>测试结果表明，以上三种算法均无法同时满足我们对检索性能和召回率的需求。其中IVF与IVFPQ召回率较低，Flat算法虽然召回率较高，但是与全体候选集计算向量相似度导致其性能较差。</strong></p>
</blockquote>
<blockquote>
<p><strong>根据用户的地理位置信息计算其GeoHash值，并扩展至附近9个或25个GeoHash块，在这些GeoHash块内采用Flat算法进行向量检索，可以有效减少计算量。这种向量子空间划分方式有效地提高了检索性能，但是存在某些距离稍远的商家无法被召回的情况，最终测得的召回率只有80%左右，无法满足要求。</strong></p>
</blockquote>
<blockquote>
<p>综上，后置过滤方案无法同时满足检索性能和召回率的需求，而GPU版本的Faiss无法实现前置过滤功能，考虑到美团外卖的业务场景，向量+标量混合检索能力是最基本的要求，因此我们决定自研GPU向量检索引擎。</p>
</blockquote>
<blockquote>
<p>基于GPU的向量检索，要想实现前置过滤，一般有三种实现方案：</p>
<ol>
<li>所有<strong>原始数据都保存在GPU显存中，由GPU完成前置过滤</strong>，再进行向量计算。</li>
<li>所有<strong>原始数据都保存在CPU内存中，在CPU内存中完成前置过滤，将过滤后的原始向量数据传给GPU进行向量计算</strong>。(能存更大的数据集)</li>
<li><strong>原始向量数据保存在GPU显存中，其他标量数据保存在CPU内存中，在CPU内存完成标量过滤后，将过滤结果的下标传给GPU，GPU根据下标从显存中获取向量数据进行计算。</strong>（省显存带宽）</li>
</ol>
<p>由于GPU与CPU结构与功能上的差异性，使用GPU完成前置过滤，显存资源占用量更大，过滤性能较差，且无法充分利用过滤比大的业务特点，<strong>因此不考虑方案1</strong>。</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-1748242298419-5-cc781b495cb0bc8b56c804a537b59a3d.webp" width="1080" height="278" class="img_ev3q"></p>
<p>实验结果表明，方案2在数据拷贝阶段耗时严重，时延无法达到要求。因为在美团外卖的场景下，过滤后的数据集仍然很大，这对CPU到GPU之间的数据传输带  宽（A30显卡带宽数据如下 CPU-GPU：PCIe Gen4: 64GB/s；GPU-GPU：933GB/s）提出了很高的要求，<strong>因此我们最终选择了方案3。</strong></p>
</blockquote>
<blockquote>
<p>考虑到显存的价格远高于内存，因此我们在设计方案的过程中，尽可能将数据存储在内存当中，仅将需要GPU计算的数据存储在显存当中。</p>
<p>内存中保存了所有的标量数据，数据<strong>按列存储</strong>，通过位置索引可以快速找到某条数据的所有字段信息，数据按列存储具备较高的灵活性和可扩展性，同时也更容易进行数据压缩和计算加速。针对需要用于过滤的标量字段，<strong>在内存中构造了倒排索引，倒排链中保存了对应的原始数据位置索引信息</strong>，内存数据结构如下图所示</p>
</blockquote>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-1748242561687-8-46646c8a46fe5a278b81322532de631c.webp" width="1080" height="1238" class="img_ev3q"></p>
<blockquote>
<p>显存中保存了所有的向量数据，数据位置索引与内存中的数据一一对应，可以通过位置索引快速获取某条数据的向量信息，如下图所示：</p>
<p><img decoding="async" loading="lazy" alt="图片" src="data:image/webp;base64,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" width="1050" height="186" class="img_ev3q"></p>
</blockquote>
<p>最后的流程图(Flat)</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-1748242653397-14-854b2dbbbffe8af6b1e6a08532e26649.webp" width="1080" height="816" class="img_ev3q"></p>
<p>最后的流程图(IVF)，放宽召回率，提升性能</p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-1748242729349-17-2a9cdd350ddfde26a2e58ee500477319.webp" width="1080" height="856" class="img_ev3q"></p>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-1748242743071-20-64fd68119b0135d73db5463a38526ce9.webp" width="1080" height="375" class="img_ev3q"></p>
<p><strong>可见，无论是Flat还是IVF，在相同的召回率下，使用前置过滤的性能都要明显好于后置过滤。</strong></p>
<p>性能优化</p>
<ul>
<li>
<p>高并发支持，通过Cuda Stream，GPU可以并行处理多个查询请求，高并发压测下，GPU利用率可以达到100%。</p>
</li>
<li>
<p>通过GPU实现部分标量过滤功能，支持在GPU上实现部分标量过滤功能，向量计算与标量过滤同处一个Kernel，充分利用GPU并行计算能力</p>
</li>
<li>
<p><strong>资源管理优化，支持句柄机制，资源预先分配，重复利用</strong>。每个句柄持有一部分私有资源，包含保存向量检索中间计算结果的可读写内存、显存，以及单独的Cuda Stream执行流；<strong>共享一份全局只读公有资源。在初始化阶段，创建句柄对象池，可以通过控制句柄数量，来调整服务端并发能力，避免服务被打爆。在检索阶段，每次向量检索需从句柄对象池中申请一个空闲的句柄，然后进行后续的计算流程，并在执行完后释放响应的句柄，达到资源回收和重复利用的目的</strong></p>
</li>
</ul>
<p><img decoding="async" loading="lazy" alt="图片" src="/assets/images/640-1748243142566-23-725fd68c9ca6aff07b382e1e9408c08b.webp" width="1080" height="367" class="img_ev3q"></p>
<blockquote>
<p>我们最终选择了单机多卡的数据分片方案，单台服务器部署多张GPU，检索时并行从本地多张GPU中检索数据，在CPU内存中进行数据合并。</p>
<p>为了支持更大规模的向量数据检索，我们还在GPU检索引擎上支持了半精度计算，使用FP16替换原来的FP32进行计算，可以节省一半的GPU显存占用，经验证Flat召回率由100%下降到99.4%，依然满足需求。使用半精度之后，单机可以加载近10亿数据，足够支撑较长时间的业务数据增长。</p>
</blockquote>
<p>GPU 检索系统上线后实际性能数据如下（数据量1亿+）：</p>
<p><img decoding="async" loading="lazy" alt="图片" src="data:image/webp;base64,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" width="1080" height="185" class="img_ev3q"></p>
<hr>
<p>22年还有一篇早期的搜索基于elasticsearch的优化实践</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&amp;mid=2651772026&amp;idx=1&amp;sn=6ff4cb024bb416c46d5d2850a6ae77d1&amp;chksm=bd120d378a6584217f1838c0f951204023e5c32b0ad413a731078e2f11f8f0009b39c3dec4ea&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s?__biz=MjM5NjQ5MTI5OA==&amp;mid=2651772026&amp;idx=1&amp;sn=6ff4cb024bb416c46d5d2850a6ae77d1&amp;chksm=bd120d378a6584217f1838c0f951204023e5c32b0ad413a731078e2f11f8f0009b39c3dec4ea&amp;scene=21#wechat_redirect</a></p>
<p>但这个就很工程很机架了</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/tech-blog">tech blog</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/美团">美团</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/system">system</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li></ul></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tags/ai/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">notes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/RL">课程笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/personal-essays">Personal Essays</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Ayanami, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>