<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-list-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">Blog | Ayanami&#x27;s Cave</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ayanami1314.github.io/blog"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="Blog | Ayanami&#x27;s Cave"><meta data-rh="true" name="description" content="Blog"><meta data-rh="true" property="og:description" content="Blog"><meta data-rh="true" name="docusaurus_tag" content="blog_posts_list"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_posts_list"><link data-rh="true" rel="icon" href="/img/ayanami.jpg"><link data-rh="true" rel="canonical" href="https://ayanami1314.github.io/blog"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog" hreflang="en"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"Blog","@id":"https://ayanami1314.github.io/blog","mainEntityOfPage":"https://ayanami1314.github.io/blog","headline":"Blog","description":"Blog","blogPost":[{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/local-llm","mainEntityOfPage":"https://ayanami1314.github.io/blog/local-llm","url":"https://ayanami1314.github.io/blog/local-llm","headline":"来本地部署大模型!","name":"来本地部署大模型!","description":"前言","datePublished":"2025-01-19T08:04:51.305Z","author":{"@type":"Person","name":"ayanami"},"keywords":["ai","llm","deploy"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/jyy-os-虚拟化","mainEntityOfPage":"https://ayanami1314.github.io/blog/jyy-os-虚拟化","url":"https://ayanami1314.github.io/blog/jyy-os-虚拟化","headline":"NJU操作系统(jyy OS)课程笔记-虚拟化部分","name":"NJU操作系统(jyy OS)课程笔记-虚拟化部分","description":"lec14 操作系统上的进程","datePublished":"2025-01-19T06:48:39.789Z","author":{"@type":"Person","name":"ayanami"},"keywords":["os","jyy"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/cs186-database-WIP","mainEntityOfPage":"https://ayanami1314.github.io/blog/cs186-database-WIP","url":"https://ayanami1314.github.io/blog/cs186-database-WIP","headline":"ucb cs186 课程笔记(更新中)","name":"ucb cs186 课程笔记(更新中)","description":"lec2","datePublished":"2025-01-19T06:44:01.658Z","author":{"@type":"Person","name":"ayanami"},"keywords":["cs186","database"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/系统架构设计笔记","mainEntityOfPage":"https://ayanami1314.github.io/blog/系统架构设计笔记","url":"https://ayanami1314.github.io/blog/系统架构设计笔记","headline":"system-design-interview笔记","name":"system-design-interview笔记","description":"限流器","datePublished":"2025-01-19T06:37:33.783Z","author":{"@type":"Person","name":"ayanami"},"keywords":["系统架构","架构设计"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/ostep-chapter42-44","mainEntityOfPage":"https://ayanami1314.github.io/blog/ostep-chapter42-44","url":"https://ayanami1314.github.io/blog/ostep-chapter42-44","headline":"ostep阅读笔记：单机fs的崩溃一致性(chapter42-44)","name":"ostep阅读笔记：单机fs的崩溃一致性(chapter42-44)","description":"chapter 42 崩溃一致性","datePublished":"2025-01-19T06:12:55.344Z","author":{"@type":"Person","name":"ayanami"},"keywords":["ostep","filesystem","崩溃一致性"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/JUC","mainEntityOfPage":"https://ayanami1314.github.io/blog/JUC","url":"https://ayanami1314.github.io/blog/JUC","headline":"JUC","name":"JUC","description":"自旋锁->自旋N次(N自适应, 取决于先前历史,当前负载等)->升级为重量级锁","datePublished":"2024-11-01T18:57:09.000Z","author":{"@type":"Person","name":"ayanami"},"keywords":[]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/cs144 labs","mainEntityOfPage":"https://ayanami1314.github.io/blog/cs144 labs","url":"https://ayanami1314.github.io/blog/cs144 labs","headline":"cs144 labs(Winter 2024)","name":"cs144 labs(Winter 2024)","description":"Lab0","datePublished":"2024-11-01T18:57:09.000Z","author":{"@type":"Person","name":"ayanami"},"keywords":["cs144","computer networks","labs"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/jyy-os：并发","mainEntityOfPage":"https://ayanami1314.github.io/blog/jyy-os：并发","url":"https://ayanami1314.github.io/blog/jyy-os：并发","headline":"NJU操作系统(jyy OS)课程笔记-并发部分","name":"NJU操作系统(jyy OS)课程笔记-并发部分","description":"lec5 多处理器编程：","datePublished":"2024-11-01T18:57:09.000Z","author":{"@type":"Person","name":"ayanami"},"keywords":["jyy os"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/nginx","mainEntityOfPage":"https://ayanami1314.github.io/blog/nginx","url":"https://ayanami1314.github.io/blog/nginx","headline":"nginx基础","name":"nginx基础","description":"配置文件","datePublished":"2024-11-01T18:57:09.000Z","author":{"@type":"Person","name":"ayanami"},"keywords":["nginx"]},{"@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/cs144/cs144 lec notes","mainEntityOfPage":"https://ayanami1314.github.io/blog/cs144/cs144 lec notes","url":"https://ayanami1314.github.io/blog/cs144/cs144 lec notes","headline":"CS144 Lecture Notes","name":"CS144 Lecture Notes","description":"Unit 1: Internet and IP","datePublished":"2024-09-20T00:00:00.000Z","author":{"@type":"Person","name":"ayanami"},"keywords":[]}]}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ayanami&#39;s Cave Atom Feed">



<link rel="alternate" type="application/rss+xml" href="/personal-essays/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-essays/atom.xml" title="Ayanami&#39;s Cave Atom Feed">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.00dd3480.css">
<script src="/assets/js/runtime~main.f1dc3430.js" defer="defer"></script>
<script src="/assets/js/main.ed533bac.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ayanami&#x27;s Cave</b></a><a class="navbar__item navbar__link" href="/docs/Chcore源码阅读/">课程笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">技术博客</a><a class="navbar__item navbar__link" href="/personal-essays">个人随笔</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All our posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/local-llm">来本地部署大模型!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os-虚拟化">NJU操作系统(jyy OS)课程笔记-虚拟化部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs186-database-WIP">ucb cs186 课程笔记(更新中)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/系统架构设计笔记">system-design-interview笔记</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ostep-chapter42-44">ostep阅读笔记：单机fs的崩溃一致性(chapter42-44)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/JUC">JUC</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144 labs">cs144 labs(Winter 2024)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os：并发">NJU操作系统(jyy OS)课程笔记-并发部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/nginx">nginx基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144/cs144 lec notes">CS144 Lecture Notes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/django-mosh">Django_mosh</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/splay-tree">splay tree</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/xv6book-notes">xv6book Notes(C1-4)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Go-Gin学习">Go,Gin学习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godis源码阅读">godis源码阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hibernate-jpa">hibernate&amp;jpa</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/linking-复习">linking 复习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ts基础">ts基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/实战2-mosh-gamehub">react practice:mosh gamehub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/浅入理解断点和调试器">浅入理解断点和调试器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/黑马点评">黑马点评(速通版)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/js基础">js基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-14-11-26学习双周记">11-14-11-26学习双周记</a></li></ul></nav></aside><main class="col col--7"><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/local-llm">来本地部署大模型!</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-01-19T08:04:51.305Z">January 19, 2025</time> · <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="前言">前言<a class="hash-link" aria-label="Direct link to 前言" title="Direct link to 前言" href="/blog#前言">​</a></h2>
<p>这件事情的起因是这样的, 在开卷上机考想要部署一个本机大模型参考一下, 同时有同学和我讲qwen2.5-coder-7B非常的nice, 于是就有了下面这篇文章, 用ollama + docker部署的local LLM...</p>
<p>本地环境: Ubuntu24.04</p>
<p>以下是步骤</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="下载nvidia-docker-runtime">下载nvidia docker runtime<a class="hash-link" aria-label="Direct link to 下载nvidia docker runtime" title="Direct link to 下载nvidia docker runtime" href="/blog#下载nvidia-docker-runtime">​</a></h4>
<p>参考 <a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#installing-with-apt" target="_blank" rel="noopener noreferrer">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html#installing-with-apt</a></p>
<p>apt</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &amp;&amp; curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sed &#x27;s#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g&#x27; | \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo apt-get install -y nvidia-container-toolkit</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>设置 /etc/docker/daemon.json</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;default-runtime&quot;: &quot;nvidia&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;registry-mirrors&quot;: [</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;https://1nj0zren.mirror.aliyuncs.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;https://docker.mirrors.ustc.edu.cn&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;http://f1361db2.m.daocloud.io&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;https://registry.docker-cn.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;runtimes&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;nvidia&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;args&quot;: [],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;path&quot;: &quot;nvidia-container-runtime&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>如果你需要代理, 参考配置加上</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">   &quot;proxies&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;http-proxy&quot;: &quot;http://127.0.0.1:7890&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;https-proxy&quot;: &quot;http://127.0.0.1:7890&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;no-proxy&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>然后重启docker服务</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl daemon-reload    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sudo systemctl restart docker</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>出现找不到&quot;nvidia&quot; runtime错误的, 检查有没有下载  过docker desktop</p>
<p><strong>下载过docker desktop的:</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker context ls</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker context use default</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>切换回default, 然后重启docker服务</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="下载ollama镜像">下载ollama镜像<a class="hash-link" aria-label="Direct link to 下载ollama镜像" title="Direct link to 下载ollama镜像" href="/blog#下载ollama镜像">​</a></h4>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p /data/containers/ollama/data</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vi /data/containers/ollama/docker-compose.yml</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>docker-compose.yml</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;ollama&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ollama</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">restart</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ollama/ollama</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">container_name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ollama</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">runtime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> nvidia</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> TZ=Asia/Shanghai</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> NVIDIA_VISIBLE_DEVICES=all</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ai</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ports</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;11434:11434&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./data</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/root/.ollama</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">networks</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">ai-tier</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ai</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">tier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">driver</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> bridge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">ipam</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">config</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> </span><span class="token key atrule" style="color:#00a4db">subnet</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> 172.22.1.0/24</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>启动</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd /data/containers/ollama</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker compose up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>之后会拉ollama (2G)</p>
<p>验证成功</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker compose ps</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 得到结果应该如下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME      IMAGE           COMMAND               SERVICE   CREATED              STATUS              PORTS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ollama    ollama/ollama   &quot;/bin/ollama serve&quot;   ollama    About a minute ago   Up About a minute   0.0.0.0:11434-&gt;11434/tcp, :::11434-&gt;11434/tcp</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="下载模型">下载模型<a class="hash-link" aria-label="Direct link to 下载模型" title="Direct link to 下载模型" href="/blog#下载模型">​</a></h4>
<p><code>qwen2.5:7b</code>建议换成其他的代码专用模型, 根据自己的电脑显卡配置决定参数量</p>
<p>空间占用 7b:5G, 3b: 2G, 1B:1G</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -it ollama ollama pull qwen2.5:7b</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>成功结果这样</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">pulling manifest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pulling 00e1317cbf74... 100% ▕████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████  4.7 GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pulling 4fa551d4f938... 100% ▕████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████   12 KB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pulling 8ab4849b038c... 100% ▕████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████   254 B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pulling 577073ffcc6c... 100% ▕████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████   110 B</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pulling ad1518640c43... 100% ▕████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████   483 B </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">verifying sha256 digest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">writing manifest</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">removing any unused layers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">success</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>验证</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">❯ docker exec -it ollama ollama list</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">NAME          ID              SIZE      MODIFIED    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">qwen2.5:7b    845dbda0ea48    4.7 GB    2 hours ago    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">What&#x27;s next:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Try Docker Debug for seamless, persistent debugging tools in any container or image → docker debug ollama</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Learn more at https://docs.docker.com/go/debug-cli/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="开始服务">开始服务<a class="hash-link" aria-label="Direct link to 开始服务" title="Direct link to 开始服务" href="/blog#开始服务">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker compose up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>会在<code>localhost:11434</code>起一个服务, 浏览器输入后正常会有<code>Ollama is running</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="前端套壳">前端套壳<a class="hash-link" aria-label="Direct link to 前端套壳" title="Direct link to 前端套壳" href="/blog#前端套壳">​</a></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="chatbox">ChatBox<a class="hash-link" aria-label="Direct link to ChatBox" title="Direct link to ChatBox" href="/blog#chatbox">​</a></h5>
<p>直接去官网下载</p>
<p><a href="https://chatboxai.app/zh/install" target="_blank" rel="noopener noreferrer">https://chatboxai.app/zh/install</a></p>
<p>设置里面指定一下模型</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2024/11/21/5gEJheUDilNtBS3.png" alt="image-20241121211509468" class="img_ev3q"></p>
<h4></h4>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="aider版本">aider版本<a class="hash-link" aria-label="Direct link to aider版本" title="Direct link to aider版本" href="/blog#aider版本">​</a></h5>
<p>参考<code>https://aider.chat/docs/config/dotenv.html</code>设置一下OLLAMA_BASE_API的环境变量</p>
<p>之后<code>aider --model ollama/qwen2.5:7b </code>即可</p>
<p>下载自己看官网(<code>pip install aider-chat</code>)</p>
<p><strong>ok, 大功告成！</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="可选-ide插件">[可选] IDE插件<a class="hash-link" aria-label="Direct link to [可选] IDE插件" title="Direct link to [可选] IDE插件" href="/blog#可选-ide插件">​</a></h4>
<p>一个例子是Continue插件<a href="https://www.continue.dev/" target="_blank" rel="noopener noreferrer">https://www.continue.dev/</a></p>
<p>参考官网, 据说vsc支持还行, jet bug不少</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/ai">ai</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/llm">llm</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/deploy">deploy</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/jyy-os-虚拟化">NJU操作系统(jyy OS)课程笔记-虚拟化部分</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-01-19T06:48:39.789Z">January 19, 2025</time> · <!-- -->18 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec14-操作系统上的进程">lec14 操作系统上的进程<a class="hash-link" aria-label="Direct link to lec14 操作系统上的进程" title="Direct link to lec14 操作系统上的进程" href="/blog#lec14-操作系统上的进程">​</a></h3>
<p>cpu有初始pc地址<code>-&gt;</code>放置固件上的初始程序(固件状态机)<code>-&gt;</code>启动OS(os状态机)<code>-&gt;</code>load init程序(程序状态机), 之后OS完全把行为转交给init(进程树的root)</p>
<p>llm <code>知道存在</code>与<code>知道</code>的界限正在模糊: 知道存在且合理 逐渐趋同于 能做</p>
<p>例如 qemu 相关的一些东西</p>
<p>问llm发散出的概念<code>-&gt;</code>知识体系的快速建立</p>
<p>fork? 以状态机的视角理解</p>
<p>经典的for fork + printf</p>
<p>写了个示例</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;cstddef&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;cstdio&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;cstdlib&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;unistd.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;vector&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;mutex&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;sys/wait.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;map&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;string&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">using</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">namespace</span><span class="token plain"> std</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> size_t buf_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1024</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">map</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">string</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> mode_map </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">_IONBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;no buffer&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">_IOLBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;line buffer&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">_IOFBF</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;full buffer&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> __modes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;test in mode %s\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> mode_map</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">at</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">__modes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">c_str</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fflush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    vector</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token keyword" style="color:#00009f">int</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> childs</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">mutex mtx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">setvbuf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">nullptr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> __modes</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain">i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> pid </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">fork</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;hello from pid %d\n&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> pid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            std</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">lock_guard</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">mutex</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">lock</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">mtx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            childs</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">push_back</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// _IOLBF, _IOFBF, _IONBF</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">test</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_IOFBF</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;\n&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">fflush</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stdout</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>在<code>_IOLBF</code>和<code>_IONBF</code>的情况下会出来6个hello</p>
<p>每次printf都直接刷新/检测到换行符刷新缓冲, fork的时候没有IO状态
而<code>_IOFBF</code>会有8个hello, 在fork第二次的时候会带着缓冲区(就是一段内存空间)进行fork,所以最后的4个进程每个都带着2个hello</p>
<p><strong>系统里面没有魔法</strong></p>
<p>fork: 把所有的知道的不知道的都复制了</p>
<p>“是不是这样?” <code>-&gt;</code> 不知道的底层状态被复制了</p>
<p><code>execve</code>: <strong>重置状态机</strong> <code>argc, argv, envp -&gt; main()</code></p>
<p>execve是唯一一个可以新建一个状态机的系统调用</p>
<p><code>exit</code>?</p>
<ul>
<li>main return</li>
<li><code>exit</code> libc提供的</li>
<li><code>_exit</code> 系统调用退出（<code>== asm volatile(&quot;mov ..., %rax; syscall&quot;)</code>）</li>
<li>直接<code>SYSCALL</code></li>
</ul>
<p>前两个在c语言的空间, 是“normal exit”</p>
<p>后两个不是normal的, <code>_exit</code> <code>exit_group</code> , <code>__exit</code> exit self</p>
<p>行为区别? <code>strace</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec15-进程的地址空间">lec15 进程的地址空间<a class="hash-link" aria-label="Direct link to lec15 进程的地址空间" title="Direct link to lec15 进程的地址空间" href="/blog#lec15-进程的地址空间">​</a></h3>
<p>pmap</p>
<p><code>/proc/[pid]/maps</code></p>
<p>vvar(r), vdso(rx), vsyscall</p>
<p>os内只读的syscall <code>-&gt;</code> 可以以内存的形式共享</p>
<p>其实只需要进程能和OS交互一些数据就行 —— why not进程写page, OS轮询?</p>
<ul>
<li>在极端的时候能提高一些高优先级的进程的性能, 某篇OSDI</li>
</ul>
<p>地址空间应该是在运行时可变的</p>
<p>所以我们需要一个不存在于c世界的操作(syscall)去操作地址空间 <code>-&gt;</code> mmap, munmap</p>
<p>入侵进程的地址空间: gdb, perf</p>
<p>Game Genie 物理入侵地址空间</p>
<ul>
<li>外接电路: 当cpu读地址a的时候读到x, 则替换为y</li>
</ul>
<p>jyy现场演示mini CE(雾)</p>
<p>gdb attach到虚拟机,查找满足某个模式的内存值, 修改之</p>
<p><code>/proc/[pid]/mem</code> 修改器 = 调试器</p>
<p>xdotool: cmd X11 automation tool</p>
<p>ydotool: better xdotool <code>-&gt;</code> 按键精灵</p>
<p>evdev 按键显示脚本</p>
<p>xdotool测试vsc插件, crazy</p>
<p>或许不需要那么多的“魔法工具”</p>
<p>OS: 解放编程能力, 什么事情在OS上可以做</p>
<p>变速齿轮: syscall是感知时间的唯一方法</p>
<p>gdb 脚本之中, 在gettimeofday打断点, 然后修改寄存器, amazing!!!</p>
<p>hook</p>
<p>patching: 整活, kpatch, 不停机更新(软件动态链接)</p>
<p><code>old func, rx -&gt; 修改为rwx -&gt; 修改old func为, jmp到new func</code></p>
<p>在chcore里面看看? 或许有必要研究一下gdb(attach with qemu)</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec16-syscall--unix-shell">lec16 syscall &amp; unix shell<a class="hash-link" aria-label="Direct link to lec16 syscall &amp; unix shell" title="Direct link to lec16 syscall &amp; unix shell" href="/blog#lec16-syscall--unix-shell">​</a></h3>
<p>everything is a file</p>
<p>thing: 操作系统里面的对象</p>
<p>gpt时代的“编程”——自然语言?</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">//OS: API:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//	get_object_by_name(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//		&quot;the address space file of pid=1234&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//	)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>文件描述符: 指向OS对象的“指针”</strong></p>
<p>windows: handle(句柄)</p>
<p>IPC endpoints: 例子, 管道</p>
<p>管道是同步的</p>
<p>fork + pipe? 本质是&quot;指针&quot;的拷贝</p>
<p>现在两个进程都有读口和写口啦</p>
<p>shell, kernel 的外壳</p>
<p>cli: 高效简洁的编程语言</p>
<p>算力的提升: <code>cli -&gt; gui -&gt; 自然语言</code></p>
<p>shell as pl: <strong>基于文本替换的快速工作流搭建</strong></p>
<p>job control: 类比窗口管理器的&quot;x&quot;, 最小化</p>
<p>或许不需要tmux, shell就是最简单的tmux</p>
<p>手册: complete ref</p>
<p>AI是“被动的”, 读一读shell manual</p>
<p>复刻unix shell</p>
<p>“抛开系统库”</p>
<p><code>-ffreestanding -nostdlib -static</code></p>
<p>gdb init已经很常见了, 但gdb init到python再在python里面转回<code>/proc/[pid]/fd</code>打印, 最后结合gdb的内置hook,在stop时候打印, fancy!</p>
<p>这打印的不是我们go的channel语法吗, 更有趣了</p>
<p>sh manual</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec-17-syscall的封装-libc">lec 17 syscall的封装: libc<a class="hash-link" aria-label="Direct link to lec 17 syscall的封装: libc" title="Direct link to lec 17 syscall的封装: libc" href="/blog#lec-17-syscall的封装-libc">​</a></h3>
<p>pipe write如果小于PIPE_BUF, 是原子的</p>
<p>pipe 7</p>
<p>读者关闭: Broken pipe</p>
<p>libc 标准化, 稳定可靠, 移植性极好</p>
<p>C runtime library: -Wl, --verbose看到链接列表</p>
<p>调试glibc? 历史包袱重, 大量内联汇编, musl</p>
<p>只要实现了C ABI指定的堆栈排布的系统调用, 就可以轻松移植musl等到自己的OS上, 底层的计算由硬件指令集给出</p>
<p>System V ABI</p>
<p>脱开workload 做优化就是耍流氓</p>
<ul>
<li>在开始考虑性能之前, 理解需要考虑什么样的性能</li>
</ul>
<p><strong>workload哪里找? 当然是paper了(顺便白得方案)</strong></p>
<ul>
<li>看wkld调性能</li>
</ul>
<p>mm alloctor: 根基</p>
<ul>
<li>大对象应该有长生存期, 否则是performance bug</li>
<li>越小的对象创建/分配越频繁</li>
<li>小对象, 中对象, 大对象</li>
</ul>
<p>瓶颈几乎是小对象</p>
<p>链表/区间树不是一个好想法: 上锁, 不能很好的并行化</p>
<p>设置两套系统：</p>
<ul>
<li>Fast path 性能极好，并行度极高，覆盖大部分情况</li>
<li>Slow path 不在乎速度，但把困难的事情做好</li>
<li>例如cache</li>
</ul>
<p>init ram fs</p>
<p>ISA -&gt; OS 对象/syscall -&gt; libc -&gt; 系统工具 coreutils, busybox -&gt; 应用程序</p>
<p>initramfs</p>
<ul>
<li>
<p>加载剩余必要的驱动程序, 例如磁盘/网卡</p>
</li>
<li>
<p>挂载必要的fs</p>
</li>
<li>
<p><strong>将根文件系统和控制权移交给另一个程序, 例如systemd</strong></p>
</li>
</ul>
<p>initramfs作为一个非常小的启动fs, 再把磁盘这个OS Object mount进来, 最后switch root把控制权给到磁盘的的根系统</p>
<p>启动的第二级阶段 /sbin/init</p>
<p>疯狂的事情不断有人在做, 但疯狂的事情的起点其实经常很小</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec-19-可执行文件">lec 19 可执行文件<a class="hash-link" aria-label="Direct link to lec 19 可执行文件" title="Direct link to lec 19 可执行文件" href="/blog#lec-19-可执行文件">​</a></h3>
<p>elf不是一个人类友好的“状态机数据结构描述”</p>
<p>为了性能, 彻底违背了可读(“信息局部性”)原则</p>
<p>可执行文件=OS的<strong>数据结构</strong>(core.dump), 描述了程序应该的初始状态</p>
<p>支持的特性越多, 人类越不能理解</p>
<p>人类友好: <strong>平坦的</strong></p>
<p>回归连接和加载的核心概念: 代码、符号、重定位</p>
<p>my_execve</p>
<p>elf file -&gt; parse as struct</p>
<p>-&gt; 将各个section load到指定的地址(mmap)-&gt;asm volatile布置好ABI调用栈(根据手册)-&gt;jmp!</p>
<p>如何释放旧进程的内存资源？proc里面需要有记录</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec-21-syscall--ctx-switch">lec 21 syscall &amp; ctx switch<a class="hash-link" aria-label="Direct link to lec 21 syscall &amp; ctx switch" title="Direct link to lec 21 syscall &amp; ctx switch" href="/blog#lec-21-syscall--ctx-switch">​</a></h3>
<p>dynamic linker</p>
<p>se给的os基础还是很扎实的
很难想象ics2里面讲了GOT和PLT</p>
<p>SEE ALSO是一个宝藏 man ld.so</p>
<p>hacking: <code>LD_PRELOAD</code>不需要修改libc, 动态加载的全局符号, <strong>先到先得</strong></p>
<p><strong>劫持大法</strong>！</p>
<p>kernel memory mapping</p>
<p>低配版Linux 1.X 分段, 内核在低位, 只是分个段</p>
<p>低配版Linux 2.X 内核还是在物理低位, 但程序看到虚拟地址已经是高位了</p>
<p>today: complete memory map</p>
<p>qemu is a state machine simulator: 调试syscall(gdb并不能si从用户态进kernel)</p>
<p>另一种理解中断的方式：&quot;被&quot;插入一条syscall</p>
<p>中断, 把状态机的整个寄存器状态存到内存里面</p>
<p>在汇编之中小心排布内存和搬运寄存器, 返回到c之中就是结构体的context</p>
<p>schedule的核心: 调用一个“不会返回的函数”</p>
<p>这个(汇编)函数以context为参数, 并且根据context, 返回到另一处控制流...</p>
<p><code>-&gt;</code> coroutine 也是如此! OS作为一个“状态机管理器”就在做一个&quot;coroutine event handler&quot;的作用</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec-22-process">lec 22 process<a class="hash-link" aria-label="Direct link to lec 22 process" title="Direct link to lec 22 process" href="/blog#lec-22-process">​</a></h3>
<p>进程: “戴上VR”的thread</p>
<p>有自己的地址转换, 对一切的load/store会应用一个f，作用在addr上</p>
<p>硬件提供了“戴上VR”的指令</p>
<p>这个f从ds的视角来说就是<code>int-&gt;int</code>的映射</p>
<p>查页表(<code>int-&gt;int</code>的映射)这件事, 如何加速? --自然想到radix tree</p>
<p>普通实现是radix tree(x86, riscv, ...收敛到的最终方案)</p>
<p>每一次访存都要查这么几次的话不可接受</p>
<p>因此有了TLB, 但立刻带来的一个设计问题是, 谁来管TLB(以及对应的miss处理？)</p>
<p>x86选择放到硬件, 但丧失灵活性的后果是即使有些进程只想要f(x)=x, 也必须要老实查表, TLB在和cpu cache抢带宽</p>
<p>MIPS选择放到软件, miss了直接丢出来异常, 让软件来决定怎么处理TLB</p>
<p>疯狂的想法: inverted page table</p>
<p>把key从VPN换成 (VPN, pid), 然后从一一映射改成hashtable, 支持每个进程有自己的页表</p>
<p>缺点在例如hashtable带来的冲突时(TLB miss, etc)时间不可控(O(1) ~ O(n))</p>
<p>每个进程都有自己的“VR眼镜”这件事情还带来了更多的优化空间, 例如多个进程, 不同的虚拟地址块映射到同一个物理地址, 以及cow</p>
<p>KSM(kernel samepage merging/mermory deduplication), demand paging</p>
<p>fork: 进程快照, redis</p>
<p>cow fork的缺点: 让系统实现变复杂</p>
<p>改革: 砍掉所有的内核部分, 剩下的全部交给xv6</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec-23-处理器调度">lec 23 处理器调度<a class="hash-link" aria-label="Direct link to lec 23 处理器调度" title="Direct link to lec 23 处理器调度" href="/blog#lec-23-处理器调度">​</a></h3>
<p>trampoline code</p>
<p>跳板代码, 例子</p>
<ul>
<li>call printf -&gt; call *GOT(printf)</li>
<li>JIT编译器</li>
<li>软件热更新(patch 函数头)</li>
</ul>
<p>资源调度(分配)是一个非常复杂的问题</p>
<p>建模, 预测, 决策 <code>-&gt;</code> 调度策略的设计空间</p>
<p>调度策略</p>
<p>再加一层机制 &quot;niceness&quot;, 管理员控制nice, 越nice越能得到cpu</p>
<p>10 nice ~ 10倍性能差异</p>
<p>taskset 绑定一个process到一个cpu上</p>
<p>round-robin时代: MLFQ, 动态优先级</p>
<ul>
<li>
<p>让出CPU(I/O) -&gt; “好”</p>
</li>
<li>
<p>用完时间片 -&gt; “坏”!</p>
</li>
</ul>
<p>1960s: breakthrough!</p>
<p>2020s: 对很多负载都欠考虑</p>
<p>今天的调度: CFS(complete fair scheduling)</p>
<p>但有vruntime, &quot;好人&quot;的钟快一些</p>
<p>真实的处理器调度: 不要高兴得太早...</p>
<ul>
<li><strong>低优先级的在持有mutex的时候被中间优先级的赶下处理器</strong>, 可以<strong>导致高优先级的任务等待mutex退化到低优先级</strong> <code>-&gt;</code> 火星车</li>
</ul>
<p><strong>Linux: 没法解决, CFS凑合用</strong></p>
<p>实时系统: 火星车在CPU Reset, 不能摆烂</p>
<ul>
<li>
<p>优先级继承, 条件变量唤醒?</p>
</li>
<li>
<p>lockdep预警</p>
</li>
<li>
<p>...</p>
</li>
</ul>
<p><strong>然而不止有锁, 还有多处理器...</strong></p>
<p><strong>今天的计算机系统: SMP</strong></p>
<p><strong>多处理器的矛盾困境</strong></p>
<ul>
<li><strong>绑定一个线程:&quot;一核有难, 八方围观&quot;</strong></li>
<li><strong>谁空丢给谁: cache, TLB白干</strong></li>
</ul>
<p><strong>更多的实际情况: NUMA, 异构, 多用户</strong></p>
<ul>
<li>
<p><strong>numa: 远近cpu性能差达到数倍</strong></p>
</li>
<li>
<p><strong>多用户的cpu共享? namespaces, cgroups, 例如一个程序开并行, 另一个程序是串行的, 是否需要给串行的保留一个核, 而不是开得越多抢得越多</strong></p>
</li>
<li>
<p><strong>异构, 大小核超小核, GPUNPU, 每个核的独有缓存和共享缓存...</strong></p>
</li>
<li>
<p><strong>更少的处理器可能更快...(反直觉, 同步cacheline带来的开销)</strong></p>
</li>
</ul>
<p>复杂的系统无人掌控</p>
<p>ghOSt: Fast &amp; Flexible User-Space Delegation of Linux</p>
<p>开始下放给应用程序做调度</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="others">Others<a class="hash-link" aria-label="Direct link to Others" title="Direct link to Others" href="/blog#others">​</a></h3>
<p>早期优雅的设计可能会成为后续发展的包袱: fork+exec带来的膨胀, <strong>所有涉及到OS内部状态的api都需要考虑fork行为</strong>, 例如文件偏移量...</p>
<p>总线, 中断控制器, DMA</p>
<p>总线: 提供设备的“虚拟化”, 注册和转发, 把收到的地址(总线地址)和数据转发到对应的设备上</p>
<p><strong>这样cpu只需要直连一根总线就行了!</strong></p>
<p>PCI总线</p>
<ul>
<li>总线可以桥接其他总线, 例如<code>pci -&gt; usb</code></li>
</ul>
<p><code>lspci -tv</code>可视化</p>
<p>&quot;即插即用&quot;的实现——非常复杂!</p>
<p>cpu: 只有一根中断线</p>
<p>启  动多个cpu: cpu给其他cpu发中断!</p>
<p>中断仲裁: 收集各个设备中断, 选一个发给cpu</p>
<p>APIC(Advanced PIC):</p>
<ul>
<li>local APIC: 中断向量表, IPI, 时钟, ...</li>
<li>IO APIC: IO设备</li>
</ul>
<p>DMA: 很早期就有了, 解放cpu, 设计专用的电路只做memcpy</p>
<p>今天: PCI总线直接支持</p>
<p><strong>文件 = 实现了文件操作的“Anything”</strong></p>
<p><strong>设备驱动程序: 一个 struct file_operations的实现, 就是一段普通的内核, “翻译”read/write等系统调用</strong></p>
<p><code>/dev/null</code>的驱动: read永远什么都不做返回0, write永远什么都不做返回count</p>
<p>一种&quot;duck type&quot;</p>
<p>设备不仅仅是数据, 还有配置</p>
<p>配置设备:</p>
<ul>
<li>控制作为数据流的一部分(自定义一套write的指令编码)</li>
<li>提供一个新的接口</li>
</ul>
<p>ioctl: 非数据的设备功能几乎完全依赖ioctl, 完全由驱动决定</p>
<p>数量最庞大,质量最低的shit</p>
<p>unix的负担: 复杂的hidden spec</p>
<p>/dev/kvm 硬件虚拟化, 支撑了几乎所有的云产商虚拟化方案</p>
<p>unix的设计: 目录树的拼接</p>
<p>将一棵目录树拼到另一棵上</p>
<p>回想最小linux系统, 只有/dev/console和几个文件</p>
<p>/proc, /sys, /tmp都是mount系统调用创建的</p>
<p>&quot;看到的fs!=磁盘的fs&quot;, is just a <strong>view</strong></p>
<p>像是procfs这种并非实际的fs更是, 可以挂载到任意的地方, 以任意的数量(因为他只是fake了read/write的“file Object”)</p>
<p>根本设计哲学: 灵活</p>
<p>灵活性带来的</p>
<ul>
<li><code>/</code>, <code>/home</code>, <code>/var</code>都可以是独立的设备, 把有些快的放在一个目录存可执行文件, 另一些存数据...</li>
</ul>
<p>mount一个文件? loopback device</p>
<p>设备驱动把设备的read/write翻译成文件的rw</p>
<p>FHS: Filesystem Hierarchy Standard</p>
<p>ln -s 图结构 as 状态机</p>
<p>fs: 一个”数据结构  题“, 但读写的单元是一个block</p>
<p>FAT: 集中保存所有&quot;next&quot;指针, 可靠性? 存n份!</p>
<p>fat manual</p>
<p>fat 小文件ok, 大文件不行</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/os">os</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/system">system</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/virtualize">virtualize</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/cs186-database-WIP">ucb cs186 课程笔记(更新中)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-01-19T06:44:01.658Z">January 19, 2025</time> · <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="lec2">lec2<a class="hash-link" aria-label="Direct link to lec2" title="Direct link to lec2" href="/blog#lec2">​</a></h2>
<p>join: inner join, natural join, outer join</p>
<p>sql  实际执行模型 写起来是 SELECT - FROM - GROUP BY - HAVING - WHERE - DISTINCT - ORDER BY</p>
<p>实际是 FROM(table过滤) - GRUOP BY(行分组) - HAVING(组过滤) - WHERE(行过滤) - DISTINCT(行去重) - SELECT(行内列过滤)</p>
<p>inner join:叉积，对AB所有行组合</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> TABLE1 t1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> TABLE2 t2 </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 等效于</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	TABLE1 t1 </span><span class="token keyword" style="color:#00009f">INNER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> TABLE2 t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 下面这种更加清晰一点</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 等效于</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	TABLE1 t1 </span><span class="token keyword" style="color:#00009f">NATURAL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> TABLE2 t2</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- natural join就是在组合的基础上自动用了一个过滤，要求table所有相同名字的列的值都相同</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>outer join:</p>
<p>Left Outer join:</p>
<p><code>A LEFT OUTER JOIN B ON cond</code> 如果cond满足的话，得到的是AB的组合（一行有A的列+B的列）;如果不满足，得到A的列+空</p>
<p>Right Outer Join 同理</p>
<p>Full Outer Join 同理 例如<code>ON A.id = B.id</code></p>
<p>如果有A没有对应的B, 那就是是 A + 空</p>
<p>如果有B没有对应的A, 那就是 空 + B</p>
<p>非常好的图</p>
<p><img decoding="async" loading="lazy" alt="db-join" src="/assets/images/image-f9fa91e00a44e27c8e39a9d1bf4c6d74.png" width="1419" height="322" class="img_ev3q"></p>
<p>alias</p>
<p>简化 +  看起来更清楚（尤其是self-join）</p>
<p><code>FROM TABLE1 AS x, TABLE1 AS y</code></p>
<p>String Comp</p>
<p><code>LIKE</code>或者正则<code>S.name ~ &#x27;^B.*&#x27;</code> (等效于<code>S.name LIKE &#x27;B_%&#x27;</code>)</p>
<p><code>AND</code> <code>OR</code> 做条件交并</p>
<p><code>EXCEPT</code> <code>UNION (ALL)</code> <code>INTERSECT</code>做子查询结果集合的交并差</p>
<p><code>IN</code> <code>EXISTS</code>用于子查询 (<code>NOT IN</code>, <code>NOT EXIST</code>) EXISTS是判空</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sname </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> Sailors S </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sid </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sid </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> Reserves R </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> R</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">bid</span><span class="token operator" style="color:#393A34">=</span><span class="token number" style="color:#36acaa">102</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>还有<code>ANY</code> <code>ALL</code></p>
<p>ARGMAX?</p>
<div class="language-SQL language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> Sailors S </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	S</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rating </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> S2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">rating </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> Sailors S2</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>View: Named Queries</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VIEW</span><span class="token plain"> xxx</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> xxx</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>cache and reuse</p>
<p>或者</p>
<p><code>WITH [viewname] AS [statement]</code>创建一个临时view</p>
<p>NULL 参与的运算大多是NULL, 除了IS NULL，False AND NULL这种</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lec3">lec3<a class="hash-link" aria-label="Direct link to lec3" title="Direct link to lec3" href="/blog#lec3">​</a></h2>
<p>Disk &amp; Buffer</p>
<p>整体架构</p>
<p>SQL client-&gt; Query Parsing &amp; Optimization-&gt;Relational Operators-&gt; Files and Index Management-&gt;Buffer Management-&gt;Disk Space Management</p>
<p>Concurrency Control &amp; Recovery</p>
<p>磁盘太慢，需要尽量减少读写，且寻道和旋转时间是大头</p>
<p>&quot;block&quot; &amp;&amp; &quot;page&quot;: 一个意思，磁盘上的块状读写最小单元 一般64KB-128KB</p>
<p>为了重用硬件驱动，经常会将磁盘空间管理器建立在文件系统API上，但带来了一些大数据库多文件系统的问题，也有直接建立在设备上的，更快但是移植性问题</p>
<p>给上层的抽象是一个巨大的文件</p>
<p>DB file: page的集合，每个page又包含了许多records</p>
<p>给上层提供：CRUD on records</p>
<p>record解构成一个&quot;指针&quot; <code>{pageID, location on page}</code></p>
<p>structures</p>
<ul>
<li>Unordered Heap Files(和数据结构heap没啥关系，无序records)</li>
<li>Clustered Heap Files</li>
<li>Sorted Files</li>
<li>Index Files</li>
</ul>
<p>如何组织page呢？</p>
<p>链表？ 想想就知道效率很差</p>
<p>类似目录的形式？ 部分page只存到其他page的指针，并且始终放在缓存之中</p>
<p>page解构</p>
<p>Page Header:</p>
<ul>
<li>Number of records</li>
<li>Free space</li>
<li>Mayba a last/next pointer</li>
<li>Bitmaps, slot table</li>
</ul>
<p>record 中间留不留空？</p>
<p>不留空：Fixed Length Records, Packed</p>
<p>header后面跟紧密定长records, 因此可以有 record id = <code>{pageId, record number in page}</code>， 简单运算得到location</p>
<p>加很简单，直接append</p>
<p>删，全移一遍？-&gt;O(N),自然想到能不能lazy delete或者soft delete</p>
<p>方法是在header里面放一个delete bit的bitmap</p>
<p>变长？</p>
<p>slotted page</p>
<p>将信息存在footer（称为slot directory）, record从头部开始存</p>
<p>由record id得到dir中位置，位置里面是pointer + length，</p>
<p>删，将slot dir中的项置空</p>
<p>插入，插在空位上，更新slot dir</p>
<p>fragmentation?</p>
<p>什么时候reorganize?-&gt;设计取舍，大部分时候没有那么多删除（乐）</p>
<p>slot不够-&gt;从page尾部向前增长</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="lec4">lec4<a class="hash-link" aria-label="Direct link to lec4" title="Direct link to lec4" href="/blog#lec4">​</a></h2>
<p>cost model for ayalysis</p>
<p>B, D, R</p>
<ul>
<li>the number of data blocks</li>
<li>the number of records per clock</li>
<li>avg time to r/w disk block</li>
<li>opt: index</li>
</ul>
<p>indexes:</p>
<p>大幅度降低range操作耗时</p>
<p>An index is data structure that enables fast lookup and modification of data entries by search key</p>
<p>区间查找 &amp; 子集搜索, 可以复合, 不需要唯一</p>
<p>2-d box 2-d circle n-d indexes都有</p>
<p>kd树啊R树啊</p>
<p>postgres 的 GiST index</p>
<p>left key opt: 最小的key是不需要的,直接拿-inf当下界就行</p>
<p>处理相等:<code>&gt;=</code> 向右走就行</p>
<p>B+树</p>
<ul>
<li>
<p>叶子不一定是连续的-动态分配,指针连接以支持range scan</p>
</li>
<li>
<p>阶数d, fan-out 2d+1 典型的fan-out 为2144()</p>
</li>
<li>
<p>删除, 理论上来说, 可能涉及到重新平衡等操作 但实际的操作之中, 只需要删除即可, 原因是平衡太慢了,并且删了也能再插</p>
</li>
</ul>
<p>叶子放什么?</p>
<ol>
<li>数据</li>
</ol>
<p>pros:</p>
<ul>
<li>快</li>
</ul>
<p>cons:</p>
<ul>
<li>想要在另一列构建索引只能重新复制文件(文件只能按照一种方式实际排序存储)</li>
<li>即使真复制了,同步问题也很寄</li>
</ul>
<ol start="2">
<li>指向数据的指针 (key, page id+list of record id)</li>
</ol>
<p>在b+树里面有重复项</p>
<ol start="3">
<li>指向同一个键的所有records (key, list of (page id + list of record id))</li>
</ol>
<p>减少冗余,增加复杂性</p>
<p>clustered: index指向的数据块在磁盘上是按照这个index排序或者近似排序的</p>
<p>非常大影响性能 顺序比随机快100倍</p>
<p>对于一个有变化的数据,例如插入或者删除,需要一些成本进行磁盘数据的重新排序来维持clustered</p>
<p>B+树的平衡性:</p>
<p>使用字节数半满(占页面容量)就行, 甚至实际上更低, 按照实际性能来决定,不严格</p>
<p>变长key: 前缀压缩 trie</p>
<p>性能的常数:</p>
<p>由于顺序读写比随机读写快100倍</p>
<p>B+树比全表扫描差不多也是涉及到1%以下的表才有显著优势</p>
<p>所以例如对一个非聚簇索引进行一个跨越半个表的range的扫描, 那还不如直接把全表取出来</p>
<p>优化</p>
<p>由于B+树效率真的很低,所以有很多优化策略</p>
<ul>
<li>bulk loading 批量装载</li>
</ul>
<ol>
<li>Sort the data by a key.</li>
<li>Fill leaf pages up to size f (the <strong>fill factor</strong>).</li>
<li>If the leaf page overflows, then use the insertion split algorithm from a normal B+ tree.</li>
<li>Adjust pointers to reflect new nodes if needed.</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/database">database</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/system">system</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/系统架构设计笔记">system-design-interview笔记</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-01-19T06:37:33.783Z">January 19, 2025</time> · <!-- -->27 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="限流器">限流器<a class="hash-link" aria-label="Direct link to 限流器" title="Direct link to 限流器" href="/blog#限流器">​</a></h3>
<ul>
<li>
<p>放在哪里?</p>
<ul>
<li>客户端, 容易被伪造绕过</li>
<li>服务端应用代码, 灵活性高, 但占据工程资源</li>
<li>云上微服务, api网关等, 灵活性低</li>
</ul>
</li>
<li>
<p>经典算法:</p>
<ul>
<li>
<p>令牌桶: 固定速率产生令牌, 每个请求消耗令牌</p>
<ul>
<li>pros: 容易实现, 内存占用少, 允许突发流量</li>
<li>cons: 调参困难, 可能需要不断填充桶</li>
</ul>
</li>
<li>
<p>漏桶: 请求进入一个定长FIFO队列, server给定速度从队列取数据处理</p>
<ul>
<li>pros: 容易实现, 内存占用少, 请求以固定速率处理</li>
<li>cons: 突发请求占据队列使得新请求得不到处理, 调参困难,可能需要不断填充桶</li>
</ul>
</li>
<li>
<p>固定窗口计数器: 每一个给定时间窗口进行计数,例如每分钟100个请求</p>
<ul>
<li>pros: 容易实现, 内存占用少</li>
<li>cons: 突发请求可以达到两倍限制的QPS(在窗口边缘有突刺)</li>
</ul>
</li>
<li>
<p>滑动窗口日志: 记录请求时间戳, 数据保存在redis等缓存,每当新请求进来的时候把过时时间戳删除, 如果请求时间戳比时间窗口的最低值还低, 拒绝请求</p>
<ul>
<li>pros: 速率限制准确</li>
<li>cons: 内存开销大, 需要存储多个时间戳</li>
</ul>
</li>
<li>
<p>滑动窗口计数器: 某时刻限制请求数 = 窗口上限 - 上一个窗口请求数 * 这一个窗口的和上一个窗口的重叠百分比。例如, 窗口为每分钟1000, 上一分钟800, 在这一分钟的30秒时, 限制这一分钟窗口的请求数最多为 1000 - 30 / 60 * 800 = 600</p>
<ul>
<li>
<p>相当于假设上一个窗口的平均速率</p>
</li>
<li>
<p>pros: 平滑了流量峰值, 内存高效(只需要计数)</p>
</li>
<li>
<p>cons: 不太严格, 然而其实可以</p>
<blockquote>
<p>然而，这个问题可能并不像它看起来那么糟糕。 根据Cloudflare[10]所做的实验，在4亿个请求中，只有0.003%的请求被错误地允许或限制速率</p>
</blockquote>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>超过速率限制</strong></p>
<p>如果一个请求被限制了速率，API会向客户端返回一个HTTP响应代码429（请求太多）。根据不同 的使用情况，我们可能会将速率受限的请求排队等候以后处理。 例如，如果一些订单由于系统过载而受到速率限制，我们可以保留这些订单以便以后处理。</p>
<p><strong>限流器请求头</strong></p>
<p>一个客户如何知道它是否被节流？客户端如何知道在被节流之前允许的剩余请求的数量？答案就在HTTP响应头中。限流器向客户端返回以下 HTTP 标头：</p>
<ul>
<li>X-Ratelimit-Remaining：窗口内允许请求的剩余数量</li>
<li>X-Ratelimit-limit：它表示客户端在每个时间窗口可以进行多少次调用</li>
<li>X-Ratelimit-Retry-After：等待的秒数，直到你可以再次提出请求而不被节流。</li>
</ul>
<p>当用户发送过多请求时，将向客户端返回 429 too many requests 错误和 X-Ratelimit-Retry-After 标头。</p>
</blockquote>
<ul>
<li>规则被存储在磁盘上。工作者经常从磁盘中提取规则，并将其存储在高速缓存中。</li>
<li>当客户端向服务器发送请求时，该请求首先被发送到限流中间件。</li>
<li>限流中间件从缓存中加载规则。它从Redis缓存中获取计数器和最后一次请求的时间戳。根据响应，限流器决定：<!-- -->
<ul>
<li>如果请求没有速率限制，它将被转发到API服务器。</li>
<li>如果请求受到速率限制，限流器会向客户端返回 429 too many requests 错误。 同时，请求被丢弃或转发到队列。</li>
</ul>
</li>
</ul>
<p>分布式限流</p>
<p>redis:</p>
<ul>
<li>lua脚本</li>
<li>sorted set每个用户有一个自己的set,试图执行动作时,使用MULTI原子地执行下列操作: <code>ZREMRANGEBYSCORE</code> 删除给定时间间隔前的元素, ZADD 添加当前时间戳, ttl设置为rate limit,计算sorted set的数量,如果超过限额,就失败 (滑动窗口日志)(有一说一我觉得这个如果没有精确的需求不如滑动窗口计数器, 开销感觉有点大)</li>
</ul>
<p>多限流器同步: 用户hash redis集群分配之 类, 尽量别做这种事情</p>
<p>其他层级的限流:</p>
<ul>
<li>iptables</li>
<li>...</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="一致性hash">一致性hash<a class="hash-link" aria-label="Direct link to 一致性hash" title="Direct link to 一致性hash" href="/blog#一致性hash">​</a></h3>
<p>基本步骤如下：</p>
<ol>
<li>使用均匀分布的哈希函数将服务器和键映射到环上。</li>
<li>要想知道一个键被映射到哪个服务器，从键的位置顺时针查找，直到找到环上的第一个服务器。</li>
</ol>
<p>步骤是很简单的, 麻烦的是问题</p>
<p>环上服务器分区大小难以保证相同(添加删除服务器)</p>
<p>解决方法: 虚拟节点(分成更小的块)</p>
<p>每个服务器动态地分配小块(虚拟节点), 这样还可以考虑服务器容量自动缩放问题</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="一致性模型">一致性模型<a class="hash-link" aria-label="Direct link to 一致性模型" title="Direct link to 一致性模型" href="/blog#一致性模型">​</a></h3>
<blockquote>
<p>N = 副本数</p>
<p>W = 大小为 W 的规定写入。要将写入操作视为成功，必须从 W 个副本确认写入操作。</p>
<p>R = 大小为 R 的读取规定人数。为了使读取操作被认为是成功的，读取操作必须等待至少R个副本的响应。</p>
<p>如何配置N、W和R以适应我们的使用情况？</p>
<p>下面是一些可能的设置：</p>
<ul>
<li>如果<code>R=1，W=N</code>，系统被优化为快速读取</li>
<li>如果<code>W=1，R=N</code>，系统被优化为快速写入</li>
<li>如果<code>W+R&gt;N</code>，就可以保证强一致性（通常<code>N=3，W=R=2</code>）。</li>
<li>如果<code>W+R&lt;=N</code>，则不能保证强一致性</li>
</ul>
</blockquote>
<p>复制<code>-&gt;</code>高可用<code>-&gt;</code>不一致</p>
<p>发现并解决冲突: 常用是向量时钟 vector clock, 但有几个问题</p>
<ul>
<li>处理冲突逻辑复杂</li>
<li>动态增 加删除服务器逻辑复杂</li>
</ul>
<p>参考:</p>
<ul>
<li><a href="https://juejin.cn/post/7205101745936203837" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7205101745936203837</a></li>
<li><a href="https://houbb.github.io/2018/08/31/lock-vector-clock-01" target="_blank" rel="noopener noreferrer">https://houbb.github.io/2018/08/31/lock-vector-clock-01</a></li>
</ul>
<p>实际业界的用例参考Dynamo</p>
<p>算法简介:在每个服务器内部维护一个所有服务器的vector</p>
<ul>
<li>当自己发生事件时,增加<code>vector[self]</code>, 并告诉需要告诉的服务器(<strong>核心就在于不广播, 没有全局时间!当然也因此不保证解决冲突</strong>)</li>
<li>当自己收到A server的事件时, <code>vector[A] += d</code></li>
</ul>
<p>最后想要觉得一个事件的全局顺序的时候, 查看所有的server的vec</p>
<p>如果有一个server的vec是最大的,那么严格有因果关系,取它的值就行</p>
<p>但如果没有最大的vec, 就需要解决冲突的策略</p>
<p>策略</p>
<ol>
<li>交给客户端, 如dynamo</li>
<li>加上时间戳, <code>vec&#x27; = [...servers, timestamp]</code>冲突取ts最大的</li>
<li>随机取一个</li>
</ol>
<blockquote>
<p>所以向量时钟算法的实质是：</p>
<p>（1）将逻辑上可以合并的冲突成功合并；</p>
<p>（2）逻辑上无法合并的冲突依旧冲突；</p>
</blockquote>
<p>拓展: 向量时钟的剪枝, riak, 牺牲绝对的正确性(false merge)来换取对太长的vec clock的剪枝</p>
<p>gossip 协议 quorom</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="唯一id生成器">唯一ID生成器<a class="hash-link" aria-label="Direct link to 唯一ID生成器" title="Direct link to 唯一ID生成器" href="/blog#唯一id生成器">​</a></h3>
<ul>
<li>
<p>多主复制: 下一个id += k, k是服务器数量,拓展性差</p>
</li>
<li>
<p>uuid</p>
<ul>
<li>
<p>引自维基百科，&quot;在每秒产生10亿个UUIDs，大约100年后，创造一个重复的概率会  达到50%&quot;。</p>
</li>
<li>
<p>优点：</p>
<ul>
<li>
<p>生成 UUID 很简单。服务器之间不需要协调，因此不会有任何同步问题。</p>
</li>
<li>
<p>该系统易于扩展，因为每个 Web 服务器负责生成它们使用的 ID。 ID 生成器可以轻松地与 Web 服务器一起扩展。</p>
</li>
</ul>
</li>
<li>
<p><strong>缺点：</strong></p>
<ul>
<li>ID 是 128 位长, 空间开销。</li>
<li>ID 不会随时间上升</li>
<li>ID 可以是非数字的</li>
</ul>
</li>
</ul>
</li>
<li>
<p>ticket服务器, 在分布式系统之中维持一个唯一的ticket server用于签发id</p>
<ul>
<li>
<p>**优点：**数字 ID，易于实施，适用于中小型应用程序</p>
</li>
<li>
<p>**缺点：**单点故障</p>
</li>
</ul>
</li>
<li>
<p>twitter雪花算法</p>
<ul>
<li><strong>符号位</strong>：1 位，它将始终为 0。这是为将来使用保留的。它可以潜在地用于区分有符号数和无符号数。</li>
<li><strong>时间戳</strong>：41 位。自纪元或自定义纪元以来的毫秒数。我们使用 Twitter 雪花默认纪元 1288834974657，相当于 2010 年 11 月 4 日 01:42:54 UTC。</li>
<li><strong>数据中心 ID</strong>：5 位，这给了我们 25=3225=32 个数据中心。</li>
<li><strong>机器 ID</strong>：5 位，每个数据中心有 25=3225=32 台机器</li>
<li><strong>序列号：12 位</strong>。<strong>对于在该机器/进程上生成的每个 ID，序列号都会递增 1。该数字每毫秒重置为 0。</strong></li>
</ul>
</li>
</ul>
<p>也就是说雪花在一台机器上1毫秒可以支持4096个新id</p>
<p>额外要点:</p>
<ul>
<li>时钟同步。在我们的设计中，我们假设 ID 生成服务器具有相同的时钟。当服务器在多个内核上运行时，此假设可能不成立。同样的挑战存在于多机场景中。时钟同步的解决方案超出了本书的范围；但是，了解问题的存在很重要。<strong>网络时间协议是这个问题最流行的解决方案。</strong></li>
<li>节段  长度调整。例如，较少的序列号但较多的时间戳位对低并发性和长期应用是有效的。</li>
<li>高可用性。由于 ID 生成器是关键任务系统，因此它必须具有高可用性</li>
</ul>
<p>拓展阅读: 网络时间协议</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="短url">短URL<a class="hash-link" aria-label="Direct link to 短URL" title="Direct link to 短URL" href="/blog#短url">​</a></h3>
<p>点击较短的别名重定向到原始url</p>
<ul>
<li>
<p>URL缩短：给定一个长的URL =&gt; 返回一个短得多的URL</p>
</li>
<li>
<p>URL重定向：给定一个短的URL =&gt; 重定向到原来的URL</p>
</li>
<li>
<p>高可用性、可扩展性和容错考虑</p>
</li>
</ul>
<blockquote>
<p>值得在这里讨论的一件事是 301 重定向与 302 重定向。</p>
<ul>
<li>
<p><strong>301重定向</strong>。301重定向表明，请求的URL被 &quot;永久 &quot;地移到了长URL上。由于是永久重定向，<strong>浏览器会缓存响应，对同一URL的后续请求将不会被发送到URL缩短服务上</strong>。相反，请求将直接被重定向到长网址服务器。</p>
</li>
<li>
<p><strong>302重定向</strong>。302重定向意味着URL被 &quot;暂时 &quot;移到长URL上，这意味着对同一URL的后续请求将首先被发送到URL缩短服务上。然后，它们会被重定向到长网址服务器。</p>
</li>
</ul>
<p>每种重定向方法都有其优点和缺点。如果优先考虑<strong>减少服务器负载</strong>，使用301重定向是有意义的，因为只有同一URL的第一个请求被发送到URL缩短服务器。然而，如果分析是重要的，302重定向是一个更好的选择，因为它可以更容易地<strong>跟踪点击率和点击的来源。</strong></p>
</blockquote>
<p>一个简单的解决方案 <code>&lt;shortURL, LongURL&gt;</code>的rdbms</p>
<p>假设系统支持3650亿个url=10年 * 每天1亿</p>
<p>可以使用<code>0-9a-zA-Z</code>62个字符， <code>62^n &gt; 3650 亿</code> n = 7</p>
<p>方法1: hash+碰撞解决</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longURL -&gt; hash -&gt; short -&gt; exist on db?(opt bloomfilter + query) -&gt; save/return/collision</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">collision 的一种解决方法是 longURL -&gt; longURL + predefined string</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>方法2: base62转换</p>
<p>给每一个请求的长url分配一个数字类型的唯一id, 再对唯一id做base62转换</p>
<p>坏处是可能出现安全问题</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">longURL -&gt; in DB ? -&gt; yes,return short</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            -&gt; no, generate new ID -&gt; id to base62 -&gt; save id, longurl, shorturl in db </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>读多于写, 加缓存</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="爬虫系统">爬虫系统<a class="hash-link" aria-label="Direct link to 爬虫系统" title="Direct link to 爬虫系统" href="/blog#爬虫系统">​</a></h3>
<p>算法侧: 从url seed开始, 将link视为边, 用BFS去爬取不同的网页</p>
<p>架构侧:</p>
<p><code>seed url -&gt; url frontier -&gt; html downloader(DNS resolver) -&gt; content parser -&gt; content seen(重复检测器, 例如 hash, BF) + 存储-&gt; link extractor -&gt; url filter -&gt; url seen -&gt; url storage</code></p>
<p>优先级: 简单的做法是根据Url内容变化的速度(可以基于历史抓取记录)和本身的价值（例如是个人博客还是官方网站）设计一个优先级估价函数, 根据url区分k个工作队列, 保证一个队列内只有一个url（的多个请求）, 这样就可以实现优先级</p>
<p>爬虫需要考虑礼貌性, DDoS</p>
<p>做法是每个url作为一个后端队列, 在优先级的selector出来之后, 维护一张(url,back queue)的表, 将url放到back queue里面去</p>
<p>对每一个url(backqueue), 维护一个时 间t, 是下一次抓取的最早时间(例如当前时间+10倍前一次获取时间)</p>
<p>而爬虫线程每次从时间的最小堆之中取出元素, (如需要, 等待到t), 然后爬取</p>
<p>html下载器: Robots 排除协议, 分布式抓取, 超时</p>
<p>其他问题: 冗余内容, 蜘蛛陷阱, 垃圾数据, js-需要动态渲染得到链接和其他数据</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="通知系统">通知系统<a class="hash-link" aria-label="Direct link to 通知系统" title="Direct link to 通知系统" href="/blog#通知系统">​</a></h3>
<p>删重, 跟踪, 限速, 用户设置(接受哪些通知), 失败时的重试机制, 安全性(客户验证)</p>
<p>推送流：</p>
<p>核心在fan out系统, 读扇出(拉模式)还是写扇出(推模式), 热键问题和速率问题</p>
<p>混合: 对大多数用户使用推送模式。对于名人或有很多朋友/粉丝的用户，我们让粉丝按需提取信息内容以避免系统过载</p>
<p>get friend IDs: graph DB</p>
<p>fanout service先从graph DB拿到friend ids, 再从用户缓存(用户db)得到朋友相关信息:</p>
<blockquote>
<p>例如，如果你把某人调成静音，她的帖子将不会显示在你的信息流中，尽管你们仍然是朋友。帖子可能不显示的另一个原因是，用户可以有选择地与特定的朋友分享信息或对其他人隐藏信息。</p>
</blockquote>
<p>把更新的需求包成任务(例如<code>&lt;post_id, user_id&gt;</code>)丢到mq</p>
<p>mq入库, 写缓存</p>
<p>缓存层级:</p>
<ul>
<li>
<p>News Feed：它存储了信息的ID。</p>
</li>
<li>
<p>Content：它存储每个帖子的数据。受欢迎的内容被存储在热缓存中。</p>
</li>
<li>
<p>Social Graph：它存储用户关系数据。</p>
</li>
<li>
<p>Action：它存储有关用户是否喜欢帖子、回复帖子或对帖子执行其他操作的信息。</p>
</li>
<li>
<p>Counters：它存储点赞、回复、关注者、关注等的计数器。</p>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="聊天系统">聊天系统<a class="hash-link" aria-label="Direct link to 聊天系统" title="Direct link to 聊天系统" href="/blog#聊天系统">​</a></h3>
<p>无状态有状态分离</p>
<ul>
<li>
<p>无状态的服务 http</p>
<p>无状态服务是传统的面向公众的请求/响应服务，用于管理登录、注册、用户资料等。这些是许多网站和应用程序中的常见功能。</p>
<p>无状态服务位于负载均衡器后面，其工作是根据请求路径将请求路由到正确的服务。这些服务可以是单体的，也可以是单独的微服务。我们不需要自己建立许多这样的无状态服务，因为市场上有一些服务可以很容易地被集成。</p>
<p>我们将深入讨论的一个服务是服务发现。它的主要工作是给客户提供一个客户可以连接到的聊天服务器的DNS主机名列表。</p>
</li>
<li>
<p>有状态的服务 websocket</p>
<p>唯一有状态的服务是聊天服务。该服务是有状态的，因为每个客户都与一个聊天服务器保持持久的网络连接。在这个服务中，只要服务器仍然可用，客户通常不会切换到另一个聊天服务器。服务发现与聊天服务密切协调，以避免服务器过载。我们将在深入研究中详细介绍。</p>
</li>
</ul>
<p>服务器的切分:</p>
<ul>
<li>chat server 管理信息的收发</li>
<li>presence server 管理在线/离线状态</li>
<li>api server 处理无状态服务</li>
<li>notification server 推送通知</li>
</ul>
<p>DB选择: KV数据库</p>
<p>为什么？<strong>聊天数据的读写模式</strong></p>
<ul>
<li>数据量巨大 需要水平拓展</li>
<li>只有最近的聊天记录才会被频繁访问</li>
<li>但“最近”里面也不完全是顺序的, 引用, 跳转, 提及等</li>
<li>读写比约为1:1, 读并不远远高于写</li>
</ul>
<p>这样的wkld下kv比关系型的优势:</p>
<ul>
<li>水平拓展轻松</li>
<li>分层架构对热数据容易优化</li>
<li>关系型数据库的index在数据量变大时昂贵</li>
</ul>
<p>消息ID设计:</p>
<p>一对一聊天: 主键message id</p>
<p>群聊: 复合主键 <code>{channel_id, message_id}</code></p>
<p>问题: id用什么?</p>
<p>要求: 唯一性 + 可以按照时间排序</p>
<ul>
<li>自增: 分布式实现困难</li>
<li>全局序列号发生器: 将时间项提前就可以按照时间排序</li>
<li>本地序列号生成器: 只保证消息在一个组内(channel内)唯一, 实现比较简单</li>
</ul>
<p>发送信息的流程</p>
<ol>
<li>用户A向聊天服务器1发送了一条聊天信息。</li>
<li>聊天服务器1从ID生成器获得一个信息ID。</li>
<li>聊天服务器1将消息发送至消息同步队列。</li>
<li>消息被储存在一个键值存储中。</li>
<li>a. 如果用户B在线，信息被转发到用户B所连接的聊天服务器2。</li>
<li>b. 如果用户B处于离线状态，则从推送通知（PN）服务器发送推送通知。</li>
<li>聊天服务器2将消息转发给用户B，用户B和聊天服务器2之间有一个持久的WebSocket连接。</li>
</ol>
<p>群组聊天:</p>
<p>第一种方法: A发消息, 在每一个成员的收件箱里面复制一个副本, 适用于群组人数较少的时候(例如微信的500人约束); 每个收件人有自己的收件箱(消息同步队列), 所以并不保证一致性</p>
<p>在线状态指示器:</p>
<ul>
<li>naive的做法: 建立连接就在线, 断开就离线。问题在网络波动时候, 变化太快</li>
<li>更优雅的做法, 心跳</li>
<li>推送, 类似微信这种小群(500人限制)可以直接查询实时的ws连接。大群需要懒加载</li>
</ul>
<p>扩展聊天应用程序以支持媒体文件，如照片和视频。媒体文件的大小明显大于文本。压缩、云存储和缩略图是值得讨论的话题。</p>
<ul>
<li>端到端加密。Whatsapp支持信息的端到端加密。只有发件人和收件人可以阅读信息。有兴趣的读者请参考参考资料中的文章[9]。</li>
<li>在客户端缓存信息，可以有 效地减少客户端和服务器之间的数据传输。</li>
<li>提高加载时间。Slack建立了一个地理分布的网络来缓存用户的数据、频道等，以获得更好的加载时间[10]。</li>
<li>故障处理。<!-- -->
<ul>
<li>聊天服务器错误。可能有数十万，甚至更多的，坚持不懈的连接到一个聊天服务器。如果一个聊天服务器离线，服务发现（Zookeeper）会提供一个新的聊天服务器，让客户建立新的连接。</li>
<li>消息重发机制。重试和排队是重发消息的常用技术。</li>
</ul>
</li>
</ul>
<p>多媒体支持的大体流程</p>
<ul>
<li>client 通过 rest 将多媒体资源发送到服务器</li>
<li>服务器转换媒体文件(例如图片生成缩略图, 压缩)</li>
<li>服务器存到s3</li>
<li>服务器通过s3链接响应client</li>
<li>客户端再将s3链接通过ws发送(广播)给聊天的其他用户</li>
<li>其他client 收到s3连接, 根据定义的消息类型进行渲染</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="简单的搜索支持-trie">简单的搜索支持: trie<a class="hash-link" aria-label="Direct link to 简单的搜索支持: trie" title="Direct link to 简单的搜索支持: trie" href="/blog#简单的搜索支持-trie">​</a></h3>
<p>topK: 先找到前缀, 再遍历子树</p>
<p>问题: 太慢</p>
<p>解决方法:</p>
<ul>
<li>在每个节点缓存常用的前k个查询</li>
<li>控制前缀的最大长度</li>
</ul>
<p>更新trie: 数据搜集, 对于实时应用服务, 短时间间隔; 对于非实时的, 可以例如一周定时更新一次</p>
<p>合法性: 自动完成可以根据hash等过一个filter, 避免补出禁止的网站等</p>
<p>多语言：unicode trie</p>
<p>分片: 可以基于字母, 但是要考虑到频率问题</p>
<p>实时(趋势)搜索: 流式, 领域特定, AI</p>
<p>视频流</p>
<p>核心是分成几个部分, 一部分类似传统的server, 提供视频metadata</p>
<p>另一部分依托云服务和CDN, 做好视频传输和解码编码</p>
<p>其中特定部分的逻辑复杂, 例如解编码的模块化和引擎化, CDN贵所以视频基于历史数据做冷热分离, 冷视频走自建而不是CDN</p>
<p>还有比如错误处理, 数字版权之类</p>
<p><a href="https://learning-guide.gitbook.io/system-design-interview/xi-tong-she-ji-mian-shi-nei-mu-zhi-nan-di-yi-juan/chapter-14-design-youtube" target="_blank" rel="noopener noreferrer">具体好多细节</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="临近服务">临近服务<a class="hash-link" aria-label="Direct link to 临近服务" title="Direct link to 临近服务" href="/blog#临近服务">​</a></h3>
<p>由于是读远多于写的情况, 所以常见用关系型db</p>
<p>关系型的问题是, 如果是经纬度, 二维数据index利用率低</p>
<p>解决方法是二维转一维再index搜索, 例如geohash, R tree, 四叉树, google s2</p>
<p>geohash: 经纬度网格编码再转base32, 共享前缀越长, 越接近</p>
<p>边界问题: 反过来不成立, 接近的两个地块可能共享前缀并不长(在子午线/赤道等大格子边界), 所以<code>geohash LIKE &#x27;sth%&#x27;</code>检索出来结果不全</p>
<p>方法是不仅检索自己格子的geohash, 也把邻居格子的一起检索</p>
<p>业务问题：范围内部商家不够, 解决方法是放大格子继续检索</p>
<p>google s2: 基于希尔伯特曲线的<code>球面-&gt;1d</code>算法, 保证2d上接近在1d上也接近</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/架构设计">架构设计</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/ostep-chapter42-44">ostep阅读笔记：单机fs的崩溃一致性(chapter42-44)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2025-01-19T06:12:55.344Z">January 19, 2025</time> · <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="chapter-42-崩溃一致性">chapter 42 崩溃一致性<a class="hash-link" aria-label="Direct link to chapter 42 崩溃一致性" title="Direct link to chapter 42 崩溃一致性" href="/blog#chapter-42-崩溃一致性">​</a></h3>
<p>以一个传统的结构(linux ext2)为例子</p>
<p>一个磁盘group</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">inode bitmap | data bitmap | inode block | data block</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>磁盘映像</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">super | group0 | group1 | …</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>想要给一个文件追加一个block，需要改<code>inode block</code>, <code>data bitmap</code> 和 <code>data block</code> 3处</p>
<p>设想中途断电，<strong>硬件原子性在磁盘上是不好做的</strong>，所以可能在三个写入之中发生任意个写入落盘的情况</p>
<p>断电时已经修改的数据和后果的对应:</p>
<ul>
<li>inode block， 元数据不一致，指向垃圾数据</li>
<li>data bitmap，元数据不一致，空间泄露</li>
<li>data block， 没关系</li>
<li>inode block + data bitmap， 文件是乱码，问题不大</li>
<li>inode block + data block，元数据不一致</li>
<li>data bitmap + data block， 元数据不一致，空间泄露</li>
</ul>
<p><strong>早期文件系统：fsck，让不一致发生，重启时修复，只确保元数据一致</strong></p>
<ul>
<li>检查super block（发现系统大小小于分配块数等不健全的情况，可以考虑启用super block的备用副本来防止super block自身损坏）</li>
<li>空闲块：inode, 间接块，<strong>以inode为参考， 修改inode bitmap达到一致, 所有看起来在用的inode都会有bitmap标记</strong></li>
<li>inode状态：如果inode的字段不合法，认为不易修复，删掉这个inode</li>
<li>inode链接：扫描整个目录树，重新计算引用计数，如果找到已经分配的inode但 没有目录引用，放到<strong>lost+found</strong></li>
<li>重复和坏块，清除不正确的指针</li>
<li>目录检查：确保无环，目录中每个inode已分配等</li>
</ul>
<p><strong>磁盘清理工具：重排inode的data block来减少碎片</strong></p>
<p>fsck 存在的一个问题：很复杂</p>
<p><strong>fsck 最关键的问题：太慢了！</strong></p>
<p><strong>另外的方法：WAL</strong></p>
<p>Linux ext34, Windows NTFS 采用的方法: 加上journal block</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">super | **journal** | group0 | group1 | …</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>journal中条目的形式：</p>
<p><strong>TxB | inode | bitmap | data | TxE (物理日志，也有逻辑日志的做法，可能提高性能，节省空间)</strong></p>
<p>checkpoint： 成功写入journal之后，就是一个checkpoint</p>
<p>先写WAL, 再写文件系统元数据，最后落盘data</p>
<p>问题：写日志的时候崩溃？</p>
<p>问题发生在，<strong>一条日志（以物理为例）可能太大，以至于不能被原子写入（常态）</strong></p>
<ul>
<li>  日志内的数据<strong>可以被磁盘调度为小块乱序</strong>写入</li>
<li>写入的部分错误难以检查，例如在写入data段的时候出错，但其他部分正确（但也可以checksum? 这就是ext4的一项重要更新，通过在TxB和TxE之中包含<strong>checksum</strong>来加快写入速度）</li>
<li>磁盘的<strong>写缓冲</strong>，早期OS强制写入顺序就是通过关中断实现的: 写A，关中断，写B；有缓冲的状态下，写入缓冲就会返回。还要保证顺序的话，一种是禁用写缓冲，更现代的方法是<strong>写屏障</strong>（有趣的是一些磁盘产商忽略了写屏障，即使存在错误的风险，<strong>“快速几乎总是打败慢速，即使快速是错的”</strong>）</li>
<li>所以早期的方案是这样的，先写除了TxE之外的所有块，这部分出错这个事务就是未提交的，会被重置；然后<strong>第二步再写TxE, 磁盘保证写512字节的block的原子性，因而TxE是原子的</strong>。流程称为日志写入，日志提交，加检查点</li>
</ul>
<p>此时，恢复仅仅是重放（replay）</p>
<p><strong>批处理：</strong></p>
<p><strong>和TLB缓存很像，fs可以为了性能将磁盘写入合并批处理，在内存之中标记dirty</strong></p>
<p>日志长度有限：循环，checkpoint之后前面的日志可以释放掉再重新写入</p>
<p>物理日志严重的写放大：元数据日志（linux ext3的另一个mode, windows NTFS），WAL之中不保存data段，只保存inode, inode bitmap，block bitmap等元数据修改。此时需要<strong>先写data, 来避免指向垃圾数据</strong></p>
<ul>
<li><strong>这样的“强制先写入被指向的对象，再写入指针”是崩溃一致性的核心</strong></li>
</ul>
<p>棘手的问题：块复用，感觉有点绕，总之是删除+文件夹这种递归结构+只记录元数据+重用得到了一些不好的结果，linux ext3的解决方法是删除也有revoke日志</p>
<p>其他崩溃一致性的解法：</p>
<ul>
<li><strong>COW</strong></li>
<li><strong>反向指针，在被引用块里面添加引用块的引用（惰性崩溃一致性）</strong></li>
<li><strong>软更新，排序所有写入，复杂</strong></li>
<li><strong>乐观崩溃一致，例如校验和的方案</strong></li>
</ul>
<p><strong>ZFS使用COW和日志</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chapter43-lfs-日志文件系统">chapter43 LFS 日志文件系统<a class="hash-link" aria-label="Direct link to chapter43 LFS 日志文件系统" title="Direct link to chapter43 LFS 日志文件系统" href="/blog#chapter43-lfs-日志文件系统">​</a></h3>
<p>很像LSM，同样是为了利用磁盘的顺序写，同时<strong>只做顺序写，读时读最新版本，GC回收旧版本数据</strong></p>
<p>LFS将每次文件系统的更新都顺序写入（data, inode），并以写缓冲实现批量写的性能提高，带来一个问题是不知道inode在哪里了</p>
<p>因而引入了一个<strong>中间层imap</strong>，记录inode, addr的对，imap需要保证持久，每次写入inode时,imap进行更新</p>
<p>imap放在哪里？<strong>如果在固定段，由于它更新的频繁性，所以需要非常多的磁盘寻道，不可接受</strong></p>
<p>所以把imap和inode一起，写到更新后面</p>
<p>那去哪里找imap呢？（有点像 一级一级的索引，现在要找索引入口）</p>
<p><strong>在磁盘的固定处维护检查点区域CR, CR指向最新imap，而CR的性能可以通过降低更新频率，例如每30s定时更新来解决，inode的更新全放到imap了</strong></p>
<p>imap还解决了递归更新的问题</p>
<p>读取的时候有内存缓存，直接读里面的imap就行</p>
<p><strong>怎么做GC? 在data block的开头有对inode块的反向引用+自身在inode中偏移量T，称为segment summary block</strong></p>
<p><strong>所以<code>data → segment → 查最新的imap得到inode addr → inode[T] == data ?  alive : dead</code></strong></p>
<p><strong>更简单的空间换时间的方法，在imap里面记录版本号，在segment里面也记录版本号</strong></p>
<p>清理哪些段？一种粗略的方法是<strong>冷热分离</strong></p>
<p><strong>经常覆盖内容的段是热段</strong>，尽可能保留；反之冷段可以早清</p>
<p><strong>崩溃恢复</strong></p>
<ul>
<li><strong>写CR崩溃：1. 给cr做一个副本 2.更新cr时，通过 时间戳 + CR + 时间戳的方式，检测更新的一致性，时间戳是原子的</strong></li>
<li><strong>其他崩溃：CR后的数据丢了，假设CR是30s, 那不超过30s, 当然可以在CR里面包含更多信息，从而在最后一个检查点之后，尽量找到日志的结尾，并尽可能恢复有效的段，称为前滚 roll forward</strong></li>
</ul>
<p>LFS的思想在ZFS, Linux btrfs等有所体现，通过快照来得到fs的版本化</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="chapter-44-检测错误">chapter 44 检测错误<a class="hash-link" aria-label="Direct link to chapter 44 检测错误" title="Direct link to chapter 44 检测错误" href="/blog#chapter-44-检测错误">​</a></h3>
<p><strong>磁盘错误：“有声的” 和“无声的”</strong></p>
<ul>
<li><strong>前者例如意外的不可读，数据位反转，可以被ECC修复或检错的，总之会被磁盘发现</strong></li>
<li><strong>后者如写歪了</strong></li>
</ul>
<p><strong>前者的解决方法是各种方式的RAID</strong></p>
<p><strong>后者的解决方法是校验和</strong>，xor, add, fletcher, crc</p>
<p>像“写歪了”（addr x写到y， 磁盘A写到B）这种如何检测？在校验和之中加入块的磁盘和扇区号这样的物理标识符</p>
<p>还有一个特殊的情况是写入丢失，解决方法有写入后检验，或者在inode上加校验和（这样inode + data block全写丢了才会发现不了）</p>
<p>何时检测：定时，磁盘的位是会衰退的</p></div><footer class="row docusaurus-mt-lg"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/filesystem">filesystem</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/崩溃一致性">崩溃一致性</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/system">system</a></li></ul></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/JUC">JUC</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-11-01T18:57:09.000Z">November 1, 2024</time> · <!-- -->11 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><p>自旋锁<code>-&gt;</code>自旋N次(N自适应, 取决于先前历史,当前负载等)<code>-&gt;</code>升级为重量级锁</p>
<p>重量级, mutex 本质上的syscall, 轻量级, CAS去尝试拿到对象头中的锁标识字节MarkWord</p>
<p>更新成功说明没人抢</p>
<p>偏向锁: 当某个线程第一次获取锁时, 接下来都没有其他线程拿, 那这个线程后续拿锁就连CAS也不需要</p>
<p>无锁<code>-&gt;</code>偏向锁<code>-&gt;</code>自旋锁<code>-&gt;</code>重量级锁</p>
<p>JMM</p>
<p>所有可能出现竞争的变量(成员, 静态等)均在主内存</p>
<p>局部变量线程私有, 工作内存相互隔离, 只能通过主内存同步</p>
<p>volatile</p>
<p>需要立即看到修改的值, 每一次读取都从主线程读, 每一次写都把工作内存的值刷新到主线程</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/java">java</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/concurrency">concurrency</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about JUC" href="/blog/JUC"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/cs144 labs">cs144 labs(Winter 2024)</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-11-01T18:57:09.000Z">November 1, 2024</time> · <!-- -->31 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lab0">Lab0<a class="hash-link" aria-label="Direct link to Lab0" title="Direct link to Lab0" href="/blog#lab0">​</a></h3>
<p>这个lab纯纯的热身lab, part1是用webget简单进行个请求, 类似csapp的网络lab part1</p>
<p>part2字符串操作, 恶心一点的就是string_view的peek和一个ring buffer不太能兼容, 总之我的代码效率也挺低的就不拿出来献丑了()</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="lab1">Lab1<a class="hash-link" aria-label="Direct link to Lab1" title="Direct link to Lab1" href="/blog#lab1">​</a></h3>
<p>这个lab要求实现tcp字节流抽象的重组部分Reassembler</p>
<p>调的时候还是很恶心的, 非常多的edge case, 建议好好看测试是怎么构造的</p>
<p>写的时间最久的一个lab, 但这里笔记没有多少, 因为Lab1结束到Lab2开始的两个星期干别的去记不清当时的感受了()</p>
<p>还是放个源代码</p>
<div class="language-cpp codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-cpp codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&quot;reassembler.hh&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cs-144">cs144</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/network">network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/labs">labs</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about cs144 labs(Winter 2024)" href="/blog/cs144 labs"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/jyy-os：并发">NJU操作系统(jyy OS)课程笔记-并发部分</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-11-01T18:57:09.000Z">November 1, 2024</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h3 class="anchor anchorWithStickyNavbar_LWe7" id="lec5-多处理器编程">lec5 多处理器编程：<a class="hash-link" aria-label="Direct link to lec5 多处理器编程：" title="Direct link to lec5 多处理器编程：" href="/blog#lec5-多处理器编程">​</a></h3>
<p>理解程序：状态机模型，我们把一个程序看成一个状态机，程序的状态是{寄存器，内存}，而每次取出一条指令、再执行的过程的就是状态迁移到过程。</p>
<p>由这个状态机模型，我们可以有非常多的 trick，例如 debug 单步执行，例如模拟器，例如如果某些指令是“可逆”的，就可以在 debug 的时候反向执行，“时间倒流”（gdb 也提供了这一模式）……</p>
<p><strong>对于并发程序，多处理器模型，我们的直觉告诉我们，可以把这个程序看成是多个状态机，并发的过程就是每次取出一个状态机，执行一步，而所有的状态机有共享的内存（线程模型）…… 这样的模型已经足够复杂，状态数是指数增长的，解决需要考虑所有状态的问题是 NP 完全的。</strong></p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>但更重量级的是，这样的模型是错的！</p></div></div>
<p>并发编程的问题：</p>
<ol>
<li>load/store 的非原子性</li>
<li>编译器的优化</li>
</ol></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/os">os</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/concurrency">concurrency</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/system">system</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about NJU操作系统(jyy OS)课程笔记-并发部分" href="/blog/jyy-os：并发"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/nginx">nginx基础</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-11-01T18:57:09.000Z">November 1, 2024</time> · <!-- -->6 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><p>配置文件</p>
<p>server 虚拟主机, 根据 <code>{listen, server_name}</code>的<code>IP-port</code>或者<code>domain-port</code>对来进行唯一性标识, 可以单项相同, 会匹配另一项转发</p>
<p>location + root, index指定主页等</p>
<p>配置静态页面结束</p>
<p>反向代理: server端请求转发</p>
<div class="language-nginx codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-nginx codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">server {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    listen 8001;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    server_name any_name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    location / {</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/nginx">nginx</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/web">web</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about nginx基础" href="/blog/nginx"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl"><header><h2 class="title_f1Hy"><a href="/blog/cs144/cs144 lec notes">CS144 Lecture Notes</a></h2><div class="container_mt6G margin-vert--md"><time datetime="2024-09-20T00:00:00.000Z">September 20, 2024</time> · <!-- -->69 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div class="markdown"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unit-1-internet-and-ip">Unit 1: Internet and IP<a class="hash-link" aria-label="Direct link to Unit 1: Internet and IP" title="Direct link to Unit 1: Internet and IP" href="/blog#unit-1-internet-and-ip">​</a></h2>
<p>网络四层模型<!-- -->:application<!-- -->, transport, network, link</p>
<p>7层OSI, 拆app,trans,link为更细的两个</p>
<p>网络的基础和底层是IP, 只有IP model是不可替代的“细腰”,上层的application、transport和下层的link都是可以替换的</p>
<p>application 应用层,smtp, ftp, http, ssh</p>
<p>transport 传输层,tcp, udp, rdp</p>
<p>link 连接层,4G, WiFi, ...</p>
<p>网络连接的几种常见例子:</p>
<p>client-server, BitTorren 一服务器多client的集群, ......</p>
<p>网络 application上 <!-- -->:read<!-- -->/write</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/network">network</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cs-144">cs144</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about CS144 Lecture Notes" href="/blog/cs144/cs144 lec notes"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">notes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">课程笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/personal-essays">Personal Essays</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Ayanami, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>