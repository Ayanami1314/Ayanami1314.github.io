<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">linking 复习 | Ayanami&#x27;s Cave</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ayanami1314.github.io/blog/linking-复习"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="linking 复习 | Ayanami&#x27;s Cave"><meta data-rh="true" name="description" content="linking 复习"><meta data-rh="true" property="og:description" content="linking 复习"><meta data-rh="true" name="keywords" content="linking,linker"><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-07-11T00:00:00.000Z"><meta data-rh="true" property="article:tag" content="linking,system"><link data-rh="true" rel="icon" href="/img/ayanami.jpg"><link data-rh="true" rel="canonical" href="https://ayanami1314.github.io/blog/linking-复习"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog/linking-复习" hreflang="en"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/blog/linking-复习" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://ayanami1314.github.io/blog/linking-复习","mainEntityOfPage":"https://ayanami1314.github.io/blog/linking-复习","url":"https://ayanami1314.github.io/blog/linking-复习","headline":"linking 复习","name":"linking 复习","description":"linking 复习","datePublished":"2024-07-11T00:00:00.000Z","author":{"@type":"Person","name":"ayanami"},"keywords":["linking","linker"],"isPartOf":{"@type":"Blog","@id":"https://ayanami1314.github.io/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ayanami&#39;s Cave Atom Feed">



<link rel="alternate" type="application/rss+xml" href="/personal-essays/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-essays/atom.xml" title="Ayanami&#39;s Cave Atom Feed">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.00dd3480.css">
<script src="/assets/js/runtime~main.3d7b1b16.js" defer="defer"></script>
<script src="/assets/js/main.740f58ee.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ayanami&#x27;s Cave</b></a><a class="navbar__item navbar__link" href="/docs/Chcore源码阅读/">课程笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">技术博客</a><a class="navbar__item navbar__link" href="/personal-essays">个人随笔</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">All our posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/local-llm">来本地部署大模型!</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os-虚拟化">NJU操作系统(jyy OS)课程笔记-虚拟化部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs186-database-WIP">ucb cs186 课程笔记(更新中)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/系统架构设计笔记">system-design-interview笔记</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ostep-chapter42-44">ostep阅读笔记：单机fs的崩溃一致性(chapter42-44)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/JUC">JUC</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144 labs">cs144 labs(Winter 2024)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/jyy-os：并发">NJU操作系统(jyy OS)课程笔记-并发部分</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/nginx">nginx基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/cs144/cs144 lec notes">CS144 Lecture Notes</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/django-mosh">Django_mosh</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/splay-tree">splay tree</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/xv6book-notes">xv6book Notes(C1-4)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/Go-Gin学习">Go,Gin学习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/godis源码阅读">godis源码阅读</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/hibernate-jpa">hibernate&amp;jpa</a></li><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/linking-复习">linking 复习</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/ts基础">ts基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/实战2-mosh-gamehub">react practice:mosh gamehub</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/浅入理解断点和调试器">浅入理解断点和调试器</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/黑马点评">黑马点评(速通版)</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/js基础">js基础</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/11-14-11-26学习双周记">11-14-11-26学习双周记</a></li></ul></nav></aside><main class="col col--7"><article><header><h1 class="title_f1Hy">linking 复习</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-07-11T00:00:00.000Z">July 11, 2024</time> · <!-- -->17 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_Hf19"><div class="avatar margin-bottom--sm"><div class="avatar__intro"><div class="avatar__name"><span>ayanami</span></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>linking 复习</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="no-linker-problems">No linker <strong>Problems</strong><a class="hash-link" aria-label="Direct link to no-linker-problems" title="Direct link to no-linker-problems" href="/blog/linking-复习#no-linker-problems">​</a></h4>
<p>• efficiency: small change requires complete recompilation</p>
<p>• modularity: hard to share common functions (e.g. printf)</p>
<p>seperate compilation: <em>separately compiled relocatable object files</em></p>
<p>reloc object files -&gt; executable object file</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-linker">What is linker<a class="hash-link" aria-label="Direct link to What is linker" title="Direct link to What is linker" href="/blog/linking-复习#what-is-linker">​</a></h4>
<ul>
<li>
<p>Linking is the process of: collecting and combining various pieces of code and data into a single executable file</p>
</li>
<li>
<p>Executable file: Can be loaded (copied) into memory and executed</p>
</li>
</ul>
<p>Linking can be performed</p>
<ul>
<li>
<p>at compile time, when the source code is translated into machine code by the linker</p>
</li>
<li>
<p>at load time, when the program is loaded into memory and executed by the loader</p>
</li>
<li>
<p>at run time, by application programs</p>
</li>
</ul>
<p>编译过程：preprocessor -&gt; compiler -&gt; assembler -&gt; linker</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="static-linking">Static Linking<a class="hash-link" aria-label="Direct link to Static Linking" title="Direct link to Static Linking" href="/blog/linking-复习#static-linking">​</a></h4>
<p>Input:</p>
<p>A relocatable object files and command line arguments</p>
<p>Output:</p>
<p><strong>Fully linked</strong> executable object file that can be loaded and run</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="relocatable-object-file">Relocatable object file<a class="hash-link" aria-label="Direct link to Relocatable object file" title="Direct link to Relocatable object file" href="/blog/linking-复习#relocatable-object-file">​</a></h5>
<p>Contain binary code and data in a form that can be combined with other relocatable object files to create an executable file</p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="sections">Sections<a class="hash-link" aria-label="Direct link to Sections" title="Direct link to Sections" href="/blog/linking-复习#sections">​</a></h5>
<ul>
<li>
<p>Various code and data sections</p>
</li>
<li>
<p>Instructions are in one section</p>
</li>
<li>
<p>Initialized global variables are in one section</p>
</li>
<li>
<p>Uninitialized global variables are in one section</p>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="external-reference">External reference<a class="hash-link" aria-label="Direct link to External reference" title="Direct link to External reference" href="/blog/linking-复习#external-reference">​</a></h5>
<ul>
<li>
<p>Reference to a symbol defined in another object file</p>
</li>
<li>
<p>The external references are <strong>value 0</strong> in the relocatable object files in the previous example</p>
</li>
</ul>
<p>Symbol resolution: Resolves external references</p>
<p>Relocates <em>symbols</em></p>
<ul>
<li>
<p>from their relative locations in the .o files</p>
</li>
<li>
<p>to new absolute positions in the executable</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="object-files">Object files<a class="hash-link" aria-label="Direct link to Object files" title="Direct link to Object files" href="/blog/linking-复习#object-files">​</a></h4>
<ul>
<li>
<p>Relocatable object file</p>
</li>
<li>
<p>Executable object file</p>
</li>
<li>
<p>Shared object file(A special type of relocatable object file that <strong>can be loaded into memory and linked dynamically, at either load time or run time</strong>)</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="executable-and-linkable-format-elf"><strong>Executable and Linkable Format (ELF)</strong><a class="hash-link" aria-label="Direct link to executable-and-linkable-format-elf" title="Direct link to executable-and-linkable-format-elf" href="/blog/linking-复习#executable-and-linkable-format-elf">​</a></h4>
<ul>
<li>
<p>Standard binary format for object files</p>
</li>
<li>
<p>Derives from AT&amp;T System V Unix</p>
</li>
<li>
<p>later adopted by BSD Unix variants and Linux</p>
</li>
<li>
<p>One unified format for relocatable object files (.o), executable object files, and shared object files (.so)</p>
</li>
<li>
<p>generic name: ELF binaries</p>
</li>
<li>
<p>Better support for shared libraries than old a.out formats.</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2024/06/18/mqs1U3JAKW27EFi.png" alt="image-20240618152139316" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="elf-header">ELF Header<a class="hash-link" aria-label="Direct link to ELF Header" title="Direct link to ELF Header" href="/blog/linking-复习#elf-header">​</a></h5>
<p>The first part is very important,used to store meta data usually</p>
<p>magic number, type (.o, exec, .so), machine, byte ordering, Beginning of the section header table (as well as the program header table), etc</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint64_t</span><span class="token plain">	Elf64_Addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint16_t</span><span class="token plain">	Elf64_Half</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint64_t</span><span class="token plain">	Elf64_Off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">int32_t</span><span class="token plain">	Elf64_Sword</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">int64_t</span><span class="token plain">	Elf64_Sxword</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint32_t</span><span class="token plain">	Elf64_Word</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint64_t</span><span class="token plain">	Elf64_Lword</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token class-name">uint64_t</span><span class="token plain">	Elf64_Xword</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> 	e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* ELF identification */</span><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Object file type ET_REL(1)、ET_EXEC(2)、ET_DYN(3)(shared) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_machine</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Machine type EM_386(3)、EM_IA_64(50)*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word 	e_version</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Object file version */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Addr 	e_entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Entry point address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Off 		e_phoff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Program header offset */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Off 		e_shoff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Section header offset */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word 	e_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Processor-specific flags */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_ehsize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* ELF header size */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_phentsize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Size of program header entry */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_phnum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Number of program header entries */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_shentsize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Size of section header entry */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_shnum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Number of section header entries */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_shstrndx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Section name string table index */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Ehdr</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>e_ident[0-3] ‘0x7f’ ‘E’ ‘L’ ‘F’    magic number</p>
<p>e_ident[4] 1(32-bit) / 2(64-bit)</p>
<p>e_ident[5] 1(little) / 2(big)</p>
<p>e_ident[15] size of e_ident[]</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word    sh_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Section name (index into the section header string table). */</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word    sh_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Section type. SHT_PROGBITS、SHT_SYMTAB 、SHT_STRTAB、SHT_REL、SHT_NOBITS </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Xword  sh_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Section flags. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Addr	    sh_addr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Address in memory image.(If the section will be copied into the memory to execute, this member gives the address at which the section’s first byte should reside </span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Off	    sh_offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Offset in file. (the byte offset from the beginning of the file to the first byte in the section) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Xword  sh_size</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Size in bytes. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word    sh_link</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Index of a related section. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word    sh_info</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Depends on section type. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Xword  sh_addralign</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Alignment in bytes. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Xword  sh_entsize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	  </span><span class="token comment" style="color:#999988;font-style:italic">/* Size of each entry in section. (Some sections hold a table of fixed-size entries, this member gives the size in bytes of each entry)*/</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Shdr</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="elf-string-table">ELF String Table<a class="hash-link" aria-label="Direct link to ELF String Table" title="Direct link to ELF String Table" href="/blog/linking-复习#elf-string-table">​</a></h5>
<ul>
<li>
<p>Hold null-terminated character sequences (strings)</p>
</li>
<li>
<p>The object file uses these strings to represent symbol and section names</p>
</li>
<li>
<p>One references a string as an index into the string table section</p>
</li>
</ul>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2024/06/18/eha1s3qotpK5vXM.png" alt="image-20240618153451314" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="other-sections">Other Sections<a class="hash-link" aria-label="Direct link to Other Sections" title="Direct link to Other Sections" href="/blog/linking-复习#other-sections">​</a></h5>
<ul>
<li>
<p>debug section: debugging symbol table, local variables and typedefs, global variables, original C source file (gcc -g)</p>
</li>
<li>
<p>.line: Mapping between line numbers in the original C source program and machine code instructions in the .text section.</p>
</li>
</ul>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="sections-in-elf-obj-file">Sections in ELF obj file<a class="hash-link" aria-label="Direct link to Sections in ELF obj file" title="Direct link to Sections in ELF obj file" href="/blog/linking-复习#sections-in-elf-obj-file">​</a></h5>
<ul>
<li>
<p>.text section: code 代码</p>
</li>
<li>
<p>.rodata section: Read-only data</p>
</li>
<li>
<p>.data section: initialized global and static C variables</p>
</li>
<li>
<p>.bss section (“Block Started by Symbol” or “Better Save Space”)</p>
</li>
</ul>
<p>–<strong>uninitialized</strong> global and static C variables, along with any global or static variables that are <strong>initialized to zero</strong></p>
<p>–<strong>has section header but occupies no disk space</strong></p>
<p>–at run time, these variables are allocated in memory with initial value zero</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="symbol">Symbol<a class="hash-link" aria-label="Direct link to Symbol" title="Direct link to Symbol" href="/blog/linking-复习#symbol">​</a></h4>
<ul>
<li>
<p>Defined global symbols</p>
</li>
<li>
<p>Referenced global symbols</p>
</li>
<li>
<p>Local symbols(C functions and global variables with static attribute)</p>
</li>
</ul>
<p>局部非静态变量不是symbol, 不在.symtab段占有空间</p>
<p><strong>Each relocatable object file has a symbol table in .symtab section</strong></p>
<p>Symbol Table包含了：</p>
<ol>
<li>
<p>the module（file） that defines the symbol</p>
</li>
<li>
<p>the symbol type (local,global,extern)</p>
</li>
<li>
<p>the section (.text,.data,.bss)</p>
</li>
</ol>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> 	name </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* the name in string table&#x27;s (byte) offset */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> 	type</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* function or data (4 bits) (usually，还有一些别的)*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	   	binding</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">4</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* local or global  (4 bits) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> 	reserved </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* unused */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">short</span><span class="token plain"> 	section </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* section header index */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  	</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain"> 	value </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* section offset(for relocatable), or abs address(for executable) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain">	size </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">		</span><span class="token comment" style="color:#999988;font-style:italic">/* Object size in bytes */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Symbol </span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>**Each symbol is assigned to some section of the object file, denoted by the section field, which is an index into the section header table.**Symbol和某个Section绑定，具体方法是Symbol记录对应Section在Section Header Table之中的index</p>
<p>There are three special pseudosections that <strong>don’t have entries in the section header table</strong></p>
<ul>
<li>
<p>ABS: symbols that should not be relocated</p>
</li>
<li>
<p>UNDEF: symbols that are referenced in this object module but defined elsewhere</p>
</li>
<li>
<p>COMMON: uninitialized data objects</p>
</li>
</ul>
<p>They only exist only in relocatable object files and do not exist in executable object files</p>
<p>For COMMON symbols</p>
<ul>
<li>
<p>value gives the alignment requirement</p>
</li>
<li>
<p>size gives the minimum size</p>
</li>
</ul>
<p><strong>重要</strong>:<strong>The difference between COMMON and .bss</strong></p>
<p>COMMON：<strong>Uninitialized global</strong> variables</p>
<p>.bss：<strong>Uninitialized static</strong> variables, <strong>global or static</strong> variables that are <strong>initialized to zero</strong></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="重要">重要！！！！！<a class="hash-link" aria-label="Direct link to 重要！！！！！" title="Direct link to 重要！！！！！" href="/blog/linking-复习#重要">​</a></h5>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2024/06/18/AKg2mf34LIXlDr7.png" alt="image-20240618160330533" class="img_ev3q"></p>
<h5 class="anchor anchorWithStickyNavbar_LWe7" id="重名问题">重名问题<a class="hash-link" aria-label="Direct link to 重名问题" title="Direct link to 重名问题" href="/blog/linking-复习#重名问题">​</a></h5>
<p>强符号： 初始化的全局变量，函数</p>
<p>弱符号： 未初始化的全局</p>
<p>重名：强+强，报错；强+弱，覆盖；弱+弱，任意</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="静态链接">静态链接<a class="hash-link" aria-label="Direct link to 静态链接" title="Direct link to 静态链接" href="/blog/linking-复习#静态链接">​</a></h4>
<ul>
<li>
<p><strong>concatenate related relocatable object files into a single file with an index (called an archive， .a)</strong></p>
</li>
<li>
<p>enhance linker so that it tries to resolve unresolved external references by looking for the symbols in one or more archives</p>
</li>
<li>
<p><strong>If an archive member file resolves reference, link into executable</strong></p>
</li>
</ul>
<p>使用静态链接：经典EUD</p>
<blockquote>
<ol>
<li>
<p>Scan .o files and .a files in the <strong>command line order.</strong></p>
</li>
<li>
<p>When scan an object file f,</p>
</li>
</ol>
<ul>
<li>
<p>Add f to E</p>
</li>
<li>
<p>Updates U, D</p>
</li>
</ul>
<ol start="3">
<li>
<p>When scan an archive file f,</p>
</li>
</ol>
<ul>
<li>
<p>Resolve U</p>
</li>
<li>
<p>If m is used to resolve symbol, m is added to E</p>
</li>
<li>
<p>Update U, D using m</p>
</li>
</ul>
<ol start="4">
<li>If any entries in the unresolved list at end of scan, then error</li>
</ol>
</blockquote>
<p>问题：command line order matters!</p>
<p>原则：总是把链接的库放在最后面，并且可以重复</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="relocation">Relocation<a class="hash-link" aria-label="Direct link to Relocation" title="Direct link to Relocation" href="/blog/linking-复习#relocation">​</a></h4>
<p>For each <strong>reference to an object with unknown location</strong></p>
<ul>
<li>
<p>Assembler generates a relocation entry</p>
</li>
<li>
<p>Relocation <strong>entries for code</strong> are placed in <strong>.rel.text</strong></p>
</li>
<li>
<p>Relocation <strong>entries for data</strong> are placed in <strong>.rel.data</strong></p>
</li>
</ul>
<p>例如</p>
<div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">09      e8 00 00 00 00	callq e&lt;main+0xe&gt; swap();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/* There is a relocation entry in rel.text */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">offset   symbol	type			addend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    0a   swap	R_X86_64_PC32   	-4  /* PC32: PC-relative */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>.rel.text section</p>
<ul>
<li>
<p><strong>relocation info for .text section</strong></p>
</li>
<li>
<p><strong>addresses of instructions</strong> that will need to be modified in the merged executable object file</p>
</li>
</ul>
<p>.rel.data section</p>
<ul>
<li>relocation info for .data section</li>
<li>addresses of <strong>pointer data</strong> that will need to be modified in the merged executable object file</li>
</ul>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">		</span><span class="token keyword" style="color:#00009f">long</span><span class="token plain">  offset </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain">  type</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         symbol</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">32</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">long</span><span class="token plain">  addend</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Rela </span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">bufp0 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">buf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token number" style="color:#36acaa">00000000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">bufp0</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token number" style="color:#36acaa">0</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">00</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* There is a relocation entry in rel.data */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">offset   symbol	type			addend</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">	   buf	R_X86_64_64   	</span><span class="token number" style="color:#36acaa">0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>addend</code>是重定位条目中的一个数值，它在链接时与符号的地址相加，以确定最终的内存地址。这个参数提供了一种机制，允许编译器生成更灵活和可移植的代码。</p>
<p><strong>Two steps</strong></p>
<ul>
<li>
<p><strong>Relocating sections and symbol definitions</strong></p>
</li>
<li>
<p><strong>Relocating symbol references within sections</strong></p>
</li>
</ul>
<p>reloc过程的伪代码：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">foreach section s </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    foreach relocation entry r </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        refptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offset </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ptr to reference to be relocated */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">/* relocate a PC-relative reference */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> R_X86_64_PC32</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            refaddr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">ADDR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offset </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">/* ref’s runtime address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">refptr</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">ADDR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addend–refaddr</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">/* relocate an absolute reference */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> R_X86_64_64 </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">type </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> R_X86_64_32</span><span class="token operator" style="color:#393A34">||</span><span class="token plain">…</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">refptr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">ADDR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> r</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addend</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="executable-elf-object">Executable ELF Object<a class="hash-link" aria-label="Direct link to Executable ELF Object" title="Direct link to Executable ELF Object" href="/blog/linking-复习#executable-elf-object">​</a></h4>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2024/06/18/ejWVEqtyn9YJbzi.png" alt="image-20240618163520190" class="img_ev3q"></p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain">  </span><span class="token keyword" style="color:#00009f">struct</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token keyword" style="color:#00009f">unsigned</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> 	e_ident</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">16</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* ELF identification */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Object file type */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_machine</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Machine type */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word 	e_version</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Object file version */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Addr 	e_entry</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Entry point address */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Off 		e_phoff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Program header offset */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Off 		e_shoff</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Section header offset */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word 	e_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Processor-specific flags */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_ehsize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* ELF header size */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_phentsize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Size of program header entry */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_phnum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Number of program header entries */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_shentsize</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Size of section header entry */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_shnum</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Number of section header entries */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Half 		e_shstrndx</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* Section name string table index */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Ehdr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">typedef</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word    p_type</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">/* Entry type.(PT_LOAD (1): loadable segment) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Word    p_flags</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">/* Access permission flags. Run time permissions (rwx)*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Off        p_offset</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* File offset of contents. (Offset from the beginning of the file to the first byte in the segment)*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Addr     p_vaddr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Virtual address in memory image. (The virtual address of the first byte in the segment)*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Addr     p_paddr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Physical address (not used). */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Xword  p_filesz</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">/* Size of contents in file.Segment size in the object file (&gt;=p_memsz)</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Xword  p_memsz</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Size of contents in memory. */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	Elf64_Xword  p_align</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/* Alignment in memory and file.Usually 4KB or 2MB*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> Elf64_Phdr</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2024/06/18/k7w5fiYPAHRjOCE.png" alt="image-20240618164607421" class="img_ev3q"></p>
<p><strong>Difference between filesz and memsz means the uninitialized data in .bss</strong></p>
<p>.init section contains a small function _init called by program’s initialization code</p>
<blockquote>
<p>startup code</p>
<p>_start: the entry point of the program. Defined in the crt1.o, Same for all C program, Calls system startup function</p>
<p>__libc_start_main: Defined in libc.so, Initializes the execution environment, Calls the main function, Handles return value, Returns control to OS (if necessary)</p>
</blockquote>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="loader">Loader<a class="hash-link" aria-label="Direct link to Loader" title="Direct link to Loader" href="/blog/linking-复习#loader">​</a></h4>
<p><strong>Memory-resident</strong> operating system code</p>
<ul>
<li>
<p><strong>Invoked by call the execve function</strong></p>
</li>
<li>
<p>Copy the code and data in the executable object file from disk into memory</p>
</li>
<li>
<p>Jump to the entry point</p>
</li>
<li>
<p>Run the program</p>
</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dynamic-link-动态链接">Dynamic Link 动态链接<a class="hash-link" aria-label="Direct link to Dynamic Link 动态链接" title="Direct link to Dynamic Link 动态链接" href="/blog/linking-复习#dynamic-link-动态链接">​</a></h4>
<ul>
<li>
<p>Dynamic Linking</p>
</li>
<li>
<p>Position Independent Code (PIC)</p>
</li>
<li>
<p>Loading and Linking Shared Libraries from applications</p>
</li>
</ul>
<p>静态链接缺点：底层库修改需要所有应用重编译，应用体积过大，冗余代码</p>
<p><strong>Shared Libraries</strong></p>
<p>.so(shared obj) on Linux, .dll(dynamic linking lib) on Windows</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">gcc –shared –fPIC –o libvector.so addvec.c multvec.c</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># –shared: creating a shared object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># –fPIC:  creating the position independent code</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Partial Linking</p>
<p>在编译时，.so文件<strong>没有将.data，.text段等copy</strong>，而只是copy了一些relocation and symbol table info</p>
<p>code and data是在memory之中<code>execve() &amp; ld-linux.so</code>链接的</p>
<blockquote>
<p>After linking, the locations of the shared libraries are fixed and do not change during the execution time</p>
<p>How to find the ld-linux.so</p>
<ul>
<li>The <strong>pathname of the ld-linux.so is contained in the .interp segment</strong> of p2</li>
</ul>
</blockquote>
<p>上面那张图，memory-mapped region for shared libs</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="运行时linking">运行时Linking<a class="hash-link" aria-label="Direct link to 运行时Linking" title="Direct link to 运行时Linking" href="/blog/linking-复习#运行时linking">​</a></h4>
<ul>
<li>Done explicitly by user with dlopen() in Linux</li>
</ul>
<p><code>gcc –rdynamic –O2 –o p3 dll.c -ldl</code></p>
<p>API：</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;dlfcn.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">dlopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">filename</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> flag</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// returns: ptr to handle if OK, NULL on error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token function" style="color:#d73a49">dlsym</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">symbol</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// returns: ptr to symbol if OK, NULL on error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain">  </span><span class="token function" style="color:#d73a49">dlclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">// returns: 0 if OK, -1 on error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dlerror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">void</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">			</span><span class="token comment" style="color:#999988;font-style:italic">/* returns: errormsg if previous call to</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> 			dlopen, dlysym, or dlclose failed,</span><br></span><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"> 			NULL if previous call was OK */</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>运行时Linking示例程序</p>
<div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;stdio.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token macro property directive-hash" style="color:#36acaa">#</span><span class="token macro property directive keyword" style="color:#00009f">include</span><span class="token macro property" style="color:#36acaa"> </span><span class="token macro property string" style="color:#e3116c">&lt;dlfcn.h&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">void</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">addvec</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">int</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">char</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain">error</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">	</span><span class="token comment" style="color:#999988;font-style:italic">/*dynamically load the shared library that contains addvec() */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	handle </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dlopen</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“</span><span class="token punctuation" style="color:#393A34">.</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">libvector</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">so”</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> RTLD_LAZY</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 		</span><span class="token function" style="color:#d73a49">fprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stderr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> “</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">s\n”</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dlerror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 		</span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/*get a pointer to the addvec() function we just loaded */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	addvec </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dlsym</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> “addvec”</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">error </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dlerror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">NULL</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 		</span><span class="token function" style="color:#d73a49">fprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stderr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> “</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">s\n”</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 		</span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">/* Now we can call addvec() just like any other function */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token function" style="color:#d73a49">addvec</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token function" style="color:#d73a49">printf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">“z</span><span class="token operator" style="color:#393A34">=</span><span class="token punctuation" style="color:#393A34">[</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">%</span><span class="token plain">d</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">\n”</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token comment" style="color:#999988;font-style:italic">/* unload the shared library */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token function" style="color:#d73a49">dlclose</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">handle</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 		</span><span class="token function" style="color:#d73a49">fprintf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token constant" style="color:#36acaa">stderr</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> “</span><span class="token operator" style="color:#393A34">%</span><span class="token plain">s\n”</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">dlerror</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 		</span><span class="token function" style="color:#d73a49">exit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> 	</span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>用处：</p>
<ul>
<li>分发系统更新，更新dll重新运行时自动加载</li>
<li>高性能web server, 对不同的库动态加载卸载，使用缓存来保证函数级别的最小内存占用，<strong>也是支持热更新的来源</strong></li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="pic位置无关代码">PIC：位置无关代码<a class="hash-link" aria-label="Direct link to PIC：位置无关代码" title="Direct link to PIC：位置无关代码" href="/blog/linking-复习#pic位置无关代码">​</a></h4>
<p>naive: 划分一块区域专门放</p>
<p>actual: 让代码都是PC-relative，从而可以被任意地址加载</p>
<ul>
<li>文件内部函数，变量：简单，直接变成PC-relative</li>
<li>文件外部引用，全局变量：间接跳转，以一个<strong>Private的.data段开头的GOT</strong>(全局偏移量表)作为跳板</li>
</ul>
<p>调用外部全局变量的解决方案：</p>
<ol>
<li>
<p>保证.data段和.text段在加载的时候不分开，一起加载</p>
</li>
<li>
<p>利用1，.data段和.text段现在的距离和加载到的地方没有关系了，在.data段开头的GOT里面记录各个全局的data的offset，然后在.text段记录GOT的entry_index, 访问时 .text -&gt; .data -&gt; GOT[idx] -&gt; global data</p>
</li>
</ol>
<p>GOT 012预留给dynamic linker</p>
<p>调用外部函数的解决方案：PLT（Procedure Linkage Table）</p>
<ol>
<li>
<p>在.text段前面加一段plt段，留下外部函数的地址的标记，对地址暂时留空</p>
</li>
<li>
<p>把.text段内部的代码之中所有外部函数的地址该外plt段之中标记的地址（相对地址）</p>
</li>
<li>
<p>当运行时.text-&gt;plt-&gt; 如果没有，再加载实际地址到标记留空的地方，之后再次访问不需要实际地址，只需要把plt当跳板就行</p>
</li>
</ol>
<p>PLT：16-byte entry array</p>
<p>PLT[0] 为dynamic linker预留</p>
<p><img decoding="async" loading="lazy" src="https://s2.loli.net/2024/06/18/DMFEe4dyZOcGLl8.png" alt="image-20240618203706209" class="img_ev3q"></p>
<p>第一次调用addvec</p>
<p>jmpq <code>*GOT[4]</code>发现没有，回来(*GOT[4]存0x4005c6下一条指令的relative，jmp相当于没jmp)，pushq $0x1 把addvec的entry ID作为栈上的参数给dynamic linker, 然后jmpq 到PLT[0]，PLT[0]压栈<code>*GOT[1]</code>参数后，跳转到dynamic linker，dynamic linker根据<code>*GOT[1]</code>和<code>ID</code>找到对应函数，同时更新GOT[4]，填上地址</p>
<p>后面调用addvec都是直接jmpq到<code>*GOT[4]</code>,实际上是函数调用</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="库打桩">库打桩<a class="hash-link" aria-label="Direct link to 库打桩" title="Direct link to 库打桩" href="/blog/linking-复习#库打桩">​</a></h4>
<p>构造“二传手”函数, 截获转发一些已经写好的库函数，例如malloc，可以用于日志，统计等等</p>
<p>编译时打桩：核心在于定义一个自己的同名函数，在自己的函数去调用库函数，例如利用宏定义malloc为mymalloc，再在mymalloc里面去调用系统的malloc</p>
<p>运行时打桩：比较复杂，不太重要</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="重定向深入">重定向深入<a class="hash-link" aria-label="Direct link to 重定向深入" title="Direct link to 重定向深入" href="/blog/linking-复习#重定向深入">​</a></h4>
<p><a href="https://anatasluo.github.io/%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3%E7%9B%B8%E5%AF%B9%E9%87%8D%E5%AE%9A%E5%90%91.html" target="_blank" rel="noopener noreferrer">深入理解相对重定向 - Anatas Luo&#x27;s Blog</a></p>
<p>总结： 1. 流水线的设计，使得IP寄存器总是指向下一条指令，计算offset时，需要考虑当前指令的长度 <strong>2. 相对偏移如果确定（通常是static data），则以section为基址进行重定向，可以减少符号表大小， Addend = symbol_offset - relocation_len 3. 相对偏移如果不确定，则以symbol为基址进行重定向，Addend = - relocation_len</strong></p>
<p>需要重定向的代码在汇编上以<code>0x0(%rip)</code>给出，<code>%rip</code>是PC，<code>0x0</code>则意味着待填充</p></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/linking">linking</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/system">system</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/hibernate-jpa"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">hibernate&amp;jpa</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/ts基础"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">ts基础</div></a></nav><div>Loading Comments...</div></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#no-linker-problems">No linker <strong>Problems</strong></a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#what-is-linker">What is linker</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#static-linking">Static Linking</a><ul><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#relocatable-object-file">Relocatable object file</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#sections">Sections</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#external-reference">External reference</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#object-files">Object files</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#executable-and-linkable-format-elf"><strong>Executable and Linkable Format (ELF)</strong></a><ul><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#elf-header">ELF Header</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#elf-string-table">ELF String Table</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#other-sections">Other Sections</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#sections-in-elf-obj-file">Sections in ELF obj file</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#symbol">Symbol</a><ul><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#重要">重要！！！！！</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#重名问题">重名问题</a></li></ul></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#静态链接">静态链接</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#relocation">Relocation</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#executable-elf-object">Executable ELF Object</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#loader">Loader</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#dynamic-link-动态链接">Dynamic Link 动态链接</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#运行时linking">运行时Linking</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#pic位置无关代码">PIC：位置无关代码</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#库打桩">库打桩</a></li><li><a class="table-of-contents__link toc-highlight" href="/blog/linking-复习#重定向深入">重定向深入</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">notes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">课程笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/personal-essays">Personal Essays</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Ayanami, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>