"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[9662],{37300:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>p,frontMatter:()=>s,metadata:()=>c,toc:()=>a});var o=r(74848),t=r(28453);const s={},l=void 0,c={id:"Chcore\u6e90\u7801\u9605\u8bfb/\u5185\u5b58\u5206\u914d\u5668/kmalloc",title:"kmalloc",description:"\u5b9e\u73b0kmalloc/kfree",source:"@site/docs/Chcore\u6e90\u7801\u9605\u8bfb/\u5185\u5b58\u5206\u914d\u5668/3.kmalloc.md",sourceDirName:"Chcore\u6e90\u7801\u9605\u8bfb/\u5185\u5b58\u5206\u914d\u5668",slug:"/Chcore\u6e90\u7801\u9605\u8bfb/\u5185\u5b58\u5206\u914d\u5668/kmalloc",permalink:"/docs/Chcore\u6e90\u7801\u9605\u8bfb/\u5185\u5b58\u5206\u914d\u5668/kmalloc",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:3,frontMatter:{},sidebar:"notesSidebar",previous:{title:"\u5c0f\u5185\u5b58\u5206\u914d\u4f18\u5316 SLab",permalink:"/docs/Chcore\u6e90\u7801\u9605\u8bfb/\u5185\u5b58\u5206\u914d\u5668/slab"},next:{title:"\u94f6\u674f\u53f6\u4e66 chapter 5",permalink:"/docs/Chcore\u6e90\u7801\u9605\u8bfb/\u5185\u5b58\u5206\u914d\u5668/\u53c2\u8003-\u94f6\u674f\u53f6\u4e66chapter5\u7b14\u8bb0"}},i={},a=[{value:"\u5b9e\u73b0kmalloc/kfree",id:"\u5b9e\u73b0kmallockfree",level:3}];function d(e){const n={code:"code",h3:"h3",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h3,{id:"\u5b9e\u73b0kmallockfree",children:"\u5b9e\u73b0kmalloc/kfree"}),"\n",(0,o.jsx)(n.p,{children:"\u6709\u4e86buddy sys\u548cslab\u7684api\u4e4b\u540e\uff0ckmalloc/kfree\u5df2\u7ecf\u547c\u4e4b\u6b32\u51fa\u4e86"}),"\n",(0,o.jsx)(n.p,{children:"kmalloc: \u5982\u679c\u662f\u5927\u5757\uff0cbuddy sys malloc; \u5426\u5219slab malloc"}),"\n",(0,o.jsxs)(n.p,{children:["kfree: \u7531addr \u5f97\u5230page, \u5982\u679c ",(0,o.jsx)(n.code,{children:"page->slab"})," , slab free; \u5982\u679c ",(0,o.jsx)(n.code,{children:"page->pool"})," buddy free"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-c",children:'void *_kmalloc(size_t size, bool is_record, size_t *real_size)\n{\n        void *addr;\n        int order;\n\n        if (unlikely(size == 0))\n                return ZERO_SIZE_PTR;\n\n        if (size <= SLAB_MAX_SIZE) {\n                addr = alloc_in_slab(size, real_size);\n#if ENABLE_MEMORY_USAGE_COLLECTING == ON\n                if(is_record && collecting_switch) {\n                        record_mem_usage(*real_size, addr);\n\t\t}\n#endif\n        } else {\n                if (size <= BUDDY_PAGE_SIZE)\n                        order = 0;\n                else\n                        order = size_to_page_order(size);\n                addr = get_pages(order);\n        }\n\n        return addr;\n}\n\nvoid _kfree(void *ptr, bool is_revoke_record)\n{\n        struct page *page;\n\n        if (unlikely(ptr == ZERO_SIZE_PTR))\n                return;\n\n        page = virt_to_page(ptr);\n#if ENABLE_MEMORY_USAGE_COLLECTING == ON\n        if (collecting_switch && is_revoke_record) {\n                revoke_mem_usage(ptr);\n\t}\n#endif\n        if (page && page->slab)\n                free_in_slab(ptr);\n        else if (page && page->pool)\n                buddy_free_pages(page->pool, page);\n        else\n                kwarn("unexpected state in %s\\n", __func__);\n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},28453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>c});var o=r(96540);const t={},s=o.createContext(t);function l(e){const n=o.useContext(s);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),o.createElement(s.Provider,{value:n},e.children)}}}]);