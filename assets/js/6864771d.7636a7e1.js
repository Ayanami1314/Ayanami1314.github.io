"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[1278],{5280:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>c,toc:()=>o});var i=r(4848),s=r(8453);const t={title:"\u9ed1\u9a6c\u70b9\u8bc4(\u901f\u901a\u7248)",date:new Date("2024-07-11T00:00:00.000Z"),author:"ayanami",tags:["\u57f9\u8bad\u73ed","redis","web"]},l=void 0,c={permalink:"/blog/\u9ed1\u9a6c\u70b9\u8bc4",source:"@site/blog/\u9ed1\u9a6c\u70b9\u8bc4.md",title:"\u9ed1\u9a6c\u70b9\u8bc4(\u901f\u901a\u7248)",description:"\u4e2a\u4eba\u73af\u5883 Ubuntu 24.04",date:"2024-07-11T00:00:00.000Z",tags:[{inline:!0,label:"\u57f9\u8bad\u73ed",permalink:"/blog/tags/\u57f9\u8bad\u73ed"},{inline:!0,label:"redis",permalink:"/blog/tags/redis"},{inline:!0,label:"web",permalink:"/blog/tags/web"}],readingTime:38.085,hasTruncateMarker:!0,authors:[{name:"ayanami"}],frontMatter:{title:"\u9ed1\u9a6c\u70b9\u8bc4(\u901f\u901a\u7248)",date:"2024-07-11T00:00:00.000Z",author:"ayanami",tags:["\u57f9\u8bad\u73ed","redis","web"]},unlisted:!1,prevItem:{title:"\u6d45\u5165\u7406\u89e3\u65ad\u70b9\u548c\u8c03\u8bd5\u5668",permalink:"/blog/\u6d45\u5165\u7406\u89e3\u65ad\u70b9\u548c\u8c03\u8bd5\u5668"},nextItem:{title:"js\u57fa\u7840",permalink:"/blog/js\u57fa\u7840"}},d={authorsImageUrls:[void 0]},o=[{value:"\u9879\u76ee\u914d\u7f6e",id:"\u9879\u76ee\u914d\u7f6e",level:3},{value:"\u767b\u5f55",id:"\u767b\u5f55",level:3},{value:"\u7f13\u5b58\u4e00\u81f4\u6027\u95ee\u9898",id:"\u7f13\u5b58\u4e00\u81f4\u6027\u95ee\u9898",level:3},{value:"\u8ba2\u5355",id:"\u8ba2\u5355",level:3},{value:"id\u751f\u6210\u5668",id:"id\u751f\u6210\u5668",level:4},{value:"\u79d2\u6740\u8d85\u5356\u95ee\u9898",id:"\u79d2\u6740\u8d85\u5356\u95ee\u9898",level:4},{value:"\u4e00\u4eba\u4e00\u5355",id:"\u4e00\u4eba\u4e00\u5355",level:4},{value:"\u96c6\u7fa4\u5b89\u5168\u95ee\u9898",id:"\u96c6\u7fa4\u5b89\u5168\u95ee\u9898",level:4},{value:"\u5206\u5e03\u5f0f\u9501",id:"\u5206\u5e03\u5f0f\u9501",level:4},{value:"\u4f18\u5316\u79d2\u6740",id:"\u4f18\u5316\u79d2\u6740",level:3},{value:"\u5b9e\u6218",id:"\u5b9e\u6218",level:3}];function a(e){const n={a:"a",blockquote:"blockquote",code:"code",h3:"h3",h4:"h4",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"\u4e2a\u4eba\u73af\u5883 Ubuntu 24.04"}),"\n",(0,i.jsx)(n.h3,{id:"\u9879\u76ee\u914d\u7f6e",children:"\u9879\u76ee\u914d\u7f6e"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["repo: \u641c\u4e00\u641c\u5c31\u884c ",(0,i.jsx)(n.a,{href:"https://github.com/cs001020/hmdp?tab=readme-ov-file",children:"https://github.com/cs001020/hmdp?tab=readme-ov-file"})]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"idea config: \u964djava\u7248\u672c\u523011\u5c31\u80fd\u4e0d\u62a5\u9519"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"redis, mysql: \u641c\u7d22\u5373\u53ef systemd \u542f\u52a8"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["nginx \u7a0d\u5fae\u590d\u6742\u4e00\u70b9, \u7ed9\u7684\u662fwin\u4e0b\u7684nginx, \u914d\u5b8csystemd\u4e4b\u540e,\u7528\u4ed6\u7684",(0,i.jsx)(n.code,{children:"nginx.conf"}),"\u66ff\u6362",(0,i.jsx)(n.code,{children:"/etc/nginx/nginx.conf"}),"(\u8bb0\u5f97\u5907\u4efd) \u7136\u540e\u4fee\u6539"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"        # \u6307\u5b9a\u524d\u7aef\u9879\u76ee\u6240\u5728\u7684\u4f4d\u7f6e\n        location / {\n            root   /home/ayanami/www/hmdp/html/hmdp; # \u4fee\u6539\u6b64\u5904, \u6539\u4e3a${\u4e0b\u8f7d\u7684nginx\u6587\u4ef6\u5939\u539f\u6765\u4f4d\u7f6e}/hmdp/html/hmdp\n\x3c!--truncate--\x3e            index  index.html index.htm;\n        }\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u5373\u53ef"}),"\n",(0,i.jsxs)(n.p,{children:["\u53ef\u80fd\u8fd8\u9700\u8981\u5728\u9876\u90e8\u4fee\u6539 ",(0,i.jsx)(n.code,{children:"user ${Your User Name}"})]}),"\n",(0,i.jsx)(n.p,{children:"ps: nginx\u4f3c\u4e4e\u5957\u4e00\u5c42\u540e\u4f1a\u8ba9\u4e4b\u524d\u7684\u8fde\u63a5\u7684token\u4e4b\u7c7binvalid\u6389, \u4f8b\u5982b\u7ad9 kimi \u9000\u51fa\u767b\u5f55"}),"\n",(0,i.jsxs)(n.p,{children:["\u76ee\u524d\u4e0d\u77e5\u9053\u9664\u4e86\u7b80\u5355",(0,i.jsx)(n.code,{children:"sudo systemctl stop nginx"}),"\u7684\u65b9\u6cd5"]}),"\n",(0,i.jsx)(n.p,{children:"\u4f1a\u4e0d\u4f1anginx\u4e22docker\u91cc\u9762\u4e4b\u7c7b\u522b\u653e\u672c\u673a\u8dd1\u597d\u4e00\u70b9"}),"\n",(0,i.jsx)(n.h3,{id:"\u767b\u5f55",children:"\u767b\u5f55"}),"\n",(0,i.jsx)(n.p,{children:"threadlocal"}),"\n",(0,i.jsx)(n.p,{children:"redis \u5b58 session, \u505a\u6c34\u5e73\u62d3\u5c55\u8d1f\u8f7d\u5747\u8861"}),"\n",(0,i.jsx)(n.p,{children:"\u7528\u6237\u6821\u9a8c phone key, \u9a8c\u8bc1\u7801 value"}),"\n",(0,i.jsx)(n.p,{children:"session\u4fe1\u606f, value \u7528hash\u800c\u4e0d\u7528string(json)"}),"\n",(0,i.jsx)(n.p,{children:'\u5b58\u50a8session\u6570\u636e value\u662f\u4e00\u4e2a"HashMap", \u652f\u6301\u5355\u5b57\u6bb5crud, \u5185\u5b58\u5360\u7528\u5c11'}),"\n",(0,i.jsx)(n.p,{children:"key ? \u751f\u6210\u4e00\u4e2a\u552f\u4e00 token, \u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef"}),"\n",(0,i.jsx)(n.p,{children:'redis key\u52a0\u4e1a\u52a1\u524d\u7f00"login:code:"'}),"\n",(0,i.jsx)(n.p,{children:"\u8bbe\u7f6e\u6709\u6548\u671f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"redisTemplate.opsForValue().set(LOGIN_CODE_KEY + phone, code, 2, TimeUnit.MINUTES);\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8bbe\u7f6e30min\u6709\u6548\u671f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"        // \u4fdd\u5b58\u7528\u6237\u4fe1\u606f\u5230redis\n        UserDTO userDTO = new UserDTO();\n        BeanUtils.copyProperties(user, UserDTO.class);\n        String token = UUID.randomUUID().toString(true);\n        Map<String, Object> userMap = BeanUtil.beanToMap(userDTO);\n        stringRedisTemplate.opsForHash().putAll(LOGIN_USER_KEY + token, userMap);\n        stringRedisTemplate.expire(LOGIN_USER_KEY + token, 30, TimeUnit.MINUTES);\n        return Result.ok();\n"})}),"\n",(0,i.jsx)(n.p,{children:'"\u7528\u6237\u4e0d\u6d3b\u8dc330min": \u5728\u62e6\u622a\u5668\u91cc\u9762\u66f4\u65b0token\u6709\u6548\u671f(\u518d\u8c03\u7528\u4e00\u6b21expire\u5c31\u884c)'}),"\n",(0,i.jsx)(n.p,{children:"\u81ea\u5b9a\u4e49\u62e6\u622a\u5668\u4e0d\u80fd\u505a\u4f9d\u8d56\u6ce8\u5165? \u8001\u5b9e\u5199\u6784\u9020\u51fd\u6570, \u5728\u5916\u90e8@Configuration\u7684Configurer\u4e2d\u6ce8\u5165, \u518d\u8c03\u7528registry\u65f6\u6784\u9020"}),"\n",(0,i.jsxs)(n.p,{children:["\u5feb\u6377\u952e\u7f29\u5199\u884c\u5c3e",(0,i.jsx)(n.code,{children:".var"})]}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u6837redis + threadlocal\u5c31\u7ed5\u5f00\u4e86\u767b\u5f55\u4e2dtomcat\u7684session\u673a\u5236,\u51cf\u5c11session\u4f20\u9012\u5f00\u9500"}),"\n",(0,i.jsx)(n.p,{children:"\u524d\u7aef\u5f97\u5230token\u5728\u8bf7\u6c42\u5934\u91cc\u9762\u653e"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {\n        // 1.\u83b7\u53d6\u8bf7\u6c42\u5934token\n        // 2.\u7531token\u83b7\u53d6redis\u7528\u6237\n        // 3.\u5224\u65adtoken\u662f\u5426\u5b58\u5728\n        // 4.\u4fdd\u5b58\u7528\u6237\u5230threadlocal\n        // 5.\u5237\u65b0\u7528\u6237token\u6709\u6548\u671f\n        String token = request.getHeader("authorization");\n        if (StrUtil.isBlank(token)){\n            response.setStatus(401); // unauthorized\n            return false;\n        }\n        Map<Object, Object> userMap = stringRedisTemplate.opsForHash().entries(LOGIN_USER_KEY + token);\n        UserDTO userDTO = BeanUtil.fillBeanWithMap(userMap, new UserDTO(), false);\n\n        // exist, save user info\n        UserHolder.saveUser(userDTO);\n\n        stringRedisTemplate.expire(LOGIN_USER_KEY + token, LOGIN_USER_TTL, TimeUnit.MINUTES);\n        return true;\n    }\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u62e6\u622a\u5668\u53ea\u62e6\u9700\u8981\u767b\u5f55\u7684\u8def\u5f84->\u518d\u52a0\u4e00\u4e2a\u65b0\u7684\u62e6\u622a\u5668, \u62e6\u6240\u6709\u8def\u5f84"}),"\n",(0,i.jsx)(n.p,{children:"\u62e6\u622a\u5668\u987a\u5e8f, \u53ef\u4ee5.order\u8c03\u6574\u4f18\u5148\u7ea7, \u4eceorder\u5c0f\u5230order\u5927\u6267\u884c, \u4e5f\u53ef\u4ee5\u9ed8\u8ba4(\u76f8\u540corder\u6309\u7167\u6dfb\u52a0\u987a\u5e8f)"}),"\n",(0,i.jsx)(n.h3,{id:"\u7f13\u5b58\u4e00\u81f4\u6027\u95ee\u9898",children:"\u7f13\u5b58\u4e00\u81f4\u6027\u95ee\u9898"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u5185\u5b58\u6dd8\u6c70(redis\u673a\u5236)"}),"\n",(0,i.jsx)(n.li,{children:"\u8d85\u65f6\u5254\u9664(\u7528\u6237\u6307\u5b9a)"}),"\n",(0,i.jsx)(n.li,{children:"\u4e3b\u52a8\u66f4\u65b0(\u7acb\u523b\u89e6\u53d1)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4f4e\u4e00\u81f4\u6027\u7684\u90e8\u5206\u5185\u5b58\u6dd8\u6c70\u6216\u8005\u8d85\u65f6\u5254\u9664\u5c31\u884c, \u5982\u7c7b\u578b"}),"\n",(0,i.jsx)(n.p,{children:"\u9ad8\u4e00\u81f4\u6027\u4e3b\u52a8\u66f4\u65b0+\u8d85\u65f6\u515c\u5e95, \u5982\u8be6\u60c5"}),"\n",(0,i.jsx)(n.p,{children:"\u4e3b\u52a8\u66f4\u65b0"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"cache aside"})," \u7f13\u5b58\u8c03\u7528\u8005\u8d1f\u8d23\u66f4\u65b0"]}),"\n",(0,i.jsx)(n.li,{children:"read/write through \u7f13\u5b58\u548c\u6570\u636e\u5e93\u6574\u4f53\u4f5c\u4e3a\u4e00\u4e2a\u670d\u52a1\u7ef4\u6301\u4e00\u81f4\u6027"}),"\n",(0,i.jsx)(n.li,{children:"Write Behind Caching \u8c03\u7528\u8005\u53ea\u64cd\u4f5c\u7f13\u5b58,\u5176\u4ed6\u7ebf\u7a0b\u5f02\u6b65\u5c06\u7f13\u5b58\u6301\u4e45\u5316\u5230db(\u53ef\u52a0\u6279\u5904\u7406)"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u540e\u4e24\u79cd\u8f83\u590d\u6742"}),"\n",(0,i.jsx)(n.p,{children:"cache aside"}),"\n",(0,i.jsx)(n.p,{children:"\u5220\u9664\u8fd8\u662f\u66f4\u65b0?"}),"\n",(0,i.jsx)(n.p,{children:"\u5220\u9664\u662f\u4e00\u79cdlazy alloc, \u5982\u679c\u5728\u591a\u6b21\u66f4\u65b0\u4e2d\u95f4\u6ca1\u6709\u67e5\u8be2\u5c31\u6d6a\u8d39\u4e86,\u8fd8\u4e0d\u5982\u5220,\u4e00\u822c\u5220\u9664\u7f13\u5b58"}),"\n",(0,i.jsx)(n.p,{children:"\u7f13\u5b58db\u539f\u5b50\u6027, \u5355\u4f53->\u4e8b\u52a1, \u5206\u5e03\u5f0f->TCC\u7b49\u5206\u5e03\u5f0f\u4e8b\u52a1"}),"\n",(0,i.jsx)(n.p,{children:"\u5148\u540e?"}),"\n",(0,i.jsx)(n.p,{children:"\u5148\u5220\u7f13\u5b58, \u518d\u66f4\u65b0db"}),"\n",(0,i.jsx)(n.p,{children:"\u5e76\u53d1\u4e0b\u6570\u636e\u53ef\u4ee5\u4e0d\u4e00\u81f4, T1 delete cache,T2 cache miss, query db, update cache, T1 write  db"}),"\n",(0,i.jsx)(n.p,{children:"\u5f97\u5230\u7f13\u5b58\u548cdb\u4e0d\u4e00\u81f4! \u5e76\u4e14\u89e6\u53d1\u6982\u7387\u5f88\u9ad8, \u56e0\u4e3a\u67e5db\u6162"}),"\n",(0,i.jsx)(n.p,{children:"\u5148\u66f4\u65b0db\u518d\u5220\u9664\u7f13\u5b58, \u5927\u90e8\u5206\u65f6\u5019\u662f\u4e00\u81f4\u7684, \u9664\u4e86"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u7f13\u5b58\u5df2\u5931\u6548"}),"\n",(0,i.jsx)(n.li,{children:"T1 \u67e5\u7f13\u5b58, \u67e5\u6570\u636e\u5e93"}),"\n",(0,i.jsx)(n.li,{children:"T2 \u66f4\u65b0\u6570\u636e\u5e93, \u5220\u7f13\u5b58"}),"\n",(0,i.jsx)(n.li,{children:"T1 \u66f4\u65b0\u7f13\u5b58"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u6837\u624d\u4f1a\u4e0d\u4e00\u81f4, \u4f46\u7f13\u5b58\u5df2\u5931\u6548\u548cT1\u67e5\u64cd\u4f5c\u6bd4T2\u66f4\u65b0\u64cd\u4f5c\u8fd8\u6162\u4e24\u4e2a\u6761\u4ef6\u540c\u65f6\u6ee1\u8db3\u662f\u7f55\u89c1\u7684, \u6240\u4ee5\u597d"}),"\n",(0,i.jsxs)(n.p,{children:["\u6240\u4ee5",(0,i.jsx)(n.strong,{children:"\u5148\u66f4\u65b0db\u518d\u5220\u9664\u7f13\u5b58"}),", \u8fd8\u6709\u540c\u6b65\u95ee\u9898\u4ea4\u7ed9\u8d85\u65f6\u65f6\u95f4"]}),"\n",(0,i.jsx)(n.p,{children:"\u540c\u65f6\u5148db\u518d\u7f13\u5b58\u65b9\u4fbf\u51fa\u9519\u65f6\u56de\u6eda, \u5982\u679c\u5148\u7f13\u5b58\u518ddb, db\u51fa\u9519\u6eda\u4e0d\u4e86redis\u7f13\u5b58(\u9700\u8981\u624b\u52a8\u4fee\u6539redis)"}),"\n",(0,i.jsx)(n.p,{children:"\u7f13\u5b58\u7a7f\u900f"}),"\n",(0,i.jsx)(n.p,{children:"\u5ba2\u6237\u7aef\u6076\u610f\u8bf7\u6c42\u4e0d\u5b58\u5728\u6570\u636e,\u6253\u5d29\u6570\u636e\u5e93"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u7f13\u5b58\u7a7a\u5bf9\u8c61"}),": \u989d\u5916\u7684\u5185\u5b58\u6d88\u8017, \u77ed\u671f\u4e0d\u4e00\u81f4, \u901a\u8fc7expire TTL\u63a7\u5236"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5e03\u9686\u8fc7\u6ee4"}),": \u5185\u5b58\u5c11, \u4f46\u6709\u5047\u9633\u6027 -> redis bitmap"]}),"\n",(0,i.jsx)(n.li,{children:"\u589e\u5f3aid\u590d\u6742\u5ea6"}),"\n",(0,i.jsx)(n.li,{children:"\u505a\u597d\u6570\u636e\u7684\u57fa\u7840\u683c\u5f0f\u6821\u9a8c"}),"\n",(0,i.jsx)(n.li,{children:"\u7528\u6237\u6743\u9650\u6821\u9a8c, \u70ed\u70b9\u53c2\u6570\u9650\u6d41"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u7f13\u5b58\u96ea\u5d29:"}),"\n",(0,i.jsx)(n.p,{children:"\u5927\u91cf\u7f13\u5b58key\u540c\u65f6\u5931\u6548(\u4f8b\u5982\u540c\u65f6\u8fc7\u671f)\u6216\u8005redis\u5b95\u673a, \u5927\u91cf\u8bf7\u6c42\u6253\u5230db, db\u5b95\u673a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"key TTL \u52a0\u968f\u673a\u503c"}),"\n",(0,i.jsx)(n.li,{children:"\u964d\u7ea7\u9650\u6d41"}),"\n",(0,i.jsx)(n.li,{children:"\u591a\u7ea7\u7f13\u5b58(\u524d\u7aef, nginx, jvm)\u7b49"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u7f13\u5b58\u51fb\u7a7f:"}),"\n",(0,i.jsx)(n.p,{children:"\u70ed\u70b9key(\u88ab\u9ad8\u5e76\u53d1\u8bbf\u95ee\u4e14\u7f13\u5b58\u91cd\u5efa\u4e1a\u52a1\u6bd4\u8f83\u590d\u6742(\u4f8b\u5982db\u9700\u8981\u505a\u591a\u8868join\u548c\u8fd0\u7b97)\u7684key)\u5931\u6548"}),"\n",(0,i.jsx)(n.p,{children:"N\u4e2a\u7ebf\u7a0b\u90fd\u5728\u8bf7\u6c42db\u5e76\u4e14\u5c1d\u8bd5\u7f13\u5b58\u91cd\u5efa"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"\u4e92\u65a5\u9501, \u91cd\u5efa\u5148\u62ff\u9501"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"\u903b\u8f91\u8fc7\u671f"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4e92\u65a5\u9501\u7684\u4e0d\u8db3\u5728\u4e8e\u7ebf\u7a0b\u8fd8\u662f\u4f1a\u7a7a\u7b49, \u4f46\u4fdd\u8bc1\u4e00\u81f4\u6027, \u5e76\u4e14\u5b9e\u73b0\u975e\u5e38\u7b80\u5355"}),"\n",(0,i.jsx)(n.p,{children:"\u903b\u8f91\u8fc7\u671f\u89e3\u51b3\u6839\u672c\u95ee\u9898, \u70ed\u70b9key\u4e0d\u91c7\u7528redis\u7684\u8fc7\u671f\u7b56\u7565\u4e0d\u5c31\u597d\u4e86?(\u9877\u523b\u70bc\u5316!)"}),"\n",(0,i.jsxs)(n.p,{children:["\u4e0d\u8bbe\u7f6eTTL, \u800c\u662f\u5728value\u91cc\u9762\u52a0\u4e0a",(0,i.jsx)(n.code,{children:"{expired: timestamp}"})]}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u4e1a\u52a1\u4ee3\u7801\u53d1\u73b0\u903b\u8f91\u8fc7\u671f\u4e4b\u540e, \u62ff\u9501, \u5f00\u542f\u4e00\u4e2a\u65b0\u7ebf\u7a0b(\u4e00\u822c\u5b9e\u9645\u4e0a\u662f\u7ed9\u7ebf\u7a0b\u6c60\u4e00\u4e2a\u4efb\u52a1)\u505a\u6574\u4e2a\u67e5\u8be2\u548c\u91cd\u5efa\u7f13\u5b58\u7684\u64cd\u4f5c"}),"\n",(0,i.jsx)(n.p,{children:"\u7136\u540e\u5728\u8fd9\u4e2a\u65b0\u7ebf\u7a0b\u505a\u5b8c\u653e\u9501\u4e4b\u524d, \u5176\u4ed6\u7ebf\u7a0b\u5c31\u5c1d\u8bd5\u62ff\u9501-\u5931\u8d25-\u8fd4\u56de\u65e7\u6570\u636e"}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd9\u91cc\u7684\u81ea\u5b9a\u4e49\u4e92\u65a5\u9501\u7528\u4e86\u4e2a\u5f88\u751f\u8349\u7684\u65b9\u6cd5, redis\u7684",(0,i.jsx)(n.code,{children:"setnx"}),"\u547d\u4ee4"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"setnx lock 1"}),"\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u80fd\u6210\u529f"]}),"\n",(0,i.jsxs)(n.p,{children:["\u653e\u9501\u5c31",(0,i.jsx)(n.code,{children:"del lock"})]}),"\n",(0,i.jsx)(n.p,{children:"\u4f30\u8ba1\u5e95\u5c42\u662fCAS\u6216\u8005\u5c31\u662f\u7b80\u5355\u7684mutex\u4e4b\u7c7b, \u4f46\u653e\u5728redis\u91cc\u9762\u4e86, \u7b80\u5316\u4e86java\u903b\u8f91"}),"\n",(0,i.jsx)(n.p,{children:"\u9501\u7684\u8d85\u65f6\u65f6\u95f4? \u770b\u4e1a\u52a1\u65f6\u95f4\u6765\u5b9a"}),"\n",(0,i.jsx)(n.p,{children:"\u57fa\u4e8e\u9501\u7684\u67e5\u8be2\u4ee3\u7801demo\u5982\u4e0b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@Service\npublic class ShopServiceImpl extends ServiceImpl<ShopMapper, Shop> implements IShopService {\n    @Autowired\n    private StringRedisTemplate stringRedisTemplate;\n\n    private Boolean tryLock(String key){\n        Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, "1", 10, TimeUnit.SECONDS);\n        return BooleanUtil.isTrue(flag);\n    }\n    private void unlock(String key){\n        stringRedisTemplate.delete(key);\n    }\n    public Result queryShopById(Long id) throws InterruptedException {\n        Map<Object,Object> shopMap = stringRedisTemplate.opsForHash().entries(CACHE_SHOP_KEY + id);\n        if (!shopMap.isEmpty()){\n            Shop shop = BeanUtil.fillBeanWithMap(shopMap, new Shop(), false);\n            return Result.ok(shop);\n        }\n        // cache miss\n        // \u907f\u514d\u7f13\u5b58\u51fb\u7a7f, \u5148\u62ff\u9501\n        String CACHE_SHOP_LOCK = "shop:lock:";\n        if (tryLock(CACHE_SHOP_LOCK + id)){\n            try {\n                Shop shop = super.getById(id);\n                if (shop != null){\n                    stringRedisTemplate.opsForHash().putAll(CACHE_SHOP_KEY + id, BeanUtil.beanToMap(shop, new HashMap<>(),\n                            CopyOptions.create().setIgnoreNullValue(true)\n                                    .setFieldValueEditor((fieldname, fieldvalue) -> fieldvalue == null ? "" : fieldvalue.toString())));\n                    stringRedisTemplate.expire(CACHE_SHOP_KEY + id, CACHE_SHOP_TTL, TimeUnit.MINUTES);\n                    return Result.ok(shop);\n                }\n                // \u7f13\u5b58\u7a7f\u900f, \u5199\u5165\u7a7a\u7f13\u5b58\n                HashMap<Object, Object> nullMap = new HashMap<>();\n                nullMap.put("null", "null");\n                stringRedisTemplate.opsForHash().putAll(CACHE_SHOP_KEY + id, nullMap);\n                stringRedisTemplate.expire(CACHE_SHOP_KEY + id, CACHE_NULL_TTL, TimeUnit.MINUTES);\n                return Result.fail("\u5546\u94fa\u4e0d\u5b58\u5728");\n            } finally {\n                unlock(CACHE_SHOP_LOCK + id);\n            }\n        }\n        // \u62ff\u4e0d\u5230, \u7b49\u5f85\u540e\u91cd\u8bd5\n        Thread.sleep(100);\n        return queryShopById(id);\n    }\n\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u7136\u540e\u7528Jmeter \u8d771000\u4e2a\u7ebf\u7a0b\u7528200QPS\u6253\u4e00\u6253"}),"\n",(0,i.jsx)(n.p,{children:"\u53d1\u73b0\u8fd9\u4e2a\u9501\u7684\u903b\u8f91\u8fd8\u662f\u6ca1\u4ec0\u4e48\u95ee\u9898\u7684, \u53ea\u67e5\u8be2\u4e86\u4e00\u6b21\u7f13\u5b58"}),"\n",(0,i.jsx)(n.p,{children:"\u8fd8\u53ef\u4ee5\u8fd9\u4e48\u5c01\u88c5\u4e00\u4e0b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'package com.hmdp.utils;\n\nimport cn.hutool.core.util.BooleanUtil;\nimport cn.hutool.json.JSONUtil;\nimport io.lettuce.core.RedisURI;\nimport lombok.Data;\nimport lombok.extern.slf4j.Slf4j;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Component;\n\nimport java.io.Serializable;\nimport java.util.Optional;\nimport java.util.concurrent.TimeUnit;\nimport java.util.function.Function;\n\n\n@Slf4j\n@Component\npublic class CacheClient {\n    private StringRedisTemplate stringRedisTemplate;\n\n\n    public CacheClient(StringRedisTemplate stringRedisTemplate) {\n        this.stringRedisTemplate = stringRedisTemplate;\n    }\n\n    public void set(String key, Object value, long timeout, TimeUnit unit) {\n        stringRedisTemplate.opsForValue().set(key, JSONUtil.toJsonStr(value), timeout, unit);\n    }\n\n    public <R> Optional<R> get(String key, Class<R> type){\n        String json = stringRedisTemplate.opsForValue().get(key);\n        if (json == null){\n            return Optional.empty();\n        }\n        R result = JSONUtil.toBean(json, type);\n        if (result == null){\n            return Optional.empty();\n        }\n        return Optional.of(result);\n    }\n\n    public void delete(String key){\n        stringRedisTemplate.delete(key);\n    }\n\n    public <R, ID extends Serializable> Optional<R> queryWithPassThrough(String keyPrefix, ID id, Class<R> type, Function<ID, Optional<R>> dbQuery, long timeout, TimeUnit unit) {\n        // 1. \u67e5\u7f13\u5b58\n        Optional<R> cacheVal = get(keyPrefix + id, type);\n        if(cacheVal.isPresent()){\n            return cacheVal;\n        }\n        // 2. \u4e0d\u5b58\u5728\u67e5db\n        Optional<R> result = dbQuery.apply(id);\n        // 3. \u5b58\u5728\u8fd4\u56de\n        if (result.isPresent()){\n            // 3.1 \u66f4\u65b0\u7f13\u5b58\n            set(keyPrefix + id, result.get(), timeout, unit);\n            return result;\n        }\n        // 4. \u5747\u4e0d\u5b58\u5728\u66f4\u65b0\u7f13\u5b58\u4e3a\u7a7a\n        set(keyPrefix + id, null, timeout, unit);\n        return Optional.empty();\n    }\n\n    private Boolean tryLock(String key){\n        Boolean flag = stringRedisTemplate.opsForValue().setIfAbsent(key, "1", 10, TimeUnit.SECONDS);\n        return BooleanUtil.isTrue(flag);\n    }\n    private void unlock(String key){\n        stringRedisTemplate.delete(key);\n    }\n\n    // \u7528\u4e8e\u70ed\u70b9key(\u88ab\u9ad8\u5e76\u53d1\u8bbf\u95ee\u4e14\u7f13\u5b58\u91cd\u5efa\u4e1a\u52a1\u6bd4\u8f83\u590d\u6742(\u4f8b\u5982db\u9700\u8981\u505a\u591a\u8868join\u548c\u8fd0\u7b97)\u7684key), \u907f\u514d\u7f13\u5b58\u51fb\u7a7f\n    public <R, ID extends Serializable> Optional<R> queryWithLock(String keyPrefix, ID id, Class<R> type, Function<ID, Optional<R>> dbQuery, long timeout, TimeUnit unit) {\n        // 1. \u67e5\u7f13\u5b58\n        Optional<R> cacheVal = get(keyPrefix + id, type);\n        if(cacheVal.isPresent()){\n            return cacheVal;\n        }\n        // 2. \u4e0d\u5b58\u5728\u67e5db\n        // \u907f\u514d\u7f13\u5b58\u51fb\u7a7f, \u5148\u62ff\u9501\n        String CACHE_LOCK = "lock:" + keyPrefix + ":" + id;\n        if (tryLock(CACHE_LOCK)){\n            try {\n                Optional<R> result = dbQuery.apply(id);\n                System.out.println("result = " + result);\n                // 3. \u5b58\u5728\u8fd4\u56de\n                if (result.isPresent()){\n                    // 3.1 \u66f4\u65b0\u7f13\u5b58\n                    set(keyPrefix + id, result.get(), timeout, unit);\n                    return result;\n                }\n                // 4. \u5747\u4e0d\u5b58\u5728\u66f4\u65b0\u7f13\u5b58\u4e3a\u7a7a\n                set(keyPrefix + id, "{}", timeout, unit);\n                return Optional.empty();\n            } catch (Exception e) {\n                throw new RuntimeException(e);\n            }\n            finally {\n                unlock(CACHE_LOCK);\n            }\n        }\n        // 5. \u672a\u83b7\u53d6\u5230\u9501, \u7b49\u5f85\u540e\u91cd\u8bd5\n        try {\n            Thread.sleep(100);\n        } catch (InterruptedException e) {\n            e.printStackTrace();\n        }\n        return queryWithLock(keyPrefix, id, type, dbQuery, timeout, unit);\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u8ba2\u5355",children:"\u8ba2\u5355"}),"\n",(0,i.jsx)(n.h4,{id:"id\u751f\u6210\u5668",children:"id\u751f\u6210\u5668"}),"\n",(0,i.jsx)(n.p,{children:"\u4e0d\u91c7\u7528\u81ea\u589eID, \u4e3b\u8981\u662f\u81ea\u589e\u4e0d\u65b9\u4fbf\u5206\u8868, \u6539\u4e3a\u5168\u5c40\u552f\u4e00ID\u751f\u6210\u5668"}),"\n",(0,i.jsxs)(n.p,{children:["\u5982\u4f55\u5b9e\u73b0\u552f\u4e00ID? \u8fd8\u662f\u7528redis\u5b9e\u73b0\u5e76\u53d1\u4e0b\u7684\u63a7\u5236, \u4e5f\u65b9\u4fbf\u62d3\u5c55\u5230\u5206\u5e03\u5f0f, \u4f7f\u7528redis\u7684",(0,i.jsx)(n.code,{children:"incr"})]}),"\n",(0,i.jsx)(n.p,{children:"id\u8bbe\u8ba1\u4e3a \u65f6\u95f4\u6233+seqNo, \u8fd8\u6709\u5c31\u662f\u628akey\u8bbe\u7f6e\u4e3a\u65e5\u671f\u4ee5\u907f\u514d\u8d85\u51fa32\u4f4d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'package com.hmdp.utils;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.stereotype.Component;\n\nimport java.time.LocalDateTime;\nimport java.time.ZoneOffset;\nimport java.time.format.DateTimeFormatter;\n\n@Component\npublic class RedisIdWorker {\n    @Autowired\n    private StringRedisTemplate stringRedisTemplate;\n\n    private static final long BEGIN_TIMESTAMP = 1640995200L;\n    private static final long COUNT_SEQ_BITS = 32;\n\n    public long nextId(String keyPrefix){\n        LocalDateTime now = LocalDateTime.now();\n        long nowSecond = now.toEpochSecond(ZoneOffset.UTC);\n        long timeStamp = nowSecond - BEGIN_TIMESTAMP;\n        // id: sign bit + timestamp + seqNo\n        // \u4e3a\u4e86\u907f\u514d\u8d85\u8fc72^32, \u4f7f\u7528\u65e5\u4f5c\u4e3akey\u7684\u540e\u7f00\n        // \u83b7\u53d6\u65e5\u671f\n        String yyyyMMdd = now.format(DateTimeFormatter.ofPattern("yyyyMMdd")); // "20241019"\n        long seqNo = stringRedisTemplate.opsForValue().increment("incr:" + keyPrefix + ":" + yyyyMMdd);\n        return timeStamp << COUNT_SEQ_BITS | seqNo;\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.h4,{id:"\u79d2\u6740\u8d85\u5356\u95ee\u9898",children:"\u79d2\u6740\u8d85\u5356\u95ee\u9898"}),"\n",(0,i.jsx)(n.p,{children:"\u7b80\u5355\u7684getStock\u67e5\u8be2\u5e93\u5b58, \u4e0d\u8db3\u8fd4\u56de\u5728\u9ad8\u5e76\u53d1\u4e0b\u662f\u4f1a\u5bc4\u7684(jmeter \u6253\u4e00\u6253, \u6253\u4e0d\u51fa\u6765\u7684\u591a\u8bd5\u51e0\u6b21)"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://s2.loli.net/2024/10/19/Y73avpAWHoiNxnr.png",alt:"image-20241019222129520"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'    @Transactional\n    @Override\n    public Result seckillVoucher(Long voucherId) {\n        // 1. \u662f\u5426\u5b58\u5728\u8be5\u79d2\u6740\u4f18\u60e0\u5238\n        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);\n        // 2. \u662f\u5426\u5728\u79d2\u6740\u65f6\u95f4\u5185\n        if (LocalDateTime.now().isBefore(voucher.getBeginTime()) || LocalDateTime.now().isAfter(voucher.getEndTime())) {\n            return Result.fail("\u4e0d\u5728\u79d2\u6740\u65f6\u95f4\u5185");\n        }\n        // 3. \u662f\u5426\u8fd8\u6709\u5e93\u5b58\n        if (voucher.getStock() < 1) {\n            return Result.fail("\u5e93\u5b58\u4e0d\u8db3");\n        }\n        // 4. \u751f\u6210\u8ba2\u5355\n        VoucherOrder order = new VoucherOrder();\n        order.setId(redisIdWorker.nextId(SECKILL_STOCK_KEY));\n        // 5. \u6263\u51cf\u5e93\u5b58\n        seckillVoucherService.update().setSql("stock = stock - 1").eq("voucher_id", voucherId).update();\n        return Result.ok(order);\n    }\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u6837\u5355\u5355\u52a0\u4e00\u4e2a@Transactional\u53ea\u662f\u4fdd\u8bc1\u4e86\u9519\u8bef\u56de\u6eda, \u5e76\u4e0d\u80fd\u4fdd\u8bc1\u5e76\u53d1\u6b21\u5e8f(\u9664\u975e\u6bd4\u5982\u5f3a\u6307\u5b9aisolation sequential)"}),"\n",(0,i.jsx)(n.p,{children:"\u5e93\u5b58\u51cf\u8fd8\u6ca1\u6709commit"}),"\n",(0,i.jsx)(n.p,{children:"\u4e0d\u662f\u539f\u5b50\u6027\u5bfc\u81f4\u7684"}),"\n",(0,i.jsx)(n.p,{children:"\u6240\u4ee5\u8981\u52a0\u9501: \u60b2\u89c2\u9501/\u4e50\u89c2\u9501"}),"\n",(0,i.jsx)(n.p,{children:"\u4e50\u89c2\u9501: \u8ba4\u4e3a\u7ebf\u7a0b\u5b89\u5168\u95ee\u9898\u4e0d\u4e00\u5b9a\u4f1a\u53d1\u751f, \u53ea\u5728\u66f4\u65b0\u7684\u65f6\u5019\u5224\u65ad\u662f\u5426\u6709\u7ebf\u7a0b\u5df2\u7ecf\u6539\u8fc7\u4e86"}),"\n",(0,i.jsx)(n.p,{children:"\u5982\u679c\u6ca1\u6709\u4fee\u6539\u5c31\u662f\u5b89\u5168\u7684, \u6709\u53ef\u4ee5\u91cd\u8bd5\u6216\u8005\u5f02\u5e38"}),"\n",(0,i.jsx)(n.p,{children:"\u5224\u65ad\u4fee\u6539\u8fc7:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u7248\u672c\u53f7\u6cd5"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["\u5728\u8fd9\u91cc\u5c31\u662f, ",(0,i.jsx)(n.code,{children:"set stock = stock - 1 where id = 10 and stock = original_stock"})]}),"\n",(0,i.jsx)(n.p,{children:"(\u5e7f\u4e49CAS)"}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u5b9e\u9645\u4e0a\u662f\u4f9d\u8d56\u4e8e\u5e76\u53d1\u4e8b\u52a1\u65f6\u4f1a\u91cd\u65b0\u5224\u65ad\u8fd9\u4e00\u884c\u662f\u5426\u6210\u7acb"}),"\n",(0,i.jsx)(n.p,{children:"pg doc"}),"\n",(0,i.jsxs)(n.blockquote,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"UPDATE"}),", ",(0,i.jsx)(n.code,{children:"DELETE"}),", ",(0,i.jsx)(n.code,{children:"SELECT FOR UPDATE"}),", and ",(0,i.jsx)(n.code,{children:"SELECT FOR SHARE"})," commands behave the same as ",(0,i.jsx)(n.code,{children:"SELECT"})," in terms of searching for target rows: they will only find target rows that were committed as of the command start time. However, such a target row might have already been updated (or deleted or locked) by another concurrent transaction by the time it is found. In this case, the would-be updater will wait for the first updating transaction to commit or roll back (if it is still in progress). If the first updater rolls back, then its effects are negated and the second updater can proceed with updating the originally found row. If the first updater commits, the second updater will ignore the row if the first updater deleted it, otherwise it will attempt to apply its operation to the updated version of the row. The search condition of the command (the ",(0,i.jsx)(n.code,{children:"WHERE"})," clause) is re-evaluated to see if the updated version of the row still matches the search condition. If so, the second updater proceeds with its operation using the updated version of the row. In the case of ",(0,i.jsx)(n.code,{children:"SELECT FOR UPDATE"})," and ",(0,i.jsx)(n.code,{children:"SELECT FOR SHARE"}),", this means it is the updated version of the row that is locked and returned to the client.\n",(0,i.jsx)(n.code,{children:"UPDATE"})," \u3001 ",(0,i.jsx)(n.code,{children:"DELETE"})," \u3001 ",(0,i.jsx)(n.code,{children:"SELECT FOR UPDATE"}),"\u548c",(0,i.jsx)(n.code,{children:"SELECT FOR SHARE"}),"\u547d\u4ee4\u5728\u641c\u7d22\u76ee\u6807\u884c\u65b9\u9762\u4e0e",(0,i.jsx)(n.code,{children:"SELECT"}),"\u7684\u884c\u4e3a\u76f8\u540c\uff1a\u5b83\u4eec\u53ea\u4f1a\u67e5\u627e\u622a\u81f3\u547d\u4ee4\u5f00\u59cb\u65f6\u95f4\u5df2\u63d0\u4ea4\u7684\u76ee\u6807\u884c\u3002\u7136\u800c\uff0c\u8fd9\u6837\u7684\u76ee\u6807\u884c\u5728\u88ab\u53d1\u73b0\u65f6\u53ef\u80fd\u5df2\u7ecf\u88ab\u53e6\u4e00\u4e2a\u5e76\u53d1\u4e8b\u52a1\u66f4\u65b0\uff08\u6216\u5220\u9664\u6216\u9501\u5b9a\uff09\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u6f5c\u5728\u7684\u66f4\u65b0\u7a0b\u5e8f\u5c06\u7b49\u5f85\u7b2c\u4e00\u4e2a\u66f4\u65b0\u4e8b\u52a1\u63d0\u4ea4\u6216\u56de\u6eda\uff08\u5982\u679c\u4ecd\u5728\u8fdb\u884c\u4e2d\uff09\u3002\u5982\u679c\u7b2c\u4e00\u4e2a\u66f4\u65b0\u7a0b\u5e8f\u56de\u6eda\uff0c\u5219\u5176\u6548\u679c\u5c06\u88ab\u5426\u5b9a\uff0c\u7b2c\u4e8c\u4e2a\u66f4\u65b0\u7a0b\u5e8f\u53ef\u4ee5\u7ee7\u7eed\u66f4\u65b0\u6700\u521d\u627e\u5230\u7684\u884c\u3002\u5982\u679c\u7b2c\u4e00\u4e2a\u66f4\u65b0\u7a0b\u5e8f\u63d0\u4ea4\uff0c\u5219\u7b2c\u4e8c\u4e2a\u66f4\u65b0\u7a0b\u5e8f\u5c06\u5ffd\u7565\u7b2c\u4e00\u4e2a\u66f4\u65b0\u7a0b\u5e8f\u5220\u9664\u7684\u884c\uff0c\u5426\u5219\u5b83\u5c06\u5c1d\u8bd5\u5c06\u5176\u64cd\u4f5c\u5e94\u7528\u4e8e\u8be5\u884c\u7684\u66f4\u65b0\u7248\u672c\u3002\u91cd\u65b0\u8bc4\u4f30\u547d\u4ee4\u7684\u641c\u7d22\u6761\u4ef6\uff08 ",(0,i.jsx)(n.code,{children:"WHERE"}),"\u5b50\u53e5\uff09\uff0c\u4ee5\u67e5\u770b\u8be5\u884c\u7684\u66f4\u65b0\u7248\u672c\u662f\u5426\u4ecd\u7136\u4e0e\u641c\u7d22\u6761\u4ef6\u5339\u914d\u3002\u5982\u679c\u662f\uff0c\u5219\u7b2c\u4e8c\u66f4\u65b0\u5668\u4f7f\u7528\u8be5\u884c\u7684\u66f4\u65b0\u7248\u672c\u7ee7\u7eed\u5176\u64cd\u4f5c\u3002\u5728",(0,i.jsx)(n.code,{children:"SELECT FOR UPDATE"}),"\u548c",(0,i.jsx)(n.code,{children:"SELECT FOR SHARE"}),"\u7684\u60c5\u51b5\u4e0b\uff0c\u8fd9\u610f\u5473\u7740\u5b83\u662f\u9501\u5b9a\u5e76\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u884c\u7684\u66f4\u65b0\u7248\u672c\u3002"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"mysql \u9ed8\u8ba4\u662f\u66f4\u9ad8\u4e00\u6863\u7684 repeatable read"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://dev.mysql.com/doc/refman/8.4/en/innodb-consistent-read.html",children:"https://dev.mysql.com/doc/refman/8.4/en/innodb-consistent-read.html"})}),"\n",(0,i.jsx)(n.p,{children:"update\u7684set\u90e8\u5206\u672c\u8eab\u662f\u4e00\u5b9a\u6709\u539f\u5b50\u6027\u7684(\u53ea\u8981\u652f\u6301\u9501\u548c\u4e8b\u52a1, \u65e0\u975e\u662f\u9501\u6574\u8868\u8fd8\u662f\u884c\u7ea7\u9501)"}),"\n",(0,i.jsx)(n.p,{children:"\u4f46update\u9700\u8981\u4e00\u4e2aread\u7684\u8fc7\u7a0b, \u8fd9\u90e8\u5206\u5728\u4f4e\u4e00\u81f4\u6027\u4e0b\u662f\u53ef\u4ee5\u4e0d\u540c\u7684(\u4e0d\u52a0\u8bfb\u9501), \u8fd9\u4e5f\u662f\u8fd9\u91cc\u9700\u8981\u68c0\u67e5\u7684\u539f\u56e0"}),"\n",(0,i.jsx)(n.p,{children:"\u6700\u540e\u5c31\u662f\u7b80\u5355\u52a0\u4e00\u4e2a eq\u5224\u65ad"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'        boolean succcess = seckillVoucherService.update().setSql("stock = stock - 1").\n                eq("voucher_id", voucherId).\n                eq("stock", voucher.getStock()).\n                update();\n        if (!succcess){\n            return Result.fail("\u5e93\u5b58\u4e0d\u8db3");\n        }\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u8bd5\u8bd5, \u9ad8qps\u4e00\u6837\u6253\u4e0d\u52a8\u7684"}),"\n",(0,i.jsx)(n.p,{children:"\u5b9e\u9645\u4e0a\u6709\u66f4\u597d\u7684\u65b9\u6848, \u53ef\u4ee5\u89c2\u5bdf\u5230, \u5728\u8fd8\u6709\u5e93\u5b58\u7684\u65f6\u5019, \u8fd9\u6837\u7684\u5224\u65ad\u65b9\u5f0f\u4e5f\u4f1a\u5bfc\u81f4\u90e8\u5206\u8bf7\u6c42\u7531\u4e8e\u89e6\u53d1\u4e86\u51b2\u7a81\u800c\u5931\u8d25"}),"\n",(0,i.jsx)(n.p,{children:"\u6240\u4ee5\u7528"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'        boolean succcess = seckillVoucherService.update().setSql("stock = stock - 1").\n                eq("voucher_id", voucherId).\n                gt("stock", 0). // \u5927\u4e8e0\u5c31\u884c\n                update();\n'})}),"\n",(0,i.jsx)(n.h4,{id:"\u4e00\u4eba\u4e00\u5355",children:"\u4e00\u4eba\u4e00\u5355"}),"\n",(0,i.jsx)(n.p,{children:"\u4e00\u4e2a\u7528\u6237\u53ea\u80fd\u4e70\u4e00\u4e2a\u4f18\u60e0\u5238\n\u6709\u4ee5\u4e0b\u51e0\u70b9\u9700\u8981\u6ce8\u610f:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"\u8fd9\u91cc\u7528\u60b2\u89c2\u9501, \u7531\u4e8e\u662f\u4e0d\u505c\u7684insert, \u6240\u4ee5\u4e50\u89c2\u9501\u4e0d\u597d\u505a"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["\u60b2\u89c2\u9501\u7684",(0,i.jsx)(n.code,{children:"synchronized"})," \u7684key\u7528",(0,i.jsx)(n.code,{children:"userId.toString().intern()"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4e0d\u540cuser\u5e94\u8be5\u6709\u4e0d\u540c\u7684\u9501, \u800c\u4e0d\u662f\u4e00\u628a\u5927\u9501\u9000\u5316\u6210\u4e32\u884c."}),"\n",(0,i.jsx)(n.li,{children:"synchronized\u5fc5\u987b\u653e\u5728(\u4e8b\u52a1\u7684)\u5916\u9762, \u4e5f\u5c31\u662f\u8c03\u7528\u7684\u5730\u65b9\u800c\u4e0d\u662f\u88ab\u8c03\u7528\u51fd\u6570\u5185\u90e8\u9501, \u5426\u5219sychronized\u5148\u9000\u51fa,\u76f8\u5f53\u4e8e\u5148\u653e\u9501\u518dcommit"}),"\n",(0,i.jsxs)(n.li,{children:["\u5728\u9501\u7684\u65f6\u5019, \u9700\u8981\u6ce8\u610f\u5230userId\u662f\u4e00\u4e2a\u672c\u5730\u53d8\u91cf, \u4e0d\u80fd\u9501\u5728\u5bf9\u8c61\u4e0a, ",(0,i.jsx)(n.strong,{children:"\u9700\u8981\u9501\u5728\u5b57\u7b26\u4e32\u7684\u5b57\u9762\u503c\u4e0a"}),", \u6240\u4ee5\u6709",(0,i.jsx)(n.code,{children:"toString().intern()"}),", \u9501\u5728\u4e86\u5e38\u91cf\u6c60\u7684\u5bf9\u8c61\u4e0a"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\u8c03\u7528\u7684\u65f6\u5019, \u9700\u8981\u6ce8\u610f\u5230\u4e8b\u52a1\u7684\u5e95\u5c42\u5b9e\u73b0\u662f\u52a0\u4e86\u4e00\u4e2aproxy\u4ee3\u7406\u7c7b, \u5982\u679c\u76f4\u63a5",(0,i.jsx)(n.code,{children:"CheckAndSaveOrder"}),"\u662f\u5728this\u4e0a\u8c03\u7528, \u5c31\u6ca1\u6709\u4e86\u4e8b\u52a1\u7684\u6548\u679c, \u6240\u4ee5\u4f7f\u7528",(0,i.jsx)(n.code,{children:"AopContext.currentProxy()"}),"\u83b7\u53d6\u4ee3\u7406\u7c7b\u540e\u8c03\u7528."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"(\u5728\u4f9d\u8d56\u91cc\u9762\u52a0\u4e0a"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-xml",children:"        <dependency>\n            <groupId>org.aspectj</groupId>\n            <artifactId>aspectjweaver</artifactId>\n            <version>1.9.7</version>\n        </dependency>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5728Application\u5904\u52a0\u4e0a",(0,i.jsx)(n.code,{children:"@EnableAspectJAutoProxy(exposeProxy = true)"})," \u66b4\u9732\u4ee3\u7406"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'@EnableAspectJAutoProxy(exposeProxy = true)\n@MapperScan("com.hmdp.mapper")\n@SpringBootApplication\npublic class HmDianPingApplication {\n    //...\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:")"}),"\n",(0,i.jsx)(n.p,{children:"\u6700\u540e\u4ee3\u7801\u8fd9\u6837(\u5b9a\u6b7bid\u662f\u65b9\u4fbf\u6d4b\u8bd5)"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'    @Override\n    public Result seckillVoucher(Long voucherId) {\n        // 1. \u662f\u5426\u5b58\u5728\u8be5\u79d2\u6740\u4f18\u60e0\u5238\n        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);\n        // 2. \u662f\u5426\u5728\u79d2\u6740\u65f6\u95f4\u5185\n        if (LocalDateTime.now().isBefore(voucher.getBeginTime()) || LocalDateTime.now().isAfter(voucher.getEndTime())) {\n            return Result.fail("\u4e0d\u5728\u79d2\u6740\u65f6\u95f4\u5185");\n        }\n        // 3. \u662f\u5426\u8fd8\u6709\u5e93\u5b58\n        if (voucher.getStock() < 1) {\n            return Result.fail("\u5e93\u5b58\u4e0d\u8db3");\n        }\n        // Long userId = UserHolder.getUser().getId();\n        Long userId = 1L;\n        VoucherOrder order;\n        synchronized (userId.toString().intern()) {\n            // get proxy object\n            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n            order = proxy.CheckAndSaveOrder(voucherId);\n            if (order == null) {\n                return Result.fail("\u60a8\u5df2\u7ecf\u62a2\u8d2d\u8fc7\u4e86");\n            }\n        }\n\n        // 5. \u6263\u51cf\u5e93\u5b58\n        boolean succcess = seckillVoucherService.update().setSql("stock = stock - 1").\n                eq("voucher_id", voucherId).\n                gt("stock", 0).\n                update();\n        if (!succcess) {\n            return Result.fail("\u5e93\u5b58\u4e0d\u8db3");\n        }\n        return Result.ok(order);\n    }\n\n    @Transactional\n    @Override\n    public VoucherOrder CheckAndSaveOrder(Long voucherId){\n        // \u4e00\u4eba\u4e00\u5355\u6821\u9a8c\n//        boolean exist =super.lambdaQuery().eq(VoucherOrder::getUserId, UserHolder.getUser().getId()).\n//                eq(VoucherOrder::getVoucherId, voucherId).count() > 0;\n        boolean exist =super.lambdaQuery().eq(VoucherOrder::getUserId, 1).\n                eq(VoucherOrder::getVoucherId, voucherId).count() > 0;\n        if (exist) {\n            return null;\n        }\n        // 4. \u751f\u6210\u8ba2\u5355\n        VoucherOrder order = new VoucherOrder();\n        order.setId(redisIdWorker.nextId(SECKILL_STOCK_KEY));\n        order.setVoucherId(voucherId);\n        order.setCreateTime(LocalDateTime.now());\n        order.setUpdateTime(LocalDateTime.now());\n        order.setStatus(1);\n        // Long userId = UserHolder.getUser().getId();\n        Long userId = 1L;\n        order.setUserId(userId);\n        boolean success = super.save(order);\n        if (!success) {\n            return null;\n        }\n        return order;\n  \n    }\n'})}),"\n",(0,i.jsx)(n.h4,{id:"\u96c6\u7fa4\u5b89\u5168\u95ee\u9898",children:"\u96c6\u7fa4\u5b89\u5168\u95ee\u9898"}),"\n",(0,i.jsx)(n.p,{children:"\u52a0\u9501\u53ef\u4ee5\u89e3\u51b3\u5355\u673a\u4e00\u4eba\u4e00\u5355, \u4f46\u4e0d\u80fd\u89e3\u51b3\u96c6\u7fa4\u4e00\u4eba\u4e00\u5355"}),"\n",(0,i.jsx)(n.p,{children:"\u5982\u4e0b\u5c31\u5bc4"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-nginx",children:"    upstream backend {\n        server 127.0.0.1:8081 max_fails=5 fail_timeout=10s weight=1;\n        server 127.0.0.1:8082 max_fails=5 fail_timeout=10s weight=1;\n    }\n"})}),"\n",(0,i.jsx)(n.p,{children:"(\u53ef\u4ee5copy\u4e00\u4e2aapplication\u518d\u542f\u52a8(vmoptions:-Dserver.port=8082\u6539\u7aef\u53e3)\u5c31\u8ba9idea\u53c8\u542f\u52a8\u4e86\u4e00\u4e2atomcat)"}),"\n",(0,i.jsx)(n.p,{children:"\u7ecf\u5178\u628a\u52a0\u9501\u903b\u8f91\u4e22\u5230redis"}),"\n",(0,i.jsx)(n.h4,{id:"\u5206\u5e03\u5f0f\u9501",children:"\u5206\u5e03\u5f0f\u9501"}),"\n",(0,i.jsx)(n.p,{children:"synchronized\u8c03\u7528\u672c\u5730JVM\u7684\u9501\u76d1\u89c6\u5668"}),"\n",(0,i.jsx)(n.p,{children:"\u5206\u5e03\u5f0f\u9501\uff1a\u591a\u8fdb\u7a0b\u53ef\u89c1\u4e14\u4e92\u65a5"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u9ad8\u53ef\u7528"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u9ad8\u6027\u80fd"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u5b89\u5168\u6027"}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"\u53ef\u91cd\u5165\uff1f\u516c\u5e73\uff1f..."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u5206\u5e03\u5f0f\u9501\uff1a"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{}),(0,i.jsx)(n.th,{children:"mysql"}),(0,i.jsx)(n.th,{children:"redis"}),(0,i.jsx)(n.th,{children:"zookeeper"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u4e92\u65a5"}),(0,i.jsx)(n.td,{children:"mysql\u672c\u8eab\u7684\u4e92\u65a5\u9501"}),(0,i.jsx)(n.td,{children:"setnx\u8fd9\u6837\u7684\u4e92\u65a5\u547d\u4ee4"}),(0,i.jsx)(n.td,{children:"\u8282\u70b9\u552f\u4e00\u6027\u548c\u6709\u5e8f\u6027\u5b9e\u73b0\u4e92\u65a5"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u9ad8\u53ef\u7528"}),(0,i.jsx)(n.td,{children:"\u597d"}),(0,i.jsx)(n.td,{children:"\u597d"}),(0,i.jsx)(n.td,{children:"\u597d"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u9ad8\u6027\u80fd"}),(0,i.jsx)(n.td,{children:"\u4e00\u822c"}),(0,i.jsx)(n.td,{children:"\u597d"}),(0,i.jsx)(n.td,{children:"\u4e00\u822c\uff08\u5f3a\u4e00\u81f4\u6027\uff09"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u5b89\u5168\u6027"}),(0,i.jsx)(n.td,{children:"\u65ad\u5f00\u8fde\u63a5\u81ea\u52a8\u91ca\u653e"}),(0,i.jsx)(n.td,{children:"\u9700\u8981\u624b\u52a8\u5220key\uff0c\u4f46\u53ef\u4ee5\u5229\u7528\u8fc7\u671f\u65f6\u95f4"}),(0,i.jsx)(n.td,{children:"\u65ad\u5f00\u8fde\u63a5\u81ea\u52a8\u91ca\u653e"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"redis setnx: set if not exists"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-redis",children:"setnx key value\nexpire key 10\ndel key\n"})}),"\n",(0,i.jsx)(n.p,{children:"setnx\u548cexpire\u4e2d\u95f4\u5b95\u673a\uff1f-> \u539f\u5b50\u6027"}),"\n",(0,i.jsx)(n.p,{children:"\u5408\u5e76\u6210\u4e00\u6761\u547d\u4ee4"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-redis",children:"SET lock thread1 EX 10 NX\ndel lock\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u4e00\u4e2a\u5927\u6982\u7684\u4ee3\u7801\u50cf\u8fd9\u6837"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public class RedisDistributedLock implements ILock{\n    @Resource\n    private StringRedisTemplate redisTemplate;\n    private static final String LOCK_PREFIX = "lock:";\n\n    private static String getKey(String name){\n        return LOCK_PREFIX + name;\n    }\n\n    @Override\n    public boolean tryLock(String name, long Timeout) {\n        String key = getKey(name);\n        long value = Thread.currentThread().getId();\n        Boolean success = redisTemplate.opsForValue().setIfAbsent(key, String.valueOf(value), Timeout, TimeUnit.SECONDS);\n        return Boolean.TRUE.equals(success); // success != null && success\n    }\n\n    @Override\n    public void unlock(String name) {\n        redisTemplate.delete(getKey(name));\n    }\n}\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u5b58\u5728\u7684\u95ee\u9898:"}),"\n",(0,i.jsx)(n.p,{children:"\u4e1a\u52a1A\u963b\u585e\u8d85\u8fc7\u8d85\u65f6\u65f6\u95f4->\u53e6\u4e00\u4e2a\u7ebf\u7a0bB\u62ff\u9501->\u963b\u585e\u7ebf\u7a0bA\u7ed3\u675f\u963b\u585e,\u628a\u9501\u91ca\u653e->\u5bc4\uff0c\u8fd9\u65f6\u5019C\u53ef\u4ee5\u62a2B\u9501\u4e86"}),"\n",(0,i.jsx)(n.p,{children:"\u89e3\u51b3\u65b9\u6848\uff0c\u91ca\u653e\u524d\u68c0\u67e5\u8fd9\u9501\u8fd8\u662f\u4e0d\u662f\u81ea\u5df1\u7684"}),"\n",(0,i.jsx)(n.p,{children:"\u83b7\u53d6\u9501->\u4e1a\u52a1\u8d85\u65f6\u6216\u8005\u670d\u52a1\u5b95\u673a, \u81ea\u52a8\u91ca\u653e\u9501/\u6210\u529f\u6267\u884c\u4e1a\u52a1,\u5224\u65ad\u9501\u7684\u6301\u6709\u8005\u8fd8\u662f\u5426\u662f\u81ea\u5df1,\u662f\u81ea\u5df1\u624b\u52a8\u91ca\u653e\u9501"}),"\n",(0,i.jsx)(n.p,{children:"\u9501\u6807\u8bc6-> UUID(as jvm id) + \u7ebf\u7a0bid"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public class RedisDistributedLock implements ILock {\n    @Resource\n    private StringRedisTemplate redisTemplate;\n    private static final String LOCK_PREFIX = "lock:";\n    // JVM\u552f\u4e00\u6807\u8bc6\n    private static final String JVMPrefix = UUID.randomUUID().toString(true);\n\n    private static String getKey(String name){\n        return LOCK_PREFIX + name;\n    }\n    private static String getUniqueValue(){\n        return JVMPrefix + "-" + Thread.currentThread().getId();\n    }\n    @Override\n    public boolean tryLock(String name, long Timeout) {\n        String key = getKey(name);\n        String value = getUniqueValue();\n        Boolean success = redisTemplate.opsForValue().setIfAbsent(key, value, Timeout, TimeUnit.SECONDS);\n        return Boolean.TRUE.equals(success); // success != null && success\n    }\n\n    @Override\n    public void unlock(String name) {\n        String whoTakes = redisTemplate.opsForValue().get(getKey(name));\n        if (getUniqueValue().equals(whoTakes)){\n            redisTemplate.delete(getKey(name));\n        }\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u4f46\u8fd8\u6709\u95ee\u9898"}),"\n",(0,i.jsx)(n.p,{children:"\u5728\u5224\u65ad\u5b8c\u7684\u65f6\u5019\uff0c\u89e6\u53d1\u4e86GC\u963b\u585e\uff0c\u7136\u540e\u8d85\u65f6\u91ca\u653e\u4e86\uff0c\u7136\u540e\u5176\u4ed6\u7ebf\u7a0b\u62ff\u8d70\uff0c\u7136\u540e\u5c31\u662f\u8bef\u5220"}),"\n",(0,i.jsx)(n.p,{children:"\u63d0\u4f9b\u539f\u5b50\u6027: redis \u7684 lua \u811a\u672c\u6a21\u5f0f"}),"\n",(0,i.jsx)(n.p,{children:"\u591a\u6761redis\u547d\u4ee4\u5199\u5230\u4e00\u884clua\u91cc\u9762\uff0c\u4ece\u800c\u8ba9redis\u4fdd\u8bc1\u539f\u5b50\u6027"}),"\n",(0,i.jsxs)(n.p,{children:["redis\u7684",(0,i.jsx)(n.code,{children:"EVAL"}),"\u547d\u4ee4\u6267\u884c\u811a\u672c"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"help @scripting"})}),"\n",(0,i.jsx)(n.p,{children:"\u4f8b\u5982"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"EVAL \"return redis.call('set', KEYS[1], ARGV[1])\" 1 name Rose"})}),"\n",(0,i.jsx)(n.p,{children:"1\uff1a\u67091\u4e2akey\u7c7b\u578b\u53c2\u6570, \u653e\u5165KEYS[1]"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-lua",children:"local key = KEYS[1]\nlocal me = ARGV[1]\n\n-- \u83b7\u53d6\u9501\u7684\u6301\u6709\u8005\nlocal whoTakes = redis.call('get', key)\nif(whoTakes == me) then\n    return redis.call('del', key)\nend\nreturn 0\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6700\u540e\u8fd9\u6837\u5c31\u53ef\u4ee5\u5f15\u5165\u4e86"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'private static final DefaultRedisScript<Long> UNLOCK_SCRIPT;\nstatic {\n    UNLOCK_SCRIPT = new DefaultRedisScript<>();\n    UNLOCK_SCRIPT.setResultType(Long.class);\n    UNLOCK_SCRIPT.setLocation(new ClassPathResource("unlock.lua")); // classpath:unlock.lua\n    // classpath, \u7c7b\u8def\u5f84, \u9ed8\u8ba4\u662f\u5f53\u524d\u76ee\u5f55\uff0c\u4f46\u662fspringboot + maven\u4f1a\u5c06resources\uff0c\u4f9d\u8d56\u7b49\u76ee\u5f55\u81ea\u52a8\u52a0\u5165classpath\u7b80\u5316\u914d\u7f6e\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public void unlock(String name) {\n        String whoTakes = redisTemplate.opsForValue().get(getKey(name));\n//        if (getUniqueValue().equals(whoTakes)){\n//            redisTemplate.delete(getKey(name));\n//        }\n        // \u4e3a\u4e86\u907f\u514d\u8bef\u5220\uff0c\u4fdd\u8bc1GC\u6216\u8005\u5176\u4ed6java\u5185\u90e8\u5835\u585e\u4e0b\u7684\u539f\u5b50\u6027\uff0c\u4f7f\u7528lua\u811a\u672c\n        redisTemplate.execute(UNLOCK_SCRIPT, Collections.singletonList(getKey(name)), getUniqueValue());\n    }\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u4e2a\u7b80\u5355\u7684\u5206\u5e03\u5f0f\u9501\u5269\u4e0b\u7684\u95ee\u9898\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4e0d\u53ef\u91cd\u5165->\u6539\u9020\u811a\u672c"}),"\n",(0,i.jsx)(n.li,{children:"\u4e0d\u53ef\u91cd\u8bd5"}),"\n",(0,i.jsx)(n.li,{children:"\u8d85\u65f6\u91ca\u653e"}),"\n",(0,i.jsx)(n.li,{children:"\u4e3b\u4ece\u4e00\u81f4 \u4e3b\u8282\u70b9\u83b7\u53d6\u9501\u5c1a\u672a\u540c\u6b65\u7ed9\u4ece\u8282\u70b9\uff0c\u7136\u540e\u4e3b\u8282\u70b9\u6302\u4e86"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u4f7f\u7528\u6210\u719f\u6846\u67b6 Redisson"}),"\n",(0,i.jsx)(n.p,{children:"\u5404\u79cd\u5206\u5e03\u5f0f\u9501\u5b9e\u73b0\uff1a"}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u91cd\u5165\u9501\u3001\u516c\u5e73\u9501\u3001\u8054\u9501\u3001\u8bfb\u5199\u9501\u3001\u53ef\u8fc7\u671f\u4fe1\u53f7\u91cf\u3001..."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'package com.hmdp.config;\n\nimport org.redisson.Redisson;\nimport org.redisson.api.RedissonClient;\nimport org.redisson.config.Config;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\n\n@Configuration\npublic class RedissonConfig {\n    @Value("${spring.redis.host}")\n    private String host;\n\n    @Value("${spring.redis.port}")\n    private String port;\n\n    @Value("${spring.redis.password}")\n    private String password;\n    @Bean\n    public RedissonClient redissonClient(){\n        Config config = new Config();\n        String address = "redis://" + host + ":" + port;\n        config.useSingleServer().setAddress(address).setPassword(password);\n        return Redisson.create(config);\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"tryLock \u5c1d\u8bd5\u83b7\u53d6\u9501\u95f4\u9694\u65f6\u95f4\uff0c\u81ea\u52a8\u91ca\u653e\u65f6\u95f4\uff0c \u65f6\u95f4\u5355\u4f4d"}),"\n",(0,i.jsx)(n.p,{children:"\u914d\u7f6e\u5b8c\u4e4b\u540e\u53ef\u4ee5\u7b80\u5355\u7684demo\u6d4b\u8bd5"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'import com.hmdp.HmDianPingApplication;\nimport org.junit.Test;\nimport org.junit.runner.RunWith;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\n\nimport javax.annotation.Resource;\nimport java.util.concurrent.TimeUnit;\nimport org.springframework.boot.test.context.SpringBootTest;\nimport org.springframework.test.context.junit4.SpringRunner;\n\n@RunWith(SpringRunner.class)\n@SpringBootTest(classes = HmDianPingApplication.class)\npublic class RedissonDemoTest {\n    @Resource\n    private RedissonClient redissonClient;\n\n    @Test\n    public void TryLockTest() throws InterruptedException {\n        RLock lock = redissonClient.getLock("redisson:anylock");\n        // \u6ce8\u610f\u8fd9\u91cc\u7684key\u4e0d\u80fd\u548credisTemplate\u7684key\u91cd\u590d\uff0c\u5426\u5219\u5f71\u54cd\u7c7b\u578b\u5224\u65ad\u4f1a\u5bc4\n        boolean isLock = lock.tryLock(1, 10, TimeUnit.SECONDS);\n        if(isLock){\n            try {\n                System.out.println("Get lock success");\n            } finally {\n                lock.unlock();\n            }\n        }\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u4e4b\u524d\u7684api\u5927\u6982\u4fee\u6539\u6210"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'da//    @Resource\n//    private RedisDistributedLock lock;\n    @Resource\n    private RedissonClient redissonClient;\n\n    @Override\n    public Result seckillVoucher(Long voucherId) {\n        // 1. \u662f\u5426\u5b58\u5728\u8be5\u79d2\u6740\u4f18\u60e0\u5238\n        SeckillVoucher voucher = seckillVoucherService.getById(voucherId);\n        // 2. \u662f\u5426\u5728\u79d2\u6740\u65f6\u95f4\u5185\n        if (LocalDateTime.now().isBefore(voucher.getBeginTime()) || LocalDateTime.now().isAfter(voucher.getEndTime())) {\n            return Result.fail("\u4e0d\u5728\u79d2\u6740\u65f6\u95f4\u5185");\n        }\n        // 3. \u662f\u5426\u8fd8\u6709\u5e93\u5b58\n        if (voucher.getStock() < 1) {\n            return Result.fail("\u5e93\u5b58\u4e0d\u8db3");\n        }\n        // Long userId = UserHolder.getUser().getId();\n        Long userId = 1L;\n        VoucherOrder order;\n//        synchronized (userId.toString().intern()) {\n//            // get proxy object\n//            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n//            order = proxy.CheckAndSaveOrder(voucherId);\n//            if (order == null) {\n//                return Result.fail("\u60a8\u5df2\u7ecf\u62a2\u8d2d\u8fc7\u4e86");\n//            }\n//        }\n        RLock lock = redissonClient.getLock("redisson:order:lock:" + userId);\n        boolean success = false;\n        try{\n            success = lock.tryLock(1, 10, TimeUnit.SECONDS);\n        } catch (InterruptedException e) {\n            if(lock.isHeldByCurrentThread()){\n                lock.unlock();\n            }\n            throw new RuntimeException(e);\n        }\n\n        if(!success){\n            // \u6b64\u7528\u6237\u5e76\u53d1\u4e0b\u5355\n            return Result.fail("\u60a8\u5df2\u7ecf\u62a2\u8d2d\u8fc7\u4e86");\n        }\n        // \u62ff\u5230\u9501\n        try{\n            IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n            order = proxy.CheckAndSaveOrder(voucherId);\n            if (order == null) {\n                return Result.fail("\u60a8\u5df2\u7ecf\u62a2\u8d2d\u8fc7\u4e86");\n            }\n            // 5. \u6263\u51cf\u5e93\u5b58\n            success = seckillVoucherService.update().setSql("stock = stock - 1").\n                    eq("voucher_id", voucherId).\n                    gt("stock", 0).\n                    update();\n        } finally {\n            lock.unlock();\n        }\n\n        if (!success) {\n            return Result.fail("\u5e93\u5b58\u4e0d\u8db3");\n        }\n        return Result.ok(order);\n    }\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u6253\u4e00\u6253\u53d1\u73b0\u786e\u5b9eok"}),"\n",(0,i.jsx)(n.p,{children:"redisson\u662f\u7b26\u5408java\u7ebf\u7a0b\u89c4\u8303\u7684\uff0c\u53ea\u6709\u62ff\u9501\u7684\u7ebf\u7a0b\u53ef\u4ee5\u653e\u9501"}),"\n",(0,i.jsx)(n.p,{children:"redisson\u53ef\u91cd\u5165\u9501\u539f\u7406"}),"\n",(0,i.jsx)(n.p,{children:"redis\u7684hset, hset\u7684field\u662fthreadId, value\u662f\u8ba1\u6570\u503c"}),"\n",(0,i.jsxs)(n.p,{children:["\u4e4b\u540elua\u811a\u672c, \u62ff\u9501\u653e\u9501\u4fee\u6539\u8ba1\u6570\u5373\u53ef(",(0,i.jsx)(n.code,{children:"hset, hexists, hincrby"}),")"]}),"\n",(0,i.jsx)(n.p,{children:"redisson\u7684lock\u6709\u7c7b\u4f3cfutex\u7684\u8bbe\u8ba1\uff0c\u5229\u7528\u4e86redis\u7684pub/sub\u548cfuture(\u5e95\u5c42\u7684park/unpark/\u56de\u8c03)\u673a\u5236\u8fbe\u5230\u8ba9\u51facpu\u800c\u4e0d\u662f\u81ea\u65cb\u7684\u673a\u5236\uff08\u5728\u7b49\u5f85\u9501\u7684\u65f6\u5019\u8ba2\u9605\u89e3\u9501\u4e8b\u4ef6\uff0c\u7136\u540eawait\u8ba9\u51fa\uff09"}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd8\u6709\u4e00\u4e2awatch dog\u673a\u5236, \u5982\u679c\u6307\u5b9a",(0,i.jsx)(n.code,{children:"leaseTime"}),"\u4e3a-1,\u5219\u8ba9redisson\u542f\u52a8\u4e00\u4e2a\u540e\u53f0\u7ebf\u7a0b,\u5728\u8981\u8fc7\u671f\u7684\u65f6\u5019\u81ea\u52a8\u7eed\u7ea6\u5ef6\u957f\u9501\u7684expire\u65f6\u95f4\uff08\u6bcf30s\uff09"]}),"\n",(0,i.jsx)(n.p,{children:"\u6ca1\u6709\u89e3\u51b3\u7684\u95ee\u9898\u4e5f\u5c31\u662f\u4e3b\u4ece\u590d\u5236\u4e3b\u5b95\u673a\u5bfc\u81f4\u7684\u4ece\u91cd\u65b0\u9009\u4e3e\u4e3b\uff0c\u5bfc\u81f4\u4e3b\u9501\u4fe1\u606f\u4e22\u5931\uff0c\u4ece\u62ff\u9501\u7684\u95ee\u9898"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{src:"https://s2.loli.net/2024/10/27/3h8sOXdqTtbZQcm.png",alt:"image-20241027002737472"})}),"\n",(0,i.jsx)(n.p,{children:"\u4e3b\u4ece\u540c\u6b65\u95ee\u9898\u600e\u4e48\u89e3\u51b3\uff1f"}),"\n",(0,i.jsx)(n.p,{children:"\u4e0d\u8981\u4e3b\u4ece, \u5168\u90e8\u53d8\u6210redis node\uff08node\u53ef\u4ee5\u6709slave\uff09"}),"\n",(0,i.jsxs)(n.p,{children:["\u83b7\u53d6\u9501\u53d8\u6210\u9700\u8981\u5728",(0,i.jsx)(n.strong,{children:"\u5168\u90e8\u7684"}),"redis node\u4e0a\u62ff\u5230\u9501\u624d\u884c->\u53ea\u8981\u6709\u4e00\u4e2anode\u5b58\u6d3b\uff0c\u5c31\u53ef\u4ee5\u907f\u514dslave\u9519\u8bef\u62ff\u5230\u9501"]}),"\n",(0,i.jsx)(n.p,{children:"\u653e\u9501\u7684\u65f6\u5019\u7b80\u5355\u80fd\u653e\u90fd\u653e\uff08\u8349\uff09\uff0c\u653e\u4e0d\u4e86\uff08\u6bd4\u5982\u6302\u4e86\uff09\u8981\u4e48\u4f9d\u8d56\u8d85\u65f6\uff0c\u8981\u4e48\u4f9d\u8d56\u91cd\u8bd5"}),"\n",(0,i.jsx)(n.p,{children:"\u603b\u4e4b\u4e0d\u8d1f\u8d23\u8282\u70b9\u6302\u4e86\u6216\u8005\u5fc3\u8df3\u65b9\u6848\u4e4b\u7c7b\uff0c\u5c31\u662fredis\u5df2\u6709\u7684\u4e3b\u4ece\u673a\u5236\uff0c\u4e00\u4e2a\u8282\u70b9\u6302\u4e86\u5c31\u7b49redis\u7ed9\u4ed6\u5207\u6362\u5230slave, \u624d\u80fd\u518d\u6b21\u6210\u529f\u62ff\u9501"}),"\n",(0,i.jsx)(n.p,{children:"\u8d85\u65f6\u662f\u6709\u7528\u7684\uff08\u96fe"}),"\n",(0,i.jsx)(n.p,{children:"\u62ff\u9501\u662f\u539f\u5b50\u7684, \u5982\u679c\u6709\u62ff\u4e0d\u5230\u4f1a\u56de\u6eda"}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u53ebmultilock"}),"\n",(0,i.jsx)(n.p,{children:"\u7f3a\u9677\uff1a\u8fd0\u7ef4\u6210\u672c\u9ad8"}),"\n",(0,i.jsx)(n.p,{children:"\u8fd0\u7ef4\u6210\u672c\u548c\u4e3b\u8282\u70b9\u5b95\u673a\u7684\u60c5\u51b5\u4e0b\u5206\u5e03\u5f0f\u9501\u6b63\u5e38\u8fd0\u884c\u8fd9\u4e2aedge case\u7684trade off"}),"\n",(0,i.jsx)(n.h3,{id:"\u4f18\u5316\u79d2\u6740",children:"\u4f18\u5316\u79d2\u6740"}),"\n",(0,i.jsx)(n.p,{children:"jmetor\u6d4bQPS\uff0c\u51c6\u5907\u597dtoken\u6587\u4ef6\uff0c\u5728\u8bf7\u6c42\u91cc\u9762\u5f15\u7528\u53d8\u91cf\u540e\u770b\u805a\u5408\u62a5\u544a"}),"\n",(0,i.jsx)(n.p,{children:"\u73b0\u5728\uff1adb\u5bc6\u96c6+\u5206\u5e03\u5f0f\u9501\uff0c\u6027\u80fd\u5dee"}),"\n",(0,i.jsx)(n.p,{children:"\u6539\u9020\u4e3a\u5f02\u6b65\u64cd\u4f5c\uff0cqueue, db\u4e0d\u8981\u5835\u5728\u8fd9\u91cc"}),"\n",(0,i.jsx)(n.p,{children:"\u67e5\u8be2->\u5224\u65ad\u5e93\u5b58->\u67e5\u8be2\u8ba2\u5355->\u6821\u9a8c\u4e00\u4eba\u4e00\u5355->\u51cf\u5e93\u5b58->\u521b\u5efa\u8ba2\u5355"}),"\n",(0,i.jsx)(n.p,{children:"\u5224\u65ad\u5e93\u5b58&\u6821\u9a8c \u653e\u5728redis? \u7ed3\u679c\u5b58\u5230\u963b\u585e\u961f\u5217"}),"\n",(0,i.jsx)(n.p,{children:"\u51cf\u5e93\u5b58\u548c\u521b\u5efa\u8ba2\u5355\u662fupdate\u62ff\u9501\u4e32\u884c\u5199\u7684->\u4ea4\u7ed9\u540e\u53f0\u7ebf\u7a0b\u5f02\u6b65\u5237, \u751a\u81f3\u6279\u91cf\u5199"}),"\n",(0,i.jsx)(n.p,{children:"\u540c\u65f6redis\u5185\u90e8\u4e00\u6bb5\u903b\u8f91\u4e5f\u9700\u8981\u662f\u539f\u5b50\u7684->lua\u811a\u672c"}),"\n",(0,i.jsx)(n.p,{children:"lua\u811a\u672c\u903b\u8f91"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-lua",children:"--- param: userId, voucherId\n--- return: result(int): 0 success, 1 \u5e93\u5b58\u4e0d\u8db3, 2 \u4e00\u4eba\u4e00\u5355\n--- \u6ce8\u610forderid\u662fjava\u91cc\u9762\u7684\u5168\u5c40id\u751f\u6210\u5668\uff08redisIdWorker\uff09\u751f\u6210\u7684, \u4e0d\u9700\u8981lua\u7ba1\n--- \u5224\u65ad\u65f6\u95f4\u53ef\u4ee5\u653e\u5728\u811a\u672c\u91cc\u9762\uff0c\u4f46\u6ca1\u6709\u5fc5\u8981\uff0c\u4e0d\u7ba1\u5728\u91cc\u9762\u8fd8\u662f\u5916\u9762\u90fd\u9700\u8981\u5230\u65f6\u6e05\u6389redis, \u4e0d\u5982redis\u76f4\u63a5\u628a\u76f8\u5173key\u7684\u8d85\u65f6\u8bbe\u7f6e\u6210\u65f6\u95f4\uff08\u6216\u8005\u8d77\u989d\u5916\u7684\u5b9a\u65f6\u4efb\u52a1\uff09\uff0c\u7b80\u5316\u811a\u672c\u903b\u8f91\nlocal userId = ARGV[1]\nlocal voucherId = ARGV[2]\n\nlocal stockKey = \"seckill:stock:\" .. voucherId\nlocal orderKey = \"seckill:order:\" .. voucherId --- order set(\u8bb0\u5f55\u4e70\u8fc7\u7684userId\u96c6\u5408)\n\n--- \u5224\u65ad\u5e93\u5b58\nif(tonumber(redis.call('get', stockKey) <= 0)) then\n     return 1\nend\n\n--- \u5224\u65ad\u7528\u6237\u662f\u5426\u4e0b\u8fc7\u5355\nif(tonumber(redis.call('sismember', orderKey, userId)) == 1) then\n     return 2\nend\n\n--- \u6210\u529f\u4e0b\u5355\uff0c\u51cf\u5c11\u5e93\u5b58,\u8bb0\u5f55\u5df2\u4e0b\u5355\nredis.call('incrby', stockKey, -1)\nredis.call('sadd', orderKey, userId)\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u6574\u4e2a\u5f02\u6b65\u7684\u4ee3\u7801\u6d41\u7a0b"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u6ce8\u5165\u4e00\u4e2a\u7ebf\u7a0b\u6c60\uff0c\u4f8b\u5982\u5355\u4e2a\u7ebf\u7a0b\u7684"}),"\n",(0,i.jsxs)(n.li,{children:["\u521b\u5efa\u4e00\u4e2a\u4efb\u52a1\uff0c\u65e0\u9650\u5730\u4ece\u963b\u585e\u961f\u5217\u4e4b\u4e2d\u8bfb\u53d6\u4fe1\u606f\uff0c\u5e76\u8fdb\u884c\u5904\u7406\u3002\u4f7f\u7528",(0,i.jsx)(n.code,{children:"@PostConstruct"}),"\u6ce8\u89e3\uff0c\u5728\u521d\u59cb\u5316\u7ed3\u675f\u7684\u65f6\u5019\uff0c\u5c06\u8fd9\u4e2a\u4efb\u52a1\u63d0\u4ea4\u7ed9\u7ebf\u7a0b\u6c60"]}),"\n",(0,i.jsx)(n.li,{children:"\u5728\u4efb\u52a1\u91cc\u9762\u9700\u8981\u6ce8\u610f\uff0c\u6b64\u65f6userId\u548cproxy\u90fd\u4e0d\u80fd\u518d\u4f7f\u7528\uff08\u90fd\u662f\u4ecethreadlocal\u91cc\u9762\u62ff\u7684\uff09\uff0cproxy\u63d0\u524d\u4fdd\u5b58\u5728\u5916\u9762\uff0cuserId\u4ece\u4f20\u5165\u7684VoucherOrder\u5bf9\u8c61\u62ff"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u6700\u540e\u7684\u4ee3\u7801\u793a\u4f8b"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'package com.hmdp.service.impl;\n\nimport com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;\nimport com.hmdp.dto.Result;\nimport com.hmdp.entity.SeckillVoucher;\nimport com.hmdp.entity.Voucher;\nimport com.hmdp.entity.VoucherOrder;\nimport com.hmdp.mapper.VoucherOrderMapper;\nimport com.hmdp.service.ISeckillVoucherService;\nimport com.hmdp.service.IUserService;\nimport com.hmdp.service.IVoucherOrderService;\nimport com.hmdp.utils.CacheClient;\nimport com.hmdp.utils.RedisDistributedLock;\nimport com.hmdp.utils.RedisIdWorker;\nimport com.hmdp.utils.UserHolder;\nimport lombok.extern.slf4j.Slf4j;\nimport org.redisson.api.RLock;\nimport org.redisson.api.RedissonClient;\nimport org.springframework.aop.framework.AopContext;\nimport org.springframework.core.io.ClassPathResource;\nimport org.springframework.data.redis.core.StringRedisTemplate;\nimport org.springframework.data.redis.core.script.DefaultRedisScript;\nimport org.springframework.stereotype.Service;\nimport org.springframework.transaction.annotation.Transactional;\n\nimport javax.annotation.PostConstruct;\nimport javax.annotation.Resource;\nimport java.time.LocalDateTime;\nimport java.util.Collections;\nimport java.util.Optional;\nimport java.util.concurrent.*;\n\nimport static com.hmdp.utils.RedisConstants.SECKILL_STOCK_KEY;\nimport static com.hmdp.utils.RedisConstants.SECKILL_VOUCHER_KEY;\n\n\n@Slf4j\n@Service\npublic class VoucherOrderServiceOptImpl extends ServiceImpl<VoucherOrderMapper, VoucherOrder> implements IVoucherOrderService {\n    @Resource\n    private ISeckillVoucherService seckillVoucherService;\n    @Resource\n    private RedisIdWorker redisIdWorker;\n    @Resource\n    private RedissonClient redissonClient;\n    @Resource\n    private CacheClient cacheClient;\n    @Resource\n    private StringRedisTemplate stringRedisTemplate;\n\n    private static ArrayBlockingQueue<VoucherOrder> orderQueue;\n    private static ExecutorService orderExecutor;\n    static {\n        orderQueue = new ArrayBlockingQueue<VoucherOrder>(1024 * 1024);\n        orderExecutor = Executors.newSingleThreadExecutor();\n    }\n    private static DefaultRedisScript<Long> seckillScript;\n    static {\n        seckillScript = new DefaultRedisScript<>();\n        seckillScript.setResultType(Long.class);\n        seckillScript.setLocation(new ClassPathResource("classpath:seckill.lua"));\n    }\n    private final IVoucherOrderService proxy = (IVoucherOrderService) AopContext.currentProxy();\n    private final Runnable orderTask = ()->{\n        while(true){\n            try {\n                VoucherOrder order = orderQueue.take(); // \u5f53\u961f\u5217\u4e3a\u7a7a\u65f6\uff0c\u4f1a\u963b\u585e\n                handleOrder(order);\n            } catch (Exception e) {\n                log.error("\u4e0b\u5355\u5f02\u5e38", e);\n            }\n        }\n    };\n    @PostConstruct\n    public void init(){\n        orderExecutor.submit(orderTask);\n    }\n\n    private void handleOrder(VoucherOrder order){\n        Long userId = order.getUserId();\n        RLock lock = redissonClient.getLock("redisson:order:lock:" + userId);\n        boolean success = false;\n        try{\n            success = lock.tryLock(1, 10, TimeUnit.SECONDS);\n        } catch (InterruptedException e) {\n            log.error("\u83b7\u53d6\u9501\u5f02\u5e38", e);\n        }\n\n        if(!success){\n            // \u6b64\u7528\u6237\u5e76\u53d1\u4e0b\u5355, \u8fd9\u91cc\u56e0\u4e3aredis\u5df2\u7ecf\u662f\u539f\u5b50\u6027\u811a\u672c\uff0c\u539f\u5219\u4e0a\u4e0d\u5e94\u8be5\u51fa\u73b0\u8fd9\u79cd\u60c5\u51b5\n            log.error(userId + "\u5df2\u7ecf\u62a2\u8d2d\u8fc7\u4e86");\n        }\n        // \u62ff\u5230\u9501\n        try{\n            success = proxy.CheckAndSaveOrder(order);\n            if (!success) {\n                log.error("\u4e0b\u5355\u5931\u8d25");\n            }\n            // 5. \u6263\u51cf\u5e93\u5b58\n            success = seckillVoucherService.update().setSql("stock = stock - 1").\n                    eq("voucher_id", order.getVoucherId()).\n                    gt("stock", 0).\n                    update();\n            if (!success) {\n                log.error("\u4e0b\u5355\u5931\u8d25");\n            }\n        } finally {\n            lock.unlock();\n        }\n    }\n\n    @Override\n    public Result seckillVoucher(Long voucherId) {\n        // 1. \u662f\u5426\u5b58\u5728\u8be5\u79d2\u6740\u4f18\u60e0\u5238\n        // SeckillVoucher voucher = seckillVoucherService.getById(voucherId);\n        Optional<SeckillVoucher> voucherOptional = cacheClient.get(SECKILL_VOUCHER_KEY + voucherId, SeckillVoucher.class);\n        if (voucherOptional.isPresent()) {\n            return Result.fail("\u79d2\u6740\u4f18\u60e0\u5238\u4e0d\u5b58\u5728");\n        }\n        SeckillVoucher voucher = voucherOptional.get();\n        // 2. \u662f\u5426\u5728\u79d2\u6740\u65f6\u95f4\u5185\n        if (LocalDateTime.now().isBefore(voucher.getBeginTime()) || LocalDateTime.now().isAfter(voucher.getEndTime())) {\n            return Result.fail("\u4e0d\u5728\u79d2\u6740\u65f6\u95f4\u5185");\n        }\n        // 3. \u662f\u5426\u8fd8\u6709\u5e93\u5b58\u548c\u4e00\u4eba\u4e00\u5355(\u6821\u9a8c\u903b\u8f91\u5728lua\u811a\u672c\u4e2d)\n        Long userId = 1L;\n        Long resultLong = stringRedisTemplate.execute(seckillScript, Collections.emptyList(), voucherId.toString(), userId.toString());\n        int result = resultLong.intValue();\n        if (result == 1) {\n            return Result.fail("\u5e93\u5b58\u4e0d\u8db3");\n        }\n        if (result == 2) {\n            return Result.fail("\u60a8\u5df2\u7ecf\u62a2\u8d2d\u8fc7\u4e86");\n        }\n        // \u751f\u6210\u4efb\u52a1\uff0c\u8fd4\u56de\u7ed3\u679c\n        VoucherOrder order = new VoucherOrder();\n        order.setId(redisIdWorker.nextId(SECKILL_STOCK_KEY));\n        order.setVoucherId(voucherId);\n        order.setCreateTime(LocalDateTime.now());\n        order.setUpdateTime(LocalDateTime.now());\n        order.setStatus(1);\n        order.setUserId(userId);\n        orderQueue.offer(order);\n        return Result.ok(order);\n    }\n\n    @Transactional\n    public boolean CheckAndSaveOrder(VoucherOrder order){\n        boolean exist = super.lambdaQuery().eq(VoucherOrder::getUserId, 1).\n                eq(VoucherOrder::getVoucherId, order.getVoucherId()).count() > 0;\n        if (exist) {\n            return false;\n        }\n        return super.save(order);\n    }\n}\n\n'})}),"\n",(0,i.jsx)(n.p,{children:"\u5e73\u5747\u503c\u5927\u6982\u52a0\u901f\u4e86\u51e0\u500d\uff0c\u800c\u6700\u5c0f\u503c\u52a0\u901f\u975e\u5e38\u591a"}),"\n",(0,i.jsx)(n.p,{children:"\u95ee\u9898\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"jdk\u963b\u585e\u961f\u5217\u53ef\u80fd\u4e0d\u591f\u7528\uff08\u9ad8\u5e76\u53d1\u6253\u7206/\u8d85\u51fa\u961f\u5217\u5bb9\u91cf\uff09"}),"\n",(0,i.jsx)(n.li,{children:"\u79d2\u6740\u7684\u6570\u636e\u5b89\u5168\u95ee\u9898\uff0c\u5047\u5982\u6302\u4e86\u5c31\u5bc4\u4e86"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u6d88\u606f\u4ee3\u7406 message broker"}),"\n",(0,i.jsx)(n.p,{children:"redis\u6d88\u606f\u961f\u5217\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"list\u6a21\u62df"}),"\n",(0,i.jsx)(n.li,{children:"PubSub \u70b9\u5bf9\u70b9"}),"\n",(0,i.jsx)(n.li,{children:"Stream \u6bd4\u8f83\u5b8c\u5584\u7684\u6d88\u606f\u961f\u5217\u6a21\u578b"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["list\u6a21\u62df\u9700\u8981\u7528",(0,i.jsx)(n.code,{children:"BRPOP, BRPOSH, BLPOP, BLPUSH"}),"\u5f97\u5230\u963b\u585e\u6548\u679c"]}),"\n",(0,i.jsx)(n.p,{children:"\u4f46\u65e0\u6cd5\u907f\u514d\u6d88\u606f\u4e22\u5931\uff0c\u5e76\u4e14\u53ea\u652f\u6301\u5355\u6d88\u8d39\u8005"}),"\n",(0,i.jsx)(n.p,{children:"pubsub"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"SUBSCRIBE channel [channel]"}),"\u8ba2\u9605\u4e00\u4e2a\u6216\u8005\u591a\u4e2a\u9891\u9053"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PUBLISH channel msg"}),"\u5411\u4e00\u4e2a\u9891\u9053\u53d1\u6d88\u606f"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"PSUBSCRIBE pattern [pattern]"})," \u8ba2\u9605\u901a\u914d\u7b26\u7684\u591a\u4e2a\u9891\u9053","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u652f\u6301",(0,i.jsx)(n.code,{children:"*"}),", ",(0,i.jsx)(n.code,{children:"?"}),",",(0,i.jsx)(n.code,{children:"[]"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u652f\u6301\u591a\u751f\u4ea7\u591a\u6d88\u8d39\uff0c\u4f46"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u4e0d\u652f\u6301\u6570\u636e\u6301\u4e45\u5316"}),"\n",(0,i.jsx)(n.li,{children:"\u5806\u79ef\u6709\u4e0a\u9650->\u653e\u5728\u6d88\u8d39\u8005\u7684\u7f13\u5b58\u533a"}),"\n",(0,i.jsx)(n.li,{children:"\u65e0\u6cd5\u907f\u514d\u6d88\u606f\u4e22\u5931"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Stream: ",(0,i.jsx)(n.a,{href:"https://redis.io/docs/latest/develop/data-types/streams/",children:"\u6570\u636e\u7c7b\u578b"})]}),"\n",(0,i.jsx)(n.p,{children:"\u6700\u7b80\u5355\u7528\u6cd5"}),"\n",(0,i.jsx)(n.p,{children:"XADD\u5199"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"XADD users * name jack age 21\n# XADD [key] * [field value [field value...]]\n# * \u8868\u793aredis\u751f\u6210id, \u683c\u5f0f\u662f \u65f6\u95f4\u6233+seq ID(0,1,2,...),\u8bfb\u7684\u65f6\u5019\u7528seqID\u5c31\u884c\n"})}),"\n",(0,i.jsx)(n.p,{children:"XLEN\u67e5\u770bkey\u91cc\u9762\u7684\u6d88\u606f\u957f\u5ea6"}),"\n",(0,i.jsx)(n.p,{children:"XREAD\u8bfb"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"# XREAD [COUNT count] [BLOCK milliseconds] STREAMS key [key...] ID [ID...]\nXREAD COUNT 1 STREAMS users 0\n"})}),"\n",(0,i.jsx)(n.p,{children:"\u53ef\u4ee5\u591a\u8bfb\uff0c\u6bcf\u4e2aclient\u6709\u81ea\u5df1\u7684\u8ba1\u6570"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"XREAD COUNT 1 BLOCK 0 STREAMS users $\n# $ \u8868\u793a\u6700\u65b0\u6d88\u606f, BLOCK 0 \u6c38\u4e45\u963b\u585e\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u4f46$\u7684\u884c\u4e3a\u8fd8\u548coffset\u4e0d\u4e00\u6837\uff0c\u4ed6\u59cb\u7ec8\u662f\u201c\u8fd9\u6761\u547d\u4ee4\u5f00\u59cb\u540e\u201d\u7684\u6700\u65b0\uff0c\u4e0d\u662f",(0,i.jsx)(n.code,{children:"offset += count"}),"\u800c\u662f",(0,i.jsx)(n.code,{children:"offset = queue.lastIndex();"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u6d88\u606f\u53ef\u56de\u6eaf"}),"\n",(0,i.jsx)(n.li,{children:"\u4e00\u53d1\u591a\u8bfb"}),"\n",(0,i.jsx)(n.li,{children:"\u53ef\u4ee5\u963b\u585e\u8bfb"}),"\n",(0,i.jsx)(n.li,{children:"\u4f46\u6709\u6f0f\u8bfb\u98ce\u9669"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u6d88\u8d39\u8005\u7ec4 Consumer Group"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u6d88\u606f\u5206\u6d41"}),"\n",(0,i.jsxs)(n.li,{children:["\u6d88\u606f\u6807\u8bc6\uff08offset\uff09 ",(0,i.jsx)(n.code,{children:">"}),"\u4ece\u4e0b\u4e00\u4e2a\u672a\u6d88\u8d39\u7684\u6d88\u606f\u5f00\u59cb"]}),"\n",(0,i.jsx)(n.li,{children:"\u6d88\u606f\u786e\u8ba4\uff0c\u62ff\u5230\u6d88\u606f\u540e\u4f1a\u8fdb\u5165pending-list, XACK\u6807\u8bc6\u5904\u7406\u5b8c\u6210\u524d\u4e0d\u79fb\u9664"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"redistemplate opsForStream\u5c31\u884c\uff0c\u548c\u547d\u4ee4\u662f\u5bf9\u5e94\u7684"}),"\n",(0,i.jsxs)(n.p,{children:["\u5f97\u5230\u7684\u662flist, \u518d\u5f97\u5230\u5355\u4e2a",(0,i.jsx)(n.code,{children:"{id, entries}"}),"\u7684\u5bf9\u8c61\uff0c\u6700\u540e\u628aentries\u8f6c\u6362\u56de\u6d88\u606f\u4f53"]}),"\n",(0,i.jsx)(n.h3,{id:"\u5b9e\u6218",children:"\u5b9e\u6218"}),"\n",(0,i.jsxs)(n.p,{children:["\u70b9\u8d5e\uff1a\u653e\u7528\u6237",(0,i.jsx)(n.strong,{children:"ID"}),"\u5728redis\u96c6\u5408"]}),"\n",(0,i.jsxs)(n.p,{children:["\u8fd8\u662f",(0,i.jsx)(n.strong,{children:"\u5148\u6539db\u518d\u6539redis"})]}),"\n",(0,i.jsx)(n.p,{children:'\u70b9\u8d5e\u6392\u884c\u699c\uff08"xxx, ...\u7b49\u8d5e\u4e86"\uff0c\u5fae\u4fe1\u6309\u65f6\u95f4\u6392\u5e8f\uff09\u6539\u6210sortedset\u5c31\u884c, \u7136\u540e\u53d6\u51fa\u7528\u6237\u7684\u65f6\u5019\u52a0\u4e2aorder by'}),"\n",(0,i.jsx)(n.p,{children:"\u5173\u6ce8\u548c\u53d6\u5173 db\u5c42\u7ea7\u662ffollow\u8868\uff0c\u4f46\u7f13\u5b58\u5462\uff1f\u5168\u90e8\u6d88\u606f\u961f\u5217\uff1f\u524d\u7aefws?"}),"\n",(0,i.jsx)(n.p,{children:"\u4e4b\u524d\u770b\u5230\u4e00\u4e2a\u65b9\u6848\u662f\u7ed9\u7528\u6237\u5efa\u4e00\u4e2a\u672a\u8bfb\u6d88\u606f\u8868\uff0c\u540e\u7aef\u767b\u5f55\u540e\u5b9a\u65f6\u62c9\u53d6\u4e00\u904d\u81ea\u5df1\u5173\u6ce8\u7684\u6240\u6709\u4eba\u7684\u65b0\u6d88\u606f\uff08\u5728\u5173\u6ce8\u8868\u91cc\u9762 user_id, follow_id, last_update \u6bd4\u8f83\u6700\u540e\u66f4\u65b0\u65f6\u95f4\u548c\u5173\u6ce8\u7684\u4eba\u7684\u65b0\u5e16\u5b50\u5c31\u884c\uff09\uff0c\u5e76\u901a\u8fc7ws/\u8f6e\u8be2\u7b49\u53d1\u7ed9\u524d\u7aef"}),"\n",(0,i.jsx)(n.p,{children:"\u8fd9\u6837\u7684\u4f18\u70b9\u5728\u4e8e\u907f\u514d\u4e00\u4e2a\u88ab\u51e0\u4e07\u51e0\u5341\u4e07\u7528\u6237\u5173\u6ce8\u7684\u52a8\u6001\u5bf9\u6570\u636e\u5e93\u9020\u6210\u5927\u538b\u529b"}),"\n",(0,i.jsx)(n.p,{children:"\u5173\u6ce8\u5217\u8868\u5e94\u8be5\u653eredis, \u8fd9\u4e2a\u6ca1\u6709\u5fc5\u8981\u4e00\u76f4\u67e5\u8868"}),"\n",(0,i.jsx)(n.p,{children:"\u5171\u540c\u5173\u6ce8: \u7531\u4e8e\u5df2\u7ecf\u6709redis\u7684\u5173\u6ce8\u5217\u8868\u4e86\uff0c\u76f4\u63a5redis\u6c42\u4ea4\u5c31\u884c"}),"\n",(0,i.jsx)(n.p,{children:"\u5173\u6ce8\u63a8\u9001 Feed\u6d41"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"timeline \u4e0d\u505a\u5185\u5bb9\u7b5b\u9009"}),"\n",(0,i.jsx)(n.li,{children:"\u667a\u80fd\u6392\u5e8f \u4f9d\u8d56\u4e8e\u7b97\u6cd5"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"timeline:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"\u62c9\u6a21\u5f0f\uff08\u8bfb\u6269\u6563\uff09\uff0c\u53ea\u6709\u201c\u53d1\u4ef6\u7bb1\u201d\u6ca1\u6709\u201c\u6536\u4ef6\u7bb1\u201d\uff0c\u53ea\u6709\u5728\u8bfb\u7684\u65f6\u5019\u624d\u4f1a\u53bb\u8bfb\u526f\u672c\uff08\u4e0d\u843d\u76d8\uff09\uff0c\u6d88\u606f\u53ea\u5728\u53d1\u9001\u7aef\u5b58\uff0c\u5ef6\u65f6\u8f83\u9ad8\u7701\u5185\u5b58\uff0c\u5b9e\u73b0\u590d\u6742"}),"\n",(0,i.jsx)(n.li,{children:"\u63a8\u6a21\u5f0f (\u5199\u6269\u6563)\uff0c\u53ea\u6709\u201c\u6536\u4ef6\u7bb1\u201d\u6ca1\u6709\u201c\u53d1\u4ef6\u7bb1\u201d\uff0c\u65b0\u6d88\u606f\u76f4\u63a5\u5b58\u5230\u6240\u6709\u5173\u6ce8\u8005\u7684\u6536\u4ef6\u7bb1\uff0c\u5ef6\u65f6\u4f4e\uff0c\u4e0d\u9700\u8981\u62c9\u53d6\u6392\u5e8f\uff0c\u4f46\u5360\u78c1\u76d8\uff0c\u5b9e\u73b0\u7b80\u5355"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u63a8\u62c9\u7ed3\u5408"}),"\uff08\u8bfb\u5199\u6df7\u5408\uff09\uff1a","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u63a8\u9001\u6570\u5c11\uff08\u4f8b\u5982",(0,i.jsx)(n.code,{children:"<1000"}),"\uff09\u63a8\uff0c\u63a8\u9001\u6570\u591a\u62c9"]}),"\n",(0,i.jsx)(n.li,{children:"\u8fd8\u53ef\u4ee5\u5224\u6d3b\uff0c\u53ea\u7ed9\u6d3b\u8dc3\u7528\u6237\u63a8\uff0c\u4e0d\u6d3b\u8dc3\u7528\u6237\u62c9\uff0c\u8fd9\u6837\u51cf\u5c11\u63a8\u7684\u6570\u91cf\uff0c\u53c8\u4f18\u5316\u4e86\u6d3b\u8dc3\u7528\u6237\u9891\u7e41\u8bfb\u7684\u5185\u5b58\u5f00\u9500"}),"\n",(0,i.jsx)(n.li,{children:"...\u5176\u4ed6\u7b56\u7565"}),"\n",(0,i.jsx)(n.li,{children:"\u5b9e\u73b0\u975e\u5e38\u590d\u6742"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"\u9ed1\u9a6c\u7684\u610f\u601d\u662f\u5343\u4e07\u4ee5\u4e0b\u7684\u7528\u6237\u6570\u63a8\u6a21\u5f0f\u90fd\u4e0d\u4f1a\u6709\u5927\u95ee\u9898\u8349"}),"\n",(0,i.jsx)(n.p,{children:"\u63a8\u6a21\u5f0f\uff1a"}),"\n",(0,i.jsx)(n.p,{children:"feed\u6d41\u7684\u5206\u9875\u95ee\u9898\uff1a\u8bfb\u7b2c\u4e00\u9875->\u63d2\u5165->\u8bfb\u7b2c\u4e8c\u9875\uff1f\uff1f\uff1f\uff08\u611f\u89c9\u4e0d\u662f\u4ec0\u4e48\u7279\u522b\u7684case...\u522b\u7684\u5206\u9875\u4e00\u822c\u4e5f\u4e0d\u8003\u8651\u8fd9\u4e2a\u554a\uff0c\u53ef\u80fd\u9ad8\u901f\u66f4\u65b0\u7684\u6d41\u9700\u8981\uff09"}),"\n",(0,i.jsx)(n.p,{children:"\u89e3\u51b3\u65b9\u6cd5\u5012\u662f\u5f88\u7b80\u5355\uff0c\u6eda\u52a8\u5206\u9875\uff0c\u8bb0\u5f55\u4e0a\u4e00\u6b21\u7684\u6700\u540e\u4e00\u6761\u3002\u4e4b\u540e\u4ece\u5b83\u5411\u540eN\u6761"}),"\n",(0,i.jsx)(n.p,{children:"redis sortedset \u6309\u7167 score range\u67e5\u8be2 (zrange byscore)"}),"\n",(0,i.jsx)(n.p,{children:"opsForZSet"}),"\n",(0,i.jsx)(n.p,{children:"\u9644\u8fd1\u5546\u6237 redis GEO"}),"\n",(0,i.jsx)(n.p,{children:"\u7528\u6237\u7b7e\u5230 BitMap"}),"\n",(0,i.jsx)(n.p,{children:"UV \u7edf\u8ba1hyperloglog\uff1a"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"UV \u72ec\u7acb\u8bbf\u95ee\u91cf\uff08\u8bbf\u5ba2\u91cf\uff09"}),"\n",(0,i.jsx)(n.li,{children:"PV \u70b9\u51fb\u91cf"}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"loglog\u7b97\u6cd5\u6d3e\u751f\u7684\u6982\u7387\u7b97\u6cd5\uff0c\u4e0d\u9700\u8981\u5b58\u503c; \u8bef\u5dee\u5c0f\u4e8e1%, \u5355\u4e2aHLL\u7684\u5185\u5b58\u6c38\u8fdc\u5c0f\u4e8e16KB"}),"\n",(0,i.jsx)(n.p,{children:"PFADD PFCOUNT PFMERGE"}),"\n",(0,i.jsx)(n.p,{children:"\u7b97\u6cd5\u672c\u8eab\u81ea\u52a8\u53bb\u91cd"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>l,x:()=>c});var i=r(6540);const s={},t=i.createContext(s);function l(e){const n=i.useContext(t);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(t.Provider,{value:n},e.children)}}}]);