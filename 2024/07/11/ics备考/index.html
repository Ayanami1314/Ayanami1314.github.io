<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="keywords" content="Hexo Theme Redefine">
    
    <meta name="author" content="Ayanami">
    <!-- preconnect -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    
    <!--- Seo Part-->
    
    <link rel="canonical" href="https://ayanami1314.github.io/2024/07/11/ics备考/"/>
    <meta name="robots" content="index,follow">
    <meta name="googlebot" content="index,follow">
    <meta name="revisit-after" content="1 days">
    
        <meta name="description" content="ics备考 一道Linking,一个VM, 两个Concurrency，一个Network  第七章Linking；2. 第9章VM，课程PPT补充的Replacement Policy； 3. 第11章Network，第十章中的RIO；4.  第12章Concurrency，课程PPT补充的Lock。  网络">
<meta property="og:type" content="article">
<meta property="og:title" content="ics备考">
<meta property="og:url" content="https://ayanami1314.github.io/2024/07/11/ics%E5%A4%87%E8%80%83/index.html">
<meta property="og:site_name" content="Ayanami&#39;s Cave">
<meta property="og:description" content="ics备考 一道Linking,一个VM, 两个Concurrency，一个Network  第七章Linking；2. 第9章VM，课程PPT补充的Replacement Policy； 3. 第11章Network，第十章中的RIO；4.  第12章Concurrency，课程PPT补充的Lock。  网络">
<meta property="og:locale">
<meta property="article:published_time" content="2024-07-10T16:00:00.000Z">
<meta property="article:modified_time" content="2024-07-11T15:35:13.405Z">
<meta property="article:author" content="Ayanami">
<meta name="twitter:card" content="summary">
    
    
    <!--- Icon Part-->
    <link rel="icon" type="image/png" href="/images/ayanami.jpg" sizes="192x192">
    <link rel="apple-touch-icon" sizes="180x180" href="/images/ayanami.jpg">
    <meta name="theme-color" content="#A31F34">
    <link rel="shortcut icon" href="/images/ayanami.jpg">
    <!--- Page Info-->
    
    <title>
        
            ics备考 -
        
        Ayanami&#39;s Cave
    </title>

    
<link rel="stylesheet" href="/fonts/Chillax/chillax.css">


    <!--- Inject Part-->
    

    
<link rel="stylesheet" href="/css/style.css">


    
        
<link rel="stylesheet" href="/assets/build/styles.css">

    

    
<link rel="stylesheet" href="/fonts/GeistMono/geist-mono.css">

    
<link rel="stylesheet" href="/fonts/Geist/geist.css">

    <!--- Font Part-->
    
    
    
    

    
        
<script src="/js/libs/anime.min.js"></script>

    

    <script id="hexo-configurations">
    window.config = {"hostname":"ayanami1314.github.io","root":"/","language":"zh","path":"search.xml"};
    window.theme = {"articles":{"style":{"font_size":"16px","line_height":1.5,"image_border_radius":"14px","image_alignment":"center","image_caption":false,"link_icon":true,"title_alignment":"left","headings_top_spacing":{"h1":"3.2rem","h2":"2.4rem","h3":"1.9rem","h4":"1.6rem","h5":"1.4rem","h6":"1.3rem"}},"word_count":{"enable":true,"count":true,"min2read":true},"author_label":{"enable":true,"auto":false,"list":[]},"code_block":{"copy":true,"style":"mac","font":{"enable":false,"family":null,"url":null}},"toc":{"enable":true,"max_depth":3,"number":false,"expand":true,"init_open":true},"copyright":{"enable":true,"default":"cc_by_nc_sa"},"lazyload":true,"recommendation":{"enable":true,"title":"推荐阅读","limit":3,"mobile_limit":2,"placeholder":"/images/wallhaven-wqery6-light.webp","skip_dirs":[]}},"colors":{"primary":"#A31F34","secondary":null,"default_mode":"light"},"global":{"fonts":{"chinese":{"enable":false,"family":null,"url":null},"english":{"enable":false,"family":null,"url":null}},"content_max_width":"1000px","sidebar_width":"210px","hover":{"shadow":true,"scale":false},"scroll_progress":{"bar":false,"percentage":true},"website_counter":{"url":"https://cn.vercount.one/js","enable":true,"site_pv":true,"site_uv":true,"post_pv":true},"single_page":true,"preloader":true,"open_graph":true,"google_analytics":{"enable":false,"id":null}},"home_banner":{"enable":true,"style":"fixed","image":{"light":"/images/wallhaven-wqery6-light.webp","dark":"/images/wallhaven-wqery6-dark.webp"},"title":"make code matter, make life better","subtitle":{"text":[],"hitokoto":{"enable":false,"api":"https://v1.hitokoto.cn"},"typing_speed":100,"backing_speed":80,"starting_delay":500,"backing_delay":1500,"loop":true,"smart_backspace":true},"text_color":{"light":"#fff","dark":"#d1d1b6"},"text_style":{"title_size":"2.8rem","subtitle_size":"1.5rem","line_height":1.2},"custom_font":{"enable":false,"family":null,"url":null},"social_links":{"enable":false,"style":"default","links":{"github":"https://github.com/Ayanami1314","instagram":null,"zhihu":"https://www.zhihu.com/people/85-36-64-12","twitter":null,"email":"lingbo_2022@sjtu.edu.cn"},"qrs":{"weixin":null}}},"plugins":{"feed":{"enable":false},"aplayer":{"enable":false,"type":"fixed","audios":[{"name":null,"artist":null,"url":null,"cover":null,"lrc":null}]},"mermaid":{"enable":false,"version":"9.3.0"}},"version":"2.6.4","navbar":{"auto_hide":false,"color":{"left":"#f78736","right":"#367df7","transparency":35},"width":{"home":"1200px","pages":"1000px"},"links":{"Home":{"path":"/","icon":"fa-regular fa-house"},"Archives":{"path":"/archives","icon":"fa-regular fa-archive"}},"search":{"enable":true,"preload":true}},"page_templates":{"friends_column":2,"tags_style":"blur"},"home":{"sidebar":{"enable":true,"position":"left","first_item":"menu","announcement":null,"show_on_mobile":true,"links":{"Archives":{"path":"/archives","icon":"fa-regular fa-archive"},"Tags":{"path":"/tags","icon":"fa-regular fa-tags"}}},"article_date_format":"auto","categories":{"enable":true,"limit":3},"tags":{"enable":true,"limit":3}},"footerStart":"2022/8/17 11:45:14"};
    window.lang_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
    window.data = {"masonry":false};
  </script>
    
    <!--- Fontawesome Part-->
    
<link rel="stylesheet" href="/fontawesome/fontawesome.min.css">

    
<link rel="stylesheet" href="/fontawesome/brands.min.css">

    
<link rel="stylesheet" href="/fontawesome/solid.min.css">

    
<link rel="stylesheet" href="/fontawesome/regular.min.css">

    
    
    
    
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
<!--        <span class="swup-progress-icon">-->
<!--            <i class="fa-solid fa-circle-notch fa-spin"></i>-->
<!--        </span>-->
    
</div>



    <style>
    :root {
        --preloader-background-color: #fff;
        --preloader-text-color: #000;
    }

    @media (prefers-color-scheme: dark) {
        :root {
            --preloader-background-color: #202124;
            --preloader-text-color: #fff;
        }
    }

    @media (prefers-color-scheme: light) {
        :root {
            --preloader-background-color: #fff;
            --preloader-text-color: #000;
        }
    }

    @media (max-width: 600px) {
        .ml13 {
            font-size: 2.6rem !important; /* Adjust this value as needed */
        }
    }

    .preloader {
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Tailwind 'gap-4' is 1rem */
        align-items: center;
        justify-content: center;
        position: fixed;
        padding: 12px;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100vw;
        height: 100vh; /* 'h-screen' is 100% of the viewport height */
        background-color: var(--preloader-background-color);
        z-index: 1100; /* 'z-[1100]' sets the z-index */
        transition: opacity 0.2s ease-in-out;
    }

    .ml13 {
        font-size: 3.2rem;
        /* text-transform: uppercase; */
        color: var(--preloader-text-color);
        letter-spacing: -1px;
        font-weight: 500;
        font-family: 'Chillax-Variable', sans-serif;
        text-align: center;
    }

    .ml13 .word {
        display: inline-flex;
        flex-wrap: wrap;
        white-space: nowrap;
    }

    .ml13 .letter {
        display: inline-block;
        line-height: 1em;
    }
</style>

<div class="preloader">
    <h2 class="ml13">
        Ayanami&#39;s Cave
    </h2>
    <script>
        var textWrapper = document.querySelector('.ml13');
        // Split text into words
        var words = textWrapper.textContent.trim().split(' ');

        // Clear the existing content
        textWrapper.innerHTML = '';

        // Wrap each word and its letters in spans
        words.forEach(function(word) {
            var wordSpan = document.createElement('span');
            wordSpan.classList.add('word');
            wordSpan.innerHTML = word.replace(/\S/g, "<span class='letter'>$&</span>");
            textWrapper.appendChild(wordSpan);
            textWrapper.appendChild(document.createTextNode(' ')); // Add space between words
        });

        var animation = anime.timeline({loop: true})
            .add({
                targets: '.ml13 .letter',
                translateY: [40,0],
                translateZ: 0,
                opacity: [0,1],
                filter: ['blur(5px)', 'blur(0px)'], // Starting from blurred to unblurred
                easing: "easeOutExpo",
                duration: 1400,
                delay: (el, i) => 300 + 30 * i,
            }).add({
                targets: '.ml13 .letter',
                translateY: [0,-40],
                opacity: [1,0],
                filter: ['blur(0px)', 'blur(5px)'], // Ending from unblurred to blurred
                easing: "easeInExpo",
                duration: 1200,
                delay: (el, i) => 100 + 30 * i,
                complete: function() {
                    hidePreloader(); // Call hidePreloader after the animation completes
                }
            });

        let themeStatus = JSON.parse(localStorage.getItem('REDEFINE-THEME-STATUS'))?.isDark;

        // If the theme status is not found in local storage, check the preferred color scheme
        if (themeStatus === undefined || themeStatus === null) {
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                themeStatus = 'dark';
            } else {
                themeStatus = 'light';
            }
        }

        // Now you can use the themeStatus variable in your code
        if (themeStatus) {
            document.documentElement.style.setProperty('--preloader-background-color', '#202124');
            document.documentElement.style.setProperty('--preloader-text-color', '#fff');
        } else {
            document.documentElement.style.setProperty('--preloader-background-color', '#fff');
            document.documentElement.style.setProperty('--preloader-text-color', '#000');
        }

        window.addEventListener('load', function () {
            setTimeout(hidePreloader, 5000); // Call hidePreloader after 5000 milliseconds if not already called by animation
        });

        function hidePreloader() {
            var preloader = document.querySelector('.preloader');
            preloader.style.opacity = '0';
            setTimeout(function () {
                preloader.style.display = 'none';
            }, 200);
        }
    </script>
</div>

<main class="page-container" id="swup">

    

    <div class="main-content-container">


        <div class="main-content-header">
            <header class="navbar-container px-6 md:px-12">

    <div class="navbar-content ">
        <div class="left">
            
            <a class="logo-title" href="/">
                
                Ayanami&#39;s Cave
                
            </a>
        </div>

        <div class="right">
            <!-- PC -->
            <div class="desktop">
                <ul class="navbar-list">
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/"
                                        >
                                    <i class="fa-regular fa-house fa-fw"></i>
                                    HOME
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                        
                            

                            <li class="navbar-item">
                                <!-- Menu -->
                                <a class=""
                                   href="/archives"
                                        >
                                    <i class="fa-regular fa-archive fa-fw"></i>
                                    ARCHIVES
                                    
                                </a>

                                <!-- Submenu -->
                                
                            </li>
                    
                    
                        <li class="navbar-item search search-popup-trigger">
                            <i class="fa-solid fa-magnifying-glass"></i>
                        </li>
                    
                </ul>
            </div>
            <!-- Mobile -->
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fa-solid fa-magnifying-glass"></i>
                    </div>
                
                <div class="icon-item navbar-bar">
                    <div class="navbar-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile sheet -->
    <div class="navbar-drawer h-screen w-full absolute top-0 left-0 bg-background-color flex flex-col justify-between">
        <ul class="drawer-navbar-list flex flex-col px-4 justify-center items-start">
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/"
                        >
                            <span>
                                HOME
                            </span>
                            
                                <i class="fa-regular fa-house fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            
                
                    

                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full "
                           href="/archives"
                        >
                            <span>
                                ARCHIVES
                            </span>
                            
                                <i class="fa-regular fa-archive fa-sm fa-fw"></i>
                            
                        </a>
                        

                        
                    </li>
            

            
            
                
                    
                    
                    <li class="drawer-navbar-item text-base my-1.5 flex flex-col w-full">
                        <a class="py-1.5 px-2 flex flex-row items-center justify-between gap-1 hover:!text-primary active:!text-primary text-2xl font-semibold group border-b border-border-color hover:border-primary w-full active"
                           href="/tags"
                        >
                            <span>Tags</span>
                            <i class="fa-regular fa-tags fa-sm fa-fw"></i>
                        </a>
                    </li>
                
            
        </ul>

        <div class="statistics flex justify-around my-2.5">
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/tags">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Tags</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/categories">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">0</div>
        <div class="label text-third-text-color text-sm">Categories</div>
    </a>
    <a class="item tag-count-item flex flex-col justify-center items-center w-20" href="/archives">
        <div class="number text-2xl sm:text-xl text-second-text-color font-semibold">21</div>
        <div class="label text-third-text-color text-sm">Posts</div>
    </a>
</div>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="main-content-body">

            

            <div class="main-content">

                
                    <div class="post-page-container flex relative justify-between box-border w-full h-full">
    <div class="article-content-container">

        <div class="article-title relative w-full">
            
                <div class="w-full flex items-center pt-6 justify-start">
                    <h1 class="article-title-regular text-second-text-color tracking-tight text-4xl md:text-6xl font-semibold px-2 sm:px-6 md:px-8 py-3">ics备考</h1>
                </div>
            
            </div>

        
            <div class="article-header flex flex-row gap-2 items-center px-2 sm:px-6 md:px-8">
                <div class="avatar w-[46px] h-[46px] flex-shrink-0 rounded-medium border border-border-color p-[1px]">
                    <img src="/images/ayanami.jpg">
                </div>
                <div class="info flex flex-col justify-between">
                    <div class="author flex items-center">
                        <span class="name text-default-text-color text-lg font-semibold">Ayanami</span>
                        
                            <span class="author-label ml-1.5 text-xs px-2 py-0.5 rounded-small text-third-text-color border border-shadow-color-1">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fa-regular fa-pen-fancy"></i>&nbsp;
        <span class="desktop">2024-07-11</span>
        <span class="mobile">2024-07-11</span>
        <span class="hover-info">Created</span>
    </span>
    
        <span class="article-date article-meta-item">
            <i class="fa-regular fa-wrench"></i>&nbsp;
            <span class="desktop">2024-07-11 23:35:13</span>
            <span class="mobile">2024-07-11 23:35:13</span>
            <span class="hover-info">Updated</span>
        </span>
    

    
    

    
    
    
    
        <span class="article-pv article-meta-item">
            <i class="fa-regular fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        


        <div class="article-content markdown-body px-2 sm:px-6 md:px-8 pb-8">
            <p>ics备考</p>
<p>一道Linking,一个VM, 两个Concurrency，一个Network</p>
<ol>
<li>第七章Linking；2. 第9章VM，课程PPT补充的Replacement Policy； 3. 第11章Network，第十章中的RIO；4.  第12章Concurrency，课程PPT补充的Lock。</li>
</ol>
<h4 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h4><span id="more"></span>
<p>1.字节序问题，网络大端序。主机使用<code>long htonl(long host)</code>(host to net long)，<code>htons</code>(… short)， <code>ntohl</code></p>
<p>2.常用api</p>
<ul>
<li><p><code>const char *inet_ntop(int af, const void *src, char *dst, socklen_t size);</code> 将二进制的网络地址转换为可读的字符串形式，af是<code>AF_INET</code>(ipv4), src是传入地址，dst是目标字符串，size是src大小</p>
</li>
<li><p><code>int accept(int sockfd, struct sockaddr *addr, socklen_t *addrlen);</code> 监听sockfd套接字，并将client的连接信息存在addr，如果addr不是NULL，会更新addrlen大小</p>
</li>
<li><p>在监听套接字之前，需要将套接字绑定到某个端口上，书上是<code>listenfd=open_listenfd(port);</code>就行，之后accept listenfd。如果不用辅助函数需要创建套接字、为<code>sockaddr_in addr</code>设置端口、再<code>bind</code>addr和sockfd、再<code>listen(sockfd)</code>发起监听</p>
</li>
<li><p><code>dup2(int fd1, int fd2)</code>将fd1复制到fd2</p>
</li>
<li><p><code>int inet_aton(const char *cp, struct in_addr *inp);</code>将cp字符串的IP解析之后转换为网络序的整数放在inp-&gt;sin_addr里面</p>
</li>
<li><p><code>int inet_pton(int af, const char *src, void *dst)</code>字符串-&gt;二进制，存在dst(in_addr*)里面; af网络族<code>AF_INET</code>ipv4</p>
<p><code>const char *inet_ntop(int af, const void *src, char *dst, socklen_t size);</code> 例如inet_ntop(AF_INET, &amp;in, ip_str, sizeof(ip_str)</p>
</li>
<li><p><code>int connect(int sockfd, const struct sockaddr *addr, socklen_t addrlen);</code></p>
</li>
<li><p><code>int listen(int sockfd, int backlog);</code> backlog最大请求数</p>
</li>
</ul>
<p><strong>记得Close不用的fd!!!</strong></p>
<p>多线程记得detach <code>pthread_detach(pthread_self())</code></p>
<blockquote>
<p>Detached thread cannot be reaped or killed by other threads, resources are automatically reaped on termination</p>
</blockquote>
<p>Rio相关</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">rio_t</span> rio;</span><br><span class="line">Rio_readinitb(<span class="type">rio_t</span>* prio, <span class="type">int</span> fd);</span><br><span class="line">Rio_readlineb(<span class="type">rio_t</span>* prio, <span class="type">char</span> *buf, <span class="type">int</span> maxline);</span><br><span class="line">Rio_readnb(<span class="type">rio_t</span>* prio, <span class="type">char</span> *buf, <span class="type">int</span> sz);</span><br><span class="line">Rio_writen(<span class="type">int</span> fd, <span class="type">char</span> *buf, <span class="type">int</span> sz);</span><br><span class="line"><span class="comment">// 避免buffer不够，while每次读一个定长（判断是否结束!多读就寄）</span></span><br></pre></td></tr></table></figure></div>

<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sprintf</span><span class="params">(<span class="type">char</span> *str, <span class="type">const</span> <span class="type">char</span> *format, ...)</span></span><br></pre></td></tr></table></figure></div>

<p>why rio:</p>
<ul>
<li>Rubust：错误处理，stdio的相关危险——流并不是真正意义上“双向”的，不能同时读写，如果同时定义两个流绑定到一个fd上又会有close问题</li>
<li>Buffer：比起原始的write&#x2F;read快很多，相当于做了batch——syscall的高开销</li>
</ul>
<h4 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h4><p>1.信号量api</p>
<ul>
<li><code>int sem_init(sem_t *sem, int pshared, unsigned int value)</code> value初始值。pshared 非0进程间共享，<code>sem_init(&amp;sem, 0, 1);</code></li>
<li><code>sem_wait</code> 书上 <code>P</code>，如果sem &gt; 0, -1，否则挂起等待sem &gt;0</li>
<li><code>sem_post</code> 书上 <code>V</code>,sem+&#x3D;1,唤醒等待进程</li>
</ul>
<p>2.pthread api</p>
<ul>
<li><p><code>pthread_create(pthread_t *thread, const pthread_attr_t *attr, void *(*start_routine)(void *), void *arg);</code> arg参数，一般整成struct， attr NULL就行</p>
</li>
<li><p><code>int pthread_join(pthread thread, void **retval);</code> retval保存返回值的指针（基本类型直接强制转换就成）</p>
</li>
<li><p><code>pthread_detach(pthread_t tid)</code></p>
</li>
</ul>
<p>例子 </p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pthread_t</span> t1,t2;</span><br><span class="line">pthread_create(&amp;t1, <span class="literal">NULL</span>, func1, <span class="literal">NULL</span>);</span><br><span class="line">pthread_create(&amp;t2, <span class="literal">NULL</span>, func2, <span class="literal">NULL</span>);</span><br><span class="line">pthread_join(t1, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">func2</span><span class="params">()</span>&#123;</span><br><span class="line">    pthread_detach(pthread_self());</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>栈帧是线程私有的，堆和全局变量（静态变量）是线程共享的</p>
<p>原子指令</p>
<p>TAS：TestAndSet:取旧设新的原子操作</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">TestAndSet</span><span class="params">(<span class="type">int</span> *old_ptr, <span class="type">int</span> new)</span> &#123;</span><br><span class="line">    <span class="type">int</span> old = *old_ptr; <span class="comment">// fetch old value at old_ptr</span></span><br><span class="line">    *old_ptr = new; <span class="comment">// store &#x27;new&#x27; into old_ptr</span></span><br><span class="line">    <span class="keyword">return</span> old; <span class="comment">// return the old value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>CAS: compare_and_swap：如果compare成立，那么写入newval</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">compare_and_swap</span><span class="params">(<span class="type">int</span>* reg, <span class="type">int</span> oldval, <span class="type">int</span> newval)</span>&#123;</span><br><span class="line">    <span class="type">int</span> old_reg_val = *reg;</span><br><span class="line">    <span class="keyword">if</span> (old_reg_val == oldval)</span><br><span class="line">       *reg = newval;</span><br><span class="line">    <span class="keyword">return</span> old_reg_val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></div>



<p>第二类读写问题（writer优先）：定义一个新信号量waiting_writers，读在有waiting_writers或者writer的时候不能进, 写在有reader或者writer的时候不能进</p>
<p>Process &#x3D; thread + code, data, and kernel context（fd, vma, brk pointer）</p>
<p>thread独有的也就一套register&amp;cc+stack(不是严格独有，由于vm是不独有, 可以通过地址摸到其他线程的变量——不安全)+tid</p>
<p>Three basic approaches for concurrent programming</p>
<ul>
<li>Processes</li>
<li>Threads</li>
<li>I&#x2F;O multiplexing</li>
</ul>
<p>其中基于线程和基于进程我们都比较熟悉了，多线程与多进程的区别在于重量级和轻量级。Linux线程比进程少复制这几个东西（和其他线程共享）：整个VM，文件相关（file structure and fd），信号处理。线程的核心就在于减少进程切换开销。</p>
<blockquote>
<p>对于LinuxThreads，它使用(CLONE_VM | CLONE_FS | CLONE_FILES | CLONE_SIGHAND)参数来调用clone()创建”线程”，表示共享内存、共享文件系统访问计数、共享文件描述符表，以及共享信号处理方式。（其中前三个标志对应共享的数据结构分别为task_struct中的mm,fs,files）。</p>
</blockquote>
<p>CLONE_VM 代表没有独立的vma, 没有独立的pagetable和heap；CLONE_FS 代表没有独立的文件系统信息，线程的当前文件夹等是共享的；CLONE_FILES 代表没有独立的文件描述符信息，对文件的操作是共享的（这引出一个注意点就是文件在多线程的情况下，尤其是webserver一定要在某个线程显式关闭，否则有线程不结束进程就不结束，fd就不回收） CLONE_SIGHAND 代表共享一套信号系统</p>
<p>而基于IO多路复用，又叫事件驱动编程，主要是针对这几个问题：</p>
<ul>
<li>线程数有限,线程开销依然大,无法承受高并发,且大多都是IO的情况下,对于IO任务不一定需要开线程</li>
<li>IO是堵塞的,类似web server,网络波动或者代码问题就会死住,希望有非堵塞服务</li>
<li>死锁活锁问题的易产生、难debug</li>
<li>并发依赖系统调度策略，难以定制和进一步调优</li>
</ul>
<p>IO多路复用就是使用select,epoll等系统调用去监听许多文件描述符（又或者它们主动中断，例如某些异步IO）。利用底层提供的aio等非阻塞IO api,避免任何阻塞，只有一个单线程主线程处理“某个fd上IO完成”这类的事件（常见于放入某个事件队列之中）。在GUI桌面编程，webserver等场景非常常见。</p>
<p>IO多路复用的问题在于：</p>
<ul>
<li>和某些底层机制，例如page，配合不好，pagefault还是会产生堵塞，不能非堵塞</li>
<li>编程相较多线程和多进程复杂，事件驱动强制要求异步和一些数据结构的包装和相关推断</li>
<li>更难适配现代多核机器</li>
</ul>
<p>thread_local：线程独有 <strong>thread_local</strong> <strong>int</strong> <strong>i</strong>&#x3D;0; 常用于随机数，errno</p>
<p>多进程的webserver: 必须回收僵尸进程（产生原因，父进程正忙（例如休眠），没有办法回收子进程资源）</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">sigchld_handler</span><span class="params">(<span class="type">int</span> sig)</span>&#123;</span><br><span class="line">	<span class="keyword">while</span> (waitpid(<span class="number">-1</span>, <span class="number">0</span>, WNOHANG) &gt; <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">Signal(SIGCHLD, sigchld_handler);</span><br></pre></td></tr></table></figure></div>



<h5 id="锁api"><a href="#锁api" class="headerlink" title="锁api"></a>锁api</h5><div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pthread_mutex_t</span> lock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="type">int</span> rc = pthread_mutex_init(&amp;lock, <span class="literal">NULL</span>);</span><br><span class="line">pthread_mutex_lock(&amp;lock);</span><br><span class="line">balance = balance + <span class="number">1</span>;</span><br><span class="line">pthread_mutex_unlock(&amp;lock);</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_trylock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex)</span>;</span><br><span class="line"><span class="type">int</span> <span class="title function_">pthread_mutex_timedlock</span><span class="params">(<span class="type">pthread_mutex_t</span> *mutex, <span class="keyword">struct</span> timespec *abs_timeout)</span>;</span><br></pre></td></tr></table></figure></div>

<p>早期锁实现：开关中断——低效，不安全，特权操作，多核不正确 现在很少用</p>
<p>软件TAS：多核不正确</p>
<p>CAS(X86) , LL&amp;SC(ARM)， FAA（fetch and add-&gt;atomic_add-&gt;ticket lock）</p>
<p>自旋锁多核可接受, 避免自旋——yield(), 少cpu好，多cpu烂 -&gt;queue, park() Unpark(tid)</p>
<p>自旋锁用循环的缺点——信号问题，可以考虑用<code>sigsuspend</code>代替实现</p>
<h4 id="VM"><a href="#VM" class="headerlink" title="VM"></a>VM</h4><p>cache认为大都是PIPT，少数拓展题VIPT</p>
<p>x86每个PTE 8Byte（32位地址空间）</p>
<p>目前的x86_64架构CPU都遵循AMD的Canonical Form,<strong>即只有虚拟地址的最低48位才会在地址转换时被使用, 且任何虚拟地址的48位至63位必须与47位一致, 也就是说总的虚拟地址空间为256TB。</strong></p>
<p><strong>0000000000000000 – 00007fffffffffff(128TB)为用户空间,</strong><br><strong>ffff800000000000 – ffffffffffffffff(128TB)为内核空间。</strong></p>
<p>4级页表，9位一级，512 * 8 &#x3D; 4KB  4*9+12 &#x3D; 48</p>
<p>PTE结构  VA &#x3D; VPN + VPO， PA&#x3D;PPN+PPO PPO&#x3D;VPO       VPN&#x3D;Tag + Index</p>
<p>第Index个，比较Tag决定 TLB hit &#x2F; TLB miss</p>
<p>PTE |valid bit|PPN  index是VPN，和cache不同，没有tag。注意是存VA-&gt;PA的映射，所以和PA-&gt;PA无关</p>
<p>cache：full-associate, N-way, direct associate</p>
<p>缓存区溢出攻击：利用%rbp存栈帧基址，且M[%rbp]存上一个栈帧的%rbp，M[%rbp+8]存返回值，如果覆盖M[%rbp+8]就能缓存区溢出攻击</p>
<p>共享级别：</p>
<ul>
<li>vnode table（文件系统对象表）是进程级别共享的</li>
<li>堆、fd、installed handler(代码段)、… 这些是线程级别共享的（依赖于本进程的VM）</li>
<li>寄存器、CC、栈等是不共享的</li>
</ul>
<p>共享库（Shared Libs）在vm内存模型之中是PRIVATE的</p>
<p>COW也是vma之中PRIVATE的flag</p>
<h4 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h4><h5 id="mmap"><a href="#mmap" class="headerlink" title="mmap"></a>mmap</h5><p>mmap是一个系统调用，将某个文件和内存上的一段虚拟地址对应起来。</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">mmap</span><span class="params">(<span class="type">void</span>* start, <span class="type">int</span> len, <span class="type">int</span> prot, <span class="type">int</span> flags, <span class="type">int</span> fd, <span class="type">int</span> offset)</span>;</span><br></pre></td></tr></table></figure></div>

<p>其中，start是（建议的）内存起始段（实际的由OS决定，一般设置成-1就行），prot是权限，flags是是否shared之类，fd为某个磁盘打开的文件或-1（匿名文件）offset指定文件的起始段</p>
<p>mmap可以实现快速文件拷贝等操作</p>
<div class="highlight-container" data-rel="C"><figure class="iseeu highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * use mmap to copy file to stdout</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">mmapcopy</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> size)</span>&#123;</span><br><span class="line">	<span class="type">char</span>* bufp;</span><br><span class="line">	bufp = mmap(<span class="number">0</span>, size, PROT_READ, MAP_PRIVATE, fd, <span class="number">0</span>);</span><br><span class="line">	write(<span class="number">1</span>, bufp, size);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div>

<p>省去了用户态的拷贝到buffer + syscall的开销</p>
<p>如果是private的mapping，是不会写回文件的(COW维护自己的副本)。而如果是shared的mapping，是会写回文件的（直接操作原始的文件，只有一个副本）。</p>
<p>通过内存映射的方法访问硬盘上的文件，效率要比read和write系统调用高， read()是系统调用，其中进行了数据拷贝，它首先将文件内容从硬盘拷贝到内核空间的一个缓冲区，然后再将这些数据拷贝到用户空间，在这个过程中，实际上完成了 <strong>两次数据拷贝</strong> ；而mmap()也是系统调用，如前所述，<strong>mmap()中没有进行数据拷贝，真正的数据拷贝是在缺页中断处理时进行的</strong>，由于mmap()将文件直接映射到用户空间，所以中断处理函数根据这个映射关系，直接将文件从硬盘拷贝到用户空间，只进行了 <strong>一次数据拷贝</strong> 。因此，内存映射的效率要比 read&#x2F;write效率高。</p>
<p><code>MAP_PRIVATE</code>如果是<code>MAP_SHARED</code>,就会是进程间真共享, 如果再搭配<code>MAP_ANON</code>（指定mmap的不是实际文件，只是虚拟的页，初始全0）,则能够达到进程间通信的效果，例如<code>MAP_SHARED|MAP_ANON</code>后fork子进程</p>
<h4 id="Replacement-policy"><a href="#Replacement-policy" class="headerlink" title="Replacement policy"></a>Replacement policy</h4><p>OPT, LRU, FIFO, RANDOM</p>
<p>在random负载，任何实际策略都差不多</p>
<p>在80-20冷热负载，LRU优于FIFO和RANDOM</p>
<p>但在循环负载，LRU和FIFO都非常差，所以选用何种策略depends</p>
<p>Random fares notably better</p>
<ul>
<li><p>not quite approaching optimal, but at least achieving a non-zero hit rate</p>
</li>
<li><p>not having weird corner-case behaviors</p>
</li>
<li><p><strong>used as TLB replacement policy</strong></p>
</li>
</ul>
<p>近似LRU，时钟算法</p>
<p>page out: select policy：demand paging, prefetching, clustering&amp;grouping (watermark)</p>
<p>thrash control: admission control, OOM killer</p>
<p>如何在physical page获取ref bit来执行时钟算法——reverse mapping （ref bit由硬件set，由软件clear）（dirty bit在level2（1G）3（2M）4之中有——最后一页）</p>
<p>可以evict pagetable page吗？ ——除了level1也不是不行</p>
<p>可以evict OS page吗？——一般不行，会设置不允许page out的PTE bit</p>
<h4 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h4><p>rax: accumulator register，<strong>累加寄存器</strong>，只是通过RAX存储函数<strong>返回值</strong>属于惯例。<br>rbx: base register，<strong>基址寄存器</strong>，一般用于访问内存的基址<br>rcx: counter register，<strong>计数寄存器</strong>。一般用于循环计数。<br>rdx: 数据寄存器，能够暂存一般性数据。<br>rsi: source index，<strong>源变址寄存器</strong>，字符串运算时常应用于源指针。<br>rdi: destination index，<strong>目标变址寄存器</strong>，字符串运算时常用于目标指针。<br>rsp: Stack Pointer，<strong>栈指针寄存器</strong>。它包含了当前栈顶的内存地址。<br>rbp: Base Pointer，<strong>基址指针寄存器</strong>。它通常用于指向<strong>当前栈帧的基址</strong>，即指向当前函数的栈帧的起始位置。在函数中，局部变量和其他数据可以通过 RBP 来访问。<strong>RBP 的值在函数调用时保持不变，因此可以作为一个固定的参考点来访问栈上的数据</strong>。<br>rip: Instruction Pointer，<strong>指令指针寄存器。它包含了将要执行的下一条指令的内存地址</strong>。<br>R8-R15: 一般是可以任意使用的，不指定特定用途，支持拆分。</p>
<h4 id="ostep补充"><a href="#ostep补充" class="headerlink" title="ostep补充"></a>ostep补充</h4><h5 id="并发数据结构"><a href="#并发数据结构" class="headerlink" title="并发数据结构"></a>并发数据结构</h5><p>性能：如果简单的方案就能工作，就不需要精巧的设计</p>
<p>多线程测试：对于一个任务，改变线程数，测试耗时</p>
<p>理想情况：多线程在多处理上就像单线程一样快（完美拓展）</p>
<p>并发计数器：naive的想法一直加锁解锁的拓展性是差的，会带来很高的性能损失</p>
<p>可拓展计数器：sloppy counter懒惰计数</p>
<p>N个cpu，N个线程，开N个局部计数器和一个全局计数器，共N+1个锁</p>
<p>定一个阈值S，只有当局部计数器的计数&gt;S的时候，才更新全局计数器，并将局部计数器归0</p>
<p>虽然局部计数器也要开锁解锁，但是由于只有全局计数器才会真正的竞争（意味着线程的挂起和调度、恢复等耗时操作），所以当S大的时候，性能很好，但计数器的精度低；当S小时，趋于naive的计数器</p>
<p>并发链表：</p>
<ol>
<li>并发的异常控制流，像是malloc这种可能会失败，但是失败概率不高的，如果需要在里面进行锁相关的操作，容易出错；更好的方法是调整语句顺序，只在真正竞态的语句前面加锁，执行完之后解锁，而不是一进入函数就加锁</li>
<li>拓展链表：上面链表的问题，拓展性差。一种理论上的解决方法是过手锁（也叫锁耦合，每个节点都有一个锁，遍历到下一个节点的时候，抢下一个节点的，释放当前节点的）（虽然实际效果不好）</li>
</ol>
<p>对于任意的数据结构，总有一个naive的并发方法：加全局的一把大锁</p>
<p>并发队列：Michael &amp; Scott 核心思想是对于头和尾，各自维护一把锁</p>
<p>这样使得入队和出队操作被分开，可以并行执行：入队获取尾锁，出队获取头锁，如果出队完队空则释放所有锁（最开始队列不是空，而是给了一个假节点）</p>
<p>并发hash：每个节点一个锁，然后每个节点是一个并发链表</p>
<p>由于每个节点的锁是独立的，并发hash的性能很好，实现也简单，被大量使用</p>
<p>“不成熟的优化是所有坏事的根源”，先从简单方案做起并发数据结构（即加一把大锁）</p>
<p>进一步方向： 更复杂的数据结构，如并发B树；不用锁的非阻塞新方案</p>
<h5 id="VM-1"><a href="#VM-1" class="headerlink" title="VM"></a>VM</h5><ul>
<li>区分on demand paging和swap out</li>
</ul>
<p>如果PTE是全0，从来没有过-&gt;on demand paging</p>
<p>如果PTE是有地址的，只不过后面的present&#x2F;valid&#x2F;…是0-&gt;swap out</p>
<ul>
<li>区分demand paging和COW -&gt;直接看vma上的标记位就行，COW是vma的事情</li>
</ul>
<p>OS还要维护一个和物理页一一对应的数据结构(因为不可能扫描虚拟页——太多了), 来辅助swap page的算法——例如LRU,FIFO,clock（近似LRU） 很多算法都要求记录访问频率之类，那就需要在struct page之中存储所有进程的VM之中指向它的pte的list，同时记录物理页的属性（例如non-swap，像OS page和pagetable page就不应该被交换下去（这个在PTE里面也有相关bit））。这个在struct page（PM）里面存VM（pte）的操作称为reverse mapping反向映射</p>
<p>swap space:在硬盘上开辟page in &amp;&amp; page out的空间</p>
<p>正常的内存引用 <strong>VA→TLB→pagetable</strong></p>
<p>如果想要让部分的page能够在硬盘之中以支持更大的地址空间，那么我们需要在PTE里面再加一个present bit，表示页是否在内存之中</p>
<p>那OS如何知道页在硬盘上的哪里呢？位置信息写在原来的PFN等地方</p>
<p>硬盘IO，进程block(调度到其他进程)，等待IO完毕之后重试指令（根据OS设计决定更不更新TLB,如果这时候不更新，重试指令TLB miss也会更新)</p>
<p>内存满了——页交换策略</p>
<p>在这种情况可以用比如!PTE_V区分是segmentation fault,用PTE_V&amp;&amp;!PTE_P来区分是page fault</p>
<p>实际上OS并不是当内存满了才开始swap page，而是有一个High watermark（HW）和 Low watermark (LW), 当OS发现有少于LW个页可用的时候，会启动内存交换进程（swap&#x2F;page daemon）直到有HW个页可用</p>
<p>把一些工作放在后台有助于OS调度、合并操作</p>
<p>判断策略优劣：AMAT（Average Memory Access Time） 或者 和 最优替换策略（总是换出最远将来将要被换出的页）进行比较</p>
<p>简单策略：FIFO、随机、LRU（Least Recently Used）</p>
<ul>
<li>没有局部性，几种策略相差不大</li>
<li>八二分布，即80%情况访问20%热门页，LRU好</li>
<li>循环引用，LRU和FIFO差，随机好</li>
</ul>
<p>实现LRU：完美LRU非常耗费资源(需要统计频率信息），通常用近似LRU，添加一个use bit(也称ref bit),有比如<strong>时钟算法等（随机遍历，如果引用位为1，设为0；替换找到第一个为0的；引用时设为1）</strong></p>
<p>也可以考虑脏页，由于踢出干净的页是低成本的（可以不写回磁盘，拿去干别的事情，例如分配内存）</p>
<p>何时将页载入内存？页选择策略（page selection）。大多数OS按需取页（demand paging）但也有不少OS实现了prefetching,例如使用页P时，提前将P+1载入内存</p>
<p>何时将页写入磁盘？OS也可以cluster或者group一些page之后再进行写入，而不是有一个页就写一次来优化</p>
<p>如果一个进程需要的内存超过了可用的总物理内存？结果是不断交换页, 被称为抖动thrashing, 有些OS会让系统运行复杂的检测来决定不运行部分进程，另一些系统在内存不足时会唤起一个杀手进程直接选择某些内存密集型程序杀掉</p>
<p>现在很有意思的情况是，内存和硬盘访问时间相差得越来越大，所以页替换算法的重要性有所降低（因为页放到硬盘的代价昂贵），“过度分页的最佳解决方案往往很简单：购买更多的内存”</p>
<h5 id="基于事件并发"><a href="#基于事件并发" class="headerlink" title="基于事件并发"></a>基于事件并发</h5><p>GUI应用， nodejs</p>
<p>基本想法是基于事件的循环：只有一个主线程，它一直进行“接收事件——处理事件”的循环</p>
<p>如何接收事件？基于操作系统的select和poll API，定时检查网络和IO的文件描述符fd是否有值得注意的写入</p>
<p>只有一个线程的好处是避免了死锁等并发问题，问题在于如果主线程阻塞了怎么办？</p>
<p>没有办法，主线程就阻塞了，无法进行切换，所以不能让主线程阻塞。</p>
<p>但是IO、网络这些操作都是可能阻塞的，因此引入了异步IO（AIO）, 当发起可能阻塞的事件处理的时候，主线程先往下走，等待操作完成之后通过中断（Unix signal）或轮询等方法得知操作处理结果。</p>
<p>但这个操作比多线程复杂，往下走的时候需要通过某种数据结构来记录依赖于这个结果的信息（通过打开的文件描述符）然后IO完成时，通过文件描述符查找这个数据结构，再去处理这些信息</p>
<p>实际上还有很多其他复杂性……</p>
<p>写出正确的并发程序：</p>
<ol>
<li>尽可能简单，避免复杂线程交互</li>
<li>使用已经被证实的线程交互方式（比如锁，或者生产者－消费者队列）</li>
<li>只在一定要使用的时候才并发，过早优化是糟糕的</li>
<li>采取map-reduce等无锁和条件变量的简单成熟算法</li>
</ol>
<h4 id="笔记节选"><a href="#笔记节选" class="headerlink" title="笔记节选"></a>笔记节选</h4><h5 id="x86大页"><a href="#x86大页" class="headerlink" title="x86大页"></a>x86大页</h5><p>4K, 2M, 1G,后两个超级块怎么实现？</p>
<p>实际上非常简单，x86 四级页表每个512 entry,8字节一个entry, 一个页表4KB，一个页也是4KB</p>
<p>超级页只需要讲entry里面的PG位设置成1——以此来标记不需要后面几级页表了——就行，4KB * 512 &#x3D; 2MB，2MB * 512 &#x3D; 1GB。很是巧妙。</p>
<p>大页的好处：</p>
<ul>
<li>占据TLB entry数量更小</li>
<li>页表翻译速度上升</li>
</ul>
<p>坏处：空间利用率低（inner fragmentation）</p>
<p>目前的x86_64架构CPU都遵循AMD的Canonical Form,<strong>即只有虚拟地址的最低48位才会在地址转换时被使用, 且任何虚拟地址的48位至63位必须与47位一致, 也就是说总的虚拟地址空间为256TB。</strong></p>
<p>0000000000000000 – 00007fffffffffff(128TB)为用户空间,</p>
<p>ffff800000000000 – ffffffffffffffff(128TB)为内核空间。</p>
<p>4级页表，9位一级，512 * 8 &#x3D; 4KB 4*9+12 &#x3D; 48</p>
<h5 id="page-attribute"><a href="#page-attribute" class="headerlink" title="page attribute"></a>page attribute</h5><p>OS做页分配的时候，页有三种attribute uncached, unalloced, cached</p>
<p>另外两种很好理解，uncached实际上就是COW，理解这一点可以这样追溯：</p>
<p>cached的page实际上对应一段data，这一段data是运行时产生的或者ELF文件之中存储的（也就是存储在实际的磁盘上的），而内存扮演了磁盘的cache的角色。在编译时分配的时候，OS记住数据所在的VM段与磁盘位置的映射关系，设置为uncached。当触发pagefault的时候，从磁盘加载到内存，分配物理页，并更新pagetable——此时uncached变成cached</p>
<p>pagefault一般也有几种情况：</p>
<ul>
<li>Swapped in or paged in</li>
<li>Demand paging</li>
<li>Segmentation fault</li>
</ul>
<h4 id="malloc"><a href="#malloc" class="headerlink" title="malloc"></a>malloc</h4><p>内部碎片和外部碎片：</p>
<p>内部: playload和实际消耗的差距，align padding 和 header &amp; footer</p>
<p>外部: 过于细碎导致装不下——和负载有关，难以衡量</p>
<p>三种策略：first fit, next fit, best fit</p>
<p>显式&#x2F;隐式空闲链表：hdr &amp; ftr，8 bytes alignment -&gt; {block &amp; alloc bit}，利用对齐后三位是0</p>

        </div>

        
            <div class="post-copyright-info w-full my-8 px-2 sm:px-6 md:px-8">
                <div class="article-copyright-info-container">
    <ul>
        <li><strong>Title:</strong> ics备考</li>
        <li><strong>Author:</strong> Ayanami</li>
        <li><strong>Created at
                :</strong> 2024-07-11 00:00:00</li>
        
            <li>
                <strong>Updated at
                    :</strong> 2024-07-11 23:35:13
            </li>
        
        <li>
            <strong>Link:</strong> https://ayanami1314.github.io/2024/07/11/ics备考/
        </li>
        <li>
            <strong>
                License:
            </strong>
            

            
                This work is licensed under <a class="license" target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0">CC BY-NC-SA 4.0</a>.
            
        </li>
    </ul>
</div>

            </div>
        

        

        
  <div class="recommended-article px-2 sm:px-6 md:px-8">
   <div class="recommended-desktop">
    <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
    </div>
    <div class="recommended-article-group"><a class="recommended-article-item" href="/2024/07/11/11-14-11-26学习双周记：/" title="11.14-11.26学习双周记" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="11.14-11.26学习双周记" class="!max-w-none">
  <span class="title">11.14-11.26学习双周记</span>
</a><a class="recommended-article-item" href="/2024/07/11/浅入理解断点和调试器/" title="浅入理解断点和调试器" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="浅入理解断点和调试器" class="!max-w-none">
  <span class="title">浅入理解断点和调试器</span>
</a><a class="recommended-article-item" href="/2024/07/11/数据结构期末复习/" title="数据结构期末复习" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="数据结构期末复习" class="!max-w-none">
  <span class="title">数据结构期末复习</span>
</a></div>
   </div>
   <div class="recommended-mobile">
   <div class="recommended-article-header text-xl md:text-3xl font-bold mt-10">
     <i aria-hidden="true"></i><span>推荐阅读</span>
   </div>
   <div class="recommended-article-group"><a class="recommended-article-item" href="/2024/07/11/11-14-11-26学习双周记：/" title="11.14-11.26学习双周记" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="11.14-11.26学习双周记" class="!max-w-none">
  <span class="title">11.14-11.26学习双周记</span>
</a><a class="recommended-article-item" href="/2024/07/11/浅入理解断点和调试器/" title="浅入理解断点和调试器" rel="bookmark">
  <img src="/images/wallhaven-wqery6-light.webp" alt="浅入理解断点和调试器" class="!max-w-none">
  <span class="title">浅入理解断点和调试器</span>
</a></div>
   </div>
  </div>

        
            <div class="article-nav my-8 flex justify-between items-center px-2 sm:px-6 md:px-8">
                
                    <div class="article-prev border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="prev"
                        rel="prev"
                        href="/2024/07/11/Go-Gin%E5%AD%A6%E4%B9%A0/"
                        >
                            <span class="left arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-left"></i>
                            </span>
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">Go,Gin学习</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next border-border-color shadow-redefine-flat shadow-shadow-color-2 rounded-medium px-4 py-2 hover:shadow-redefine-flat-hover hover:shadow-shadow-color-2">
                        <a class="next"
                        rel="next"
                        href="/2024/07/11/linking-%E5%A4%8D%E4%B9%A0/"
                        >
                            <span class="title flex justify-center items-center">
                                <span class="post-nav-title-item">linking 复习</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex justify-center items-center">
                                <i class="fa-solid fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        


        
    </div>

    
        <div class="toc-content-container">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <div class="toc-title">On this page</div>
        <div class="page-title">ics备考</div>
        

    </div>
</div>
        </div>
    
</div>



                

            </div>

            

        </div>

        <div class="main-content-footer">
            <footer class="footer mt-5 py-5 h-auto text-base text-third-text-color relative border-t-2 border-t-border-color">
    <div class="info-container py-3 text-center">
        
        <div class="text-center">
            &copy;
            
              <span>2022</span>
              -
            
            2024&nbsp;&nbsp;<i class="fa-solid fa-heart fa-beat" style="--fa-animation-duration: 0.5s; color: #f54545"></i>&nbsp;&nbsp;<a href="/">Ayanami</a>
            
                
                <p class="post-count space-x-0.5">
                    <span>
                        21 posts in total
                    </span>
                    
                </p>
            
        </div>
        
            <script data-swup-reload-script src="https://cn.vercount.one/js"></script>
            <div class="relative text-center lg:absolute lg:right-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-right">
                
                    <span id="busuanzi_container_site_uv" class="lg:!block">
                        <span class="text-sm">VISITOR COUNT</span>
                        <span id="busuanzi_value_site_uv"></span>
                    </span>
                
                
                    <span id="busuanzi_container_site_pv" class="lg:!block">
                        <span class="text-sm">TOTAL PAGE VIEWS</span>
                        <span id="busuanzi_value_site_pv"></span>
                    </span>
                
            </div>
        
        <div class="relative text-center lg:absolute lg:left-[20px] lg:top-1/2 lg:-translate-y-1/2 lg:text-left">
            <span class="lg:block text-sm">POWERED BY <?xml version="1.0" encoding="utf-8"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd"><svg class="relative top-[2px] inline-block align-baseline" version="1.1" id="圖層_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="1rem" height="1rem" viewBox="0 0 512 512" enable-background="new 0 0 512 512" xml:space="preserve"><path fill="#0E83CD" d="M256.4,25.8l-200,115.5L56,371.5l199.6,114.7l200-115.5l0.4-230.2L256.4,25.8z M349,354.6l-18.4,10.7l-18.6-11V275H200v79.6l-18.4,10.7l-18.6-11v-197l18.5-10.6l18.5,10.8V237h112v-79.6l18.5-10.6l18.5,10.8V354.6z"/></svg><a target="_blank" class="text-base" href="https://hexo.io">Hexo</a></span>
            <span class="text-sm lg:block">THEME&nbsp;<a class="text-base" target="_blank" href="https://github.com/EvanNotFound/hexo-theme-redefine">Redefine v2.6.4</a></span>
        </div>
        
        
            <div>
                Blog up for <span class="odometer" id="runtime_days" ></span> days <span class="odometer" id="runtime_hours"></span> hrs <span class="odometer" id="runtime_minutes"></span> Min <span class="odometer" id="runtime_seconds"></span> Sec
            </div>
        
        
            <script data-swup-reload-script>
                try {
                    function odometer_init() {
                    const elements = document.querySelectorAll('.odometer');
                    elements.forEach(el => {
                        new Odometer({
                            el,
                            format: '( ddd).dd',
                            duration: 200
                        });
                    });
                    }
                    odometer_init();
                } catch (error) {}
            </script>
        
        
        
    </div>  
</footer>
        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="article-tools-list">
        <!-- TOC aside toggle -->
        
            <li class="right-bottom-tools page-aside-toggle">
                <i class="fa-regular fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-side-tools-container">
        <div class="side-tools-container">
    <ul class="hidden-tools-list">
        <li class="right-bottom-tools tool-font-adjust-plus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-plus"></i>
        </li>

        <li class="right-bottom-tools tool-font-adjust-minus flex justify-center items-center">
            <i class="fa-regular fa-magnifying-glass-minus"></i>
        </li>

        <li class="right-bottom-tools tool-dark-light-toggle flex justify-center items-center">
            <i class="fa-regular fa-moon"></i>
        </li>

        <!-- rss -->
        

        

        <li class="right-bottom-tools tool-scroll-to-bottom flex justify-center items-center">
            <i class="fa-regular fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="visible-tools-list">
        <li class="right-bottom-tools toggle-tools-list flex justify-center items-center">
            <i class="fa-regular fa-cog fa-spin"></i>
        </li>
        
            <li class="right-bottom-tools tool-scroll-to-top flex justify-center items-center">
                <i class="arrow-up fas fa-arrow-up"></i>
                <span class="percent"></span>
            </li>
        
        
    </ul>
</div>

    </div>

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fa-solid fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fa-solid fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fa-solid fa-spinner fa-spin-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>


    
<script src="/js/libs/Swup.min.js"></script>

<script src="/js/libs/SwupSlideTheme.min.js"></script>

<script src="/js/libs/SwupScriptsPlugin.min.js"></script>

<script src="/js/libs/SwupProgressPlugin.min.js"></script>

<script src="/js/libs/SwupScrollPlugin.min.js"></script>

<script src="/js/libs/SwupPreloadPlugin.min.js"></script>

<script>
    const swup = new Swup({
        plugins: [
            new SwupScriptsPlugin({
                optin: true,
            }),
            new SwupProgressPlugin(),
            new SwupScrollPlugin({
                offset: 80,
            }),
            new SwupSlideTheme({
                mainElement: ".main-content-body",
            }),
            new SwupPreloadPlugin(),
        ],
        containers: ["#swup"],
    });
</script>







<script src="/js/tools/imageViewer.js" type="module"></script>

<script src="/js/utils.js" type="module"></script>

<script src="/js/main.js" type="module"></script>

<script src="/js/layouts/navbarShrink.js" type="module"></script>

<script src="/js/tools/scrollTopBottom.js" type="module"></script>

<script src="/js/tools/lightDarkSwitch.js" type="module"></script>

<script src="/js/layouts/categoryList.js" type="module"></script>



    
<script src="/js/tools/localSearch.js" type="module"></script>




    
<script src="/js/tools/codeBlock.js" type="module"></script>




    
<script src="/js/layouts/lazyload.js" type="module"></script>




    
<script src="/js/tools/runtime.js"></script>

    
<script src="/js/libs/odometer.min.js"></script>

    
<link rel="stylesheet" href="/assets/odometer-theme-minimal.css">




  
<script src="/js/libs/Typed.min.js"></script>

  
<script src="/js/plugins/typed.js" type="module"></script>









<div class="post-scripts" data-swup-reload-script>
    
        
<script src="/js/tools/tocToggle.js" type="module"></script>

<script src="/js/layouts/toc.js" type="module"></script>

<script src="/js/plugins/tabs.js" type="module"></script>

    
</div>


</body>
</html>
