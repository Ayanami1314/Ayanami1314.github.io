<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.4.0">
<title data-rh="true">银杏叶书 chapter 5 | Ayanami&#x27;s Cave</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ayanami1314.github.io/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ayanami1314.github.io/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="银杏叶书 chapter 5 | Ayanami&#x27;s Cave"><meta data-rh="true" name="description" content="为什么使用slab + buddy sys"><meta data-rh="true" property="og:description" content="为什么使用slab + buddy sys"><link data-rh="true" rel="icon" href="/img/ayanami.jpg"><link data-rh="true" rel="canonical" href="https://ayanami1314.github.io/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记" hreflang="en"><link data-rh="true" rel="alternate" href="https://ayanami1314.github.io/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Ayanami&#39;s Cave Atom Feed">



<link rel="alternate" type="application/rss+xml" href="/personal-essays/rss.xml" title="Ayanami&#39;s Cave RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/personal-essays/atom.xml" title="Ayanami&#39;s Cave Atom Feed">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.00dd3480.css">
<script src="/assets/js/runtime~main.0fb531b3.js" defer="defer"></script>
<script src="/assets/js/main.044b537f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Ayanami&#x27;s Cave</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/Chcore源码阅读/">课程笔记</a><a class="navbar__item navbar__link" href="/blog">技术博客</a><a class="navbar__item navbar__link" href="/personal-essays">个人随笔</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z" dir="ltr"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/docs/Chcore源码阅读/">Chcore源码阅读</a><button aria-label="Collapse sidebar category &#x27;Chcore源码阅读&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/Chcore源码阅读/rpc/rpc基础">rpc</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/docs/Chcore源码阅读/内存分配器/buddy-sys">内存分配器</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Chcore源码阅读/内存分配器/buddy-sys">buddy system</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Chcore源码阅读/内存分配器/slab">小内存分配优化 SLab</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Chcore源码阅读/内存分配器/kmalloc">kmalloc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记">银杏叶书 chapter 5</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/Chcore源码阅读/多核支持与调度/多核支持">多核支持与调度</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Chcore源码阅读/异常管理/">异常管理</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/Chcore源码阅读/文件系统/POSIX">文件系统</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Chcore源码阅读/用户态程序编写/">用户态程序编写</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Chcore源码阅读/系统调用/">系统调用</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/Chcore源码阅读/进程管理/能力组管理">进程管理</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/docs/Chcore源码阅读/页表分配/缺页管理">页表分配</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/docs/应用系统体系架构/作业/hw1-impl">应用系统体系架构</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/docs/离散数学/">离散数学</a><button aria-label="Expand sidebar category &#x27;离散数学&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/Chcore源码阅读/"><span itemprop="name">Chcore源码阅读</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">内存分配器</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">银杏叶书 chapter 5</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>银杏叶书 chapter 5</h1>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="为什么使用slab--buddy-sys">为什么使用slab + buddy sys<a class="hash-link" aria-label="Direct link to 为什么使用slab + buddy sys" title="Direct link to 为什么使用slab + buddy sys" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#为什么使用slab--buddy-sys">​</a></h3>
<p>buddy sys对大内存块，外部碎片和分配速度上表现良好, 但对小于页粒度的内存分配存在太多的内部碎片</p>
<p>因此linux引入了SLab作为buddy sys的补充, 核心思想是将一个page 划分成 meta data + 一系列的等长 slot, 这样在slab之中进行小内存分配的时候就可以兼顾较快的速度和较小的内部碎片</p>
<blockquote>
<p>linux内核包括三种小对象管理方式，slab，slub和slob，slab维护复杂，开销较大; slob开销最小,但碎片指标等不佳,用于嵌入式等; linux默认使用折中的slub</p>
</blockquote>
<p>在 <a href="https://hammertux.github.io/slab-allocator" target="_blank" rel="noopener noreferrer">https://hammertux.github.io/slab-allocator</a> 也有论述</p>
<ol>
<li><strong>SLOB Allocator</strong>: Was the original slab allocator as implemented in <em>Solaris OS</em>. Now used for embedded systems where memory is scarce, performs well when allocating very small chunks of memory. Based on the <em>first-fit</em> allocation algorithm.</li>
<li><strong>SLAB Allocator</strong>: An improvement over the SLOB allocator, aims to be very <em>“cache-friendly”</em>.</li>
<li><strong>SLUB Allocator</strong>: Has better execution time than the SLAB allocator by reducing the number of queues/chains used.</li>
</ol>
<p>slab in linux kernel</p>
<p><a href="https://www.dingmos.com/index.php/archives/23/" target="_blank" rel="noopener noreferrer">https://www.dingmos.com/index.php/archives/23/</a></p>
<p><a href="https://freeflyingsheep.github.io/posts/kernel/memory/slab/" target="_blank" rel="noopener noreferrer">https://freeflyingsheep.github.io/posts/kernel/memory/slab/</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="查看本机的slab">查看本机的slab<a class="hash-link" aria-label="Direct link to 查看本机的slab" title="Direct link to 查看本机的slab" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#查看本机的slab">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">sudo cat /proc/slabinfo</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 专用部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">nsproxy             1344   1344     72   56    1 : tunables    0    0    0 : slabdata     24     24      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">vma_lock          366998 451350     40  102    1 : tunables    0    0    0 : slabdata   4425   4425      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">files_cache         1518   1518    704   46    8 : tunables    0    0    0 : slabdata     33     33      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">signal_cache        1732   1932   1152   28    8 : tunables    0    0    0 : slabdata     69     69      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">sighand_cache       1395   1395   2112   15    8 : tunables    0    0    0 : slabdata     93     93      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">task_struct         4897   5091  10496    3    8 : tunables    0    0    0 : slabdata   1697   1697      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 通用部分</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-8k         0      0   8192    4    8 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-4k         0      0   4096    8    8 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-2k         0      0   2048   16    8 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-1k         0      0   1024   32    8 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-512        0      0    512   32    4 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-256        0      0    256   32    2 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-192        0      0    192   42    2 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-128        0      0    128   32    1 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-96         0      0     96   42    1 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-64         0      0     64   64    1 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-32         0      0     32  128    1 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-16         0      0     16  256    1 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">dma-kmalloc-8          0      0      8  512    1 : tunables    0    0    0 : slabdata      0      0      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-8k            64     64   8192    4    8 : tunables    0    0    0 : slabdata     16     16      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-4k           569    584   4096    8    8 : tunables    0    0    0 : slabdata     73     73      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-2k           752    752   2048   16    8 : tunables    0    0    0 : slabdata     47     47      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-1k           704    704   1024   32    8 : tunables    0    0    0 : slabdata     22     22      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-512         2112   2112    512   32    4 : tunables    0    0    0 : slabdata     66     66      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-256          768    768    256   32    2 : tunables    0    0    0 : slabdata     24     24      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-192         1050   1050    192   42    2 : tunables    0    0    0 : slabdata     25     25      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-128         1376   1376    128   32    1 : tunables    0    0    0 : slabdata     43     43      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-96          1134   1134     96   42    1 : tunables    0    0    0 : slabdata     27     27      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-64          3072   3072     64   64    1 : tunables    0    0    0 : slabdata     48     48      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-32          3072   3072     32  128    1 : tunables    0    0    0 : slabdata     24     24      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-16          6144   6144     16  256    1 : tunables    0    0    0 : slabdata     24     24      0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">kmalloc-8          12288  12288      8  512    1 : tunables    0    0    0 : slabdata     24     24      0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The slab allocator provides two main classes of caches<!-- -->:slab<!-- -->分配器提供两种主要的缓存类型：</p>
<ol>
<li>
<p><strong>Dedicated</strong>: These are caches that are created in the kernel for commonly used objects (e.g., <code>mm_struct</code>, <code>vm_area_struct</code>, etc…). Structures allocated in this cache are initialised and when they are freed, they remain initialised so that the next allocation will be faster.</p>
<p><strong>Dedicated</strong>：这些是在内核中为常用对象（例如，<code>mm_struct</code>、<code>vm_area_struct</code>等）。在这个缓存中分配的结构被初始化，当它们被释放时，它们保持初始化，以便下一次分配会更快。</p>
</li>
<li>
<p><strong>Generic</strong> (<em>size-N</em> and <em>size-N(DMA)</em>): These are general purpose caches, which in most cases are of sizes corresponding to powers of two.</p>
<p><strong>通用</strong>（<em>大小为N</em>和<em>大小为N（DMA）</em>）：这些是通用缓存，在大多数情况下，其大小对应于2的幂。</p>
</li>
</ol>
<blockquote>
<p>In the <strong>SLUB allocator</strong> things are less complicated because it stops keeping lists (queues) of different types, each cpu etc… Also the data structures used by SLUB are less cluttered and complicated thanks to these adjustments. <strong>The only queue that the SLUB allocator manages is a linked list for every of the objects in each of the slab pages</strong>. The idea was to <strong>minimise TLB thrashing by associating a slab page to the CPU</strong> (known as <strong>CPU slab</strong>) instead of a queue, so that we are only allocating objects within that page, meaning that we will be accessing the same TLB entry.</p>
</blockquote>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="如何获得更多物理内存资源">如何获得更多物理内存资源<a class="hash-link" aria-label="Direct link to 如何获得更多物理内存资源" title="Direct link to 如何获得更多物理内存  资源" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#如何获得更多物理内存资源">​</a></h3>
<ul>
<li>换页机制<!-- -->
<ul>
<li>原理：缺少内存时，将内存页换出到磁盘，修改对应进程页表的pte，同时在某些地方记录换出的地址; 当重新访问到这个页的时候，触发一个pagefault, os 发现这个虚拟页在合法的虚拟地址空间（linux vma）内，因而知道是换出到了磁盘。<!-- -->
<ul>
<li>如何区分是换出（swap out）还是 按需分配（demand paging）? 可以在pte上使用额外的标记位</li>
<li>是内存用完了才会换出吗？不是，有可配置的watermark, linux 的内存资源小于低水位线时，开始启用换出，到高水位线停止; 如果内存资源比最小水位线还低，则立刻进行批量换出（依然可以配置）</li>
<li>如何从物理页得到所有使用它的进程的pte： Linux reverse mapping // TODO</li>
<li>优化：换页带来的性能损失可以通过预取（prefetching）进行降低，一个是减少trap的次数，另一个是可以batch processing和平均磁盘寻道等时间</li>
</ul>
</li>
<li>换页策略<!-- -->
<ul>
<li>FIFO</li>
<li>Second Chance： FIFO + 每个页一个物理位，如果被访问就将其置1, 如果为1则在被evict的时候有一次回到队头的“免死机会”</li>
<li>LRU</li>
<li>时钟算法：近似LRU，同样的每个页一个物理位，但因为没有队尾→队头的操作，比Second Chance更高效</li>
<li>…</li>
</ul>
</li>
<li>处理thrashing：工作集模型，在前一段时间t内访问的pages预测为后一段时间t内的工作集，应该优先换出非工作集的页，而不是把所有的换入换出都交给LRU的不可控大手（由lru的size决定）。工作集追踪的思路在于额外对每个页保存一个时间戳</li>
</ul>
</li>
<li>用vm节约物理资源<!-- -->
<ul>
<li>内存去重：kernel定时扫描，相同物理页合并（Linux KSM）(可能导致性 能下降)</li>
<li>内存压缩：由于内存和磁盘的性能差得越来越大，作为换出的中间选项，可以把内存页压缩放到一段专门的区域（Linux zswap），访问时解压</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="性能优化">性能优化<a class="hash-link" aria-label="Direct link to 性能优化" title="Direct link to 性能优化" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#性能优化">​</a></h3>
<ul>
<li>多个slab allocator(每个cpu一个) 减少锁竞争（TODO: 如何保证一致性？）</li>
<li><strong>缓存着色（Cache Coloring/Page Coloring）</strong>：分配物理页的时候尽可能均匀地占用cpu的不同cache set, 在基础的分配连续块之外。单核上这个问题基本只需要保证分配的内存连续性，cache 的 set tag设计自然满足这一点，但在多核上如何优化以减少竞争是一个问题<!-- -->
<ul>
<li>业界方案：Intel CAT，ARMv8-A MPAM，用位图或者寄存器的值来指定一个进程可以使用哪些缓存</li>
<li>ref: <a href="https://liulei-sys-inventor.github.io/files/Page%20Coloring%E7%9A%84%E5%8E%86%E5%8F%B2%E4%B8%8E%E5%8F%91%E5%B1%95.pdf" target="_blank" rel="noopener noreferrer">https://liulei-sys-inventor.github.io/files/Page Coloring的历史与发展.pdf</a> // 待增加</li>
</ul>
</li>
<li>NUMA: 尽可能让cpu访问靠近的内存，现代cpu架构之中近内存和远内存访问时延差距被拉开，对OS不再透明，linux libnuma库等，尽可能在本地节点内存分配</li>
</ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/Chcore源码阅读/内存分配器/kmalloc"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">kmalloc</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Chcore源码阅读/多核支持与调度/多核支持"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">多核支持</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a class="table-of-contents__link toc-highlight" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#为什么使用slab--buddy-sys">为什么使用slab + buddy sys</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#查看本机的slab">查看本机的slab</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#如何获得更多物理内存资源">如何获得更多物理内存资源</a></li><li><a class="table-of-contents__link toc-highlight" href="/docs/Chcore源码阅读/内存分配器/参考-银杏叶书chapter5笔记#性能优化">性能优化</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">notes</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs">课程笔记</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/personal-essays">Personal Essays</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Ayanami, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>